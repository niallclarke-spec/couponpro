<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | PromoStack</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo img {
            width: 240px;
            height: auto;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 32px;
            color: #1a202c;
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #1a1d29;
            color: #a0aec0;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo img {
            width: 180px;
            height: auto;
        }

        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            padding: 0 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a0aec0;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            color: #fff;
            border-left-color: #667eea;
        }

        .nav-item-icon {
            font-size: 20px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .content-header {
            background: white;
            padding: 32px 40px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .content-header p {
            color: #718096;
            font-size: 14px;
        }

        .content-body {
            padding: 40px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 20px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .hint {
            font-size: 12px;
            color: #718096;
            margin-top: 6px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Analytics Filter Buttons */
        .analytics-filter-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 10px 20px;
            margin: 0 6px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .analytics-filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .analytics-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        /* Analytics Stats Grid */
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .analytics-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
        }

        .analytics-stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .analytics-stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        /* Analytics Tables */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table thead {
            background: #f7fafc;
        }

        .analytics-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .analytics-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .analytics-table tbody tr:hover {
            background: #f7fafc;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #718096;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Assets/Templates List */
        .assets-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .delete-selected-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .asset-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .asset-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
            transform: translateX(4px);
        }

        .template-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
            flex-shrink: 0;
        }

        .asset-item-info {
            flex: 1;
        }

        .asset-name {
            font-weight: 600;
            color: #1a202c;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .asset-slug {
            font-size: 13px;
            color: #718096;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .asset-edit-icon,
        .asset-delete-icon {
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }

        .asset-edit-icon {
            color: #667eea;
        }

        .asset-edit-icon:hover {
            transform: scale(1.2);
        }

        .asset-delete-icon {
            color: #ef4444;
        }

        .asset-delete-icon:hover {
            transform: scale(1.2);
        }

        /* Template Section */
        .template-section {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            background: #fafbfc;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .section-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
        }

        .preview-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .preview-frame {
            position: relative;
            background: #0a0b10;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .preview-frame.square {
            aspect-ratio: 1/1;
        }

        .preview-frame.story {
            aspect-ratio: 9/16;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .preview-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 10;
        }

        /* Row Layout */
        .row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* Slider */
        .slider {
            width: 100%;
            max-width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            margin-bottom: 8px;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        /* Color Picker */
        .color-picker-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .color-swatches {
            display: flex;
            gap: 12px;
        }

        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,.25);
        }

        .color-swatch.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(0,0,0,.25);
        }

        .color-swatch.red {
            background: #FF273E;
        }

        .color-swatch.white {
            background: #FFFFFF;
            border: 1px solid #e2e8f0;
        }

        .color-swatch-label {
            font-size: 11px;
            color: #718096;
            text-align: center;
            margin-top: 4px;
        }

        /* Nudge Controls */
        .nudge-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
            align-items: center;
        }

        .nudge-controls-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .nudge-buttons {
            display: grid;
            grid-template-columns: repeat(3, 36px);
            grid-template-rows: repeat(3, 36px);
            gap: 6px;
        }

        .nudge-btn {
            background: white;
            color: #667eea;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nudge-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .nudge-up { grid-column: 2; grid-row: 1; }
        .nudge-left { grid-column: 1; grid-row: 2; }
        .nudge-right { grid-column: 3; grid-row: 2; }
        .nudge-down { grid-column: 2; grid-row: 3; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: scale(0.95) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            text-align: center;
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 15px;
            color: #718096;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #edf2f7;
            color: #4a5568;
        }

        .modal-btn-cancel:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-header {
                padding: 24px 20px;
            }

            .content-body {
                padding: 20px;
            }

            .card {
                padding: 20px;
            }

            .row {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="login-logo">
                <img src="/assets/promostack-logo.png" alt="PromoStack" />
            </div>
            <h1 class="login-title">üîê Admin Login</h1>
            <div id="loginAlert"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 12px;">Login</button>
                <a href="https://dash.promostack.io" class="btn btn-secondary" style="width: 100%; display: block; text-align: center; text-decoration: none;">Visit Frontend</a>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard hidden" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="/assets/promostack-logo.png" alt="PromoStack" />
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="showView('templates')">
                        <span class="nav-item-icon">üì¶</span>
                        <span class="nav-item-text">Template Manager</span>
                    </a>
                    <a class="nav-item" onclick="showView('analytics')">
                        <span class="nav-item-icon">üìä</span>
                        <span class="nav-item-text">Bot Analytics</span>
                    </a>
                    <a class="nav-item" onclick="showView('campaigns')">
                        <span class="nav-item-icon">üéØ</span>
                        <span class="nav-item-text">Campaigns</span>
                    </a>
                    <a class="nav-item" onclick="showView('broadcast')">
                        <span class="nav-item-icon">üì¢</span>
                        <span class="nav-item-text">Broadcast</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <a class="nav-item" onclick="showView('configuration')">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        <span class="nav-item-text">Configuration</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="handleLogout()">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Templates View -->
            <div id="templatesView" class="view-container">
                <div class="content-header">
                    <h1>Template Manager</h1>
                    <p>Upload and manage your promotional templates with drag-to-draw coupon positioning</p>
                </div>

                <div class="content-body">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('upload')">Upload Template</button>
                        <button class="tab" onclick="switchTab('assets')">Current Assets</button>
                        <button class="tab" onclick="switchTab('campaigns-tab')">Campaigns</button>
                    </div>

                    <!-- Upload Tab -->
                    <div id="uploadTab" class="tab-content active">
                        <div id="uploadAlert"></div>

                        <form id="templateForm" onsubmit="handleUpload(event)">
                            <div class="card">
                                <div class="form-group">
                                    <label for="name">Template Name *</label>
                                    <input type="text" id="name" required placeholder="e.g., Flash Sale">
                                    <div class="hint">This will appear in the dropdown</div>
                                </div>

                                <div class="form-group" style="display: none;">
                                    <label for="slug">Slug *</label>
                                    <input type="text" id="slug" required pattern="[a-z0-9-]+" placeholder="e.g., flash-sale">
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Square Image (1:1)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="squareImage">Square PNG (optional)</label>
                                            <input type="file" id="squareImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="squareLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="squareHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="squareMaxFontPx">Font Size</label>
                                            <input type="range" id="squareMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="squareMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="squareShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('square', 'up')">‚Üë</button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('square', 'left')">‚Üê</button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('square', 'right')">‚Üí</button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('square', 'down')">‚Üì</button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="square" onclick="selectColor('#FF273E', 'square')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="square" onclick="selectColor('#FFFFFF', 'square')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame square">
                                            <div class="preview-hint">‚ÑπÔ∏è Click and draw coupon area</div>
                                            <canvas id="previewSquare"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Story Image (9:16)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="storyImage">Portrait PNG (optional)</label>
                                            <input type="file" id="storyImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="storyLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="storyHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="storyMaxFontPx">Font Size</label>
                                            <input type="range" id="storyMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="storyMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="storyShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('story', 'up')">‚Üë</button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('story', 'left')">‚Üê</button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('story', 'right')">‚Üí</button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('story', 'down')">‚Üì</button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="story" onclick="selectColor('#FF273E', 'story')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="story" onclick="selectColor('#FFFFFF', 'story')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame story">
                                            <div class="preview-hint">‚ÑπÔ∏è Click and draw coupon area</div>
                                            <canvas id="previewStory"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="squareFontColor" value="#FF273E">
                            <input type="hidden" id="storyFontColor" value="#FF273E">

                            <button type="submit" class="btn" id="submitBtn">Upload Template</button>
                        </form>
                    </div>

                    <!-- Assets Tab -->
                    <div id="assetsTab" class="tab-content">
                        <div class="assets-header">
                            <label class="select-all-container">
                                <input type="checkbox" id="selectAllTemplates" onchange="toggleSelectAll()">
                                <span>Select All</span>
                            </label>
                            <button type="button" class="delete-selected-btn" onclick="deleteSelectedTemplates()">Delete Selected</button>
                        </div>
                        <div id="assetsList" class="assets-list">
                            <p style="color: #718096; text-align: center;">Loading templates...</p>
                        </div>
                    </div>

                    <!-- Campaigns Tab -->
                    <div id="campaignsTabContent" class="tab-content">
                        <div id="campaignAlert"></div>
                        
                        <div class="card">
                            <div class="card-title" id="campaignFormTitle">Create Campaign</div>
                            <form id="campaignForm" onsubmit="handleCampaignSubmit(event)">
                                <input type="hidden" id="editCampaignId" value="">
                                
                                <div class="form-group">
                                    <label for="campaignTitle">Campaign Title *</label>
                                    <input type="text" id="campaignTitle" required placeholder="e.g., Summer Giveaway 2025">
                                </div>

                                <div class="form-group">
                                    <label for="campaignDescription">Description *</label>
                                    <input type="text" id="campaignDescription" required placeholder="Brief description of the campaign">
                                </div>

                                <div class="row">
                                    <div class="form-group">
                                        <label for="campaignStartDate">Start Date *</label>
                                        <input type="date" id="campaignStartDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="campaignEndDate">End Date *</label>
                                        <input type="date" id="campaignEndDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="campaignPrize">Prize *</label>
                                        <input type="text" id="campaignPrize" required placeholder="e.g., $500 Gift Card">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Platforms *</label>
                                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:#2d3748;font-weight:normal;">
                                            <input type="checkbox" id="platformInstagram" style="width:auto;margin:0;" />
                                            <span>Instagram</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:#2d3748;font-weight:normal;">
                                            <input type="checkbox" id="platformTwitter" style="width:auto;margin:0;" />
                                            <span>Twitter</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:#2d3748;font-weight:normal;">
                                            <input type="checkbox" id="platformFacebook" style="width:auto;margin:0;" />
                                            <span>Facebook</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="campaignOverlay">Campaign Overlay Image (Optional)</label>
                                    <input type="file" id="campaignOverlay" accept="image/png,image/jpeg" onchange="handleOverlayPreview(event)">
                                    <small style="color: #718096; display: block; margin-top: 4px;">
                                        PNG or JPEG. Will be overlaid on user-uploaded images during participation.
                                    </small>
                                    <div id="overlayPreview" style="margin-top: 12px; display: none;">
                                        <img id="overlayPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e2e8f0;">
                                        <button type="button" onclick="clearOverlay()" class="btn btn-secondary" style="margin-top: 8px; padding: 8px 16px; font-size: 12px;">Remove</button>
                                    </div>
                                    <input type="hidden" id="existingOverlayUrl" value="">
                                </div>

                                <div style="display: flex; gap: 12px;">
                                    <button type="submit" class="btn" id="campaignSubmitBtn">Create Campaign</button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelCampaignEdit()" id="campaignCancelBtn" style="display:none;">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-title">All Campaigns</div>
                            <div id="campaignsList" class="assets-list">
                                <p style="color: #718096; text-align: center;">Loading campaigns...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns View -->
            <div id="campaignsView" class="view-container hidden">
                <div class="content-header">
                    <h1>Campaigns</h1>
                    <p>Manage your promotional campaigns and giveaways</p>
                </div>

                <div class="content-body">
                    <div id="campaignsViewAlert"></div>
                    
                    <div class="card">
                        <div class="card-title">Create Campaign</div>
                        <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">
                            Use the Campaigns tab in Template Manager to create and manage campaigns.
                        </p>
                        <button class="btn" onclick="showView('templates'); switchTab('campaigns-tab')">Go to Campaigns</button>
                    </div>
                </div>
            </div>

            <!-- Bot Analytics View -->
            <div id="analyticsView" class="view-container hidden">
                <div class="content-header">
                    <h1>üìä Bot Analytics</h1>
                    <p>Track your Telegram bot usage and performance</p>
                </div>

                <div class="content-body">
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="analytics-filter-btn" data-days="today" onclick="changeAnalyticsPeriod('today')">Today</button>
                            <button class="analytics-filter-btn" data-days="yesterday" onclick="changeAnalyticsPeriod('yesterday')">Yesterday</button>
                            <button class="analytics-filter-btn active" data-days="7" onclick="changeAnalyticsPeriod(7)">Last 7 Days</button>
                            <button class="analytics-filter-btn" data-days="30" onclick="changeAnalyticsPeriod(30)">Last 30 Days</button>
                            <button class="analytics-filter-btn" data-days="90" onclick="changeAnalyticsPeriod(90)">Last 90 Days</button>
                        </div>
                    </div>

                    <div id="analytics-content">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            Loading statistics...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broadcast View -->
            <div id="broadcastView" class="view-container hidden">
                <div class="content-header">
                    <h1>üì¢ Broadcast Messages</h1>
                    <p>Send announcements to all active Telegram bot users</p>
                </div>

                <div class="content-body">
                    <!-- Active Users Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Active Users</div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="activeUsersCount">
                                <div class="spinner"></div>
                            </div>
                            <div style="color: #718096; margin-top: 8px;">users active in the last 30 days</div>
                        </div>
                    </div>

                    <!-- Broadcast Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Send Broadcast</div>
                        <div id="broadcastAlert"></div>
                        
                        <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                            <div class="form-group">
                                <label for="broadcastMessage">Message</label>
                                <textarea 
                                    id="broadcastMessage" 
                                    rows="6" 
                                    required 
                                    placeholder="üéâ New templates available! Use /generate to create promotional images with your saved coupon code."
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                                <div class="hint">Supports Markdown formatting (*bold*, _italic_, `code`)</div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="previewBroadcast()">Preview</button>
                                <button type="submit" class="btn">
                                    <span id="broadcastBtnText">Send Broadcast</span>
                                    <span id="broadcastBtnSpinner" class="spinner" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Broadcast History -->
                    <div class="card">
                        <div class="card-title">Broadcast History</div>
                        <div id="broadcastHistory">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading broadcast history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration View -->
            <div id="configurationView" class="view-container hidden">
                <div class="content-header">
                    <h1>Configuration</h1>
                    <p>System settings and configuration options</p>
                </div>

                <div class="content-body">
                    <div class="card">
                        <div class="card-title">Settings</div>
                        <p style="color: #718096; font-size: 14px;">
                            Configuration options coming soon...
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">üóëÔ∏è</div>
            <div class="modal-title" id="modalTitle">Delete Template?</div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Campaign Submissions Modal -->
    <div class="modal-overlay" id="submissionsModal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title" id="submissionsModalTitle">Campaign Submissions</div>
            <div id="submissionsContent" style="margin: 20px 0; max-height: 400px; overflow-y: auto;">
                <p style="color: #718096; text-align: center;">Loading submissions...</p>
            </div>
            <div style="text-align: center;">
                <button class="modal-btn modal-btn-cancel" onclick="closeSubmissionsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.add('hidden');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (viewName === 'templates') {
                document.getElementById('templatesView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (viewName === 'analytics') {
                document.getElementById('analyticsView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadAnalytics();
            } else if (viewName === 'campaigns') {
                document.getElementById('templatesView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                switchTab('campaigns-tab');
            } else if (viewName === 'broadcast') {
                document.getElementById('broadcastView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[3].classList.add('active');
                loadBroadcastData();
            } else if (viewName === 'configuration') {
                document.getElementById('configurationView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[4].classList.add('active');
            }
        }

        // Login/Logout
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadAssets();
                } else {
                    showAlert('loginAlert', data.error || 'Invalid password', true);
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed: ' + error.message, true);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Bot Analytics
        let currentAnalyticsDays = 7;
        let dailyChart = null;
        let isEditingTemplate = false;

        async function loadAnalytics() {
            try {
                const response = await fetch(`/api/bot-stats?days=${currentAnalyticsDays}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const stats = await response.json();
                renderAnalytics(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('analytics-content').innerHTML = `
                    <div class="card">
                        <p style="color: #e53e3e; text-align: center;">Failed to load statistics. Please try again.</p>
                    </div>
                `;
            }
        }

        function changeAnalyticsPeriod(days) {
            currentAnalyticsDays = days;
            
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            loadAnalytics();
        }

        function renderAnalytics(stats) {
            const content = document.getElementById('analytics-content');
            
            if (stats.total_uses === 0) {
                content.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            <h2 style="margin-bottom: 12px;">No bot usage data yet</h2>
                            <p>Start using the Telegram bot to see statistics here.</p>
                        </div>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Total Uses</div>
                        <div class="analytics-stat-value">${stats.total_uses.toLocaleString()}</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Success Rate</div>
                        <div class="analytics-stat-value">${stats.success_rate}%</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Unique Users</div>
                        <div class="analytics-stat-value">${stats.unique_users.toLocaleString()}</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Successful Uses</div>
                        <div class="analytics-stat-value">${stats.successful_uses.toLocaleString()}</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-title">Daily Usage</div>
                    <canvas id="dailyChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-title">Popular Templates</div>
                    ${renderTemplatesTable(stats.popular_templates)}
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-title">Popular Coupon Codes</div>
                    ${renderCouponsTable(stats.popular_coupons)}
                </div>

                ${stats.errors.length > 0 ? `
                    <div class="card">
                        <div class="card-title">Error Breakdown</div>
                        ${renderErrorsTable(stats.errors)}
                    </div>
                ` : ''}
            `;

            renderDailyChart(stats.daily_usage);
        }

        function renderTemplatesTable(templates) {
            if (templates.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No template usage data</p>';
            }

            return `
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Template</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${templates.map(t => `
                            <tr>
                                <td>${t.template}</td>
                                <td>${t.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderCouponsTable(coupons) {
            if (coupons.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No coupon usage data</p>';
            }

            return `
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Coupon Code</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coupons.map(c => `
                            <tr>
                                <td>${c.coupon}</td>
                                <td>${c.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderErrorsTable(errors) {
            return `
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Error Type</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${errors.map(e => `
                            <tr>
                                <td>${e.type.replace(/_/g, ' ').toUpperCase()}</td>
                                <td>${e.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderDailyChart(dailyUsage) {
            if (dailyChart) {
                dailyChart.destroy();
            }

            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyUsage.map(d => d.date),
                    datasets: [{
                        label: 'Bot Uses',
                        data: dailyUsage.map(d => d.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Tab Switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = Array.from(tabs);
            if (tabName === 'upload') {
                tabButtons[0]?.classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            } else if (tabName === 'assets') {
                tabButtons[1]?.classList.add('active');
                document.getElementById('assetsTab').classList.add('active');
                loadAssets();
            } else if (tabName === 'campaigns-tab') {
                tabButtons[2]?.classList.add('active');
                document.getElementById('campaignsTabContent').classList.add('active');
                loadCampaigns();
            }
        }

        // Alert Helper
        function showAlert(elementId, message, isError = false) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert ${isError ? 'alert-error' : 'alert-success'}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Template Upload
        async function handleUpload(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('slug', document.getElementById('slug').value);
            
            const squareFile = document.getElementById('squareImage').files[0];
            const storyFile = document.getElementById('storyImage').files[0];
            if (squareFile) formData.append('squareImage', squareFile);
            if (storyFile) formData.append('storyImage', storyFile);
            
            formData.append('squareLeftPct', document.getElementById('squareLeftPct').value);
            formData.append('squareTopPct', document.getElementById('squareTopPct').value);
            formData.append('squareWidthPct', document.getElementById('squareWidthPct').value);
            formData.append('squareHeightPct', document.getElementById('squareHeightPct').value);
            formData.append('squareHAlign', 'center');
            formData.append('squareVAlign', 'middle');
            formData.append('squareMaxFontPx', document.getElementById('squareMaxFontPx').value);
            formData.append('squareShowLogo', document.getElementById('squareShowLogo').checked);
            
            formData.append('storyLeftPct', document.getElementById('storyLeftPct').value);
            formData.append('storyTopPct', document.getElementById('storyTopPct').value);
            formData.append('storyWidthPct', document.getElementById('storyWidthPct').value);
            formData.append('storyHeightPct', document.getElementById('storyHeightPct').value);
            formData.append('storyHAlign', 'center');
            formData.append('storyVAlign', 'middle');
            formData.append('storyMaxFontPx', document.getElementById('storyMaxFontPx').value);
            formData.append('storyShowLogo', document.getElementById('storyShowLogo').checked);
            
            formData.append('squareFontColor', document.getElementById('squareFontColor').value);
            formData.append('storyFontColor', document.getElementById('storyFontColor').value);

            try {
                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('uploadAlert', data.message + ' ‚úì');
                    document.getElementById('templateForm').reset();
                    isEditingTemplate = false;
                    const slugInput = document.getElementById('slug');
                    slugInput.readOnly = false;
                    slugInput.style.backgroundColor = '';
                    slugInput.style.cursor = '';
                    drawingState.square.hasDrawnBox = false;
                    drawingState.story.hasDrawnBox = false;
                    updatePreviewsImmediate();
                } else {
                    showAlert('uploadAlert', data.error || 'Upload failed', true);
                }
            } catch (error) {
                showAlert('uploadAlert', 'Upload failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Template';
            }
        }

        // Auto-generate slug from name (only when creating new templates, not editing)
        document.getElementById('name').addEventListener('input', function(e) {
            if (!isEditingTemplate) {
                const slug = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('slug').value = slug;
            }
        });

        // Load Assets
        async function loadAssets() {
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading templates...</p>';
            
            try {
                let response;
                try {
                    response = await fetch('https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/index.json?ts=' + Date.now());
                } catch (_) {
                    response = await fetch('/assets/templates/index.json?ts=' + Date.now());
                }
                const data = await response.json();
                
                if (!data.templates || data.templates.length === 0) {
                    assetsList.innerHTML = '<p style="color: #718096; text-align: center;">No templates found</p>';
                    return;
                }
                
                assetsList.innerHTML = '';
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <input type="checkbox" class="template-checkbox" data-slug="${template.slug}" data-name="${template.name}" onchange="updateSelectAllState()">
                        <div class="asset-item-info">
                            <div class="asset-name">${template.name}</div>
                            <div class="asset-slug">${template.slug}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="loadTemplateForEdit('${template.slug}')">‚úé</div>
                            <div class="asset-delete-icon" onclick="deleteTemplate('${template.slug}', '${template.name}')">üóë</div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                });
                
                document.getElementById('selectAllTemplates').checked = false;
            } catch (error) {
                assetsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading templates</p>';
                console.error('Failed to load assets:', error);
            }
        }

        // Load template for editing
        async function loadTemplateForEdit(slug) {
            try {
                let response;
                try {
                    response = await fetch(`https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/meta.json?ts=${Date.now()}`);
                } catch (_) {
                    response = await fetch(`/assets/templates/${slug}/meta.json?ts=${Date.now()}`);
                }
                const meta = await response.json();
                
                switchTab('upload');
                
                isEditingTemplate = true;
                document.getElementById('name').value = meta.name || slug;
                const slugInput = document.getElementById('slug');
                slugInput.value = slug;
                slugInput.readOnly = true;
                slugInput.style.backgroundColor = '#f3f4f6';
                slugInput.style.cursor = 'not-allowed';
                
                document.getElementById('squareLeftPct').value = meta.square?.box?.leftPct || meta.square?.leftPct || 5;
                document.getElementById('squareTopPct').value = meta.square?.box?.topPct || meta.square?.topPct || 78;
                document.getElementById('squareWidthPct').value = meta.square?.box?.widthPct || meta.square?.widthPct || 90;
                document.getElementById('squareHeightPct').value = meta.square?.box?.heightPct || meta.square?.heightPct || 12;
                document.getElementById('squareMaxFontPx').value = meta.square?.maxFontPx || 80;
                document.getElementById('squareShowLogo').checked = meta.square?.showLogo !== false;
                
                document.getElementById('storyLeftPct').value = meta.story?.box?.leftPct || meta.story?.leftPct || 5;
                document.getElementById('storyTopPct').value = meta.story?.box?.topPct || meta.story?.topPct || 78;
                document.getElementById('storyWidthPct').value = meta.story?.box?.widthPct || meta.story?.widthPct || 90;
                document.getElementById('storyHeightPct').value = meta.story?.box?.heightPct || meta.story?.heightPct || 12;
                document.getElementById('storyMaxFontPx').value = meta.story?.maxFontPx || 80;
                document.getElementById('storyShowLogo').checked = meta.story?.showLogo !== false;
                
                const squareFontColor = meta.square?.fontColor || '#FF273E';
                const storyFontColor = meta.story?.fontColor || '#FF273E';
                document.getElementById('squareFontColor').value = squareFontColor;
                document.getElementById('storyFontColor').value = storyFontColor;
                selectColor(squareFontColor, 'square');
                selectColor(storyFontColor, 'story');
                
                drawingState.square.hasDrawnBox = true;
                if (meta.story) {
                    drawingState.story.hasDrawnBox = true;
                }
                
                const squareImg = new Image();
                squareImg.onload = async function() {
                    try {
                        await squareImg.decode();
                        previewImages.square = squareImg;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square image decode failed:', e);
                    }
                };
                
                try {
                    squareImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/square.png?ts=${Date.now()}`;
                } catch (_) {
                    squareImg.src = `/assets/templates/${slug}/square.png?ts=${Date.now()}`;
                }
                
                if (meta.story) {
                    const storyImg = new Image();
                    storyImg.onload = async function() {
                        try {
                            await storyImg.decode();
                            previewImages.story = storyImg;
                            renderPreview('story');
                        } catch(e) {
                            console.error('Story image decode failed:', e);
                        }
                    };
                    
                    try {
                        storyImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/story.png?ts=${Date.now()}`;
                    } catch (_) {
                        storyImg.src = `/assets/templates/${slug}/story.png?ts=${Date.now()}`;
                    }
                }
                
                document.getElementById('submitBtn').textContent = 'Update Template';
                
            } catch (error) {
                showAlert('uploadAlert', 'Failed to load template: ' + error.message, true);
            }
        }

        // Delete template
        let deleteConfirmCallback = null;

        function deleteTemplate(slug, name) {
            document.getElementById('modalTitle').textContent = 'Delete Template?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                try {
                    const response = await fetch('/api/delete-template', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('uploadAlert', `Template "${name}" deleted successfully ‚úì`);
                        loadAssets();
                    } else {
                        showAlert('uploadAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('uploadAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteConfirmCallback = null;
        }

        // Bulk delete
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllTemplates').checked;
            document.querySelectorAll('.template-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.template-checkbox');
            const checkedBoxes = document.querySelectorAll('.template-checkbox:checked');
            document.getElementById('selectAllTemplates').checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }

        function deleteSelectedTemplates() {
            const selected = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => ({
                slug: cb.dataset.slug,
                name: cb.dataset.name
            }));
            
            if (selected.length === 0) {
                showAlert('uploadAlert', 'No templates selected', true);
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Delete Multiple Templates?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete ${selected.length} template(s)? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                let successCount = 0;
                let failCount = 0;
                
                for (const template of selected) {
                    try {
                        const response = await fetch('/api/delete-template', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug: template.slug })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                if (successCount > 0) {
                    showAlert('uploadAlert', `Successfully deleted ${successCount} template(s) ‚úì`);
                }
                if (failCount > 0) {
                    showAlert('uploadAlert', `Failed to delete ${failCount} template(s)`, true);
                }
                
                loadAssets();
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        // Color selection
        function selectColor(color, variant) {
            document.querySelectorAll(`.color-swatch[data-variant="${variant}"]`).forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
            document.getElementById(variant + 'FontColor').value = color;
            updatePreviews();
        }

        // Canvas preview setup
        const previewSquareCanvas = document.getElementById('previewSquare');
        const previewStoryCanvas = document.getElementById('previewStory');
        const ctxSquare = previewSquareCanvas.getContext('2d');
        const ctxStory = previewStoryCanvas.getContext('2d');

        const previewImages = {
            square: null,
            story: null
        };

        const drawingState = {
            square: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false },
            story: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false }
        };

        function computeAutoFontPx(ctx, text, maxWidth, maxHeight, minPx) {
            let lo = minPx, hi = maxHeight;
            while (hi - lo > 1) {
                const mid = Math.floor((lo + hi) / 2);
                ctx.font = `700 ${mid}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
                const metrics = ctx.measureText(text);
                if (metrics.width <= maxWidth) {
                    lo = mid;
                } else {
                    hi = mid;
                }
            }
            return lo;
        }

        function drawTextAutoFit(ctx, text, natW, natH, box, maxPx, fontColor) {
            const left = Math.round(natW * (box.leftPct / 100));
            const top = Math.round(natH * (box.topPct / 100));
            const width = Math.round(natW * (box.widthPct / 100));
            const height = Math.round(natH * (box.heightPct / 100));

            const cap = Math.min(maxPx, height);
            const px = computeAutoFontPx(ctx, text, width, cap, 8);

            const hAlign = (box?.hAlign || 'center');
            let x = left;
            let textAlign = 'left';
            if (hAlign === 'center') {
                x = left + Math.round(width / 2);
                textAlign = 'center';
            } else if (hAlign === 'right') {
                x = left + width;
                textAlign = 'right';
            }

            const vAlign = (box?.vAlign || 'bottom');
            let y = top + px;
            if (vAlign === 'middle') {
                y = top + Math.round(height / 2) + Math.round(px * 0.35);
            } else if (vAlign === 'bottom') {
                y = top + height;
            }

            ctx.font = `700 ${px}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'alphabetic';
            ctx.lineJoin = 'round';
            ctx.lineWidth = Math.max(2, Math.floor(px * 0.08));
            ctx.strokeStyle = 'rgba(0,0,0,.75)';
            ctx.fillStyle = fontColor || '#ffffff';
            ctx.strokeText(text, x, y);
            ctx.fillText(text, x, y);
        }

        function renderPreview(variant, showBoundingBox = false) {
            const canvas = variant === 'square' ? previewSquareCanvas : previewStoryCanvas;
            const ctx = variant === 'square' ? ctxSquare : ctxStory;
            const img = previewImages[variant];

            const natW = img && img.naturalWidth ? img.naturalWidth : 1080;
            const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

            const off = document.createElement('canvas');
            off.width = natW;
            off.height = natH;
            const og = off.getContext('2d');
            og.imageSmoothingQuality = 'high';

            if (img && img.naturalWidth) {
                og.drawImage(img, 0, 0, natW, natH);
            } else {
                og.fillStyle = '#10131a';
                og.fillRect(0, 0, natW, natH);
            }

            const prefix = variant === 'square' ? 'square' : 'story';
            const box = {
                leftPct: parseFloat(document.getElementById(prefix + 'LeftPct').value) || 5,
                topPct: parseFloat(document.getElementById(prefix + 'TopPct').value) || 78,
                widthPct: parseFloat(document.getElementById(prefix + 'WidthPct').value) || 90,
                heightPct: parseFloat(document.getElementById(prefix + 'HeightPct').value) || 12,
                hAlign: 'center',
                vAlign: 'middle'
            };
            const maxFontPx = parseInt(document.getElementById(prefix + 'MaxFontPx').value) || 80;

            if (showBoundingBox) {
                const boxLeft = Math.round(natW * (box.leftPct / 100));
                const boxTop = Math.round(natH * (box.topPct / 100));
                const boxWidth = Math.round(natW * (box.widthPct / 100));
                const boxHeight = Math.round(natH * (box.heightPct / 100));
                
                og.fillStyle = 'rgba(102, 126, 234, 0.15)';
                og.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                og.strokeStyle = 'rgba(102, 126, 234, 0.6)';
                og.lineWidth = Math.max(2, Math.round(Math.min(natW, natH) * 0.003));
                og.strokeRect(boxLeft, boxTop, boxWidth, boxHeight);
            }

            const state = drawingState[variant];
            if (state.hasDrawnBox) {
                const fontColor = document.getElementById(variant + 'FontColor').value || '#FF273E';
                drawTextAutoFit(og, 'COUPON-AREA', natW, natH, box, maxFontPx, fontColor);
            }

            const targetW = Math.max(1, Math.round(canvas.parentElement.clientWidth));
            const targetH = Math.max(1, Math.round(canvas.parentElement.clientHeight));
            const pixelRatio = window.devicePixelRatio || 2;
            canvas.width = targetW * pixelRatio;
            canvas.height = targetH * pixelRatio;
            canvas.style.width = targetW + 'px';
            canvas.style.height = targetH + 'px';
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(pixelRatio, pixelRatio);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, targetW, targetH);
            
            const scale = Math.min(targetW / natW, targetH / natH);
            const dw = Math.ceil(natW * scale);
            const dh = Math.ceil(natH * scale);
            const dx = Math.round((targetW - dw) / 2);
            const dy = Math.round((targetH - dh) / 2);
            
            ctx.drawImage(off, 0, 0, natW, natH, dx, dy, dw, dh);
        }

        let updatePreviewsTimeout = null;
        function updatePreviews() {
            if (updatePreviewsTimeout) {
                clearTimeout(updatePreviewsTimeout);
            }
            updatePreviewsTimeout = setTimeout(() => {
                renderPreview('square');
                renderPreview('story');
            }, 50);
        }
        
        function updatePreviewsImmediate() {
            renderPreview('square');
            renderPreview('story');
        }

        // Image upload handlers
        document.getElementById('squareImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.square.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.square = img;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        document.getElementById('storyImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.story.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.story = img;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // Slider sync
        function setupSliderSync(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            if (!slider || !input) return;
            
            slider.addEventListener('input', function() {
                input.value = parseFloat(this.value).toFixed(1);
                updatePreviews();
            });
            
            input.addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!isNaN(val)) {
                    slider.value = val;
                }
                updatePreviews();
            });
        }

        setupSliderSync('squareMaxFontPxSlider', 'squareMaxFontPx');
        setupSliderSync('storyMaxFontPxSlider', 'storyMaxFontPx');

        // Drag-to-draw
        function setupDragToDraw(canvasId, variant) {
            const canvas = document.getElementById(canvasId);
            const state = drawingState[variant];

            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            function convertToImagePercentages(startX, startY, endX, endY) {
                const rect = canvas.getBoundingClientRect();
                const canvasDisplayWidth = rect.width;
                const canvasDisplayHeight = rect.height;

                const img = previewImages[variant];
                const natW = img && img.naturalWidth ? img.naturalWidth : (variant === 'square' ? 1080 : 1080);
                const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

                const scale = Math.min(canvasDisplayWidth / natW, canvasDisplayHeight / natH);
                const scaledImageWidth = natW * scale;
                const scaledImageHeight = natH * scale;

                const offsetX = (canvasDisplayWidth - scaledImageWidth) / 2;
                const offsetY = (canvasDisplayHeight - scaledImageHeight) / 2;

                const imgX1 = (Math.min(startX, endX) - offsetX) / scaledImageWidth;
                const imgY1 = (Math.min(startY, endY) - offsetY) / scaledImageHeight;
                const imgX2 = (Math.max(startX, endX) - offsetX) / scaledImageWidth;
                const imgY2 = (Math.max(startY, endY) - offsetY) / scaledImageHeight;

                const leftPct = Math.max(0, Math.min(100, imgX1 * 100));
                const topPct = Math.max(0, Math.min(100, imgY1 * 100));
                const widthPct = Math.max(1, Math.min(100 - leftPct, (imgX2 - imgX1) * 100));
                const heightPct = Math.max(1, Math.min(100 - topPct, (imgY2 - imgY1) * 100));

                return { leftPct, topPct, widthPct, heightPct };
            }

            function drawDragRectangle() {
                if (!state.isDrawing) return;

                const ctx = variant === 'square' ? ctxSquare : ctxStory;
                
                renderPreview(variant, true);

                const x1 = Math.min(state.startX, state.currentX);
                const y1 = Math.min(state.startY, state.currentY);
                const width = Math.abs(state.currentX - state.startX);
                const height = Math.abs(state.currentY - state.startY);

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);

                ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                ctx.fillRect(x1, y1, width, height);
                ctx.restore();
            }

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCanvasCoordinates(e);
                state.isDrawing = true;
                state.startX = coords.x;
                state.startY = coords.y;
                state.currentX = coords.x;
                state.currentY = coords.y;
                renderPreview(variant, true);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                drawDragRectangle();
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                state.isDrawing = false;

                const minDragDistance = 10;
                if (Math.abs(state.currentX - state.startX) < minDragDistance || 
                    Math.abs(state.currentY - state.startY) < minDragDistance) {
                    renderPreview(variant);
                    return;
                }

                const percentages = convertToImagePercentages(
                    state.startX, state.startY, 
                    state.currentX, state.currentY
                );

                const prefix = variant === 'square' ? 'square' : 'story';
                document.getElementById(prefix + 'LeftPct').value = percentages.leftPct.toFixed(1);
                document.getElementById(prefix + 'TopPct').value = percentages.topPct.toFixed(1);
                document.getElementById(prefix + 'WidthPct').value = percentages.widthPct.toFixed(1);
                document.getElementById(prefix + 'HeightPct').value = percentages.heightPct.toFixed(1);

                state.hasDrawnBox = true;

                updatePreviewsImmediate();
            });

            canvas.addEventListener('mouseleave', (e) => {
                if (state.isDrawing) {
                    state.isDrawing = false;
                    renderPreview(variant);
                }
            });
        }

        setupDragToDraw('previewSquare', 'square');
        setupDragToDraw('previewStory', 'story');

        // Nudge controls
        function nudgePosition(variant, direction) {
            const prefix = variant === 'square' ? 'square' : 'story';
            const leftInput = document.getElementById(prefix + 'LeftPct');
            const topInput = document.getElementById(prefix + 'TopPct');
            
            const step = 0.5;
            let currentLeft = parseFloat(leftInput.value) || 5;
            let currentTop = parseFloat(topInput.value) || 78;
            
            switch(direction) {
                case 'up':
                    currentTop = Math.max(0, currentTop - step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'down':
                    currentTop = Math.min(100, currentTop + step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'left':
                    currentLeft = Math.max(0, currentLeft - step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
                case 'right':
                    currentLeft = Math.min(100, currentLeft + step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
            }
            
            updatePreviews();
        }

        // Campaign Management
        async function loadCampaigns() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading campaigns...</p>';
            
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                
                if (!data.campaigns || data.campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">No campaigns found</p>';
                    return;
                }
                
                campaignsList.innerHTML = '';
                data.campaigns.forEach(campaign => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <div class="asset-item-info" style="flex: 1;">
                            <div class="asset-name">${campaign.title}</div>
                            <div class="asset-slug">${campaign.description} | ${campaign.start_date} to ${campaign.end_date}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="editCampaign(${campaign.id})">‚úé</div>
                            <div class="asset-delete-icon" onclick="deleteCampaign(${campaign.id}, '${campaign.title}')">üóë</div>
                            <button onclick="viewSubmissions(${campaign.id}, '${campaign.title}')" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Submissions</button>
                        </div>
                    `;
                    campaignsList.appendChild(item);
                });
            } catch (error) {
                campaignsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading campaigns</p>';
                console.error('Failed to load campaigns:', error);
            }
        }

        async function handleCampaignSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('campaignSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const formData = new FormData();
            const editId = document.getElementById('editCampaignId').value;
            if (editId) formData.append('id', editId);
            
            formData.append('title', document.getElementById('campaignTitle').value);
            formData.append('description', document.getElementById('campaignDescription').value);
            formData.append('start_date', document.getElementById('campaignStartDate').value);
            formData.append('end_date', document.getElementById('campaignEndDate').value);
            formData.append('prize', document.getElementById('campaignPrize').value);
            
            const platforms = [];
            if (document.getElementById('platformInstagram').checked) platforms.push('Instagram');
            if (document.getElementById('platformTwitter').checked) platforms.push('Twitter');
            if (document.getElementById('platformFacebook').checked) platforms.push('Facebook');
            formData.append('platforms', platforms.join(','));
            
            const overlayFile = document.getElementById('campaignOverlay').files[0];
            if (overlayFile) {
                formData.append('overlay', overlayFile);
            } else if (editId) {
                const existingUrl = document.getElementById('existingOverlayUrl').value;
                if (existingUrl) formData.append('existingOverlay', existingUrl);
            }

            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('campaignAlert', data.message + ' ‚úì');
                    document.getElementById('campaignForm').reset();
                    document.getElementById('editCampaignId').value = '';
                    document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
                    document.getElementById('campaignCancelBtn').style.display = 'none';
                    document.getElementById('overlayPreview').style.display = 'none';
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Failed to save campaign', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to save campaign: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editId ? 'Update Campaign' : 'Create Campaign';
            }
        }

        async function editCampaign(id) {
            try {
                const response = await fetch(`/api/campaigns/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const campaign = data.campaign;
                    document.getElementById('editCampaignId').value = campaign.id;
                    document.getElementById('campaignTitle').value = campaign.title;
                    document.getElementById('campaignDescription').value = campaign.description;
                    document.getElementById('campaignStartDate').value = campaign.start_date;
                    document.getElementById('campaignEndDate').value = campaign.end_date;
                    document.getElementById('campaignPrize').value = campaign.prize;
                    
                    const platforms = campaign.platforms.split(',');
                    document.getElementById('platformInstagram').checked = platforms.includes('Instagram');
                    document.getElementById('platformTwitter').checked = platforms.includes('Twitter');
                    document.getElementById('platformFacebook').checked = platforms.includes('Facebook');
                    
                    if (campaign.overlay_url) {
                        document.getElementById('existingOverlayUrl').value = campaign.overlay_url;
                        document.getElementById('overlayPreviewImg').src = campaign.overlay_url;
                        document.getElementById('overlayPreview').style.display = 'block';
                    }
                    
                    document.getElementById('campaignFormTitle').textContent = 'Edit Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Update Campaign';
                    document.getElementById('campaignCancelBtn').style.display = 'inline-block';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to load campaign: ' + error.message, true);
            }
        }

        function cancelCampaignEdit() {
            document.getElementById('campaignForm').reset();
            document.getElementById('editCampaignId').value = '';
            document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
            document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
            document.getElementById('campaignCancelBtn').style.display = 'none';
            document.getElementById('overlayPreview').style.display = 'none';
        }

        async function deleteCampaign(id, title) {
            document.getElementById('modalTitle').textContent = 'Delete Campaign?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${title}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                try {
                    const response = await fetch(`/api/campaigns/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('campaignAlert', `Campaign "${title}" deleted successfully ‚úì`);
                        loadCampaigns();
                    } else {
                        showAlert('campaignAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('campaignAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        async function viewSubmissions(campaignId, campaignTitle) {
            document.getElementById('submissionsModalTitle').textContent = `Submissions: ${campaignTitle}`;
            document.getElementById('submissionsContent').innerHTML = '<p style="color: #718096; text-align: center;">Loading submissions...</p>';
            document.getElementById('submissionsModal').classList.add('active');
            
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/submissions`);
                const data = await response.json();
                
                if (data.success && data.submissions.length > 0) {
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">';
                    data.submissions.forEach(sub => {
                        html += `
                            <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                                <img src="${sub.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #4a5568; font-weight: 600;">${sub.user_id}</div>
                                <div style="font-size: 11px; color: #718096;">${new Date(sub.submitted_at).toLocaleDateString()}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('submissionsContent').innerHTML = html;
                } else {
                    document.getElementById('submissionsContent').innerHTML = '<p style="color: #718096; text-align: center;">No submissions yet</p>';
                }
            } catch (error) {
                document.getElementById('submissionsContent').innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading submissions</p>';
            }
        }

        function closeSubmissionsModal() {
            document.getElementById('submissionsModal').classList.remove('active');
        }

        function handleOverlayPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('overlayPreviewImg').src = e.target.result;
                    document.getElementById('overlayPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearOverlay() {
            document.getElementById('campaignOverlay').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('existingOverlayUrl').value = '';
        }

        // Broadcast Functions
        async function loadBroadcastData() {
            await Promise.all([
                loadActiveUsersCount(),
                loadBroadcastHistory()
            ]);
        }

        async function loadActiveUsersCount() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                document.getElementById('activeUsersCount').textContent = data.active_users || 0;
            } catch (error) {
                console.error('Error loading active users:', error);
                document.getElementById('activeUsersCount').textContent = '?';
            }
        }

        async function loadBroadcastHistory() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    document.getElementById('broadcastHistory').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            No broadcasts sent yet
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Message</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Recipients</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Sent</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Failed</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.jobs.forEach(job => {
                    const statusColor = {
                        'completed': '#10b981',
                        'processing': '#3b82f6',
                        'failed': '#ef4444',
                        'pending': '#f59e0b'
                    }[job.status] || '#718096';

                    const messagePreview = job.message.length > 50 
                        ? job.message.substring(0, 50) + '...' 
                        : job.message;

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px; font-size: 14px; color: #1a202c;">${messagePreview}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                                    ${job.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #4a5568;">${job.total_users}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #10b981; font-weight: 600;">${job.sent_count}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #ef4444; font-weight: 600;">${job.failed_count}</td>
                            <td style="padding: 12px; font-size: 13px; color: #718096;">${new Date(job.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('broadcastHistory').innerHTML = html;
            } catch (error) {
                console.error('Error loading broadcast history:', error);
                document.getElementById('broadcastHistory').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Error loading broadcast history
                    </div>
                `;
            }
        }

        async function sendBroadcast(event) {
            event.preventDefault();

            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showAlert('broadcastAlert', 'Please enter a message', true);
                return;
            }

            // Confirm before sending
            if (!confirm(`Send this broadcast to all active users?`)) {
                return;
            }

            // Show loading state
            document.getElementById('broadcastBtnText').style.display = 'none';
            document.getElementById('broadcastBtnSpinner').style.display = 'inline-block';
            document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, days: 30 })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('broadcastAlert', `‚úÖ Broadcast started! Sending to ${data.total_users} users. Job ID: ${data.job_id}`);
                    document.getElementById('broadcastForm').reset();
                    
                    // Reload history after a delay
                    setTimeout(() => loadBroadcastHistory(), 2000);
                } else {
                    showAlert('broadcastAlert', data.error || 'Failed to send broadcast', true);
                }
            } catch (error) {
                showAlert('broadcastAlert', 'Error: ' + error.message, true);
            } finally {
                // Reset loading state
                document.getElementById('broadcastBtnText').style.display = 'inline';
                document.getElementById('broadcastBtnSpinner').style.display = 'none';
                document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = false;
            }
        }

        function previewBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message first');
                return;
            }

            // Convert basic Markdown to HTML for preview
            const htmlMessage = message
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<strong>$1</strong>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">$1</code>')
                .replace(/\n/g, '<br>');

            const previewWindow = window.open('', 'Broadcast Preview', 'width=400,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Broadcast Preview</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            padding: 20px;
                            background: #0d1117;
                            color: #fff;
                        }
                        .message {
                            background: #1c2128;
                            padding: 16px;
                            border-radius: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                        }
                        .label {
                            color: #8b949e;
                            font-size: 12px;
                            margin-bottom: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="label">üì± Telegram Message Preview</div>
                    <div class="message">${htmlMessage}</div>
                </body>
                </html>
            `);
        }

        // Initial render
        updatePreviewsImmediate();
    </script>
</body>
</html>
