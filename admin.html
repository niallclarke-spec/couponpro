<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | PromoStack</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/assets/js/auth.js"></script>
    <link rel="stylesheet" href="/assets/css/journeys.css">
    <style>
        /* ========================================
           DESIGN SYSTEM - Dark Theme (Dashdark X)
           ======================================== */
        :root {
            /* Background Colors - Figma Design */
            --bg-primary: #091128;
            --bg-secondary: #091128;
            --bg-sidebar: #081028;
            --bg-card: #0B1739;
            --bg-card-hover: #122048;
            --bg-input: #0B1739;
            
            /* Accent Colors - Blue Indigo Purple */
            --accent-primary: #4f46e5;
            --accent-primary-hover: #6366f1;
            --accent-gradient: linear-gradient(90deg, #1e3a5f 0%, #4f46e5 50%, #7c3aed 100%);
            --accent-glow: rgba(79, 70, 229, 0.3);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-dark: #1e293b;
            
            /* Border Colors - Subtle blue tints */
            --border-primary: rgba(255, 255, 255, 0.06);
            --border-secondary: rgba(255, 255, 255, 0.10);
            --border-accent: var(--accent-primary);
            
            /* Status Colors */
            --status-online: #10b981;
            --status-online-bg: rgba(16, 185, 129, 0.15);
            --status-offline: #6b7280;
            --status-offline-bg: rgba(107, 114, 128, 0.15);
            --status-warning: #f59e0b;
            --status-warning-bg: rgba(245, 158, 11, 0.15);
            --status-error: #ef4444;
            --status-error-bg: rgba(239, 68, 68, 0.15);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            
            /* Spacing */
            --sidebar-width: 260px;
            --header-height: 70px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 20px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo img {
            width: 220px;
            height: auto;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
        }

        .login-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 32px;
        }

        /* Dual Sidebar Dashboard Layout */
        .app-container {
            display: grid;
            grid-template-columns: 60px var(--sidebar-width) 1fr;
            min-height: 100vh;
        }

        /* Product Switcher Sidebar (60px) */
        .product-switcher {
            width: 60px;
            background: var(--bg-sidebar);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 16px;
            z-index: 1001;
            border-right: 1px solid var(--border-primary);
        }

        .product-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            background: transparent;
            position: relative;
        }

        .product-icon:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .product-icon.active {
            background: var(--accent-primary);
            color: white;
        }

        .product-icon svg {
            width: 24px;
            height: 24px;
        }

        .product-icon[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid var(--border-primary);
            z-index: 1002;
        }

        /* Main Sidebar */
        .feature-sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            color: var(--text-secondary);
            position: fixed;
            left: 60px;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border-primary);
        }

        .feature-sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-primary);
        }

        /* Sidebar Search */
        .sidebar-search {
            padding: 16px 20px;
        }

        .sidebar-search-input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.2s;
        }

        .sidebar-search-input::placeholder {
            color: var(--text-muted);
        }

        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .breadcrumb {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 6px;
        }

        .feature-nav {
            flex: 1;
            padding: 16px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 0 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            margin: 2px 0;
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: transparent;
        }

        .nav-item.active {
            color: var(--text-primary);
            border-left-color: var(--accent-primary);
            background: transparent;
        }

        .nav-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item-chevron {
            margin-left: auto;
            opacity: 0.5;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-primary);
        }

        /* Auth container - shows either sign-in or user chip */
        .auth-container {
            position: relative;
        }

        /* Sign in button for logged-out state */
        .signin-btn {
            width: 100%;
            padding: 12px 16px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .signin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        /* User chip for logged-in state */
        .user-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .user-chip:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-secondary);
        }

        .user-chip-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .user-chip-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-chip-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .user-chip-email {
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-chip-chevron {
            color: var(--text-muted);
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .user-chip.open .user-chip-chevron {
            transform: rotate(180deg);
        }

        /* User dropdown menu */
        .user-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s;
            z-index: 100;
        }

        .user-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-dropdown-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .user-dropdown-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .user-dropdown-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .user-dropdown-item:only-child {
            border-radius: var(--radius-md);
        }

        .user-dropdown-item svg {
            width: 18px;
            height: 18px;
        }

        .user-dropdown-item.logout-item:hover {
            color: #ef4444;
        }

        /* Legacy logout-btn kept for compatibility but hidden */
        .logout-btn {
            display: none;
        }

        /* Main Content Area */
        .main-content {
            grid-column: 3;
            min-height: 100vh;
            background: var(--bg-primary);
            transition: margin-left 0.3s ease;
        }

        .content-header {
            background: var(--bg-secondary);
            padding: 24px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-search {
            position: relative;
        }

        .header-search input {
            width: 280px;
            padding: 10px 14px 10px 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
        }

        .header-search input::placeholder {
            color: var(--text-muted);
        }

        .content-body {
            padding: 32px;
        }

        /* View Container */
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1002;
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-md);
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        .mobile-menu-btn svg {
            width: 22px;
            height: 22px;
            stroke: #ffffff;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Common Styles */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            transition: all 0.2s ease;
            border: 1px solid var(--border-primary);
        }

        .card:hover {
            border-color: var(--border-secondary);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        /* Stats Cards - New Design */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 14px 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 14px;
            transition: all 0.2s;
        }

        .stat-card .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-card .stat-icon svg {
            width: 20px;
            height: 20px;
        }

        .stat-card .stat-icon.win-rate {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .stat-card .stat-icon.total-pips {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .stat-card .stat-icon.total-pips.positive {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .stat-card .stat-icon.total-signals {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .stat-card .stat-icon.active-bot {
            background: rgba(79, 70, 229, 0.15);
            color: #6366f1;
        }

        .stat-card .stat-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .stat-card:hover {
            border-color: var(--border-secondary);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-icon.blue {
            background: rgba(99, 102, 241, 0.15);
            color: #6366f1;
        }

        .stat-icon.green {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .stat-icon.yellow {
            background: var(--status-warning-bg);
            color: var(--status-warning);
        }

        .stat-icon.purple {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .stat-icon.red {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        /* Telegram Channel Inline Display */
        .channels-row {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-primary);
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-item .tg-icon {
            width: 20px;
            height: 20px;
            color: #229ED9;
            flex-shrink: 0;
        }

        .channel-item .channel-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .channel-item .paid-badge {
            width: 14px;
            height: 14px;
            color: #fbbf24;
            margin-left: 2px;
        }

        .channel-item .member-count {
            font-size: 13px;
            color: var(--text-muted);
            margin-left: 4px;
        }
        
        .channel-item .member-count.has-error {
            color: var(--danger);
        }
        
        .error-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
            cursor: help;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .btn:disabled {
            background: var(--bg-card);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1.5px solid var(--accent-primary);
        }

        .btn-secondary:hover {
            background: rgba(203, 60, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: none;
            transform: none;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: opacity 0.2s;
            color: var(--accent-primary);
            vertical-align: middle;
        }

        .copy-btn:hover {
            opacity: 1;
        }

        .copy-btn svg {
            display: block;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px dashed var(--border-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="file"]:hover {
            border-color: var(--accent-primary);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .alert {
            padding: 14px 18px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: var(--status-online-bg);
            color: var(--status-online);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: var(--status-error-bg);
            color: var(--status-error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-secondary);
        }

        th {
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-primary);
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-primary);
            font-size: 14px;
            color: var(--text-secondary);
        }

        tbody tr {
            transition: background-color 0.15s;
        }

        tbody tr:hover {
            background: var(--bg-card-hover);
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .table-action-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .table-action-btn.delete:hover {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-buy {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .badge-sell {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .badge-won,
        .status-active,
        .status-online {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .badge-lost {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .badge-pending,
        .status-pending {
            background: var(--status-warning-bg);
            color: var(--status-warning);
        }

        .badge-expired,
        .status-offline {
            background: var(--status-offline-bg);
            color: var(--status-offline);
        }

        .status-revoked {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .status-free_plan {
            background: var(--status-offline-bg);
            color: var(--status-offline);
        }

        /* Bot Type Badges */
        .badge-aggressive {
            background: var(--status-error-bg);
            color: var(--status-error);
        }
        
        .badge-conservative {
            background: var(--status-online-bg);
            color: var(--status-online);
        }
        
        .badge-custom {
            background: rgba(99, 102, 241, 0.15);
            color: #6366f1;
        }
        
        .badge-legacy {
            background: var(--status-offline-bg);
            color: var(--status-offline);
        }

        /* Active Signal Banner */
        .active-signal-banner {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .active-signal-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(102, 126, 234, 0); }
        }
        
        .active-signal-info {
            flex: 1;
        }
        
        .active-signal-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .active-signal-details {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .active-signal-meta {
            text-align: right;
        }
        
        .active-signal-time {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .active-signal-breakeven {
            font-size: 12px;
            color: var(--status-online);
            font-weight: 600;
            margin-top: 4px;
        }

        /* Bot Settings Styles */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }
        
        @media (max-width: 900px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .bot-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .bot-option {
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
        }
        
        .bot-option:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .bot-option.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .bot-option.active {
            border-color: var(--status-online);
            background: var(--status-online-bg);
        }
        
        .bot-option-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .bot-option-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .bot-option-icon.aggressive {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .bot-option-icon.conservative {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .bot-option-icon.custom {
            background: var(--accent-gradient);
        }
        
        .bot-option-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .bot-option-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .bot-option-indicators {
            font-size: 11px;
            color: var(--text-muted);
            font-family: monospace;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-info {
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .status-label {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .status-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: capitalize;
        }
        
        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .bot-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .bot-stat {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .bot-stat-label {
            color: var(--text-secondary);
        }
        
        .bot-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Multi-TP Configuration Styles */
        .tp-config-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
        }
        
        .tp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .tp-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tp-count-selector {
            display: flex;
            gap: 8px;
        }
        
        .tp-count-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tp-count-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .tp-count-btn.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
        }
        
        .tp-levels {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .tp-level {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            transition: all 0.2s;
        }
        
        .tp-level.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .tp-level-badge {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .tp-level-badge.tp1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .tp-level-badge.tp2 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .tp-level-badge.tp3 {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .tp-level-info {
            flex: 1;
        }
        
        .tp-level-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .tp-level-desc {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .tp-level-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tp-pct-input {
            width: 70px;
            height: 40px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-card);
            transition: all 0.2s;
        }
        
        .tp-pct-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .tp-pct-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .tp-total {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-top: 8px;
        }
        
        .tp-total-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .tp-total-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .tp-total-value.valid {
            color: var(--status-online);
        }
        
        .tp-total-value.invalid {
            color: var(--status-error);
        }
        
        .settings-section {
            margin-bottom: 32px;
        }
        
        .settings-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .settings-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
        }
        
        .settings-main {
            min-width: 0;
        }
        
        .settings-sidebar {
            min-width: 0;
        }
        
        .settings-card-modern {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-primary);
        }
        
        .strategy-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .strategy-card {
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 20px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            background: var(--bg-card);
        }
        
        .strategy-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--accent-glow);
        }
        
        .strategy-card.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .strategy-card.active-strategy {
            border-color: var(--status-online);
            background: var(--status-online-bg);
        }
        
        .strategy-card.active-strategy::after {
            content: 'ACTIVE';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 10px;
            font-weight: 700;
            color: var(--status-online);
            background: var(--status-online-bg);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            letter-spacing: 0.5px;
        }
        
        .strategy-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .strategy-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .strategy-icon.aggressive {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .strategy-icon.conservative {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .strategy-icon.custom {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
        }
        
        .strategy-icon.raja-banks {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
        }
        
        .strategy-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .strategy-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .guardrails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .guardrail-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-primary);
        }
        
        .guardrail-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .guardrail-input {
            width: 100%;
            height: 44px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 0 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-card);
            transition: all 0.2s;
        }
        
        .guardrail-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .guardrail-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        
        .session-hours-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-hours-row input {
            width: 70px;
        }
        
        .session-hours-row span {
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .status-card-modern {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .status-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 14px;
            border: 1px solid var(--border-primary);
        }
        
        .status-item-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .status-item-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .status-item-value.positive {
            color: #10b981;
        }
        
        .status-item-value.negative {
            color: #ef4444;
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .custom-modal-overlay.active {
            display: flex;
        }
        .custom-modal {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .custom-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
        }
        .custom-modal-message {
            color: #a0a0b0;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .custom-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .custom-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .custom-modal-btn-cancel {
            background: #3d3d4d;
            color: #fff;
        }
        .custom-modal-btn-cancel:hover {
            background: #4d4d5d;
        }
        .custom-modal-btn-confirm {
            background: #7c3aed;
            color: #fff;
        }
        .custom-modal-btn-confirm:hover {
            background: #6d28d9;
        }
        .custom-modal-btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .custom-modal-btn-danger:hover {
            background: #dc2626;
        }

        /* Stats Cards - Override/Extension */
        .stat-value.positive {
            color: var(--status-online);
        }

        .stat-value.negative {
            color: var(--status-error);
        }

        .stat-subtext {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Analytics Chart Card */
        .chart-card {
            margin: 24px 0;
        }

        .day-of-week-stats {
            margin-top: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Section Headers */
        .section-header {
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-primary);
        }

        .section-title {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
        }

        .section-subtitle {
            margin: 8px 0 0 0;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Retention Grid */
        .retention-grid {
            margin-bottom: 24px;
        }

        .retention-card-day1 {
            background: var(--accent-gradient);
        }

        .retention-card-day7 {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
        }

        .retention-card-day30 {
            background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
        }

        .retention-card-day1 .analytics-stat-label,
        .retention-card-day7 .analytics-stat-label,
        .retention-card-day30 .analytics-stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .retention-card-day1 .analytics-stat-value,
        .retention-card-day7 .analytics-stat-value,
        .retention-card-day30 .analytics-stat-value {
            color: white;
        }

        .analytics-stat-subtext {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            margin-top: 4px;
        }

        .loading-text {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
        }

        /* Analytics Stats Grid */
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .analytics-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .analytics-stat-card:hover {
            border-color: var(--border-secondary);
        }

        /* Horizontal stat card layout (like Win Rate) */
        .analytics-stat-card.horizontal {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .analytics-stat-card.horizontal .analytics-stat-label {
            margin-bottom: 0;
            min-width: 60px;
        }

        .analytics-stat-card.horizontal .stat-details {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .analytics-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Percentage badge for stats */
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.positive {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .stat-badge.negative {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .stat-badge.neutral {
            background: var(--status-offline-bg);
            color: var(--text-secondary);
        }

        .stat-secondary-text {
            font-size: 13px;
            color: var(--text-muted);
        }

        .analytics-stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        /* Analytics Tables */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .analytics-table thead {
            background: var(--bg-secondary);
        }

        .analytics-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .analytics-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .analytics-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .analytics-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Scrollable Table Container */
        .table-scroll {
            max-height: 360px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--bg-card-hover);
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Side-by-side layout for Analytics */
        .analytics-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .analytics-row .card {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 1024px) {
            .analytics-row {
                flex-direction: column;
            }
            
            .analytics-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (max-width: 768px) {
            .analytics-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table thead {
            background: var(--bg-secondary);
        }

        .leaderboard-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-primary);
        }

        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-secondary);
        }

        .leaderboard-table tbody tr {
            transition: background-color 0.15s;
        }

        .leaderboard-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .leaderboard-rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%) !important;
        }

        .leaderboard-rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.1) 0%, transparent 100%) !important;
        }

        .leaderboard-rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.1) 0%, transparent 100%) !important;
        }

        .leaderboard-rank {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .status-error {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        /* Telegram Link */
        .telegram-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .telegram-link:hover {
            text-decoration: underline;
            color: var(--accent-primary-hover);
        }

        /* Placeholder */
        .placeholder-view {
            text-align: center;
            padding: 80px 20px;
        }

        .placeholder-view h2 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .placeholder-view p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Mobile product switcher - hidden on desktop, shown on mobile */
        .mobile-product-switcher {
            display: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .product-switcher {
                display: none;
            }

            .feature-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .feature-sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: 60px;
                grid-column: 1;
                width: 100%;
                max-width: 100vw;
                box-sizing: border-box;
            }

            .mobile-menu-btn {
                display: block;
            }

            .content-header {
                padding: 20px 16px;
            }

            .content-header h1 {
                font-size: 20px;
            }

            .content-body {
                padding: 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .stat-card {
                padding: 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .card {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                padding: 16px;
                margin-bottom: 16px;
            }

            /* Settings Page Mobile Layout */
            .settings-layout {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .settings-sidebar {
                order: -1;
            }

            .settings-main {
                order: 1;
            }

            .strategy-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .strategy-card {
                padding: 14px;
            }

            .strategy-icon {
                width: 40px;
                height: 40px;
                margin-bottom: 10px;
            }

            .strategy-icon svg {
                width: 20px;
                height: 20px;
            }

            .strategy-name {
                font-size: 14px;
            }

            .strategy-desc {
                font-size: 11px;
            }

            .strategy-card.active-strategy::after {
                font-size: 9px;
                top: 10px;
                right: 10px;
                padding: 3px 6px;
            }

            .settings-section {
                margin-bottom: 20px;
            }

            .status-card-modern {
                position: static !important;
                padding: 16px;
            }

            .stat-value {
                font-size: 22px;
            }

            .filter-pill {
                width: 100%;
            }

            .signals-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .filter-pill select {
                padding: 12px 36px 12px 16px;
                font-size: 14px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 12px;
                min-width: 600px;
            }

            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            /* Mobile Product Switcher */
            .mobile-product-switcher {
                display: flex;
                gap: 8px;
                padding: 12px 16px;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-primary);
            }

            .mobile-product-btn {
                flex: 1;
                padding: 10px 16px;
                border: 1px solid var(--border-primary);
                border-radius: var(--radius-md);
                background: var(--bg-card);
                color: var(--text-secondary);
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            .mobile-product-btn.active {
                background: var(--accent-primary);
                border-color: var(--accent-primary);
                color: white;
            }

            .mobile-product-btn svg {
                width: 16px;
                height: 16px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 15px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
        }

        .modal-btn-cancel:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .modal-btn-confirm {
            background: var(--status-error);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
        }

        /* Filter and Price Widget Layout - MOBILE: Stack vertically with price on top */
        @media (max-width: 768px) {
            .filters-price-row {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                margin-bottom: 24px !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .price-widget-card {
                display: flex !important;
                flex-direction: column !important;
                order: -1 !important;
                width: 100% !important;
                max-width: 100% !important;
                min-height: 80px !important;
                background: var(--bg-card) !important;
                padding: 12px 16px !important;
                border-radius: var(--radius-lg) !important;
                border: 1px solid var(--border-primary) !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
            }
            
            .filters-card {
                display: flex !important;
                flex-direction: column !important;
                order: 1 !important;
                width: 100% !important;
                max-width: 100% !important;
                background: var(--bg-card) !important;
                padding: 12px !important;
                border-radius: var(--radius-lg) !important;
                border: 1px solid var(--border-primary) !important;
                gap: 8px !important;
                box-sizing: border-box !important;
            }
            
            .price-widget-header {
                flex-wrap: wrap !important;
                gap: 8px !important;
            }
            
            .price-widget-price {
                font-size: 20px !important;
            }
            
            .price-sparkline-wrap {
                width: 100% !important;
                max-width: 100% !important;
                height: 40px !important;
            }
        }

        /* DESKTOP: 60/40 grid layout */
        @media (min-width: 769px) {
            .filters-price-row {
                display: grid !important;
                grid-template-columns: minmax(0, 3fr) minmax(260px, 2fr) !important;
                grid-template-areas: "filters price" !important;
                gap: 16px !important;
                margin-bottom: 24px !important;
            }

            .filters-card {
                grid-area: filters !important;
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                background: var(--bg-card);
                padding: 16px;
                border-radius: var(--radius-lg);
                border: 1px solid var(--border-primary);
                gap: 12px;
            }

            .price-widget-card {
                grid-area: price !important;
                display: flex !important;
                flex-direction: column !important;
                background: var(--bg-card);
                padding: 16px 20px;
                border-radius: var(--radius-lg);
                border: 1px solid var(--border-primary);
                justify-content: center;
                min-width: 0;
            }
        }

        .filter-pill {
            position: relative;
        }

        .filter-pill select {
            appearance: none;
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: 20px;
            padding: 10px 32px 10px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .filter-pill select:hover {
            border-color: var(--border-primary);
            color: var(--text-primary);
        }

        .filter-pill select:focus {
            outline: none;
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .filter-pill::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid var(--text-muted);
            pointer-events: none;
        }

        .filters-row-compact {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-pill-compact {
            position: relative;
            flex: 1;
            min-width: 120px;
        }

        .filter-pill-compact select {
            appearance: none;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 8px 28px 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .filter-pill-compact select:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .filter-pill-compact select:focus {
            outline: none;
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .filter-pill-compact::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid var(--text-muted);
            pointer-events: none;
        }

        /* New chart-metrics layout */
        .chart-metrics-layout {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .chart-card-large {
            flex: 7;
            background: var(--bg-card);
            border: none;
            border-radius: var(--radius-lg);
            padding: 0;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-card-large .chart-header {
            display: none;
        }

        .chart-card-large .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-card-large .tradingview-widget-container {
            flex: 1;
            min-height: 350px;
            overflow: hidden;
            border-radius: var(--radius-lg);
            margin: -2px;
            padding: 2px;
        }

        .chart-card-large .tradingview-widget-container iframe {
            border: none !important;
            margin: -1px;
            width: calc(100% + 2px) !important;
            height: calc(100% + 2px) !important;
        }

        .chart-card-large .tradingview-widget-container__widget {
            border: none !important;
            overflow: hidden;
            border-radius: var(--radius-lg);
        }

        .chart-card-large .tradingview-widget-copyright {
            display: none;
        }

        .metrics-stack-vertical {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .metric-card-stacked {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 16px 18px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .metric-card-stacked .metric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .metric-card-stacked .metric-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .metric-card-stacked .metric-icon svg {
            width: 16px;
            height: 16px;
        }

        .metric-card-stacked .metric-icon.ratio {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .metric-card-stacked .metric-icon.time {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .metric-card-stacked .metric-icon.calendar {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .metric-card-stacked .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 0;
        }

        .metric-card-stacked .metric-body {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .metric-card-stacked .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-card-stacked .metric-subtext {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Unified metric card body */
        .metric-card-stacked .metric-main {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 8px;
        }

        .metric-card-stacked .metric-main .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-card-stacked .metric-main .value.buy {
            color: #10b981;
        }

        .metric-card-stacked .metric-main .value.sell {
            color: #ef4444;
        }

        .metric-card-stacked .metric-main .separator {
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 400;
        }

        .metric-card-stacked .metric-main .label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Horizontal split bar for all cards */
        .metric-card-stacked .split-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            display: flex;
        }

        .metric-card-stacked .split-bar .bar-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .metric-card-stacked .split-bar .bar-segment.buy {
            background: #10b981;
        }

        .metric-card-stacked .split-bar .bar-segment.sell {
            background: #ef4444;
        }

        .metric-card-stacked .split-bar .bar-segment.primary {
            background: linear-gradient(90deg, #1e3a5f, #4f46e5, #7c3aed);
        }

        /* Day bars inline */
        .metric-card-stacked .day-bars {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 32px;
            margin-top: 4px;
        }

        .metric-card-stacked .day-bars .day-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .metric-card-stacked .day-bars .bar {
            width: 100%;
            min-height: 4px;
            border-radius: 2px;
            background: linear-gradient(180deg, #7c3aed, #4f46e5, #1e3a5f);
            transition: height 0.3s ease;
        }

        .metric-card-stacked .day-bars .day-label {
            font-size: 9px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Legacy support */
        .metrics-price-row {
            display: none;
        }

        .metric-card-compact {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 14px 18px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .metric-subtext {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        @media (max-width: 1024px) {
            .chart-metrics-layout {
                flex-direction: column;
            }

            .chart-card-large {
                min-height: 350px;
            }

            .metrics-stack-vertical {
                flex-direction: row;
                gap: 12px;
            }

            .metric-card-stacked {
                flex: 1;
                min-width: 0;
            }
        }

        @media (max-width: 768px) {
            .filters-row-compact {
                flex-wrap: wrap;
            }
            
            .filter-pill-compact {
                flex: 1 1 45%;
                min-width: 100px;
            }

            .chart-card-large {
                min-height: 280px;
            }

            .metrics-stack-vertical {
                flex-direction: column;
            }

            .metric-card-stacked {
                flex: none;
            }
        }
        
        .filters-row-compact {
            margin-bottom: 16px;
        }

        .filters-modern {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .segment-control {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }

        .segment-btn {
            background: transparent;
            border: none;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .segment-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }

        .segment-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .segment-btn.buy.active {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .segment-btn.sell.active {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .segment-btn.won.active {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .segment-btn.lost.active {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .segment-btn svg {
            flex-shrink: 0;
        }

        .filter-select-modern {
            appearance: none;
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 32px 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .filter-select-modern:hover {
            border-color: var(--border-primary);
            color: var(--text-primary);
        }

        .filter-select-modern:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .period-indicator {
            font-size: 14px;
            font-weight: 500;
            color: var(--accent-primary);
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .filters-modern {
                gap: 16px;
            }
            
            .filter-group {
                flex: 1 1 45%;
                min-width: 140px;
            }
            
            .segment-control {
                flex-wrap: wrap;
            }
            
            .segment-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        .price-widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .price-widget-left {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .price-widget-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .price-widget-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-widget-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .price-widget-change {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .price-widget-change.positive {
            color: var(--status-online);
            background: var(--status-online-bg);
        }

        .price-widget-change.negative {
            color: var(--status-error);
            background: var(--status-error-bg);
        }

        .price-sparkline-wrap {
            width: 100%;
            height: 50px;
        }

        /* Trading Signals Header with Limit Filter */
        .signals-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 12px;
        }

        .signals-header .card-title {
            margin-bottom: 0;
        }

        .signals-header .filter-pill select {
            padding: 8px 28px 8px 12px;
            font-size: 12px;
        }

        .filter-group {
            flex: 1;
            min-width: 140px;
        }

        /* Template Manager Styles */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-primary);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .row {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .template-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-primary);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-primary);
        }

        .section-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        @media (max-width: 968px) {
            .section-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-frame {
            position: relative;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-frame.square {
            aspect-ratio: 1 / 1;
            max-width: 400px;
        }

        .preview-frame.story {
            aspect-ratio: 9 / 16;
            max-width: 300px;
        }

        .preview-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 13px;
            color: #a0aec0;
            text-align: center;
            pointer-events: none;
            z-index: 1;
        }

        .preview-frame canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }

        .color-picker-group {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .color-picker-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .color-swatches {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .color-swatches > div {
            text-align: center;
        }

        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .color-swatch.red {
            background: #FF273E;
        }

        .color-swatch.white {
            background: #FFFFFF;
            border: 2px solid #e2e8f0;
        }

        .color-swatch-label {
            font-size: 11px;
            color: #718096;
            margin-top: 6px;
            font-weight: 600;
        }

        .nudge-controls {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .nudge-controls-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-align: center;
        }

        .nudge-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
        }

        .nudge-btn {
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .nudge-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .nudge-btn.nudge-up {
            grid-column: 2;
        }

        .nudge-btn.nudge-left {
            grid-column: 1;
            grid-row: 2;
        }

        .nudge-btn.nudge-right {
            grid-column: 3;
            grid-row: 2;
        }

        .nudge-btn.nudge-down {
            grid-column: 2;
            grid-row: 3;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        /* Assets List Styles */
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .delete-selected-btn {
            padding: 10px 20px;
            background: var(--status-error);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            transition: all 0.2s;
        }

        .asset-item:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .asset-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .asset-item-info {
            flex: 1;
        }

        .asset-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .asset-slug {
            font-size: 13px;
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
        }

        .telegram-toggle-container {
            display: flex;
            align-items: center;
        }

        .telegram-toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        .telegram-toggle-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .telegram-toggle-slider {
            width: 48px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }

        .telegram-toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .telegram-toggle-checkbox:checked + .telegram-toggle-slider {
            background: #10b981;
        }

        .telegram-toggle-checkbox:checked + .telegram-toggle-slider::before {
            transform: translateX(24px);
        }

        .telegram-toggle-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .asset-edit-icon,
        .asset-delete-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .asset-edit-icon {
            background: var(--bg-secondary);
            color: var(--accent-primary);
        }

        .asset-edit-icon:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
        }

        .asset-delete-icon {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .asset-delete-icon:hover {
            background: var(--status-error);
            color: white;
            transform: scale(1.1);
        }

        /* Modal Icon */
        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Analytics Filter Buttons */
        .analytics-filter-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
        }

        .analytics-filter-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .analytics-filter-btn.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
        }

        /* Table Container */
        .table-container {
            overflow-x: auto;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Metrics Period Header & Pills */
        .metrics-period-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .metrics-period-label {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-pills {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .period-pill {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #a0aec0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-pill:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.3);
        }

        .period-pill.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Table Filter Bar - subtle in-table filters */
        .table-filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
        }

        .table-filter-label {
            font-size: 12px;
            color: #718096;
            margin-right: 4px;
        }

        .table-filter-btn {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 500;
            color: #718096;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .table-filter-btn:hover {
            color: #a0aec0;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .table-filter-btn.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        /* Subscription Detail Modal - Dark Theme */
        .subscription-detail-modal {
            background: #1a1d29;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .detail-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .detail-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #a0aec0;
        }

        .detail-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .detail-modal-body {
            padding: 24px 28px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 13px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            min-width: 140px;
        }

        .detail-value {
            font-size: 14px;
            color: #e2e8f0;
            text-align: right;
            word-break: break-word;
            flex: 1;
            margin-left: 16px;
        }

        .detail-value a {
            color: #667eea;
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .subscription-detail-modal .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .subscription-detail-modal::-webkit-scrollbar {
            width: 8px;
        }

        .subscription-detail-modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .subscription-detail-modal::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        .subscription-detail-modal::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Billing Section Styles */
        .billing-divider {
            margin: 20px 0;
            padding-top: 20px;
            border-top: 2px solid rgba(102, 126, 234, 0.3);
        }

        .billing-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-section-title::before {
            content: '';
        }

        .billing-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #a0aec0;
            font-size: 14px;
            gap: 12px;
        }

        .billing-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: billing-spin 0.8s linear infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: billing-spin 0.8s linear infinite;
            vertical-align: middle;
        }

        @keyframes billing-spin {
            to { transform: rotate(360deg); }
        }

        .billing-error {
            padding: 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #f87171;
            font-size: 13px;
            text-align: center;
        }

        .billing-na {
            padding: 16px;
            background: rgba(107, 114, 128, 0.1);
            border: 1px solid rgba(107, 114, 128, 0.3);
            border-radius: 8px;
            color: #9ca3af;
            font-size: 13px;
            text-align: center;
        }

        /* Stripe Status Badges */
        .stripe-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stripe-status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .stripe-status-past_due {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .stripe-status-canceled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stripe-status-unpaid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stripe-status-trialing {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .stripe-status-incomplete {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .stripe-status-incomplete_expired {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .stripe-status-paused {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .cancel-warning {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 146, 60, 0.3);
            border-radius: 6px;
            color: #fb923c;
            font-size: 12px;
            font-weight: 500;
        }

        .connections-header { margin-bottom: 24px; }
        .connections-header h2 { margin: 0 0 8px 0; }
        .connections-description { color: var(--text-secondary); margin: 0; }

        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .connection-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 24px;
        }

        .connection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .connection-header h3 { margin: 0; }

        .connection-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            background: var(--status-offline-bg);
            color: var(--status-offline);
        }

        .connection-badge.connected {
            background: var(--status-online-bg);
            color: var(--status-online);
        }

        .connection-badge.error {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .token-status {
            font-size: 13px;
            margin-top: 8px;
            margin-bottom: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            background: var(--status-online-bg);
            color: var(--status-online);
            display: none;
        }

        .token-status.visible {
            display: block;
        }

        .channel-id-optional {
            display: none;
        }

        .channel-id-optional.visible {
            display: block;
        }

        .optional-label {
            font-weight: 400;
            color: var(--text-muted);
            font-size: 12px;
            margin-left: 4px;
        }

        .connection-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .connection-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .token-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .token-input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .btn-toggle-visibility {
            padding: 10px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-card);
            cursor: pointer;
            color: var(--text-primary);
        }

        .connection-info {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-row:last-child { margin-bottom: 0; }

        .info-row strong, .info-row code {
            color: var(--text-primary);
        }

        .info-row code {
            font-size: 11px;
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .connection-error {
            background: var(--status-error-bg);
            color: var(--status-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .connection-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .connection-actions button {
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-validate {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary) !important;
        }

        .btn-save {
            background: var(--accent-primary);
            color: white;
        }

        .btn-delete {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

    </style>
</head>
<body>
    <!-- Login Page (hidden initially to prevent flash) -->
    <div class="login-page hidden" id="loginPage">
        <div class="login-logo">
            <img src="/assets/promostack-logo.png" alt="PromoStack" />
        </div>
        <div class="login-card">
            <h1 class="login-title"> Admin Login</h1>
            <div id="loginAlert"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 12px;">Login</button>
                <a href="https://dash.promostack.io" class="btn btn-secondary" style="width: 100%; display: block; text-align: center; text-decoration: none;">Visit Frontend</a>
            </form>
        </div>
    </div>

    <!-- Access Denied Page -->
    <div class="login-page hidden" id="accessDeniedPage">
        <div class="login-logo">
            <img src="/assets/promostack-logo.png" alt="PromoStack" />
        </div>
        <div class="login-card" style="text-align: center;">
            <h1 class="login-title" style="color: #ef4444;"> Access Denied</h1>
            <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">
                Your account does not have admin access to this dashboard.
            </p>
            <p id="accessDeniedEmail" style="color: var(--text-muted); margin-bottom: 24px; font-size: 13px;"></p>
            <a href="https://dash.promostack.io" class="btn" style="width: 100%; display: block; text-align: center; text-decoration: none; margin-bottom: 12px;">Go to Frontend</a>
            <button onclick="handleAccessDeniedLogout()" class="btn btn-secondary" style="width: 100%;">Sign Out</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="app-container hidden" id="dashboard">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

        <!-- Product Switcher Sidebar (60px) -->
        <aside class="product-switcher" id="productSwitcher">
            <div class="product-icon active" data-tooltip="Forex Signals Bot" onclick="switchProduct('forex')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                </svg>
            </div>
            <div class="product-icon" data-tooltip="Coupon Bot" onclick="switchProduct('coupon')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
                </svg>
            </div>
            <div class="product-icon" data-tooltip="Tenants" onclick="switchProduct('tenants')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                </svg>
            </div>
        </aside>

        <!-- Feature Sidebar (240px) -->
        <aside class="feature-sidebar" id="featureSidebar">
            <div class="feature-sidebar-header">
                <div class="breadcrumb">Dashboard</div>
                <div class="product-name" id="productName">Forex Signals Bot</div>
            </div>

            <nav class="feature-nav" id="featureNav">
                <!-- Navigation will be populated by JavaScript -->
            </nav>

            <div class="sidebar-footer">
                <div id="authContainer" class="auth-container">
                    <a id="signin-link" href="/login" class="signin-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <polyline points="10 17 15 12 10 7"/>
                            <line x1="15" y1="12" x2="3" y2="12"/>
                        </svg>
                        <span>Sign In</span>
                    </a>
                    <div id="user-chip-container" style="display: none;">
                        <div id="user-chip" class="user-chip" onclick="toggleUserDropdown()">
                            <div id="user-chip-avatar" class="user-chip-avatar">?</div>
                            <div class="user-chip-info">
                                <div id="user-chip-email" class="user-chip-email">Loading...</div>
                            </div>
                            <svg class="user-chip-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div id="user-dropdown" class="user-dropdown">
                            <button class="user-dropdown-item logout-item" onclick="handleLogout()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                    <polyline points="16 17 21 12 16 7"/>
                                    <line x1="21" y1="12" x2="9" y2="12"/>
                                </svg>
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mobile Product Switcher (visible only on mobile) -->
            <div class="mobile-product-switcher" id="mobileProductSwitcher">
                <button class="mobile-product-btn active" data-product="forex" onclick="switchProduct('forex')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    Signals
                </button>
                <button class="mobile-product-btn" data-product="coupon" onclick="switchProduct('coupon')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
                    </svg>
                    Coupon
                </button>
                <button class="mobile-product-btn" data-product="tenants" onclick="switchProduct('tenants')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                    </svg>
                    Tenants
                </button>
            </div>

            <!-- Coupon Bot Views -->
            <div id="coupon-templates" class="view-container active">
                <div class="content-header">
                    <h1>Template Manager</h1>
                    <p>Upload and manage your promotional templates with drag-to-draw coupon positioning</p>
                </div>

                <div class="content-body">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('upload')">Upload Template</button>
                        <button class="tab" onclick="switchTab('assets')">Current Assets</button>
                    </div>

                    <!-- Upload Tab -->
                    <div id="uploadTab" class="tab-content active">
                        <div id="uploadAlert"></div>

                        <form id="templateForm" onsubmit="handleUpload(event)">
                            <div class="card">
                                <div class="form-group">
                                    <label for="name">Template Name *</label>
                                    <input type="text" id="name" required placeholder="e.g., Flash Sale">
                                    <div class="hint">This will appear in the dropdown</div>
                                </div>

                                <div class="form-group" style="display: none;">
                                    <label for="slug">Slug *</label>
                                    <input type="text" id="slug" required pattern="[a-z0-9-]+" placeholder="e.g., flash-sale">
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Square Image (1:1)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="squareImage">Square PNG (optional)</label>
                                            <input type="file" id="squareImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="squareLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="squareHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="squareMaxFontPx">Font Size</label>
                                            <input type="range" id="squareMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="squareMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="squareShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('square', 'up')"></button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('square', 'left')"></button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('square', 'right')"></button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('square', 'down')"></button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="square" onclick="selectColor('#FF273E', 'square')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="square" onclick="selectColor('#FFFFFF', 'square')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame square">
                                            <div class="preview-hint"> Click and draw coupon area</div>
                                            <canvas id="previewSquare"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Story Image (9:16)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="storyImage">Portrait PNG (optional)</label>
                                            <input type="file" id="storyImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="storyLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="storyHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="storyMaxFontPx">Font Size</label>
                                            <input type="range" id="storyMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="storyMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="storyShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('story', 'up')"></button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('story', 'left')"></button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('story', 'right')"></button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('story', 'down')"></button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="story" onclick="selectColor('#FF273E', 'story')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="story" onclick="selectColor('#FFFFFF', 'story')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame story">
                                            <div class="preview-hint"> Click and draw coupon area</div>
                                            <canvas id="previewStory"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="squareFontColor" value="#FF273E">
                            <input type="hidden" id="storyFontColor" value="#FF273E">
                            <input type="hidden" id="isEditing" value="false">

                            <div style="display: flex; gap: 12px;">
                                <button type="button" class="btn btn-secondary" onclick="clearTemplateForm()">New Template</button>
                                <button type="submit" class="btn" id="submitBtn">Upload Template</button>
                            </div>
                        </form>
                    </div>

                    <!-- Assets Tab -->
                    <div id="assetsTab" class="tab-content">
                        <div class="assets-header">
                            <label class="select-all-container">
                                <input type="checkbox" id="selectAllTemplates" onchange="toggleSelectAll()">
                                <span>Select All</span>
                            </label>
                            <button type="button" class="delete-selected-btn" onclick="deleteSelectedTemplates()">Delete Selected</button>
                        </div>
                        <div id="assetsList" class="assets-list">
                            <p style="color: #718096; text-align: center;">Loading templates...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-analytics" class="view-container">
                <div class="content-header">
                    <h1> Bot Analytics</h1>
                    <p>Track your Telegram bot usage and performance</p>
                </div>

                <div class="content-body">
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="analytics-filter-btn" data-days="today" onclick="changeAnalyticsPeriod('today')">Today</button>
                            <button class="analytics-filter-btn" data-days="yesterday" onclick="changeAnalyticsPeriod('yesterday')">Yesterday</button>
                            <button class="analytics-filter-btn active" data-days="7" onclick="changeAnalyticsPeriod(7)">Last 7 Days</button>
                            <button class="analytics-filter-btn" data-days="30" onclick="changeAnalyticsPeriod(30)">Last 30 Days</button>
                            <button class="analytics-filter-btn" data-days="90" onclick="changeAnalyticsPeriod(90)">Last 90 Days</button>
                        </div>
                    </div>

                    <div id="analytics-content">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            Loading statistics...
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-broadcast" class="view-container">
                <div class="content-header">
                    <h1> Broadcast Messages</h1>
                    <p>Send announcements to all active Telegram bot users</p>
                </div>

                <div class="content-body">
                    <!-- Active Users Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Active Users</div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="activeUsersCount">
                                <div class="spinner"></div>
                            </div>
                            <div style="color: #718096; margin-top: 8px;">users active in the last 30 days</div>
                        </div>
                    </div>

                    <!-- Broadcast Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Send Broadcast</div>
                        <div id="broadcastAlert"></div>
                        
                        <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                            <div class="form-group">
                                <label for="broadcastMessage">Message</label>
                                <textarea 
                                    id="broadcastMessage" 
                                    rows="6" 
                                    required 
                                    placeholder=" New templates available! Use /generate to create promotional images with your saved coupon code."
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                                <div class="hint">Supports Markdown formatting (*bold*, _italic_, `code`)</div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="previewBroadcast()">Preview</button>
                                <button type="submit" class="btn">
                                    <span id="broadcastBtnText">Send Broadcast</span>
                                    <span id="broadcastBtnSpinner" class="spinner" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Broadcast History -->
                    <div class="card">
                        <div class="card-title">Broadcast History</div>
                        <div id="broadcastHistory">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading broadcast history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-campaigns" class="view-container">
                <div class="content-header">
                    <h1> Campaigns</h1>
                    <p>Create and manage promotional campaigns with user submissions</p>
                </div>

                <div class="content-body">
                    <!-- Campaign Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" id="campaignFormTitle">Create Campaign</div>
                        <div id="campaignAlert"></div>
                        
                        <form id="campaignForm" onsubmit="handleCampaignSubmit(event)">
                            <div class="form-group">
                                <label for="campaignTitle">Campaign Title *</label>
                                <input type="text" id="campaignTitle" required placeholder="e.g., Summer Sale 2024">
                            </div>

                            <div class="form-group">
                                <label for="campaignDescription">Description *</label>
                                <textarea 
                                    id="campaignDescription" 
                                    rows="3" 
                                    required 
                                    placeholder="Brief description of the campaign"
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="campaignStartDate">Start Date *</label>
                                    <input type="date" id="campaignStartDate" required>
                                </div>

                                <div class="form-group">
                                    <label for="campaignEndDate">End Date *</label>
                                    <input type="date" id="campaignEndDate" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="campaignOverlay">Overlay Image (Optional)</label>
                                <input type="file" id="campaignOverlay" accept="image/*" onchange="handleOverlayPreview(event)">
                                <div class="hint">Upload an image to overlay on generated coupons</div>
                            </div>

                            <div id="overlayPreview" style="display: none; margin-top: 12px;">
                                <div style="position: relative; display: inline-block;">
                                    <img id="overlayPreviewImg" style="max-width: 200px; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    <button type="button" onclick="clearOverlay()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                </div>
                            </div>

                            <input type="hidden" id="campaignEditId" value="">
                            <input type="hidden" id="existingOverlayUrl" value="">

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="clearCampaignForm()">Reset</button>
                                <button type="submit" class="btn" id="campaignSubmitBtn">Create Campaign</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Campaigns -->
                    <div class="card">
                        <div class="card-title">Active Campaigns</div>
                        <div id="campaignsList">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading campaigns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-settings" class="view-container">
                <div class="content-header">
                    <h1>Settings</h1>
                    <p>Configure Coupon Bot settings</p>
                </div>
                <div class="content-body">
                    <div class="placeholder-view">
                        <h2> Settings Coming Soon</h2>
                        <p>Settings configuration will be available soon</p>
                    </div>
                </div>
            </div>

            <!-- Forex Bot Views -->
            <div id="forex-subscriptions" class="view-container">
                <div class="content-header">
                    <h1>Telegram Subscriptions</h1>
                    <p>Manage EntryLab subscriber access to private channel</p>
                </div>
                <div class="content-body">
                    <!-- Telegram Signal Channel -->
                    <div class="channels-row">
                        <div class="channel-item" id="signalChannelItem">
                            <svg class="tg-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                            <span class="channel-name" id="signalChannelName">Signal Channel</span>
                            <span class="member-count" id="signalChannelMemberCount">(<span id="signalChannelCount">--</span> members)</span>
                        </div>
                    </div>

                    <!-- Search + Period Filters Row -->
                    <div class="controls" style="margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 280px;">
                            <input type="text" id="subscriptionSearchInput" placeholder="Search by email, name, or Stripe ID..." style="width: 100%;" oninput="searchSubscriptions(this.value)">
                        </div>
                        <div class="period-pills">
                            <button class="period-pill active" data-period="all" onclick="setMetricsPeriod('all')">All Time</button>
                            <button class="period-pill" data-period="30d" onclick="setMetricsPeriod('30d')">30d</button>
                            <button class="period-pill" data-period="7d" onclick="setMetricsPeriod('7d')">7d</button>
                            <button class="period-pill" data-period="yesterday" onclick="setMetricsPeriod('yesterday')">Yesterday</button>
                            <button class="period-pill" data-period="today" onclick="setMetricsPeriod('today')">Today</button>
                        </div>
                    </div>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(79, 70, 229, 0.15); color: #6366f1;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Paid Subscribers</div>
                                <div class="stat-value" id="paidSubscribers">--</div>
                                <div class="stat-subtext">Active VIP members</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Active</div>
                                <div class="stat-value" id="activeSubscribers">--</div>
                                <div class="stat-subtext">Joined channel</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label" id="churnRateLabel">Churn Rate</div>
                                <div class="stat-value" id="churnRate">--%</div>
                                <div class="stat-subtext" id="churnRateSubtext">All time</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Net Revenue</div>
                                <div class="stat-value" id="netRevenue">$--</div>
                                <div class="stat-subtext" id="netRevenueSubtext">All time (net)</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Upcoming Rebill</div>
                                <div class="stat-value" id="monthlyRebill">$--</div>
                                <div class="stat-subtext">All upcoming</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <!-- Table Status Filters -->
                        <div class="table-filter-bar">
                            <span class="table-filter-label">Show:</span>
                            <button class="table-filter-btn active" data-status="all" onclick="filterSubscriptions('all')">All</button>
                            <button class="table-filter-btn" data-status="active" onclick="filterSubscriptions('active')">Active</button>
                            <button class="table-filter-btn" data-status="revoked" onclick="filterSubscriptions('revoked')">Revoked</button>
                        </div>
                        <div id="subscriptionsContent">
                            <div class="loading">Loading subscriptions...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forex-conversions" class="view-container">
                <div class="content-header">
                    <h1>Conversion Analytics</h1>
                    <p>Track free-to-VIP conversions and marketing attribution</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.15); color: #3b82f6;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Free Leads</div>
                                <div class="stat-value" id="totalFreeLeads">--</div>
                                <div class="stat-subtext">Free signups</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Conversions</div>
                                <div class="stat-value" id="totalConversions">--</div>
                                <div class="stat-subtext">Upgraded to VIP</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(79, 70, 229, 0.15); color: #6366f1;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Conversion Rate</div>
                                <div class="stat-value" id="conversionRate">--%</div>
                                <div class="stat-subtext">Free to VIP</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Avg Days to Convert</div>
                                <div class="stat-value" id="avgConversionDays">--</div>
                                <div class="stat-subtext">Free to paid</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Conversion Revenue</div>
                                <div class="stat-value" id="conversionRevenue">$--</div>
                                <div class="stat-subtext">From converted users</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Leads by Source</div>
                        <div id="leadsBySource" style="padding: 20px;">
                            <div class="loading">Loading lead attribution...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Sales by Source</div>
                        <div id="salesBySource" style="padding: 20px;">
                            <div class="loading">Loading sales data...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Best Converting Sources</div>
                        <div id="bestConvertingSources" style="padding: 20px;">
                            <div class="loading">Loading conversion data...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Recent Conversions</div>
                        <div id="recentConversions" style="padding: 20px;">
                            <div class="loading">Loading conversions...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-title">All Leads</div>
                        <div id="allLeadsTable" style="padding: 20px; overflow-x: auto;">
                            <div class="loading">Loading leads...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forex-signals" class="view-container">
                <div class="content-header">
                    <h1>Forex Signals Monitor</h1>
                    <p>XAU/USD trading signals with live performance metrics</p>
                </div>
                <div class="content-body">
                    <div id="activeSignalBanner" class="active-signal-banner" style="display: none; background: linear-gradient(135deg, #1a1f2e 0%, #252b3d 100%); border: 1px solid #3d4663; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="active-signal-glow" style="position: relative;">
                                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse-glow 2s infinite;"></div>
                                <style>
                                    @keyframes pulse-glow {
                                        0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                                        50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
                                    }
                                </style>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="color: #10b981; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">ACTIVE SIGNAL</span>
                                    <span id="activeSignalId" style="color: #667eea; font-size: 12px;"></span>
                                </div>
                                <div id="activeSignalDetails" style="color: #e2e8f0; font-size: 15px; font-weight: 500;">Loading...</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="color: #a0aec0; font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Live Price</div>
                                    <div id="activeSignalPrice" style="color: #667eea; font-size: 16px; font-weight: 600;">--</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #a0aec0; font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">P/L</div>
                                    <div id="activeSignalPnL" style="font-size: 16px; font-weight: 600;">--</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #a0aec0; font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">TPs</div>
                                    <div id="activeSignalTPs" style="font-size: 14px;">--</div>
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 100px;">
                                <div id="activeSignalTime" style="color: #a0aec0; font-size: 13px;"></div>
                                <div id="activeSignalBreakeven" style="font-size: 12px; margin-top: 2px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon win-rate">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Win Rate</div>
                                <div class="stat-value" id="winRate">--%</div>
                                <div class="stat-subtext" id="winRateSubtext">Loading...</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon total-pips" id="totalPipsIcon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Pips</div>
                                <div class="stat-value" id="totalPips">--</div>
                                <div class="stat-subtext">Net profit/loss</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon total-signals">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Signals</div>
                                <div class="stat-value" id="totalSignals">--</div>
                                <div class="stat-subtext" id="signalsBreakdown">Loading...</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon active-bot">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Active Bot</div>
                                <div class="stat-value" id="activeBotType" style="text-transform: capitalize;">--</div>
                                <div class="stat-subtext" id="activeBotSubtext">Strategy mode</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-metrics-layout">
                        <div class="chart-card-large">
                            <div class="chart-header">
                                <span class="chart-title">XAU/USD Live Chart</span>
                            </div>
                            <!-- TradingView Widget BEGIN -->
                            <div class="tradingview-widget-container" style="height:100%;width:100%">
                              <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                              <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/XAUUSD/?exchange=OANDA" rel="noopener nofollow" target="_blank"><span class="blue-text">XAUUSD chart</span></a><span class="trademark"> by TradingView</span></div>
                              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                              {
                              "allow_symbol_change": true,
                              "calendar": false,
                              "details": false,
                              "hide_side_toolbar": true,
                              "hide_top_toolbar": true,
                              "hide_legend": false,
                              "hide_volume": true,
                              "hotlist": false,
                              "interval": "15",
                              "locale": "en",
                              "save_image": true,
                              "style": "1",
                              "symbol": "OANDA:XAUUSD",
                              "theme": "dark",
                              "timezone": "Etc/UTC",
                              "backgroundColor": "#0F0F0F",
                              "gridColor": "rgba(66, 189, 168, 0.06)",
                              "watchlist": [],
                              "withdateranges": false,
                              "compareSymbols": [],
                              "studies": [],
                              "autosize": true
                              }
                              </script>
                            </div>
                            <!-- TradingView Widget END -->
                        </div>
                        <div class="metrics-stack-vertical">
                            <div class="metric-card-stacked">
                                <div class="metric-header">
                                    <div class="metric-icon ratio">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                                        </svg>
                                    </div>
                                    <div class="metric-label">Buy / Sell Ratio</div>
                                </div>
                                <div class="metric-main">
                                    <span class="value buy" id="buyCount">0</span>
                                    <span class="separator">:</span>
                                    <span class="value sell" id="sellCount">0</span>
                                    <span class="label">buys vs sells</span>
                                </div>
                                <div class="split-bar" id="buySellBar">
                                    <div class="bar-segment buy" id="buyBarSegment" style="width: 50%"></div>
                                    <div class="bar-segment sell" id="sellBarSegment" style="width: 50%"></div>
                                </div>
                            </div>
                            <div class="metric-card-stacked">
                                <div class="metric-header">
                                    <div class="metric-icon time">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="metric-label">Avg Hold Time</div>
                                </div>
                                <div class="metric-main">
                                    <span class="value" id="avgHoldTime">--</span>
                                    <span class="label" id="avgHoldSubtext">per signal</span>
                                </div>
                                <div class="split-bar">
                                    <div class="bar-segment primary" id="holdTimeBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="metric-card-stacked">
                                <div class="metric-header">
                                    <div class="metric-icon calendar">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                        </svg>
                                    </div>
                                    <div class="metric-label">Signals by Day</div>
                                </div>
                                <div class="metric-main">
                                    <span class="value" id="totalSignalsDays">0</span>
                                    <span class="label">this week</span>
                                </div>
                                <div class="day-bars" id="dayBarsContainer">
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">M</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">T</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">W</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">T</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">F</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">S</span></div>
                                    <div class="day-bar"><div class="bar" style="height: 4px"></div><span class="day-label">S</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="signals-header">
                            <h2 class="card-title">Trading Signals <span id="periodIndicator" class="period-indicator"></span></h2>
                            <div class="filter-pill">
                                <select id="filterLimit">
                                    <option value="50">Last 50</option>
                                    <option value="100" selected>Last 100</option>
                                    <option value="200">Last 200</option>
                                </select>
                            </div>
                        </div>
                        <div class="filters-modern">
                            <div class="filter-group">
                                <div class="filter-label">Period</div>
                                <div class="segment-control" id="dateRangeSegment">
                                    <button class="segment-btn active" data-value="all">All</button>
                                    <button class="segment-btn" data-value="today">Today</button>
                                    <button class="segment-btn" data-value="7days">7D</button>
                                    <button class="segment-btn" data-value="30days">30D</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <div class="filter-label">Direction</div>
                                <div class="segment-control" id="typeSegment">
                                    <button class="segment-btn active" data-value="all">All</button>
                                    <button class="segment-btn buy" data-value="BUY">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                                        Buy
                                    </button>
                                    <button class="segment-btn sell" data-value="SELL">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                                        Sell
                                    </button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <div class="filter-label">Status</div>
                                <div class="segment-control" id="statusSegment">
                                    <button class="segment-btn active" data-value="all">All</button>
                                    <button class="segment-btn won" data-value="won">Won</button>
                                    <button class="segment-btn lost" data-value="lost">Lost</button>
                                    <button class="segment-btn" data-value="pending">Open</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <div class="filter-label">Strategy</div>
                                <select id="filterBotType" class="filter-select-modern">
                                    <option value="all">All Strategies</option>
                                    <option value="aggressive">Aggressive</option>
                                    <option value="conservative">Conservative</option>
                                    <option value="raja_banks">Raja Banks</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="filterDateRange" value="all">
                        <input type="hidden" id="filterType" value="all">
                        <input type="hidden" id="filterStatus" value="all">
                        <div id="signalsTableContent">
                            <div class="loading">Loading signals...</div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="forex-settings" class="view-container">
                <div class="content-header">
                    <h1>Bot Settings</h1>
                    <p>Configure your trading strategy and risk management</p>
                </div>
                <div class="content-body">
                    <div id="botSwitchError" class="alert alert-error" style="display: none;"></div>
                    <div id="botSwitchSuccess" class="alert alert-success" style="display: none;"></div>
                    <div id="guardrailError" class="alert alert-error" style="display: none;"></div>
                    <div id="guardrailSuccess" class="alert alert-success" style="display: none;"></div>
                    
                    <div class="settings-layout">
                        <div class="settings-main">
                            <div class="settings-section">
                                <div class="settings-section-title">Strategy Selection</div>
                                <div class="strategy-cards">
                                    <div class="strategy-card" data-bot="aggressive" onclick="selectBot('aggressive')">
                                        <div class="strategy-icon aggressive">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Aggressive</div>
                                        <div class="strategy-desc">High frequency with momentum-based entries</div>
                                    </div>
                                    
                                    <div class="strategy-card" data-bot="conservative" onclick="selectBot('conservative')">
                                        <div class="strategy-icon conservative">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Conservative</div>
                                        <div class="strategy-desc">Confirmed trends with multi-indicator alignment</div>
                                    </div>
                                    
                                    <div class="strategy-card" data-bot="raja_banks" onclick="selectBot('raja_banks')">
                                        <div class="strategy-icon raja-banks">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Raja Banks</div>
                                        <div class="strategy-desc">Session-based 15-min impulse breakouts</div>
                                    </div>
                                    
                                    <div class="strategy-card" data-bot="custom" onclick="selectBot('custom')">
                                        <div class="strategy-icon custom">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Custom</div>
                                        <div class="strategy-desc">Configurable thresholds you control</div>
                                    </div>
                                </div>
                                <button id="switchBotBtn" class="btn-primary" onclick="switchActiveBot()" disabled style="margin-top: 16px;">
                                    <span id="switchBotBtnText">Select a strategy to switch</span>
                                </button>
                                <button id="cancelQueueBtn" class="btn-secondary" onclick="cancelQueuedBot()" style="margin-top: 8px; display: none;">
                                    Cancel Queued Switch
                                </button>
                                <div id="queuedBotStatus" style="margin-top: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3); display: none;">
                                    <span style="color: #667eea;"></span> <span id="queuedBotText"></span>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-title">Take Profit Configuration</div>
                                <div class="tp-config-card">
                                    <div class="tp-header">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                                            </svg>
                                            TP Levels
                                        </h3>
                                        <div class="tp-count-selector">
                                            <button class="tp-count-btn" data-count="1" onclick="setTpCount(1)">1</button>
                                            <button class="tp-count-btn" data-count="2" onclick="setTpCount(2)">2</button>
                                            <button class="tp-count-btn active" data-count="3" onclick="setTpCount(3)">3</button>
                                        </div>
                                    </div>
                                    
                                    <div class="tp-levels">
                                        <div class="tp-level" id="tpLevel1">
                                            <div class="tp-level-badge tp1">TP1</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">First Target</div>
                                                <div class="tp-level-desc">Quick profit lock-in</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp1Pct" value="50" min="10" max="100" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tp-level" id="tpLevel2">
                                            <div class="tp-level-badge tp2">TP2</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">Second Target</div>
                                                <div class="tp-level-desc">Extended move capture</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp2Pct" value="30" min="0" max="90" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tp-level" id="tpLevel3">
                                            <div class="tp-level-badge tp3">TP3</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">Final Target</div>
                                                <div class="tp-level-desc">Maximum profit zone</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp3Pct" value="20" min="0" max="80" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="tp-total">
                                        <span class="tp-total-label">Total Position</span>
                                        <span class="tp-total-value valid" id="tpTotalValue">100%</span>
                                    </div>
                                    
                                    <button class="btn-primary" onclick="saveTpConfig()" style="margin-top: 16px;">
                                        Save TP Configuration
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-title">Risk Management</div>
                                <div class="settings-card-modern">
                                    <div class="guardrails-grid">
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                                </svg>
                                                Daily Loss Cap
                                            </label>
                                            <input type="number" class="guardrail-input" id="dailyLossCap" min="10" max="200" step="5" placeholder="...">
                                            <div class="guardrail-hint">Stop signals after losing this many pips</div>
                                        </div>
                                        
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Loss Throttle
                                            </label>
                                            <input type="number" class="guardrail-input" id="backToBackThrottle" min="5" max="120" step="5" placeholder="...">
                                            <div class="guardrail-hint">Minutes to wait after a loss</div>
                                        </div>
                                        
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                                </svg>
                                                Session Hours (UTC)
                                            </label>
                                            <div class="session-hours-row">
                                                <input type="number" class="guardrail-input" id="sessionStartHour" min="0" max="23" placeholder="...">
                                                <span>to</span>
                                                <input type="number" class="guardrail-input" id="sessionEndHour" min="0" max="23" placeholder="...">
                                            </div>
                                            <div class="guardrail-hint">Default: 8-21 UTC</div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn-primary" onclick="saveGuardrails()" style="margin-top: 20px;">
                                        Save Risk Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-sidebar">
                            <div class="status-card-modern" style="position: sticky; top: 24px;">
                                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #e2e8f0;">Live Status</h3>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-item-label">Active Bot</div>
                                        <div class="status-item-value" id="settingsActiveBot" style="text-transform: capitalize;">--</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Open Signal</div>
                                        <div class="status-item-value" id="settingsOpenSignal">None</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Live P/L</div>
                                        <div class="status-item-value" id="livePnlDisplay">--</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Daily P/L</div>
                                        <div class="status-item-value" id="dailyPnlDisplay">--</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Session</div>
                                        <div class="status-item-value" id="currentSessionDisplay">--</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <h4 style="font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Signals by Bot</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Aggressive</span>
                                            <span style="font-weight: 600; color: #f56565;" id="aggressiveCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Conservative</span>
                                            <span style="font-weight: 600; color: #48bb78;" id="conservativeCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Custom</span>
                                            <span style="font-weight: 600; color: #667eea;" id="customCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Legacy</span>
                                            <span style="font-weight: 600; color: #a0aec0;" id="legacyCount">--</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                        <span style="color: #94a3b8;">Last Signal</span>
                                        <span style="font-weight: 500; color: #e2e8f0;" id="lastSignalDisplay">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journeys View -->
            <div id="forex-journeys" class="view-container">
                <div class="content-header">
                    <h1>Journeys</h1>
                    <p>Create automated messaging sequences triggered by deep links</p>
                </div>
                <div class="content-body">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="limit-badge" id="journeys-limit-badge">0 / 6</span>
                        </div>
                        <button class="btn" id="create-journey-btn" onclick="window.JourneysModule.openJourneyModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Create Journey
                        </button>
                    </div>

                    <div id="journeys-empty-state" class="journeys-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2M12 11h4M12 16h4M8 11h.01M8 16h.01" />
                        </svg>
                        <h3>No journeys yet</h3>
                        <p>Create your first automated messaging journey to engage users when they join via deep links.</p>
                    </div>

                    <div class="journeys-grid" id="journeys-grid" style="display: none;"></div>
                </div>
            </div>

            <!-- Cross Promo View -->
            <div id="forex-crosspromo" class="view-container">
                <div class="content-header">
                    <h1>Cross Promo Automation</h1>
                    <p>Automatically promote VIP signals in your free channel (Mon-Fri only)</p>
                </div>
                <div class="content-body">
                    <div class="crosspromo-section">
                        <div class="card" style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 16px;">Settings</h3>
                            
                            <div class="form-row" style="margin-bottom: 16px;">
                                <label class="toggle-label">
                                    <input type="checkbox" id="crosspromo-enabled" onchange="saveCrossPromoSettings()">
                                    <span class="toggle-switch"></span>
                                    <span>Enable Cross Promo</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label>Free Channel ID</label>
                                <input type="text" id="crosspromo-free-channel" placeholder="e.g., -1001234567890" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--bg-hover); background: var(--bg-card);">
                                <div class="hint">The channel where promo messages will be posted</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label>VIP Channel ID</label>
                                <input type="text" id="crosspromo-vip-channel" placeholder="e.g., -1001234567891" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--bg-hover); background: var(--bg-card);">
                                <div class="hint">The VIP channel to copy winning signals from</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label>CTA URL</label>
                                <input type="text" id="crosspromo-cta-url" value="https://entrylab.io/subscribe" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--bg-hover); background: var(--bg-card);">
                                <div class="hint">Link shown in congratulations messages</div>
                            </div>
                            
                            <button class="btn" onclick="saveCrossPromoSettings()" style="margin-top: 8px;">Save Settings</button>
                        </div>
                        
                        <div class="card" style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 16px;">Morning Message Preview</h3>
                            <pre id="crosspromo-preview" style="background: var(--bg-hover); padding: 16px; border-radius: 8px; white-space: pre-wrap; font-family: inherit; color: var(--text-primary); border: 1px solid var(--bg-hover);">Loading preview...</pre>
                            <button class="btn" onclick="loadCrossPromoPreview()" style="margin-top: 12px;">Refresh Preview</button>
                        </div>
                        
                        <div class="card" style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 16px;">Actions</h3>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn" onclick="runDailySequence()">Run Today's Sequence</button>
                                <button class="btn btn-secondary" onclick="sendTestMorning()">Send Test Morning Message</button>
                            </div>
                            
                            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--bg-hover);">
                                <h4 style="margin-bottom: 12px;">Publish Winning Promo</h4>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                                    <input type="number" id="crosspromo-signal-id" placeholder="VIP Signal Message ID" style="flex: 1; min-width: 180px; padding: 10px; border-radius: 8px; border: 1px solid var(--bg-hover); background: var(--bg-card);">
                                    <input type="number" id="crosspromo-win-id" placeholder="VIP Win Message ID" style="flex: 1; min-width: 180px; padding: 10px; border-radius: 8px; border: 1px solid var(--bg-hover); background: var(--bg-card);">
                                </div>
                                <button class="btn" onclick="publishWinSequence()">Publish Winning Promo</button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 style="margin-bottom: 16px;">Job History</h3>
                            <div id="crosspromo-jobs-table" style="overflow-x: auto;">
                                <table class="data-table" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Scheduled</th>
                                            <th>Error</th>
                                        </tr>
                                    </thead>
                                    <tbody id="crosspromo-jobs-tbody">
                                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-secondary" onclick="loadCrossPromoJobs()" style="margin-top: 12px;">Refresh Jobs</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connections View -->
            <div id="forex-connections" class="view-container">
                <div class="content-header">
                    <h1>Bot Connections</h1>
                    <p>Configure Telegram bots for signals and messages</p>
                </div>
                <div class="content-body">
                    <div class="connections-header">
                        <h2>Bot Connections</h2>
                        <p class="connections-description">Configure Telegram bots for signals and messages. Each bot needs a unique token.</p>
                    </div>
                    
                    <div class="connections-grid">
                        <!-- Signal Bot Card -->
                        <div class="connection-card" data-role="signal" data-has-token="false">
                            <div class="connection-header">
                                <h3>Signal Bot</h3>
                                <span class="connection-badge" id="signal-status">Not configured </span>
                            </div>
                            <p class="connection-desc">Used for sending forex signals to channels</p>
                            
                            <div class="connection-form">
                                <label>Bot Token</label>
                                <div class="token-input-group">
                                    <input type="password" id="signal-bot-token" placeholder="Enter bot token from @BotFather" />
                                    <button class="btn-toggle-visibility" onclick="toggleTokenVisibility('signal')">
                                        <span class="eye-icon"></span>
                                    </button>
                                </div>
                                <div class="token-status" id="signal-token-status"></div>
                                
                                <label>Channel ID <span style="color: var(--status-error);">*</span></label>
                                <input type="text" id="signal-channel-id" placeholder="Enter Telegram channel ID (e.g., -1001234567890)" />
                                
                                <div class="connection-info" id="signal-info" style="display:none">
                                    <div class="info-row"><span>Bot Username:</span> <strong id="signal-username">-</strong></div>
                                    <div class="info-row"><span>Channel ID:</span> <code id="signal-channel-id-display">-</code></div>
                                    <div class="info-row"><span>Webhook URL:</span> <code id="signal-webhook">-</code></div>
                                    <div class="info-row"><span>Last Updated:</span> <span id="signal-updated">-</span></div>
                                </div>
                                
                                <div class="connection-error" id="signal-error" style="display:none"></div>
                                
                                <div class="connection-actions">
                                    <button class="btn-validate" onclick="validateConnection('signal')">Validate</button>
                                    <button class="btn-validate" onclick="testConnection('signal')">Test Connection</button>
                                    <button class="btn-save" onclick="saveConnection('signal')">Save & Setup Webhook</button>
                                    <button class="btn-delete" onclick="deleteConnection('signal')" style="display:none" id="signal-delete">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Message Bot Card -->
                        <div class="connection-card" data-role="message" data-has-token="false">
                            <div class="connection-header">
                                <h3>Message Bot</h3>
                                <span class="connection-badge" id="message-status">Not configured </span>
                            </div>
                            <p class="connection-desc">Used for Journeys and user messaging</p>
                            
                            <div class="connection-form">
                                <label>Bot Token</label>
                                <div class="token-input-group">
                                    <input type="password" id="message-bot-token" placeholder="Enter bot token from @BotFather" />
                                    <button class="btn-toggle-visibility" onclick="toggleTokenVisibility('message')">
                                        <span class="eye-icon"></span>
                                    </button>
                                </div>
                                <div class="token-status" id="message-token-status"></div>
                                
                                <div class="channel-id-optional" id="message-channel-wrapper">
                                    <label>Channel ID <span class="optional-label">(optional)</span></label>
                                    <input type="text" id="message-channel-id" placeholder="Enter Telegram channel ID (optional)" />
                                </div>
                                
                                <div class="connection-info" id="message-info" style="display:none">
                                    <div class="info-row"><span>Bot Username:</span> <strong id="message-username">-</strong></div>
                                    <div class="info-row"><span>Channel ID:</span> <code id="message-channel-id-display">-</code></div>
                                    <div class="info-row"><span>Webhook URL:</span> <code id="message-webhook">-</code></div>
                                    <div class="info-row"><span>Last Updated:</span> <span id="message-updated">-</span></div>
                                </div>
                                
                                <div class="connection-error" id="message-error" style="display:none"></div>
                                
                                <div class="connection-actions">
                                    <button class="btn-validate" onclick="validateConnection('message')">Validate</button>
                                    <button class="btn-validate" onclick="testConnection('message')">Test Connection</button>
                                    <button class="btn-save" onclick="saveConnection('message')">Save & Setup Webhook</button>
                                    <button class="btn-delete" onclick="deleteConnection('message')" style="display:none" id="message-delete">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenants Management Views -->
            <div id="tenants-list" class="view-container">
                <div class="content-header">
                    <h1>Tenant Management</h1>
                    <p>View and manage all registered tenants</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Tenants</div>
                                <div class="stat-value" id="totalTenantsCount">--</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Onboarding Complete</div>
                                <div class="stat-value" id="onboardingCompleteCount">--</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon yellow">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Pending Onboarding</div>
                                <div class="stat-value" id="onboardingPendingCount">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">All Tenants</div>
                        <div style="overflow-x: auto;">
                            <table id="tenantsTable">
                                <thead>
                                    <tr>
                                        <th>Tenant ID</th>
                                        <th>Display Name</th>
                                        <th>Owner Email</th>
                                        <th>Created</th>
                                        <th>Onboarding</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                            Loading tenants...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="modal-box">
            <div class="modal-title">Subscription Details</div>
            <div id="modalDetails"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('subscriptionModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon"></div>
            <div class="modal-title" id="modalTitle">Delete Template?</div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Subscription Detail Modal (Dark Theme) -->
    <div class="modal-overlay" id="subscriptionDetailModal">
        <div class="subscription-detail-modal">
            <div class="detail-modal-header">
                <h2 class="detail-modal-title">Subscriber Details</h2>
                <button class="detail-modal-close" onclick="closeSubscriptionDetailModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="detail-modal-body" id="subscriptionDetailContent">
            </div>
        </div>
    </div>

    <!-- Custom Confirm/Alert Modal -->
    <div class="custom-modal-overlay" id="customModal">
        <div class="custom-modal">
            <div class="custom-modal-title" id="customModalTitle">Confirm Action</div>
            <div class="custom-modal-message" id="customModalMessage"></div>
            <div class="custom-modal-buttons" id="customModalButtons"></div>
        </div>
    </div>

    <!-- Journey Modal -->
    <div class="modal-backdrop" id="journey-modal-backdrop">
        <div class="journey-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="journey-modal-title">Create Journey</h3>
                <button class="modal-close" onclick="window.JourneysModule.closeJourneyModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Journey Name</label>
                    <input type="text" class="form-input" id="journey-name-input" placeholder="e.g., Welcome Sequence">
                </div>

                <div class="form-group">
                    <label class="form-label">Trigger Type</label>
                    <select class="form-select" id="journey-trigger-type" disabled>
                        <option value="deep_link" selected>Deep Link</option>
                    </select>
                    <div class="form-hint">Journeys are triggered when users start the bot via a deep link.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Trigger Value</label>
                    <input type="text" class="form-input" id="journey-trigger-value" placeholder="e.g., welcome_promo" oninput="window.JourneysModule.updateDeepLinkPreview()">
                    <div class="form-hint">The start parameter value (e.g., t.me/bot?start=<strong>welcome_promo</strong>)</div>
                    <div class="deeplink-preview" id="deeplink-preview" style="display: none;">
                        <div class="deeplink-preview-label">Your Deep Link:</div>
                        <div class="deeplink-preview-url">
                            <code id="deeplink-preview-url"></code>
                            <button class="btn-copy" onclick="window.JourneysModule.copyDeepLinkFromPreview()" title="Copy link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                            <a id="deeplink-preview-test" href="#" target="_blank" class="btn-test" title="Test link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                            </a>
                        </div>
                        <div class="deeplink-preview-warning" id="deeplink-preview-warning" style="display: none;">
                            Configure Message Bot in Connections tab first
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="status-options">
                        <div class="status-option selected" onclick="window.JourneysModule.selectStatus('draft')" data-status="draft">
                            <div class="status-option-label">Draft</div>
                        </div>
                        <div class="status-option" onclick="window.JourneysModule.selectStatus('active')" data-status="active">
                            <div class="status-option-label">Active</div>
                        </div>
                        <div class="status-option" onclick="window.JourneysModule.selectStatus('paused')" data-status="paused">
                            <div class="status-option-label">Paused</div>
                        </div>
                    </div>
                    <div class="active-warning" id="active-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" style="flex-shrink: 0;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                        <span style="margin-left: 8px;">Active journeys will start sending messages to users immediately when they join via the deep link.</span>
                    </div>
                </div>

                <div class="steps-section">
                    <div class="steps-header">
                        <div class="steps-title">Message Steps</div>
                        <button class="btn btn-secondary" onclick="window.JourneysModule.addStep()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="14" height="14">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Add Step
                        </button>
                    </div>
                    <div class="steps-list" id="steps-list">
                        <div class="steps-empty" id="steps-empty">No steps yet. Add your first message step above.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.JourneysModule.closeJourneyModal()">Cancel</button>
                <button class="btn" onclick="window.JourneysModule.saveJourney()">Save Journey</button>
            </div>
        </div>
    </div>

    <!-- Step Modal -->
    <div class="modal-backdrop" id="step-modal-backdrop">
        <div class="journey-modal step-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="step-modal-title">Add Step</h3>
                <button class="modal-close" onclick="window.JourneysModule.closeStepModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" id="step-message-input" placeholder="Enter your message..."></textarea>
                    <div class="form-hint">The message that will be sent to the user. Supports Telegram markdown.</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Wait Time (seconds)</label>
                    <input type="number" class="form-input" id="step-delay-input" value="0" min="0">
                    <div class="form-hint">How long to wait. Use 0 for immediate delivery, or set a delay before sending/checking for reply.</div>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="step-wait-for-reply" onchange="window.JourneysModule.updateStepModalVisibility()" style="width: 18px; height: 18px;">
                        <span>Wait for user response</span>
                    </label>
                    <div class="form-hint">If checked, the journey will wait for the user to respond within the wait time before continuing.</div>
                </div>
                <div class="form-group" id="step-timeout-group" style="display: none;">
                    <label class="form-label">If no response received</label>
                    <select class="form-input" id="step-timeout-action">
                        <option value="continue">Continue to next step</option>
                        <option value="end">End the journey</option>
                    </select>
                    <div class="form-hint">What happens if the user doesn't respond within the wait time.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.JourneysModule.closeStepModal()">Cancel</button>
                <button class="btn" onclick="window.JourneysModule.saveStep()">Save Step</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/journeys.js"></script>
    <script>
        // App State Management
        const appState = {
            activeProduct: 'forex',
            activeView: 'subscriptions',
            isLoggedIn: false,
            isMobileMenuOpen: false
        };
        
        // Loading overlay functions
        function showLoading(message = 'Loading...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
                overlay.innerHTML = `<div style="background:#1e293b;color:#fff;padding:20px 40px;border-radius:8px;font-size:16px;">${message}</div>`;
                document.body.appendChild(overlay);
            }
            overlay.querySelector('div').textContent = message;
            overlay.style.display = 'flex';
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // Product Navigation Structure
        const productNavigation = {
            coupon: [
                { id: 'templates', label: 'Templates', icon: 'M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42' },
                { id: 'analytics', label: 'Analytics', icon: 'M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z' },
                { id: 'broadcast', label: 'Broadcast', icon: 'M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46' },
                { id: 'campaigns', label: 'Campaigns', icon: 'M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0l-5.571 3-5.571-3' },
                { id: 'settings', label: 'Settings', icon: 'M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28ZM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z' }
            ],
            forex: [
                { id: 'subscriptions', label: 'Subscriptions', icon: 'M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z' },
                { id: 'conversions', label: 'Conversions', icon: 'M2.25 18L9 11.25l4.306 4.306a11.95 11.95 0 015.814-5.518l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941' },
                { id: 'signals', label: 'Signals Monitor', icon: 'M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941' },
                { id: 'journeys', label: 'Journeys', icon: 'M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2 M12 11h4 M12 16h4 M8 11h.01 M8 16h.01' },
                { id: 'crosspromo', label: 'Cross Promo', icon: 'M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z' },
                { id: 'connections', label: 'Connections', icon: 'M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244' },
                { id: 'settings', label: 'Settings', icon: 'M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28ZM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z' }
            ],
            tenants: [
                { id: 'list', label: 'All Tenants', icon: 'M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z' }
            ]
        };

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkAuth();
        });

        async function checkAuth() {
            try {
                const headers = await getAuthHeaders();
                
                // Get email from Clerk user object or sessionStorage
                let userEmail = sessionStorage.getItem('clerk_user_email');
                if (window.Clerk && window.Clerk.user) {
                    userEmail = window.Clerk.user.primaryEmailAddress?.emailAddress || 
                                window.Clerk.user.emailAddresses?.[0]?.emailAddress || 
                                userEmail;
                }
                
                // Include email in request for server to use (JWT may not contain it)
                const url = userEmail ? `/api/check-auth?email=${encodeURIComponent(userEmail)}` : '/api/check-auth';
                
                const response = await fetch(url, {
                    headers: headers,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok && data.authenticated) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('accessDeniedPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    appState.isLoggedIn = true;
                    initializeRouting();
                    updateAuthUI(true, data.email, data.avatar);
                } else if (data.email) {
                    showAccessDenied(data.email);
                    updateAuthUI(false, null, null);
                } else {
                    window.location.href = '/login';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error?.message || error);
                window.location.href = '/login';
                return;
            }
        }

        function initializeApp() {
            renderFeatureNav();
            updateAuthUI(false, null, null);
            
            document.addEventListener('click', function(e) {
                const userChip = document.getElementById('user-chip');
                const dropdown = document.getElementById('user-dropdown');
                if (userChip && dropdown && !userChip.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('open');
                    userChip.classList.remove('open');
                }
            });
        }

        function updateAuthUI(isAuthenticated, email, avatarUrl) {
            const signinLink = document.getElementById('signin-link');
            const userChipContainer = document.getElementById('user-chip-container');
            const userChipEmail = document.getElementById('user-chip-email');
            const userChipAvatar = document.getElementById('user-chip-avatar');
            
            if (isAuthenticated) {
                if (signinLink) signinLink.style.display = 'none';
                if (userChipContainer) userChipContainer.style.display = 'block';
                
                // Always update email - use fallback if not provided
                if (userChipEmail) {
                    userChipEmail.textContent = email || 'Admin';
                }
                
                // Always update avatar - use first letter of email or fallback
                if (userChipAvatar) {
                    if (avatarUrl) {
                        userChipAvatar.innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
                    } else if (email) {
                        userChipAvatar.textContent = email.charAt(0).toUpperCase();
                    } else {
                        userChipAvatar.textContent = 'A';
                    }
                }
            } else {
                if (signinLink) signinLink.style.display = 'flex';
                if (userChipContainer) userChipContainer.style.display = 'none';
            }
        }

        function toggleUserDropdown() {
            const userChip = document.getElementById('user-chip');
            const dropdown = document.getElementById('user-dropdown');
            if (userChip && dropdown) {
                userChip.classList.toggle('open');
                dropdown.classList.toggle('open');
            }
        }

        function formatBotName(botType) {
            if (!botType) return '--';
            return botType.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function initializeRouting() {
            // Initialize journeys module
            initJourneys({
                getAuthHeaders: getAuthHeaders,
                showToast: function(msg, type) { showModalAlert(type === 'error' ? 'Error' : 'Success', msg); },
                showLoading: showLoading,
                hideLoading: hideLoading,
                escapeHtml: escapeHtml || function(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; },
                confirmDialog: function(msg) { return confirm(msg); }
            });
            
            // Load route from hash on page load
            loadRouteFromHash();
            
            // Listen for hash changes
            window.addEventListener('hashchange', loadRouteFromHash);
        }

        function loadRouteFromHash() {
            const hash = window.location.hash.substring(1); // Remove #
            if (!hash) {
                navigateTo('forex', 'subscriptions', false);
                return;
            }

            const [product, view] = hash.split('/');
            if (product && view) {
                navigateTo(product, view, false);
            } else {
                navigateTo('forex', 'subscriptions', false);
            }
        }

        function renderFeatureNav() {
            const nav = document.getElementById('featureNav');
            const items = productNavigation[appState.activeProduct];
            
            nav.innerHTML = `
                <div class="nav-section">
                    <div class="nav-section-title">Navigation</div>
                    ${items.map(item => `
                        <a class="nav-item ${item.id === appState.activeView ? 'active' : ''}" onclick="navigateTo('${appState.activeProduct}', '${item.id}')">
                            <span class="nav-item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${item.icon}" />
                                </svg>
                            </span>
                            <span class="nav-item-text">${item.label}</span>
                        </a>
                    `).join('')}
                </div>
            `;
        }

        function switchProduct(product) {
            if (appState.activeProduct === product) return;
            
            appState.activeProduct = product;
            appState.activeView = productNavigation[product][0].id;
            
            // Update desktop product icons
            document.querySelectorAll('.product-icon').forEach(icon => {
                icon.classList.remove('active');
                if (icon.dataset.tooltip?.toLowerCase().includes(product)) {
                    icon.classList.add('active');
                }
            });
            // Also try to activate the clicked icon directly
            if (event && event.target) {
                const clickedIcon = event.target.closest('.product-icon');
                if (clickedIcon) clickedIcon.classList.add('active');
            }
            
            // Update mobile product switcher buttons
            document.querySelectorAll('.mobile-product-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.product === product) {
                    btn.classList.add('active');
                }
            });
            
            // Update product name
            const productNames = { coupon: 'Coupon Bot', forex: 'Forex Signals Bot', tenants: 'Tenant Management' };
            document.getElementById('productName').textContent = productNames[product] || 'Dashboard';
            
            // Render new navigation
            renderFeatureNav();
            
            // Navigate to first view of new product
            navigateTo(product, appState.activeView);
            
            closeMobileMenu();
        }

        function navigateTo(product, view, updateHash = true) {
            appState.activeProduct = product;
            appState.activeView = view;
            
            // Update URL hash
            if (updateHash) {
                window.location.hash = `${product}/${view}`;
            }
            
            // Update product name
            const productNames = { coupon: 'Coupon Bot', forex: 'Forex Signals Bot', tenants: 'Tenant Management' };
            document.getElementById('productName').textContent = productNames[product] || 'Dashboard';
            
            // Update active product icon (index 0 = forex, index 1 = coupon, index 2 = tenants)
            const productIcons = document.querySelectorAll('.product-icon');
            const productIndexMap = { forex: 0, coupon: 1, tenants: 2 };
            productIcons.forEach((icon, index) => {
                if (index === productIndexMap[product]) {
                    icon.classList.add('active');
                } else {
                    icon.classList.remove('active');
                }
            });
            
            // Hide all views
            document.querySelectorAll('.view-container').forEach(v => {
                v.classList.remove('active');
            });
            
            // Show active view
            const viewId = `${product}-${view}`;
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
                
                // Load data for specific views
                if (viewId === 'coupon-templates') {
                    loadAssets();
                } else if (viewId === 'coupon-analytics') {
                    loadAnalytics();
                } else if (viewId === 'forex-subscriptions') {
                    loadSubscriptions();
                } else if (viewId === 'forex-conversions') {
                    loadConversions();
                } else if (viewId === 'forex-signals') {
                    loadForexSignals();
                } else if (viewId === 'forex-settings') {
                    loadForexSettings();
                } else if (viewId === 'forex-journeys') {
                    window.JourneysModule.loadJourneys();
                } else if (viewId === 'forex-crosspromo') {
                    loadCrossPromo();
                } else if (viewId === 'forex-connections') {
                    loadConnections();
                } else if (viewId === 'tenants-list') {
                    loadTenants();
                }
            }
            
            // Update navigation active state
            renderFeatureNav();
            
            closeMobileMenu();
        }

        // TODO: REMOVE STATIC PASSWORD LOGIN - This is legacy auth that should be removed
        // once Clerk Google login is fully working. To remove:
        // 1. Delete this handleLogin function
        // 2. Delete the #loginPage section in HTML (around line 4016)
        // 3. Remove POST /api/login endpoint in server.py (around line 662)
        // 4. Remove create_signed_session() and verify_signed_session() in server.py
        // 5. Update checkAuth() to only use Clerk authentication
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    appState.isLoggedIn = true;
                    initializeRouting();
                    updateAuthUI(true, sessionStorage.getItem('clerk_user_email'), sessionStorage.getItem('clerk_user_avatar'));
                } else {
                    showAlert('loginAlert', data.error || 'Invalid password', true);
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed: ' + error.message, true);
            }
        }

        async function handleLogout() {
            // Show signing out state immediately
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#94a3b8;font-size:18px;">Signing out...</div>';
            }
            
            sessionStorage.removeItem('clerk_session_token');
            sessionStorage.removeItem('clerk_user_email');
            sessionStorage.removeItem('clerk_user_avatar');
            
            // Wait for overlay to paint before proceeding
            await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));
            
            if (window.Clerk) {
                try {
                    await window.Clerk.signOut();
                } catch (err) {
                    console.warn('Clerk signOut error:', err);
                }
            }
            
            try {
                await fetch('/api/logout', { method: 'POST' });
            } catch (err) {
                console.warn('Backend logout error:', err);
            }
            
            // Small delay to ensure signOut fully completes
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Navigate to login page with signed_out flag to prevent auto-redirect
            window.location.replace('/login?signed_out=1');
        }

        async function handleAccessDeniedLogout() {
            // Sign out from Clerk if available
            if (window.Clerk && typeof window.Clerk.signOut === 'function') {
                try {
                    await window.Clerk.signOut();
                } catch (clerkError) {
                    console.warn('Clerk signOut failed:', clerkError);
                }
            }
            
            sessionStorage.removeItem('clerk_session_token');
            sessionStorage.removeItem('clerk_user_email');
            
            // Small delay to ensure signOut fully completes
            await new Promise(resolve => setTimeout(resolve, 100));
            
            window.location.replace('/login?signed_out=1');
        }

        function showAccessDenied(email) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('accessDeniedPage').classList.remove('hidden');
            if (email) {
                document.getElementById('accessDeniedEmail').textContent = 'Logged in as: ' + email;
            }
        }

        function showAlert(elementId, message, isError = false) {
            const alert = document.getElementById(elementId);
            alert.className = isError ? 'alert alert-error' : 'alert alert-success';
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Mobile Menu
        function toggleMobileMenu() {
            const switcher = document.getElementById('productSwitcher');
            const sidebar = document.getElementById('featureSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            switcher.classList.toggle('mobile-open');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            appState.isMobileMenuOpen = !appState.isMobileMenuOpen;
        }

        function closeMobileMenu() {
            const switcher = document.getElementById('productSwitcher');
            const sidebar = document.getElementById('featureSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            switcher.classList.remove('mobile-open');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            appState.isMobileMenuOpen = false;
        }

        // Custom Modal Functions
        let modalResolve = null;
        
        function showCustomModal(title, message, options = {}) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                document.getElementById('customModalTitle').textContent = title;
                document.getElementById('customModalMessage').innerHTML = message;
                
                const buttonsHtml = options.type === 'alert' 
                    ? `<button class="custom-modal-btn custom-modal-btn-confirm" onclick="resolveModal(true)">OK</button>`
                    : `
                        <button class="custom-modal-btn custom-modal-btn-cancel" onclick="resolveModal(false)">Cancel</button>
                        <button class="custom-modal-btn ${options.danger ? 'custom-modal-btn-danger' : 'custom-modal-btn-confirm'}" onclick="resolveModal(true)">${options.confirmText || 'Confirm'}</button>
                    `;
                
                document.getElementById('customModalButtons').innerHTML = buttonsHtml;
                document.getElementById('customModal').classList.add('active');
            });
        }
        
        function resolveModal(result) {
            document.getElementById('customModal').classList.remove('active');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }
        
        function showModalAlert(title, message) {
            return showCustomModal(title, message, { type: 'alert' });
        }
        
        function showModalConfirm(title, message, options = {}) {
            return showCustomModal(title, message, options);
        }

        // Conversion Analytics Functions
        async function loadConversions() {
            try {
                const response = await authedFetch('/api/telegram/conversion-analytics', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load conversions');
                
                const data = await response.json();
                const summary = data.summary || {};
                
                // Update stat cards
                document.getElementById('totalFreeLeads').textContent = summary.total_free_signups || 0;
                document.getElementById('totalConversions').textContent = summary.total_conversions || 0;
                document.getElementById('conversionRate').textContent = `${(summary.conversion_rate || 0).toFixed(1)}%`;
                document.getElementById('avgConversionDays').textContent = summary.avg_conversion_days > 0 ? summary.avg_conversion_days.toFixed(1) : '--';
                document.getElementById('conversionRevenue').textContent = `$${(summary.conversion_revenue || 0).toFixed(0)}`;
                
                // Render leads by source (free signups funnel)
                renderLeadsBySource(data.funnel_by_source);
                
                // Render sales by source
                renderSalesBySource(data.by_source);
                
                // Render best converting sources
                renderBestConvertingSources(data.funnel_by_source);
                
                // Render recent conversions
                renderRecentConversions(data.recent_conversions);
                
                // Render all leads table
                renderAllLeads(data.all_leads);
                
            } catch (error) {
                console.error('Error loading conversions:', error);
                document.getElementById('salesBySource').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
            }
        }
        
        function renderLeadsBySource(leads) {
            const container = document.getElementById('leadsBySource');
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No leads yet. Free signups will appear here with their UTM attribution.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Signups</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Converted</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Conv. Rate</th>';
            html += '</tr></thead><tbody>';
            
            leads.forEach(lead => {
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${lead.source || '(Direct)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${lead.signups}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${lead.converted}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: ${lead.conversion_rate > 0 ? '#48bb78' : '#718096'};">${lead.conversion_rate}%</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderSalesBySource(sources) {
            const container = document.getElementById('salesBySource');
            if (!sources || sources.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No sales data yet. Sales will be tracked when users convert.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Sales</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Revenue</th>';
            html += '</tr></thead><tbody>';
            
            sources.forEach(source => {
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${source.source || '(Direct)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${source.conversions}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #48bb78;">$${source.revenue.toFixed(0)}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderBestConvertingSources(sources) {
            const container = document.getElementById('bestConvertingSources');
            if (!sources || sources.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No conversion data yet. Sources will be ranked by conversion rate.</div>';
                return;
            }
            
            // Sort by conversion rate descending
            const sorted = [...sources].sort((a, b) => (b.conversion_rate || 0) - (a.conversion_rate || 0));
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Leads</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Converted</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Conv. Rate</th>';
            html += '</tr></thead><tbody>';
            
            sorted.forEach(source => {
                const rateColor = source.conversion_rate >= 20 ? '#10b981' : source.conversion_rate >= 10 ? '#f59e0b' : '#718096';
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${source.source || '(Direct)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${source.signups || 0}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${source.converted || 0}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: ${rateColor}; font-weight: 600;">${source.conversion_rate || 0}%</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderRecentConversions(conversions) {
            const container = document.getElementById('recentConversions');
            if (!conversions || conversions.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No conversions yet. When free users upgrade to VIP, they\'ll appear here.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Email</th>';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Converted</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Days</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Amount</th>';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '</tr></thead><tbody>';
            
            conversions.forEach(conv => {
                const convDate = conv.converted_at ? new Date(conv.converted_at).toLocaleDateString() : '--';
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${conv.email}</td>`;
                html += `<td style="padding: 10px;">${convDate}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${conv.days_to_convert || '--'}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #48bb78;">$${(conv.amount || 0).toFixed(0)}</td>`;
                html += `<td style="padding: 10px;">${conv.source || '(Direct)'}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderAllLeads(leads) {
            const container = document.getElementById('allLeadsTable');
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No leads yet. Sign ups will appear here.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead><tr style="border-bottom: 2px solid #2d3748; background: #1a202c;">';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Status</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Email</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Name</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Campaign</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Signup Date</th>';
            html += '<th style="text-align: right; padding: 12px 10px; color: #a0aec0;">Revenue</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Telegram</th>';
            html += '</tr></thead><tbody>';
            
            leads.forEach(lead => {
                const signupDate = lead.signup_date ? new Date(lead.signup_date).toLocaleDateString() : '--';
                const statusTag = lead.is_converted 
                    ? '<span style="background: #48bb78; color: #1a202c; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">SALE</span>'
                    : '<span style="background: #4a5568; color: #e2e8f0; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">LEAD</span>';
                const revenue = lead.is_converted ? `<span style="color: #48bb78; font-weight: 600;">$${lead.amount.toFixed(0)}</span>` : '<span style="color: #718096;">--</span>';
                const telegram = lead.telegram ? `@${lead.telegram}` : '<span style="color: #718096;">--</span>';
                
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 12px 10px;">${statusTag}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.email}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.name || '<span style="color: #718096;">--</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.source || '<span style="color: #718096;">direct</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.campaign || '<span style="color: #718096;">--</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${signupDate}</td>`;
                html += `<td style="padding: 12px 10px; text-align: right;">${revenue}</td>`;
                html += `<td style="padding: 12px 10px;">${telegram}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Subscriptions Functions
        let allSubscriptions = [];
        let currentFilter = 'all';
        let currentMetricsPeriod = 'all';
        
        // Caching for performance
        const dataCache = {
            subscriptions: { loaded: false, lastLoad: null },
            channelStats: { loaded: false, lastLoad: null },
            connections: { loaded: false, lastLoad: null },
            signals: { loaded: false, lastLoad: null },
            conversions: { loaded: false, lastLoad: null },
            tenants: { loaded: false, lastLoad: null }
            // Revenue metrics are cached per-period: revenueMetrics_all, revenueMetrics_7d, etc.
        };
        const CACHE_TTL = 60000; // 60 seconds
        
        function isCacheValid(cacheKey) {
            const cache = dataCache[cacheKey];
            if (!cache || !cache.loaded || !cache.lastLoad) return false;
            return (Date.now() - cache.lastLoad) < CACHE_TTL;
        }
        
        function setCacheLoaded(cacheKey, data = null) {
            if (!dataCache[cacheKey]) dataCache[cacheKey] = {};
            dataCache[cacheKey].loaded = true;
            dataCache[cacheKey].lastLoad = Date.now();
            if (data !== null) dataCache[cacheKey].data = data;
        }
        
        function invalidateCache(cacheKey) {
            if (dataCache[cacheKey]) {
                dataCache[cacheKey].loaded = false;
                dataCache[cacheKey].lastLoad = null;
            }
        }
        
        function isMetricsCacheValid(period) {
            const key = `revenueMetrics_${period}`;
            return dataCache[key] && dataCache[key].loaded && 
                   dataCache[key].lastLoad && 
                   (Date.now() - dataCache[key].lastLoad) < CACHE_TTL;
        }
        
        function getCachedMetrics(period) {
            const key = `revenueMetrics_${period}`;
            return dataCache[key]?.data || null;
        }
        
        function cacheMetrics(period, data) {
            const key = `revenueMetrics_${period}`;
            dataCache[key] = { loaded: true, lastLoad: Date.now(), data };
        }

        function setMetricsPeriod(period) {
            currentMetricsPeriod = period;
            
            // Update pill active states
            document.querySelectorAll('.period-pill').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Check if we have cached data for this specific period
            if (isMetricsCacheValid(period)) {
                displayRevenueMetrics(getCachedMetrics(period), period);
            } else {
                // Fetch fresh metrics for this period
                fetchRevenueMetrics(period);
            }
        }

        function getDisplayStatus(sub) {
            if (sub.status === 'revoked') return 'revoked';
            if (sub.amount_paid > 0) return 'active';
            return 'free_plan';
        }

        async function loadSubscriptions(forceRefresh = false) {
            // Use cached data if valid
            if (!forceRefresh && isCacheValid('subscriptions')) {
                renderSubscriptions();
                updateSubscriptionStats(false); // Don't re-fetch metrics
                return;
            }
            
            try {
                const url = `/api/telegram-subscriptions?include_test=true`;
                const response = await authedFetch(url);
                if (!response.ok) throw new Error('Failed to load subscriptions');
                
                const data = await response.json();
                allSubscriptions = data.subscriptions || [];
                setCacheLoaded('subscriptions');
                updateSubscriptionStats(true); // Fetch metrics on first load
                renderSubscriptions();
                loadTelegramChannelStats();
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                document.getElementById('subscriptionsContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading subscriptions</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateSubscriptionStats(fetchMetrics = true) {
            const paidSubs = allSubscriptions.filter(s => s.amount_paid > 0 && s.status !== 'revoked');
            const paidCount = paidSubs.length;
            const activePaid = paidSubs.filter(s => s.status === 'active').length;
            
            document.getElementById('paidSubscribers').textContent = paidCount;
            document.getElementById('activeSubscribers').textContent = activePaid;
            
            // Only fetch revenue metrics if requested and not already cached for current period
            if (fetchMetrics && !isMetricsCacheValid(currentMetricsPeriod)) {
                fetchRevenueMetrics(currentMetricsPeriod);
            } else if (isMetricsCacheValid(currentMetricsPeriod)) {
                // Display cached metrics for current period
                displayRevenueMetrics(getCachedMetrics(currentMetricsPeriod), currentMetricsPeriod);
            }
        }
        
        function displayRevenueMetrics(metrics, period) {
            document.getElementById('netRevenue').textContent = `$${metrics.total_revenue.toFixed(0)}`;
            document.getElementById('monthlyRebill').textContent = `$${metrics.monthly_rebill.toFixed(0)}`;
            
            const churnRate = metrics.churn_rate !== undefined ? metrics.churn_rate : 0;
            document.getElementById('churnRate').textContent = `${churnRate.toFixed(1)}%`;
            
            const periodLabels = {
                'all': { revenue: 'All time (net)', rebill: 'All upcoming', churn: 'All time' },
                '30d': { revenue: 'Last 30 days', rebill: 'Due in 30 days', churn: 'Last 30 days' },
                '7d': { revenue: 'Last 7 days', rebill: 'Due in 7 days', churn: 'Last 7 days' },
                'yesterday': { revenue: 'Yesterday', rebill: 'Due today', churn: 'Yesterday' },
                'today': { revenue: 'Today', rebill: 'Due tomorrow', churn: 'Today' }
            };
            
            const labels = periodLabels[period] || periodLabels['all'];
            document.getElementById('netRevenueSubtext').textContent = labels.revenue;
            
            const rebillLabel = document.querySelector('#monthlyRebill').closest('.stat-content').querySelector('.stat-label');
            if (rebillLabel) {
                rebillLabel.textContent = period === 'all' ? 'Total Upcoming Rebill' : 'Expected Rebill';
            }
            const rebillSubtext = document.querySelector('#monthlyRebill').closest('.stat-content').querySelector('.stat-subtext');
            if (rebillSubtext) {
                rebillSubtext.textContent = labels.rebill;
            }
            
            document.getElementById('churnRateSubtext').textContent = labels.churn;
        }
        
        async function fetchRevenueMetrics(period = 'all') {
            // Show loading spinners
            document.getElementById('netRevenue').innerHTML = '<span class="loading-spinner"></span>';
            document.getElementById('monthlyRebill').innerHTML = '<span class="loading-spinner"></span>';
            document.getElementById('churnRate').innerHTML = '<span class="loading-spinner"></span>';
            
            try {
                const response = await authedFetch(`/api/telegram/revenue-metrics?period=${period}`);
                
                if (!response.ok) throw new Error('Failed to fetch revenue metrics');
                
                const metrics = await response.json();
                
                // Cache the metrics per period
                cacheMetrics(period, metrics);
                
                displayRevenueMetrics(metrics, period);
                
            } catch (error) {
                console.error('Error fetching revenue metrics:', error);
                // Fallback to database amounts
                const paidSubs = allSubscriptions.filter(s => s.amount_paid > 0 && s.status !== 'revoked');
                const totalFromDb = paidSubs.reduce((sum, s) => sum + (s.amount_paid || 0), 0);
                document.getElementById('netRevenue').textContent = `$${totalFromDb.toFixed(0)}`;
                document.getElementById('monthlyRebill').textContent = '$--';
                document.getElementById('netRevenueSubtext').textContent = 'From database';
                document.getElementById('churnRate').textContent = '--%';
            }
        }

        async function loadTelegramChannelStats() {
            const countEl = document.getElementById('signalChannelCount');
            const memberCountEl = document.getElementById('signalChannelMemberCount');
            const channelNameEl = document.getElementById('signalChannelName');
            
            const setChannelDisplay = (count, error = null, channelId = null, botUsername = null) => {
                if (error) {
                    const errorBadge = `<span class="error-badge" title="${error}">!</span>`;
                    countEl.innerHTML = `N/A ${errorBadge}`;
                    memberCountEl.classList.add('has-error');
                } else {
                    countEl.textContent = count;
                    countEl.title = '';
                    memberCountEl.classList.remove('has-error');
                }
                
                if (channelId) {
                    channelNameEl.textContent = channelId.startsWith('-100') ? 'Signal Channel' : channelId;
                    channelNameEl.title = `Channel ID: ${channelId}${botUsername ? `, Bot: @${botUsername}` : ''}`;
                }
            };
            
            try {
                const response = await authedFetch('/api/telegram-channel-stats');
                const data = await response.json();
                
                if (response.status === 401) {
                    setChannelDisplay('--', 'Not authenticated. Please refresh and log in again.');
                    return;
                }
                
                if (response.status === 403) {
                    setChannelDisplay('--', 'Access denied.');
                    return;
                }
                
                if (response.status === 503) {
                    const msg = data.message || 'Bot not configured';
                    setChannelDisplay('--', msg);
                    return;
                }
                
                if (response.status === 502 || !data.success) {
                    const msg = data.message || 'Telegram API error';
                    setChannelDisplay('--', msg, data.channel_id, data.bot_username);
                    return;
                }
                
                if (data.success && data.member_count !== null && data.member_count !== undefined) {
                    const count = data.member_count.toLocaleString();
                    setChannelDisplay(count, null, data.channel_id, data.bot_username);
                } else {
                    setChannelDisplay('--', data.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Error loading channel stats:', error);
                setChannelDisplay('--', 'Failed to load channel stats');
            }
        }

        function filterSubscriptions(status) {
            currentFilter = status;
            
            // Update table filter button states
            document.querySelectorAll('.table-filter-btn').forEach(btn => {
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderSubscriptions();
        }

        function searchSubscriptions(query) {
            renderSubscriptions(query.toLowerCase());
        }

        function renderSubscriptions(searchQuery = '') {
            let filtered = currentFilter === 'all' 
                ? allSubscriptions 
                : allSubscriptions.filter(sub => getDisplayStatus(sub) === currentFilter);
            
            if (searchQuery) {
                filtered = filtered.filter(sub => 
                    (sub.email && sub.email.toLowerCase().includes(searchQuery)) ||
                    (sub.name && sub.name.toLowerCase().includes(searchQuery)) ||
                    (sub.telegram_username && sub.telegram_username.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_customer_id && sub.stripe_customer_id.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_subscription_id && sub.stripe_subscription_id.toLowerCase().includes(searchQuery))
                );
            }

            if (filtered.length === 0) {
                document.getElementById('subscriptionsContent').innerHTML = `
                    <div class="empty-state">No subscriptions found</div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Stripe IDs</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Telegram</th>
                            <th>Signed Up</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((sub, index) => {
                            const displayStatus = getDisplayStatus(sub);
                            const statusLabel = displayStatus === 'free_plan' ? 'FREE PLAN' : displayStatus.toUpperCase();
                            return `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 0.9rem;">${sub.email}</span>
                                        <button onclick="copyToClipboard('${sub.email}', this)" class="copy-btn" title="Copy email">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td style="font-size: 0.8rem; font-family: monospace;">
                                    ${sub.stripe_customer_id ? `<div title="Customer ID" style="color: #a0a0b0;">cus: ${sub.stripe_customer_id.substring(0, 14)}...</div>` : '<div style="color: #666;">No Stripe ID</div>'}
                                    ${sub.stripe_subscription_id ? `<div title="Subscription ID" style="color: #7c8aff;">sub: ${sub.stripe_subscription_id.substring(0, 14)}...</div>` : ''}
                                </td>
                                <td>
                                    <div>${sub.plan_type || (sub.amount_paid > 0 ? 'Premium' : 'Free')}</div>
                                    <div style="color: ${sub.amount_paid > 0 ? '#4caf50' : '#666'}; font-weight: bold;">$${sub.amount_paid || '0'}</div>
                                </td>
                                <td><span class="badge status-${displayStatus}">${statusLabel}</span></td>
                                <td>${sub.telegram_username ? `@${sub.telegram_username}` : '<span style="color: #666;">Not joined</span>'}</td>
                                <td>${formatDate(sub.created_at)}</td>
                                <td>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="showSubscriptionDetails(${index})">View Details</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('subscriptionsContent').innerHTML = html;
        }
        
        function showSubscriptionDetails(index) {
            let filtered = currentFilter === 'all' 
                ? allSubscriptions 
                : allSubscriptions.filter(sub => getDisplayStatus(sub) === currentFilter);
            
            const searchInput = document.getElementById('subscriptionSearchInput');
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            
            if (searchQuery) {
                filtered = filtered.filter(sub => 
                    (sub.email && sub.email.toLowerCase().includes(searchQuery)) ||
                    (sub.name && sub.name.toLowerCase().includes(searchQuery)) ||
                    (sub.telegram_username && sub.telegram_username.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_customer_id && sub.stripe_customer_id.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_subscription_id && sub.stripe_subscription_id.toLowerCase().includes(searchQuery))
                );
            }
            
            const sub = filtered[index];
            if (!sub) return;
            
            const isPaidUser = parseFloat(sub.amount_paid || 0) > 0;
            const hasStripeSubscription = !!sub.stripe_subscription_id;
            
            let billingSection = '';
            if (!isPaidUser) {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div class="billing-na">N/A - Free user</div>
                    </div>
                `;
            } else if (!hasStripeSubscription) {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div class="billing-na">No Stripe subscription linked</div>
                    </div>
                `;
            } else {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div id="billingContent">
                            <div class="billing-loading">
                                <div class="billing-loading-spinner"></div>
                                Loading billing info...
                            </div>
                        </div>
                        <div id="cancelActions" class="cancel-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.85rem; color: #a0a0b0; margin-bottom: 10px;">Subscription Actions</div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="cancelSubscription(${sub.id}, false)" class="btn-cancel-period" style="padding: 8px 16px; background: #f59e0b; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    Cancel at Period End
                                </button>
                                <button onclick="cancelSubscription(${sub.id}, true)" class="btn-cancel-now" style="padding: 8px 16px; background: #ef4444; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    Cancel Immediately
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                                <strong>Cancel at Period End:</strong> User keeps access until billing period ends<br>
                                <strong>Cancel Immediately:</strong> User loses access and is removed from channel now
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const modalContent = `
                <div class="detail-row">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${sub.name || 'Unknown'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${sub.email || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Plan Type</div>
                    <div class="detail-value">${sub.plan_type || 'Premium'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Amount Paid</div>
                    <div class="detail-value" style="color: #4caf50; font-weight: bold;">$${sub.amount_paid || '0'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="badge status-${sub.status}">${sub.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Telegram Username</div>
                    <div class="detail-value">${sub.telegram_username ? `@${sub.telegram_username}` : 'Not joined'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Telegram User ID</div>
                    <div class="detail-value">${sub.telegram_user_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Stripe Customer ID</div>
                    <div class="detail-value" style="font-family: monospace; word-break: break-all;">${sub.stripe_customer_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Stripe Subscription ID</div>
                    <div class="detail-value" style="font-family: monospace; word-break: break-all;">${sub.stripe_subscription_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Invite Link</div>
                    <div class="detail-value" style="word-break: break-all;">${sub.invite_link ? `<a href="${sub.invite_link}" target="_blank" style="color: #667eea;">${sub.invite_link}</a>` : 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Signed Up</div>
                    <div class="detail-value">${formatDateFull(sub.created_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Joined At</div>
                    <div class="detail-value">${formatDateFull(sub.joined_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Last Seen At</div>
                    <div class="detail-value">${formatDateFull(sub.last_seen_at)}</div>
                </div>
                ${sub.revoked_at ? `
                <div class="detail-row">
                    <div class="detail-label">Revoked At</div>
                    <div class="detail-value" style="color: #ef4444;">${formatDateFull(sub.revoked_at)}</div>
                </div>
                ` : ''}
                ${billingSection}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                    <div style="font-size: 0.85rem; color: #a0a0b0; margin-bottom: 10px;">Danger Zone</div>
                    <button onclick="deleteSubscription(${sub.id}, '${(sub.email || '').replace(/'/g, "\\'")}', ${sub.telegram_user_id || 'null'})" 
                            style="padding: 10px 20px; background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%;">
                         Delete This Record
                    </button>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                        Permanently deletes this subscription record from the database. Cannot be undone.
                    </div>
                </div>
            `;
            
            document.getElementById('subscriptionDetailContent').innerHTML = modalContent;
            document.getElementById('subscriptionDetailModal').classList.add('active');
            
            if (isPaidUser && hasStripeSubscription) {
                fetchBillingInfo(sub.id);
            }
        }
        
        async function fetchBillingInfo(subscriptionId) {
            const billingContainer = document.getElementById('billingContent');
            if (!billingContainer) return;
            
            try {
                const response = await fetch(`/api/telegram/billing/${subscriptionId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch billing info');
                }
                
                const data = await response.json();
                const billing = data.billing;
                const billingStatus = data.billing_status;
                
                // Handle different billing statuses
                if (billingStatus === 'free_user') {
                    billingContainer.innerHTML = `
                        <div class="billing-na">N/A - Free user</div>
                    `;
                    return;
                }
                
                if (billingStatus === 'no_stripe_ids') {
                    billingContainer.innerHTML = `
                        <div class="billing-error">No Stripe subscription linked</div>
                    `;
                    return;
                }
                
                if (billingStatus === 'stripe_error' || !billing) {
                    const errorMsg = data.error || 'Unable to fetch billing info from Stripe';
                    billingContainer.innerHTML = `
                        <div class="billing-error">${errorMsg}</div>
                    `;
                    return;
                }
                
                // Success - render billing info
                const billingHtml = renderBillingInfo(billing);
                billingContainer.innerHTML = billingHtml;
                
            } catch (error) {
                console.error('Error fetching billing info:', error);
                billingContainer.innerHTML = `
                    <div class="billing-error">Unable to load billing info</div>
                `;
            }
        }
        
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief visual feedback with checkmark
                const svg = btn.querySelector('svg');
                const originalSvg = svg.outerHTML;
                svg.outerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                btn.style.opacity = '1';
                setTimeout(() => {
                    btn.innerHTML = originalSvg;
                    btn.style.opacity = '';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        async function cleanupTestData() {
            const confirmed = await showModalConfirm(
                'Delete Test Data',
                'This will remove records with:<br><br> Emails starting with test@ or demo@<br> Emails ending with @example.com<br> That have fake payment amounts<br><br><strong>Real subscriber data will NOT be affected.</strong>',
                { danger: true, confirmText: 'Delete Test Data' }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await authedFetch('/api/telegram/cleanup-test-data', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const deletedList = result.deleted.length > 0 
                        ? result.deleted.map(r => ` ${r.email} ($${r.amount})`).join('<br>') 
                        : 'None found';
                    await showModalAlert('Success', `${result.message}<br><br>${deletedList}`);
                    loadSubscriptions();
                } else {
                    await showModalAlert('Error', `Failed to cleanup: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cleaning up test data:', error);
                await showModalAlert('Error', `Error: ${error.message}`);
            }
        }
        
        async function cancelSubscription(subscriptionId, cancelImmediately) {
            const actionText = cancelImmediately ? 'Cancel Immediately' : 'Cancel at Period End';
            const warningText = cancelImmediately 
                ? 'This will <strong>immediately revoke access</strong> and remove the user from the Telegram channel.'
                : 'This will cancel the subscription at the end of the current billing period. The user will <strong>retain access until then</strong>.';
            
            const confirmed = await showModalConfirm(actionText, warningText, { 
                danger: cancelImmediately,
                confirmText: cancelImmediately ? 'Cancel Now' : 'Cancel at Period End'
            });
            
            if (!confirmed) return;
            
            const cancelActions = document.getElementById('cancelActions');
            if (cancelActions) {
                cancelActions.innerHTML = `
                    <div style="color: #a0a0b0; display: flex; align-items: center; gap: 10px;">
                        <div class="billing-loading-spinner"></div>
                        Processing cancellation...
                    </div>
                `;
            }
            
            try {
                const response = await authedFetch('/api/telegram/cancel-subscription', {
                    method: 'POST',
                    body: JSON.stringify({
                        subscriptionId: subscriptionId,
                        cancelImmediately: cancelImmediately
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (cancelActions) {
                        cancelActions.innerHTML = `
                            <div style="color: #4caf50; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                                 ${result.message}
                            </div>
                        `;
                    }
                    
                    // Refresh the billing info after a short delay
                    setTimeout(() => {
                        fetchBillingInfo(subscriptionId);
                        loadSubscriptions(); // Refresh the main list
                    }, 1500);
                } else {
                    if (cancelActions) {
                        cancelActions.innerHTML = `
                            <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                                 Failed to cancel: ${result.error || 'Unknown error'}
                            </div>
                            <button onclick="showSubscriptionDetails(${subscriptionId})" style="margin-top: 10px; padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
                                Try Again
                            </button>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error canceling subscription:', error);
                if (cancelActions) {
                    cancelActions.innerHTML = `
                        <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                             Error: ${error.message}
                        </div>
                        <button onclick="showSubscriptionDetails(${subscriptionId})" style="margin-top: 10px; padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    `;
                }
            }
        }
        
        async function deleteSubscription(subscriptionId, email, telegramUserId) {
            const confirmed = await showModalConfirm(
                'Delete Subscription Record',
                `<strong>Email:</strong> ${email}<br><br>This action cannot be undone. The record will be permanently removed from the database.`,
                { danger: true, confirmText: 'Delete' }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await authedFetch('/api/telegram/delete-subscription', {
                    method: 'POST',
                    body: JSON.stringify({
                        subscriptionId: subscriptionId,
                        telegramUserId: telegramUserId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await showModalAlert('Success', `Deleted successfully: ${email}`);
                    closeSubscriptionDetailModal();
                    loadSubscriptions();
                } else {
                    await showModalAlert('Error', `Failed to delete: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting subscription:', error);
                await showModalAlert('Error', `Error: ${error.message}`);
            }
        }
        
        function renderBillingInfo(billing) {
            const formatCurrency = (amount, currency) => {
                const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '' : currency === 'GBP' ? '' : currency + ' ';
                return `${symbol}${parseFloat(amount).toFixed(2)}`;
            };
            
            const formatBillingDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            const formatBillingInterval = (interval, count) => {
                if (count === 1) {
                    return interval === 'month' ? 'Monthly' : interval === 'year' ? 'Yearly' : interval;
                }
                return `Every ${count} ${interval}s`;
            };
            
            const statusClass = `stripe-status stripe-status-${billing.status}`;
            
            let cancelWarning = '';
            if (billing.cancel_at_period_end) {
                cancelWarning = `
                    <div class="detail-row">
                        <div class="detail-label">Cancel Status</div>
                        <div class="detail-value">
                            <span class="cancel-warning"> Cancels at period end</span>
                        </div>
                    </div>
                `;
            }
            
            let canceledAt = '';
            if (billing.canceled_at) {
                canceledAt = `
                    <div class="detail-row">
                        <div class="detail-label">Canceled At</div>
                        <div class="detail-value" style="color: #ef4444;">${formatBillingDate(billing.canceled_at)}</div>
                    </div>
                `;
            }
            
            let lastPayment = 'N/A';
            if (billing.latest_invoice && billing.latest_invoice.paid_at) {
                lastPayment = `${formatBillingDate(billing.latest_invoice.paid_at)} - ${formatCurrency(billing.latest_invoice.amount_paid, billing.latest_invoice.currency)}`;
            }
            
            let nextPayment = 'N/A';
            if (billing.upcoming_invoice && billing.upcoming_invoice.next_payment_attempt) {
                nextPayment = `${formatBillingDate(billing.upcoming_invoice.next_payment_attempt)} - ${formatCurrency(billing.upcoming_invoice.amount_due, billing.upcoming_invoice.currency)}`;
            }
            
            return `
                <div class="detail-row">
                    <div class="detail-label">Stripe Status</div>
                    <div class="detail-value"><span class="${statusClass}">${billing.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Billing Cycle</div>
                    <div class="detail-value">${formatBillingInterval(billing.billing_interval, billing.billing_interval_count)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Current Period</div>
                    <div class="detail-value">${formatBillingDate(billing.current_period_start)}  ${formatBillingDate(billing.current_period_end)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Last Payment</div>
                    <div class="detail-value" style="color: #10b981;">${lastPayment}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Next Payment Due</div>
                    <div class="detail-value">${nextPayment}</div>
                </div>
                ${cancelWarning}
                ${canceledAt}
            `;
        }
        
        function closeSubscriptionDetailModal() {
            document.getElementById('subscriptionDetailModal').classList.remove('active');
        }
        
        function formatDateFull(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Forex Signals Functions
        let allSignals = [];
        let botStatus = null;
        let selectedBotType = null;
        let currentActiveBot = null;

        async function loadForexSignals() {
            try {
                const limit = document.getElementById('filterLimit')?.value || 100;
                const response = await authedFetch(`/api/forex-signals?limit=${limit}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load signals');
                
                allSignals = await response.json();
                applySignalFilters();
                updateForexMetrics();
                loadBotStatus();
            } catch (error) {
                console.error('Error loading signals:', error);
                document.getElementById('signalsTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading signals</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadBotStatus() {
            try {
                const response = await authedFetch('/api/signal-bot/status', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load bot status');
                
                botStatus = await response.json();
                currentActiveBot = botStatus.active_bot || null;
                updateBotStatusUI();
                updateActiveSignalBanner();
                
                // Re-render table with live price data now available
                if (allSignals.length > 0) {
                    applySignalFilters();
                }
            } catch (error) {
                console.error('Error loading bot status:', error);
            }
        }

        function updateBotStatusUI() {
            if (!botStatus) return;
            
            // Update signals page
            const activeBotEl = document.getElementById('activeBotType');
            if (activeBotEl) {
                let botText = formatBotName(botStatus.active_bot);
                if (botStatus.queued_bot) {
                    botText += `  ${formatBotName(botStatus.queued_bot)} (queued)`;
                }
                activeBotEl.textContent = botText;
            }
            
            // Update settings page
            const settingsActiveBot = document.getElementById('settingsActiveBot');
            if (settingsActiveBot) {
                let botText = formatBotName(botStatus.active_bot);
                if (botStatus.queued_bot) {
                    botText += `  ${formatBotName(botStatus.queued_bot)} (queued)`;
                }
                settingsActiveBot.textContent = botText;
            }
            
            const settingsOpenSignal = document.getElementById('settingsOpenSignal');
            if (settingsOpenSignal) {
                if (botStatus.open_signal) {
                    settingsOpenSignal.innerHTML = `<span style="color: #667eea;">#${botStatus.open_signal.id} (${botStatus.open_signal.signal_type})</span>`;
                } else {
                    settingsOpenSignal.textContent = 'None';
                }
            }
            
            const livePnlDisplay = document.getElementById('livePnlDisplay');
            if (livePnlDisplay) {
                if (botStatus.open_signal && botStatus.current_dollars !== null && botStatus.current_dollars !== undefined) {
                    const pnl = botStatus.current_dollars;
                    const pips = botStatus.current_pips;
                    const isProfit = pnl >= 0;
                    const color = isProfit ? '#10b981' : '#ef4444';
                    const sign = isProfit ? '+' : '';
                    livePnlDisplay.innerHTML = `<span style="color: ${color}; font-weight: 600;">${sign}$${pnl.toFixed(2)}</span> <span style="color: #94a3b8; font-size: 11px;">(${sign}${pips} pips)</span>`;
                } else if (botStatus.open_signal) {
                    livePnlDisplay.innerHTML = '<span style="color: #94a3b8;">Loading...</span>';
                } else {
                    livePnlDisplay.textContent = '--';
                }
            }
            
            const dailyPnlDisplay = document.getElementById('dailyPnlDisplay');
            if (dailyPnlDisplay) {
                const dailyPnl = botStatus.daily_pnl || 0;
                const isProfit = dailyPnl >= 0;
                const color = isProfit ? '#10b981' : '#ef4444';
                const sign = isProfit ? '+' : '';
                dailyPnlDisplay.innerHTML = `<span style="color: ${color}; font-weight: 600;">${sign}${dailyPnl.toFixed(1)} pips</span>`;
            }
            
            // Update signal counts
            const aggressiveCount = document.getElementById('aggressiveCount');
            const conservativeCount = document.getElementById('conservativeCount');
            const customCount = document.getElementById('customCount');
            const legacyCount = document.getElementById('legacyCount');
            
            if (aggressiveCount) aggressiveCount.textContent = botStatus.recent_signals?.aggressive || 0;
            if (conservativeCount) conservativeCount.textContent = botStatus.recent_signals?.conservative || 0;
            if (customCount) customCount.textContent = botStatus.recent_signals?.custom || 0;
            if (legacyCount) legacyCount.textContent = botStatus.recent_signals?.legacy || 0;
            
            // Update bot option active states
            document.querySelectorAll('.bot-option').forEach(opt => {
                opt.classList.remove('active', 'selected');
                if (opt.dataset.bot === botStatus.active_bot) {
                    opt.classList.add('active');
                }
            });
            
            // Update queued bot status display
            const cancelQueueBtn = document.getElementById('cancelQueueBtn');
            const queuedBotStatus = document.getElementById('queuedBotStatus');
            const queuedBotText = document.getElementById('queuedBotText');
            
            if (botStatus.queued_bot && botStatus.open_signal) {
                if (cancelQueueBtn) cancelQueueBtn.style.display = 'block';
                if (queuedBotStatus) {
                    queuedBotStatus.style.display = 'block';
                    if (queuedBotText) {
                        queuedBotText.textContent = `${botStatus.queued_bot} will activate after Signal #${botStatus.open_signal.id} closes`;
                    }
                }
            } else {
                if (cancelQueueBtn) cancelQueueBtn.style.display = 'none';
                if (queuedBotStatus) queuedBotStatus.style.display = 'none';
            }
        }

        function updateActiveSignalBanner() {
            const banner = document.getElementById('activeSignalBanner');
            if (!banner) return;
            
            if (botStatus?.open_signal) {
                const signal = botStatus.open_signal;
                banner.style.display = 'block';
                
                // Signal ID
                const signalIdEl = document.getElementById('activeSignalId');
                if (signalIdEl) signalIdEl.textContent = `#${signal.id}`;
                
                // Signal details
                document.getElementById('activeSignalDetails').innerHTML = 
                    `${signal.signal_type} @ $${signal.entry_price?.toFixed(2)} | TP: $${signal.take_profit?.toFixed(2)} | SL: $${signal.stop_loss?.toFixed(2)}`;
                
                // Live price
                const priceEl = document.getElementById('activeSignalPrice');
                if (priceEl && botStatus.current_price) {
                    priceEl.textContent = `$${botStatus.current_price.toFixed(2)}`;
                }
                
                // P/L display
                const pnlEl = document.getElementById('activeSignalPnL');
                if (pnlEl && botStatus.current_pips !== null) {
                    const pips = botStatus.current_pips;
                    const sign = pips >= 0 ? '+' : '';
                    pnlEl.textContent = `${sign}${pips.toFixed(1)} pips`;
                    pnlEl.style.color = pips >= 0 ? '#10b981' : '#f56565';
                }
                
                // TP indicators
                const tpsEl = document.getElementById('activeSignalTPs');
                if (tpsEl) {
                    const hasTP1 = signal.take_profit != null;
                    const hasTP2 = signal.take_profit_2 != null;
                    const hasTP3 = signal.take_profit_3 != null;
                    const tp1Hit = signal.tp1_hit === true;
                    const tp2Hit = signal.tp2_hit === true;
                    const tp3Hit = signal.tp3_hit === true;
                    
                    let icons = '';
                    if (hasTP1) icons += tp1Hit ? '<span style="color: #10b981;"></span>' : '<span style="color: #4a5568;"></span>';
                    if (hasTP2) icons += tp2Hit ? '<span style="color: #10b981;"></span>' : '<span style="color: #4a5568;"></span>';
                    if (hasTP3) icons += tp3Hit ? '<span style="color: #10b981;"></span>' : '<span style="color: #4a5568;"></span>';
                    tpsEl.innerHTML = icons || '--';
                }
                
                // Calculate time open
                const postedAt = new Date(signal.posted_at);
                const now = new Date();
                const hoursOpen = Math.floor((now - postedAt) / (1000 * 60 * 60));
                const minsOpen = Math.floor(((now - postedAt) / (1000 * 60)) % 60);
                document.getElementById('activeSignalTime').textContent = `${hoursOpen}h ${minsOpen}m open`;
                
                // Breakeven status
                const breakevenEl = document.getElementById('activeSignalBreakeven');
                if (signal.breakeven_triggered || signal.breakeven_set) {
                    breakevenEl.textContent = 'BE Protected';
                    breakevenEl.style.color = '#10b981';
                } else {
                    breakevenEl.textContent = '';
                }
            } else {
                banner.style.display = 'none';
            }
        }

        function applySignalFilters() {
            const typeFilter = document.getElementById('filterType')?.value || 'all';
            const statusFilter = document.getElementById('filterStatus')?.value || 'all';
            const botTypeFilter = document.getElementById('filterBotType')?.value || 'all';
            const dateRangeFilter = document.getElementById('filterDateRange')?.value || 'all';
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let filtered = allSignals.filter(signal => {
                if (typeFilter !== 'all' && signal.signal_type !== typeFilter) return false;
                if (statusFilter !== 'all' && signal.status !== statusFilter) return false;
                if (botTypeFilter !== 'all' && signal.bot_type !== botTypeFilter) return false;
                
                // Date range filter
                if (dateRangeFilter !== 'all') {
                    const signalDate = new Date(signal.posted_at);
                    if (dateRangeFilter === 'today' && signalDate < today) return false;
                    if (dateRangeFilter === 'yesterday' && (signalDate < yesterday || signalDate >= today)) return false;
                    if (dateRangeFilter === '7days' && signalDate < sevenDaysAgo) return false;
                    if (dateRangeFilter === '30days' && signalDate < thirtyDaysAgo) return false;
                }
                
                return true;
            });
            
            renderSignalsTable(filtered);
            updateForexMetrics(filtered);
        }

        function renderSignalsTable(signals) {
            if (signals.length === 0) {
                document.getElementById('signalsTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No signals found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Date/Time</th>
                            <th>Bot</th>
                            <th>Type</th>
                            <th>Entry</th>
                            <th>TP</th>
                            <th>SL</th>
                            <th>TPs</th>
                            <th>Status</th>
                            <th>Closed At</th>
                            <th>Price</th>
                            <th>Pips</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${signals.map(signal => {
                            const signalDate = new Date(signal.posted_at);
                            const dayName = signalDate.toLocaleString('en-US', { weekday: 'short' });
                            const date = signalDate.toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            let pips = signal.result_pips || 0;
                            let pipsDisplay = pips > 0 ? `+${pips.toFixed(2)}` : pips.toFixed(2);
                            
                            // Price display: live price for pending, close_price for closed
                            let priceDisplay = '--';
                            const isPending = (signal.status === 'pending' || signal.status === 'open');
                            
                            if (isPending && botStatus?.current_price && botStatus?.open_signal?.id === signal.id) {
                                // Live price for active signal
                                priceDisplay = `<span style="color: #667eea;" title="Live">$${botStatus.current_price.toFixed(2)}</span>`;
                                pips = botStatus.current_pips || 0;
                                const sign = pips >= 0 ? '+' : '';
                                pipsDisplay = `<span title="Live">${sign}${pips.toFixed(1)}</span>`;
                            } else if (!isPending && signal.close_price) {
                                // Close price for completed signals
                                priceDisplay = `$${signal.close_price.toFixed(2)}`;
                            } else if (isPending) {
                                priceDisplay = '<span style="color: #a0aec0;">--</span>';
                            }
                            
                            const botType = signal.bot_type || 'custom';
                            
                            // TP icons - show green for hit, grey for pending
                            const tpIcons = renderTPIcons(signal);
                            
                            return `
                                <tr>
                                    <td style="font-weight: 500; color: #a0aec0;">${dayName}</td>
                                    <td>${date}</td>
                                    <td><span class="badge badge-${botType}" style="text-transform: capitalize;">${botType.replace('_', ' ')}</span></td>
                                    <td><span class="badge badge-${signal.signal_type.toLowerCase()}">${signal.signal_type}</span></td>
                                    <td>$${signal.entry_price ? signal.entry_price.toFixed(2) : '--'}</td>
                                    <td>$${signal.take_profit ? signal.take_profit.toFixed(2) : '--'}</td>
                                    <td>$${signal.stop_loss ? signal.stop_loss.toFixed(2) : '--'}</td>
                                    <td>${tpIcons}</td>
                                    <td><span class="badge badge-${signal.status}">${signal.status}</span></td>
                                    <td>${signal.closed_at ? new Date(signal.closed_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '<span style="color: #a0aec0;">--</span>'}</td>
                                    <td>${priceDisplay}</td>
                                    <td style="color: ${pips >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">${pipsDisplay}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                </div>
            `;

            document.getElementById('signalsTableContent').innerHTML = html;
        }
        
        function renderTPIcons(signal) {
            // Determine how many TPs this signal has (check if tp2/tp3 prices exist)
            const hasTP1 = signal.take_profit != null;
            const hasTP2 = signal.take_profit_2 != null;
            const hasTP3 = signal.take_profit_3 != null;
            
            const totalTPs = (hasTP1 ? 1 : 0) + (hasTP2 ? 1 : 0) + (hasTP3 ? 1 : 0);
            
            if (totalTPs === 0) return '<span style="color: #a0aec0;">--</span>';
            
            // Check which TPs are hit
            const tp1Hit = signal.tp1_hit === true;
            const tp2Hit = signal.tp2_hit === true;
            const tp3Hit = signal.tp3_hit === true;
            
            let icons = '';
            
            // TP1
            if (hasTP1) {
                icons += tp1Hit 
                    ? '<span title="TP1 Hit" style="color: #10b981; margin-right: 3px;"></span>'
                    : '<span title="TP1 Pending" style="color: #4a5568; margin-right: 3px;"></span>';
            }
            
            // TP2
            if (hasTP2) {
                icons += tp2Hit 
                    ? '<span title="TP2 Hit" style="color: #10b981; margin-right: 3px;"></span>'
                    : '<span title="TP2 Pending" style="color: #4a5568; margin-right: 3px;"></span>';
            }
            
            // TP3
            if (hasTP3) {
                icons += tp3Hit 
                    ? '<span title="TP3 Hit" style="color: #10b981;"></span>'
                    : '<span title="TP3 Pending" style="color: #4a5568;"></span>';
            }
            
            return icons || '--';
        }

        function updateForexMetrics(signals = null) {
            // Use filtered signals if provided, otherwise use all signals
            const targetSignals = signals || allSignals;
            
            const completed = targetSignals.filter(s => s.status === 'won' || s.status === 'lost');
            const won = targetSignals.filter(s => s.status === 'won').length;
            const total = completed.length;
            const winRate = total > 0 ? ((won / total) * 100).toFixed(1) : 0;
            const totalPips = targetSignals.reduce((sum, s) => sum + (s.result_pips || 0), 0);

            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('winRateSubtext').textContent = `${won} won / ${total} total`;
            document.getElementById('totalPips').textContent = totalPips.toFixed(2);
            document.getElementById('totalSignals').textContent = targetSignals.length;
            document.getElementById('signalsBreakdown').textContent = `${completed.length} completed`;
            
            // Apply color to total pips
            const pipsEl = document.getElementById('totalPips');
            if (totalPips >= 0) {
                pipsEl.classList.add('positive');
                pipsEl.classList.remove('negative');
            } else {
                pipsEl.classList.add('negative');
                pipsEl.classList.remove('positive');
            }
            
            // Calculate and display avg hold time and avg pips per trade from completed signals
            if (completed.length > 0) {
                let totalHoldMinutes = 0;
                let validHoldCount = 0;
                
                completed.forEach(s => {
                    if (s.posted_at && s.closed_at) {
                        const posted = new Date(s.posted_at);
                        const closed = new Date(s.closed_at);
                        const holdMinutes = (closed - posted) / (1000 * 60);
                        if (holdMinutes > 0 && holdMinutes < 10000) {
                            totalHoldMinutes += holdMinutes;
                            validHoldCount++;
                        }
                    }
                });
                
                const avgHoldMinutes = validHoldCount > 0 ? totalHoldMinutes / validHoldCount : 0;
                const avgPips = totalPips / completed.length;
                
                // Format hold time
                const avgHoldEl = document.getElementById('avgHoldTime');
                const holdTimeBar = document.getElementById('holdTimeBar');
                if (avgHoldEl) {
                    if (avgHoldMinutes >= 60) {
                        const hours = Math.floor(avgHoldMinutes / 60);
                        const mins = Math.round(avgHoldMinutes % 60);
                        avgHoldEl.textContent = `${hours}h ${mins}m`;
                    } else {
                        avgHoldEl.textContent = `${Math.round(avgHoldMinutes)}m`;
                    }
                }
                // Update hold time bar (max 8 hours = 480 mins = 100%)
                if (holdTimeBar) {
                    const pct = Math.min(100, (avgHoldMinutes / 480) * 100);
                    holdTimeBar.style.width = pct + '%';
                }
                
                // Format avg pips
                const avgPipsEl = document.getElementById('avgPipsPerTrade');
                if (avgPipsEl) {
                    const sign = avgPips >= 0 ? '+' : '';
                    avgPipsEl.textContent = `${sign}${avgPips.toFixed(1)}`;
                    avgPipsEl.classList.toggle('positive', avgPips >= 0);
                    avgPipsEl.classList.toggle('negative', avgPips < 0);
                }
            } else {
                const avgHoldEl = document.getElementById('avgHoldTime');
                const avgPipsEl = document.getElementById('avgPipsPerTrade');
                const holdTimeBar = document.getElementById('holdTimeBar');
                if (avgHoldEl) avgHoldEl.textContent = '--';
                if (avgPipsEl) avgPipsEl.textContent = '--';
                if (holdTimeBar) holdTimeBar.style.width = '0%';
            }
            
            // Update Buy/Sell pie chart
            const buys = targetSignals.filter(s => s.signal_type === 'BUY').length;
            const sells = targetSignals.filter(s => s.signal_type === 'SELL').length;
            drawBuySellPieChart(buys, sells);
            
            // Update signals by day bar chart
            drawDayBarChart(targetSignals);
            
            // Update subtexts based on selected period
            const periodLabel = getCurrentPeriodLabel();
            const avgHoldSubtext = document.getElementById('avgHoldSubtext');
            const avgPipsSubtext = document.getElementById('avgPipsSubtext');
            if (avgHoldSubtext) avgHoldSubtext.textContent = periodLabel;
            if (avgPipsSubtext) avgPipsSubtext.textContent = periodLabel;
            
            // Update period indicator in title
            const periodIndicator = document.getElementById('periodIndicator');
            if (periodIndicator) {
                const indicatorText = getPeriodIndicatorText();
                periodIndicator.textContent = indicatorText ? `- ${indicatorText}` : '';
            }
        }
        
        function getPeriodIndicatorText() {
            const segment = document.getElementById('dateRangeSegment');
            if (!segment) return '';
            const activeBtn = segment.querySelector('.segment-btn.active');
            if (!activeBtn) return '';
            const value = activeBtn.dataset.value;
            switch(value) {
                case 'today': return 'Today';
                case '7days': return 'Past 7D';
                case '30days': return 'Past 30D';
                default: return '';
            }
        }
        
        function getCurrentPeriodLabel() {
            const segment = document.getElementById('dateRangeSegment');
            if (!segment) return 'all time';
            const activeBtn = segment.querySelector('.segment-btn.active');
            if (!activeBtn) return 'all time';
            const value = activeBtn.dataset.value;
            switch(value) {
                case 'today': return 'today';
                case '7days': return 'last 7 days';
                case '30days': return 'last 30 days';
                default: return 'all time';
            }
        }
        
        function drawBuySellPieChart(buys, sells) {
            const total = buys + sells;
            const buyCountEl = document.getElementById('buyCount');
            const sellCountEl = document.getElementById('sellCount');
            const buyBarEl = document.getElementById('buyBarSegment');
            const sellBarEl = document.getElementById('sellBarSegment');
            
            if (buyCountEl) buyCountEl.textContent = buys;
            if (sellCountEl) sellCountEl.textContent = sells;
            
            if (total > 0 && buyBarEl && sellBarEl) {
                const buyPct = (buys / total) * 100;
                const sellPct = (sells / total) * 100;
                buyBarEl.style.width = buyPct + '%';
                sellBarEl.style.width = sellPct + '%';
            } else if (buyBarEl && sellBarEl) {
                buyBarEl.style.width = '50%';
                sellBarEl.style.width = '50%';
            }
        }

        function drawDayBarChart(signals) {
            const container = document.getElementById('dayBarsContainer');
            const totalEl = document.getElementById('totalSignalsDays');
            if (!container) return;
            
            const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Mon-Sun
            
            signals.forEach(sig => {
                if (!sig.posted_at) return;
                const date = new Date(sig.posted_at);
                const dayIndex = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                const mappedIndex = dayIndex === 0 ? 6 : dayIndex - 1; // Convert to Mon=0, Sun=6
                dayCounts[mappedIndex]++;
            });
            
            const total = dayCounts.reduce((a, b) => a + b, 0);
            const maxCount = Math.max(...dayCounts, 1);
            
            if (totalEl) totalEl.textContent = total;
            
            const bars = container.querySelectorAll('.day-bar .bar');
            bars.forEach((bar, i) => {
                const height = Math.max(4, (dayCounts[i] / maxCount) * 28);
                bar.style.height = height + 'px';
            });
        }

        // Bot Settings Functions
        function selectBot(botType) {
            selectedBotType = botType;
            
            document.querySelectorAll('.bot-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.bot === botType && botType !== botStatus?.active_bot) {
                    opt.classList.add('selected');
                }
            });
            
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.bot === botType && botType !== botStatus?.active_bot) {
                    card.classList.add('selected');
                }
            });
            
            const switchBtn = document.getElementById('switchBotBtn');
            const switchBtnText = document.getElementById('switchBotBtnText');
            
            if (botType === botStatus?.active_bot) {
                switchBtn.disabled = true;
                switchBtnText.textContent = `${botType} is already active`;
            } else if (botStatus?.open_signal) {
                switchBtn.disabled = false;
                switchBtnText.textContent = `Queue ${botType} (activates after signal closes)`;
            } else {
                switchBtn.disabled = false;
                switchBtnText.textContent = `Switch to ${botType}`;
            }
        }

        async function switchActiveBot() {
            if (!selectedBotType || selectedBotType === botStatus?.active_bot) return;
            
            const switchBtn = document.getElementById('switchBotBtn');
            const switchBtnText = document.getElementById('switchBotBtnText');
            const errorEl = document.getElementById('botSwitchError');
            const successEl = document.getElementById('botSwitchSuccess');
            
            switchBtn.disabled = true;
            switchBtnText.textContent = 'Switching...';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            try {
                const response = await authedFetch('/api/signal-bot/set-active', {
                    method: 'POST',
                    body: JSON.stringify({ bot_type: selectedBotType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    successEl.textContent = result.message;
                    successEl.style.display = 'block';
                    await loadBotStatus();
                    updateStrategyCards();
                    switchBtnText.textContent = 'Select a strategy to switch';
                    selectedBotType = null;
                } else {
                    errorEl.textContent = result.error;
                    errorEl.style.display = 'block';
                    switchBtnText.textContent = `Switch to ${selectedBotType}`;
                    switchBtn.disabled = false;
                }
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                switchBtnText.textContent = `Switch to ${selectedBotType}`;
                switchBtn.disabled = false;
            }
        }

        async function cancelQueuedBot() {
            const cancelBtn = document.getElementById('cancelQueueBtn');
            const errorEl = document.getElementById('botSwitchError');
            const successEl = document.getElementById('botSwitchSuccess');
            
            if (cancelBtn) cancelBtn.disabled = true;
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
            
            try {
                const response = await authedFetch('/api/signal-bot/cancel-queue', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (successEl) {
                        successEl.textContent = result.message;
                        successEl.style.display = 'block';
                    }
                    await loadBotStatus();
                    updateStrategyCards();
                    selectedBotType = null;
                    const switchBtnText = document.getElementById('switchBotBtnText');
                    if (switchBtnText) switchBtnText.textContent = 'Select a strategy to switch';
                } else {
                    if (errorEl) {
                        errorEl.textContent = result.error;
                        errorEl.style.display = 'block';
                    }
                }
            } catch (error) {
                if (errorEl) {
                    errorEl.textContent = error.message;
                    errorEl.style.display = 'block';
                }
            } finally {
                if (cancelBtn) cancelBtn.disabled = false;
            }
        }

        async function loadForexSettings() {
            await Promise.all([
                loadBotStatus(),
                loadTpConfig(),
                loadGuardrailSettings()
            ]);
            updateStrategyCards();
        }

        async function loadCrossPromo() {
            try {
                const [settingsResp, jobsResp, previewResp] = await Promise.all([
                    authedFetch('/api/crosspromo/settings'),
                    authedFetch('/api/crosspromo/jobs'),
                    authedFetch('/api/crosspromo/preview')
                ]);
                
                const settings = await settingsResp.json();
                const jobs = await jobsResp.json();
                const preview = await previewResp.json();
                
                document.getElementById('crosspromo-enabled').checked = settings.enabled || false;
                document.getElementById('crosspromo-free-channel').value = settings.free_channel_id || '';
                document.getElementById('crosspromo-vip-channel').value = settings.vip_channel_id || '';
                document.getElementById('crosspromo-cta-url').value = settings.cta_url || 'https://entrylab.io/subscribe';
                
                document.getElementById('crosspromo-preview').textContent = preview.preview || 'No preview available';
                
                renderCrossPromoJobs(jobs.jobs || []);
            } catch (e) {
                console.error('Error loading cross promo:', e);
            }
        }
        
        function renderCrossPromoJobs(jobs) {
            const tbody = document.getElementById('crosspromo-jobs-tbody');
            if (!jobs || jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No jobs yet</td></tr>';
                return;
            }
            
            const statusBadge = (status) => {
                const colors = {
                    'queued': '#6366f1',
                    'sending': '#f59e0b',
                    'sent': '#10b981',
                    'failed': '#ef4444'
                };
                return `<span style="background: ${colors[status] || '#6b7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${status}</span>`;
            };
            
            tbody.innerHTML = jobs.map(job => `
                <tr>
                    <td>${job.job_type}</td>
                    <td>${statusBadge(job.status)}</td>
                    <td>${job.run_at ? new Date(job.run_at).toLocaleString() : '-'}</td>
                    <td style="color: var(--status-error); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${job.error || '-'}</td>
                </tr>
            `).join('');
        }
        
        async function loadCrossPromoJobs() {
            try {
                const resp = await authedFetch('/api/crosspromo/jobs');
                const data = await resp.json();
                renderCrossPromoJobs(data.jobs || []);
            } catch (e) {
                console.error('Error loading jobs:', e);
            }
        }
        
        async function loadCrossPromoPreview() {
            try {
                const resp = await authedFetch('/api/crosspromo/preview');
                const data = await resp.json();
                document.getElementById('crosspromo-preview').textContent = data.preview || 'No preview available';
            } catch (e) {
                console.error('Error loading preview:', e);
            }
        }
        
        async function saveCrossPromoSettings() {
            try {
                const settings = {
                    enabled: document.getElementById('crosspromo-enabled').checked,
                    free_channel_id: document.getElementById('crosspromo-free-channel').value,
                    vip_channel_id: document.getElementById('crosspromo-vip-channel').value,
                    cta_url: document.getElementById('crosspromo-cta-url').value || 'https://entrylab.io/subscribe'
                };
                
                const resp = await authedFetch('/api/crosspromo/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (resp.ok) {
                    showToast('Settings saved');
                } else {
                    const err = await resp.json();
                    showToast(err.error || 'Failed to save', 'error');
                }
            } catch (e) {
                console.error('Error saving settings:', e);
                showToast('Error saving settings', 'error');
            }
        }
        
        async function runDailySequence() {
            try {
                const resp = await authedFetch('/api/crosspromo/run-daily-seq', { method: 'POST' });
                const data = await resp.json();
                
                if (resp.ok) {
                    showToast(data.message || `Jobs created: ${(data.jobs_created || []).join(', ')}`);
                    loadCrossPromoJobs();
                } else {
                    showToast(data.error || 'Failed to run sequence', 'error');
                }
            } catch (e) {
                console.error('Error running sequence:', e);
                showToast('Error running sequence', 'error');
            }
        }
        
        async function sendTestMorning() {
            try {
                const resp = await authedFetch('/api/crosspromo/send-test', { method: 'POST' });
                const data = await resp.json();
                
                if (resp.ok) {
                    showToast('Test message sent');
                } else {
                    showToast(data.error || 'Failed to send test', 'error');
                }
            } catch (e) {
                console.error('Error sending test:', e);
                showToast('Error sending test', 'error');
            }
        }
        
        async function publishWinSequence() {
            const signalId = document.getElementById('crosspromo-signal-id').value;
            const winId = document.getElementById('crosspromo-win-id').value;
            
            if (!signalId || !winId) {
                showToast('Please enter both message IDs', 'error');
                return;
            }
            
            try {
                const resp = await authedFetch('/api/crosspromo/publish-win', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vip_signal_message_id: parseInt(signalId),
                        vip_win_message_id: parseInt(winId)
                    })
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    showToast(`Win sequence queued: ${(data.jobs_created || []).join(', ')}`);
                    loadCrossPromoJobs();
                    document.getElementById('crosspromo-signal-id').value = '';
                    document.getElementById('crosspromo-win-id').value = '';
                } else {
                    showToast(data.error || 'Failed to publish win', 'error');
                }
            } catch (e) {
                console.error('Error publishing win:', e);
                showToast('Error publishing win', 'error');
            }
        }

        const UI_TO_API_ROLE = {
            'signal': 'signal_bot',
            'message': 'message_bot'
        };
        
        const API_TO_UI_ROLE = {
            'signal_bot': 'signal',
            'message_bot': 'message',
            'signal': 'signal',
            'message': 'message'
        };
        
        async function loadConnections() {
            const headers = await getAuthHeaders();
            try {
                const response = await authedFetch('/api/connections');
                const data = await response.json();
                
                const uiRoles = ['signal', 'message'];
                const connMap = {};
                for (const conn of data.connections || []) {
                    const uiRole = API_TO_UI_ROLE[conn.bot_role] || conn.bot_role;
                    connMap[uiRole] = conn;
                }
                
                for (const role of uiRoles) {
                    const conn = connMap[role];
                    const statusEl = document.getElementById(`${role}-status`);
                    const tokenStatusEl = document.getElementById(`${role}-token-status`);
                    const tokenInput = document.getElementById(`${role}-bot-token`);
                    const card = document.querySelector(`.connection-card[data-role="${role}"]`);
                    
                    if (role === 'message') {
                        const channelWrapper = document.getElementById('message-channel-wrapper');
                        if (channelWrapper) channelWrapper.classList.add('visible');
                    }
                    
                    if (conn) {
                        card.dataset.hasToken = 'true';
                        tokenInput.value = '';
                        tokenInput.placeholder = 'Token saved - enter new token to update';
                        
                        const username = conn.bot_username || '';
                        const last4 = username.length > 4 ? username.slice(-4) : username;
                        tokenStatusEl.textContent = `Token saved  (${last4})`;
                        tokenStatusEl.classList.add('visible');
                        
                        if (conn.last_error) {
                            statusEl.textContent = 'Error ';
                            statusEl.className = 'connection-badge error';
                            document.getElementById(`${role}-error`).textContent = conn.last_error;
                            document.getElementById(`${role}-error`).style.display = 'block';
                        } else {
                            statusEl.textContent = 'Connected ';
                            statusEl.className = 'connection-badge connected';
                        }
                        
                        document.getElementById(`${role}-username`).textContent = conn.bot_username || '-';
                        document.getElementById(`${role}-channel-id-display`).textContent = conn.channel_id || '-';
                        document.getElementById(`${role}-webhook`).textContent = conn.webhook_url || '-';
                        document.getElementById(`${role}-updated`).textContent = conn.last_validated_at ? new Date(conn.last_validated_at).toLocaleString() : '-';
                        document.getElementById(`${role}-info`).style.display = 'block';
                        document.getElementById(`${role}-delete`).style.display = 'inline-block';
                        if (conn.channel_id) {
                            document.getElementById(`${role}-channel-id`).value = conn.channel_id;
                        }
                    } else {
                        card.dataset.hasToken = 'false';
                        statusEl.textContent = 'Not configured ';
                        statusEl.className = 'connection-badge';
                        tokenStatusEl.classList.remove('visible');
                        tokenInput.placeholder = 'Enter bot token from @BotFather';
                        document.getElementById(`${role}-info`).style.display = 'none';
                        document.getElementById(`${role}-delete`).style.display = 'none';
                        document.getElementById(`${role}-error`).style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Error loading connections:', e);
            }
        }
        
        async function testConnection(role) {
            const tokenInput = document.getElementById(`${role}-bot-token`);
            const token = tokenInput.value.trim();
            const card = document.querySelector(`.connection-card[data-role="${role}"]`);
            const hasToken = card.dataset.hasToken === 'true';
            
            if (!token && !hasToken) {
                showModalAlert('Error', 'Please enter a bot token or save one first');
                return;
            }
            
            const headers = await getAuthHeaders();
            showLoading('Testing connection...');
            
            const apiRole = UI_TO_API_ROLE[role] || role;
            try {
                const body = { bot_role: apiRole };
                if (token) {
                    body.bot_token = token;
                }
                
                const resp = await authedFetch('/api/connections/test', {
                    method: 'POST',
                    headers: {...headers, 'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await resp.json();
                hideLoading();
                
                if (data.success) {
                    showModalAlert('Success', `Connection successful! Bot: ${data.bot_username}`);
                    document.getElementById(`${role}-error`).style.display = 'none';
                } else {
                    document.getElementById(`${role}-error`).textContent = data.error || 'Connection test failed';
                    document.getElementById(`${role}-error`).style.display = 'block';
                    showModalAlert('Error', data.error || 'Connection test failed');
                }
            } catch (e) {
                hideLoading();
                showModalAlert('Error', 'Failed to test connection');
            }
        }

        function toggleTokenVisibility(role) {
            const input = document.getElementById(`${role}-bot-token`);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        async function validateConnection(role) {
            const token = document.getElementById(`${role}-bot-token`).value.trim();
            if (!token) {
                showModalAlert('Error', 'Please enter a bot token');
                return;
            }
            
            const headers = await getAuthHeaders();
            showLoading('Validating bot token...');
            
            const apiRole = UI_TO_API_ROLE[role] || role;
            try {
                const resp = await authedFetch('/api/connections/validate', {
                    method: 'POST',
                    headers: {...headers, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ bot_role: apiRole, bot_token: token })
                });
                const data = await resp.json();
                hideLoading();
                
                if (data.valid) {
                    showModalAlert('Success', `Valid! Bot username: @${data.bot_username}`);
                    document.getElementById(`${role}-error`).style.display = 'none';
                } else {
                    document.getElementById(`${role}-error`).textContent = data.error || 'Invalid token';
                    document.getElementById(`${role}-error`).style.display = 'block';
                    showModalAlert('Error', 'Invalid bot token');
                }
            } catch (e) {
                hideLoading();
                showModalAlert('Error', 'Failed to validate token');
            }
        }

        async function saveConnection(role) {
            const token = document.getElementById(`${role}-bot-token`).value.trim();
            const channelId = document.getElementById(`${role}-channel-id`).value.trim();
            if (!token) {
                showModalAlert('Error', 'Please enter a bot token');
                return;
            }
            
            const headers = await getAuthHeaders();
            showLoading('Setting up webhook...');
            
            const apiRole = UI_TO_API_ROLE[role] || role;
            try {
                const resp = await authedFetch('/api/connections', {
                    method: 'POST',
                    headers: {...headers, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ bot_role: apiRole, bot_token: token, channel_id: channelId || null })
                });
                const data = await resp.json();
                hideLoading();
                
                if (data.success) {
                    showModalAlert('Success', 'Bot connected and webhook configured!');
                    await loadConnections();
                    document.getElementById(`${role}-bot-token`).value = '';
                } else {
                    document.getElementById(`${role}-error`).textContent = data.error || 'Failed to save';
                    document.getElementById(`${role}-error`).style.display = 'block';
                    showModalAlert('Error', data.error || 'Failed to save connection');
                }
            } catch (e) {
                hideLoading();
                showModalAlert('Error', 'Failed to save connection');
            }
        }

        async function deleteConnection(role) {
            if (!confirm('Are you sure you want to remove this bot connection?')) return;
            
            const headers = await getAuthHeaders();
            showLoading('Removing connection...');
            
            const apiRole = UI_TO_API_ROLE[role] || role;
            try {
                const resp = await authedFetch(`/api/connections/${apiRole}`, {
                    method: 'DELETE',
                    headers
                });
                const data = await resp.json();
                hideLoading();
                
                if (data.success) {
                    showModalAlert('Success', 'Connection removed');
                    const statusEl = document.getElementById(`${role}-status`);
                    statusEl.textContent = 'Not configured ';
                    statusEl.className = 'connection-badge';
                    
                    const tokenStatusEl = document.getElementById(`${role}-token-status`);
                    tokenStatusEl.classList.remove('visible');
                    
                    const tokenInput = document.getElementById(`${role}-bot-token`);
                    tokenInput.value = '';
                    tokenInput.placeholder = 'Enter bot token from @BotFather';
                    
                    const card = document.querySelector(`.connection-card[data-role="${role}"]`);
                    card.dataset.hasToken = 'false';
                    
                    document.getElementById(`${role}-info`).style.display = 'none';
                    document.getElementById(`${role}-delete`).style.display = 'none';
                    document.getElementById(`${role}-error`).style.display = 'none';
                    document.getElementById(`${role}-channel-id`).value = '';
                } else {
                    showModalAlert('Error', data.error || 'Failed to remove');
                }
            } catch (e) {
                hideLoading();
                showModalAlert('Error', 'Failed to remove connection');
            }
        }

        async function loadTenants() {
            const tbody = document.getElementById('tenantsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">
                        Loading tenants...
                    </td>
                </tr>
            `;

            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/admin/tenants', { headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load tenants');
                }

                const tenants = data.tenants || [];
                
                // Update stats
                const totalCount = tenants.length;
                const completeCount = tenants.filter(t => t.onboarding_complete).length;
                const pendingCount = totalCount - completeCount;
                
                document.getElementById('totalTenantsCount').textContent = totalCount;
                document.getElementById('onboardingCompleteCount').textContent = completeCount;
                document.getElementById('onboardingPendingCount').textContent = pendingCount;

                if (tenants.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                No tenants found
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = tenants.map(tenant => `
                    <tr>
                        <td>
                            <code style="font-size: 11px; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">
                                ${escapeHtml(tenant.tenant_id?.substring(0, 8) || '--')}...
                            </code>
                        </td>
                        <td style="font-weight: 500; color: var(--text-primary);">
                            ${escapeHtml(tenant.display_name || 'Unnamed')}
                        </td>
                        <td>${escapeHtml(tenant.owner_email || '--')}</td>
                        <td>${tenant.created_at ? new Date(tenant.created_at).toLocaleDateString() : '--'}</td>
                        <td>
                            <span class="badge ${tenant.onboarding_complete ? 'badge-won' : 'badge-pending'}">
                                ${tenant.onboarding_complete ? 'Complete' : 'Pending'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="impersonateTenant('${escapeHtml(tenant.tenant_id)}')">
                                View Dash
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load tenants:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--status-error); padding: 40px;">
                            Error loading tenants: ${escapeHtml(error.message)}
                        </td>
                    </tr>
                `;
            }
        }

        function impersonateTenant(tenantId) {
            sessionStorage.setItem('impersonating_tenant_id', tenantId);
            window.open('/app', '_blank');
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function updateStrategyCards() {
            const cards = document.querySelectorAll('.strategy-card');
            cards.forEach(card => {
                card.classList.remove('active-strategy', 'selected');
                if (card.dataset.bot === currentActiveBot) {
                    card.classList.add('active-strategy');
                }
            });
        }
        
        let currentTpCount = 3;
        
        function setTpCount(count) {
            currentTpCount = count;
            
            document.querySelectorAll('.tp-count-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.count) === count) {
                    btn.classList.add('active');
                }
            });
            
            const tp2Level = document.getElementById('tpLevel2');
            const tp3Level = document.getElementById('tpLevel3');
            
            if (count === 1) {
                tp2Level.classList.add('disabled');
                tp3Level.classList.add('disabled');
                document.getElementById('tp1Pct').value = 100;
                document.getElementById('tp2Pct').value = 0;
                document.getElementById('tp3Pct').value = 0;
            } else if (count === 2) {
                tp2Level.classList.remove('disabled');
                tp3Level.classList.add('disabled');
                document.getElementById('tp3Pct').value = 0;
            } else {
                tp2Level.classList.remove('disabled');
                tp3Level.classList.remove('disabled');
            }
            
            updateTpTotal();
        }
        
        function updateTpTotal() {
            const tp1 = parseInt(document.getElementById('tp1Pct').value) || 0;
            const tp2 = parseInt(document.getElementById('tp2Pct').value) || 0;
            const tp3 = parseInt(document.getElementById('tp3Pct').value) || 0;
            
            const total = tp1 + tp2 + tp3;
            const totalEl = document.getElementById('tpTotalValue');
            
            totalEl.textContent = `${total}%`;
            
            if (total === 100) {
                totalEl.classList.remove('invalid');
                totalEl.classList.add('valid');
            } else {
                totalEl.classList.remove('valid');
                totalEl.classList.add('invalid');
            }
        }
        
        async function loadTpConfig() {
            try {
                const response = await authedFetch('/api/forex-tp-config');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentTpCount = data.tp_count || 3;
                        document.getElementById('tp1Pct').value = data.tp1_percentage || 50;
                        document.getElementById('tp2Pct').value = data.tp2_percentage || 30;
                        document.getElementById('tp3Pct').value = data.tp3_percentage || 20;
                        
                        setTpCount(currentTpCount);
                    }
                }
            } catch (error) {
                console.error('Failed to load TP config:', error);
            }
        }
        
        async function saveTpConfig() {
            const tp1 = parseInt(document.getElementById('tp1Pct').value) || 0;
            const tp2 = parseInt(document.getElementById('tp2Pct').value) || 0;
            const tp3 = parseInt(document.getElementById('tp3Pct').value) || 0;
            
            if (tp1 + tp2 + tp3 !== 100) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = 'TP percentages must add up to 100%';
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
                return;
            }
            
            try {
                const response = await authedFetch('/api/forex-tp-config', {
                    method: 'POST',
                    body: JSON.stringify({
                        tp_count: currentTpCount,
                        tp1_percentage: tp1,
                        tp2_percentage: tp2,
                        tp3_percentage: tp3
                    })
                });
                
                const result = await response.json();
                
                const successEl = document.getElementById('guardrailSuccess');
                const errorEl = document.getElementById('guardrailError');
                
                if (result.success) {
                    successEl.textContent = 'TP configuration saved successfully';
                    successEl.style.display = 'block';
                    setTimeout(() => successEl.style.display = 'none', 5000);
                } else {
                    errorEl.textContent = result.error || 'Failed to save TP configuration';
                    errorEl.style.display = 'block';
                    setTimeout(() => errorEl.style.display = 'none', 5000);
                }
            } catch (error) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }
        
        async function saveGuardrails() {
            try {
                const dailyLossCap = document.getElementById('dailyLossCap').value;
                const backToBackThrottle = document.getElementById('backToBackThrottle').value;
                const sessionFilterEnabled = 'true';
                const sessionStartHour = document.getElementById('sessionStartHour').value;
                const sessionEndHour = document.getElementById('sessionEndHour').value;
                
                const response = await authedFetch('/api/forex-config', {
                    method: 'POST',
                    body: JSON.stringify({
                        daily_loss_cap_pips: parseFloat(dailyLossCap),
                        back_to_back_throttle_minutes: parseInt(backToBackThrottle),
                        session_filter_enabled: sessionFilterEnabled,
                        session_start_hour_utc: parseInt(sessionStartHour),
                        session_end_hour_utc: parseInt(sessionEndHour)
                    })
                });
                
                const result = await response.json();
                
                const successEl = document.getElementById('guardrailSuccess');
                const errorEl = document.getElementById('guardrailError');
                
                if (result.success) {
                    successEl.textContent = 'Risk settings saved successfully';
                    successEl.style.display = 'block';
                    setTimeout(() => successEl.style.display = 'none', 5000);
                } else {
                    errorEl.textContent = result.error || 'Failed to save risk settings';
                    errorEl.style.display = 'block';
                    setTimeout(() => errorEl.style.display = 'none', 5000);
                }
            } catch (error) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }
        
        async function loadGuardrailSettings() {
            try {
                const response = await authedFetch('/api/forex-config');
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dailyLossCap').value = data.daily_loss_cap_pips || 50;
                    document.getElementById('backToBackThrottle').value = data.back_to_back_throttle_minutes || 30;
                    document.getElementById('sessionStartHour').value = data.session_start_hour_utc || 8;
                    document.getElementById('sessionEndHour').value = data.session_end_hour_utc || 21;
                    
                    // Update session display
                    const sessionDisplay = document.getElementById('currentSessionDisplay');
                    if (sessionDisplay) {
                        const now = new Date();
                        const utcHour = now.getUTCHours();
                        const start = parseInt(data.session_start_hour_utc) || 8;
                        const end = parseInt(data.session_end_hour_utc) || 21;
                        const isActive = utcHour >= start && utcHour < end;
                        sessionDisplay.textContent = isActive ? 'Active' : 'Closed';
                        sessionDisplay.className = 'status-item-value ' + (isActive ? 'positive' : '');
                    }
                }
            } catch (error) {
                console.error('Failed to load guardrail settings:', error);
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Add event listeners for forex filters
        setTimeout(() => {
            const filterLimit = document.getElementById('filterLimit');
            const filterBotType = document.getElementById('filterBotType');
            
            if (filterLimit) filterLimit.addEventListener('change', loadForexSignals);
            if (filterBotType) filterBotType.addEventListener('change', applySignalFilters);
            
            // Initialize segment controls
            initSegmentControl('dateRangeSegment', 'filterDateRange');
            initSegmentControl('typeSegment', 'filterType');
            initSegmentControl('statusSegment', 'filterStatus');
        }, 1000);
        
        function initSegmentControl(segmentId, hiddenInputId) {
            const segment = document.getElementById(segmentId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if (!segment || !hiddenInput) return;
            
            segment.querySelectorAll('.segment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    segment.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    hiddenInput.value = btn.dataset.value;
                    applySignalFilters();
                });
            });
        }

        // ============================================
        // COUPON BOT FUNCTIONS (Template Manager, Campaigns, Broadcast, Analytics)
        // ============================================

        // Global variables for template manager
        let isEditingTemplate = false;
        let deleteConfirmCallback = null;

        // Tab switching
        function switchTab(tabName) {
            const uploadTab = document.getElementById('uploadTab');
            const assetsTab = document.getElementById('assetsTab');
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (tabName === 'upload') {
                uploadTab.classList.add('active');
                assetsTab.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                uploadTab.classList.remove('active');
                assetsTab.classList.add('active');
                tabs[1].classList.add('active');
            }
        }

        // Alert display
        function showAlert(elementId, message, isError = false) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.style.padding = '12px';
            alertDiv.style.marginBottom = '16px';
            alertDiv.style.borderRadius = '8px';
            alertDiv.style.backgroundColor = isError ? '#fee' : '#efe';
            alertDiv.style.color = isError ? '#c33' : '#363';
            alertDiv.style.border = `1px solid ${isError ? '#fcc' : '#cfc'}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // Clear template form
        function clearTemplateForm() {
            document.getElementById('templateForm').reset();
            document.getElementById('name').value = '';
            document.getElementById('slug').value = '';
            
            const slugInput = document.getElementById('slug');
            slugInput.readOnly = false;
            slugInput.style.backgroundColor = '';
            slugInput.style.cursor = '';
            
            isEditingTemplate = false;
            
            previewImages.square = null;
            previewImages.story = null;
            
            document.getElementById('squareFontColor').value = '#FF273E';
            document.getElementById('storyFontColor').value = '#FF273E';
            
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === '#FF273E') {
                    swatch.classList.add('selected');
                }
            });
            
            const squareCanvas = document.getElementById('previewSquare');
            const storyCanvas = document.getElementById('previewStory');
            if (squareCanvas) {
                const ctx = squareCanvas.getContext('2d');
                ctx.clearRect(0, 0, squareCanvas.width, squareCanvas.height);
            }
            if (storyCanvas) {
                const ctx = storyCanvas.getContext('2d');
                ctx.clearRect(0, 0, storyCanvas.width, storyCanvas.height);
            }
            
            document.getElementById('isEditing').value = 'false';
            document.getElementById('submitBtn').textContent = 'Upload Template';
            
            console.log('[FORM] Template form cleared for new upload');
        }

        // Handle template upload
        async function handleUpload(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            const nameValue = document.getElementById('name').value;
            const slugInput = document.getElementById('slug');
            const slugValue = slugInput.value;
            
            formData.append('name', nameValue);
            formData.append('slug', slugValue);
            
            const squareFile = document.getElementById('squareImage').files[0];
            const storyFile = document.getElementById('storyImage').files[0];
            if (squareFile) formData.append('squareImage', squareFile);
            if (storyFile) formData.append('storyImage', storyFile);
            
            formData.append('squareLeftPct', document.getElementById('squareLeftPct').value);
            formData.append('squareTopPct', document.getElementById('squareTopPct').value);
            formData.append('squareWidthPct', document.getElementById('squareWidthPct').value);
            formData.append('squareHeightPct', document.getElementById('squareHeightPct').value);
            formData.append('squareHAlign', 'center');
            formData.append('squareVAlign', 'middle');
            formData.append('squareMaxFontPx', document.getElementById('squareMaxFontPx').value);
            formData.append('squareShowLogo', document.getElementById('squareShowLogo').checked);
            
            formData.append('storyLeftPct', document.getElementById('storyLeftPct').value);
            formData.append('storyTopPct', document.getElementById('storyTopPct').value);
            formData.append('storyWidthPct', document.getElementById('storyWidthPct').value);
            formData.append('storyHeightPct', document.getElementById('storyHeightPct').value);
            formData.append('storyHAlign', 'center');
            formData.append('storyVAlign', 'middle');
            formData.append('storyMaxFontPx', document.getElementById('storyMaxFontPx').value);
            formData.append('storyShowLogo', document.getElementById('storyShowLogo').checked);
            
            formData.append('squareFontColor', document.getElementById('squareFontColor').value);
            formData.append('storyFontColor', document.getElementById('storyFontColor').value);

            try {
                const authHeaders = await getAuthHeaders();
                delete authHeaders['Content-Type'];
                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    headers: authHeaders,
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('uploadAlert', data.message + ' ');
                    clearTemplateForm();
                    isEditingTemplate = false;
                    drawingState.square.hasDrawnBox = false;
                    drawingState.story.hasDrawnBox = false;
                    updatePreviewsImmediate();
                    loadAssets();
                } else {
                    showAlert('uploadAlert', data.error || 'Upload failed', true);
                }
            } catch (error) {
                showAlert('uploadAlert', 'Upload failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Template';
            }
        }

        // Auto-generate slug from name
        document.getElementById('name').addEventListener('input', function(e) {
            if (!isEditingTemplate) {
                const slug = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('slug').value = slug;
            }
        });

        // Load templates/assets
        async function loadAssets() {
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading templates...</p>';
            
            try {
                let response;
                try {
                    response = await fetch('https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/index.json?ts=' + Date.now());
                } catch (_) {
                    response = await fetch('/assets/templates/index.json?ts=' + Date.now());
                }
                const data = await response.json();
                
                if (!data.templates || data.templates.length === 0) {
                    assetsList.innerHTML = '<p style="color: #718096; text-align: center;">No templates found</p>';
                    return;
                }
                
                assetsList.innerHTML = '';
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    const telegramEnabled = template.telegramEnabled !== false;
                    item.innerHTML = `
                        <input type="checkbox" class="template-checkbox" data-slug="${template.slug}" data-name="${template.name}" onchange="updateSelectAllState()">
                        <div class="asset-item-info">
                            <div class="asset-name">${template.name}</div>
                            <div class="asset-slug">${template.slug}</div>
                        </div>
                        <div class="telegram-toggle-container" title="${telegramEnabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot'}">
                            <label class="telegram-toggle-label">
                                <input type="checkbox" class="telegram-toggle-checkbox" data-slug="${template.slug}" ${telegramEnabled ? 'checked' : ''} onchange="toggleTelegramVisibility(event, '${template.slug}', this.checked)">
                                <span class="telegram-toggle-slider"></span>
                                <span class="telegram-toggle-text">${telegramEnabled ? ' Telegram' : ' Telegram'}</span>
                            </label>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="loadTemplateForEdit('${template.slug}')"></div>
                            <div class="asset-delete-icon" onclick="deleteTemplate('${template.slug}', '${template.name}')"></div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                });
                
                document.getElementById('selectAllTemplates').checked = false;
            } catch (error) {
                assetsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading templates</p>';
                console.error('Failed to load assets:', error);
            }
        }

        // Load template for editing
        async function loadTemplateForEdit(slug) {
            try {
                let response;
                try {
                    response = await fetch(`https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/meta.json?ts=${Date.now()}`);
                } catch (_) {
                    response = await fetch(`/assets/templates/${slug}/meta.json?ts=${Date.now()}`);
                }
                const meta = await response.json();
                
                switchTab('upload');
                
                isEditingTemplate = true;
                document.getElementById('isEditing').value = 'true';
                document.getElementById('name').value = meta.name || slug;
                const slugInput = document.getElementById('slug');
                slugInput.value = slug;
                slugInput.readOnly = true;
                slugInput.style.backgroundColor = '#f3f4f6';
                slugInput.style.cursor = 'not-allowed';
                document.getElementById('submitBtn').textContent = 'Update Template';
                
                document.getElementById('squareLeftPct').value = meta.square?.box?.leftPct || meta.square?.leftPct || 5;
                document.getElementById('squareTopPct').value = meta.square?.box?.topPct || meta.square?.topPct || 78;
                document.getElementById('squareWidthPct').value = meta.square?.box?.widthPct || meta.square?.widthPct || 90;
                document.getElementById('squareHeightPct').value = meta.square?.box?.heightPct || meta.square?.heightPct || 12;
                document.getElementById('squareMaxFontPx').value = meta.square?.maxFontPx || 80;
                document.getElementById('squareShowLogo').checked = meta.square?.showLogo !== false;
                
                document.getElementById('storyLeftPct').value = meta.story?.box?.leftPct || meta.story?.leftPct || 5;
                document.getElementById('storyTopPct').value = meta.story?.box?.topPct || meta.story?.topPct || 78;
                document.getElementById('storyWidthPct').value = meta.story?.box?.widthPct || meta.story?.widthPct || 90;
                document.getElementById('storyHeightPct').value = meta.story?.box?.heightPct || meta.story?.heightPct || 12;
                document.getElementById('storyMaxFontPx').value = meta.story?.maxFontPx || 80;
                document.getElementById('storyShowLogo').checked = meta.story?.showLogo !== false;
                
                const squareFontColor = meta.square?.fontColor || '#FF273E';
                const storyFontColor = meta.story?.fontColor || '#FF273E';
                document.getElementById('squareFontColor').value = squareFontColor;
                document.getElementById('storyFontColor').value = storyFontColor;
                selectColor(squareFontColor, 'square');
                selectColor(storyFontColor, 'story');
                
                drawingState.square.hasDrawnBox = true;
                if (meta.story) {
                    drawingState.story.hasDrawnBox = true;
                }
                
                const squareImg = new Image();
                squareImg.onload = async function() {
                    try {
                        await squareImg.decode();
                        previewImages.square = squareImg;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square image decode failed:', e);
                    }
                };
                
                try {
                    squareImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/square.png?ts=${Date.now()}`;
                } catch (_) {
                    squareImg.src = `/assets/templates/${slug}/square.png?ts=${Date.now()}`;
                }
                
                if (meta.story) {
                    const storyImg = new Image();
                    storyImg.onload = async function() {
                        try {
                            await storyImg.decode();
                            previewImages.story = storyImg;
                            renderPreview('story');
                        } catch(e) {
                            console.error('Story image decode failed:', e);
                        }
                    };
                    
                    try {
                        storyImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/story.png?ts=${Date.now()}`;
                    } catch (_) {
                        storyImg.src = `/assets/templates/${slug}/story.png?ts=${Date.now()}`;
                    }
                }
                
                document.getElementById('submitBtn').textContent = 'Update Template';
                
            } catch (error) {
                showAlert('uploadAlert', 'Failed to load template: ' + error.message, true);
                console.error('Error loading template for edit:', error);
            }
        }

        // Delete template
        function deleteTemplate(slug, name) {
            document.getElementById('modalTitle').textContent = 'Delete Template?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                try {
                    const response = await authedFetch('/api/delete-template', {
                        method: 'POST',
                        body: JSON.stringify({ slug })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showAlert('uploadAlert', `Template "${name}" deleted successfully `);
                        loadAssets();
                    } else {
                        showAlert('uploadAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('uploadAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteConfirmCallback = null;
        }

        // Toggle Telegram visibility
        async function toggleTelegramVisibility(event, slug, enabled) {
            const checkbox = event.target;
            const label = checkbox.closest('.telegram-toggle-label');
            const toggleText = label.querySelector('.telegram-toggle-text');
            const container = checkbox.closest('.telegram-toggle-container');
            
            try {
                const response = await authedFetch('/api/toggle-telegram-template', {
                    method: 'POST',
                    body: JSON.stringify({ slug, enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    toggleText.textContent = enabled ? ' Telegram' : ' Telegram';
                    container.title = enabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot';
                    const statusMsg = enabled ? 'enabled' : 'disabled';
                    showAlert('uploadAlert', `Template "${slug}" ${statusMsg} for Telegram `);
                } else {
                    checkbox.checked = !enabled;
                    showAlert('uploadAlert', 'Failed to update: ' + data.error, true);
                }
            } catch (error) {
                checkbox.checked = !enabled;
                showAlert('uploadAlert', 'Failed to update Telegram visibility: ' + error.message, true);
                console.error('Toggle error:', error);
            }
        }

        // Bulk delete
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllTemplates').checked;
            document.querySelectorAll('.template-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.template-checkbox');
            const checkedBoxes = document.querySelectorAll('.template-checkbox:checked');
            document.getElementById('selectAllTemplates').checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }

        function deleteSelectedTemplates() {
            const selected = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => ({
                slug: cb.dataset.slug,
                name: cb.dataset.name
            }));
            
            if (selected.length === 0) {
                showAlert('uploadAlert', 'No templates selected', true);
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Delete Multiple Templates?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete ${selected.length} template(s)? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                let successCount = 0;
                let failCount = 0;
                
                for (const template of selected) {
                    try {
                        const response = await authedFetch('/api/delete-template', {
                            method: 'POST',
                            body: JSON.stringify({ slug: template.slug })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                if (successCount > 0) {
                    showAlert('uploadAlert', `Successfully deleted ${successCount} template(s) `);
                }
                if (failCount > 0) {
                    showAlert('uploadAlert', `Failed to delete ${failCount} template(s)`, true);
                }
                
                loadAssets();
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        // Color selection
        function selectColor(color, variant) {
            document.querySelectorAll(`.color-swatch[data-variant="${variant}"]`).forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
            document.getElementById(variant + 'FontColor').value = color;
            updatePreviews();
        }

        // Canvas preview setup
        const previewSquareCanvas = document.getElementById('previewSquare');
        const previewStoryCanvas = document.getElementById('previewStory');
        const ctxSquare = previewSquareCanvas.getContext('2d');
        const ctxStory = previewStoryCanvas.getContext('2d');

        const previewImages = {
            square: null,
            story: null
        };

        const drawingState = {
            square: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false },
            story: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false }
        };

        function computeAutoFontPx(ctx, text, maxWidth, maxHeight, minPx) {
            let lo = minPx, hi = maxHeight;
            while (hi - lo > 1) {
                const mid = Math.floor((lo + hi) / 2);
                ctx.font = `700 ${mid}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
                const metrics = ctx.measureText(text);
                if (metrics.width <= maxWidth) {
                    lo = mid;
                } else {
                    hi = mid;
                }
            }
            return lo;
        }

        function drawTextAutoFit(ctx, text, natW, natH, box, maxPx, fontColor) {
            const left = Math.round(natW * (box.leftPct / 100));
            const top = Math.round(natH * (box.topPct / 100));
            const width = Math.round(natW * (box.widthPct / 100));
            const height = Math.round(natH * (box.heightPct / 100));

            const cap = Math.min(maxPx, height);
            const px = computeAutoFontPx(ctx, text, width, cap, 8);

            const hAlign = (box?.hAlign || 'center');
            let x = left;
            let textAlign = 'left';
            if (hAlign === 'center') {
                x = left + Math.round(width / 2);
                textAlign = 'center';
            } else if (hAlign === 'right') {
                x = left + width;
                textAlign = 'right';
            }

            const vAlign = (box?.vAlign || 'bottom');
            let y = top + px;
            if (vAlign === 'middle') {
                y = top + Math.round(height / 2) + Math.round(px * 0.35);
            } else if (vAlign === 'bottom') {
                y = top + height;
            }

            ctx.font = `700 ${px}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'alphabetic';
            ctx.lineJoin = 'round';
            ctx.lineWidth = Math.max(2, Math.floor(px * 0.08));
            ctx.strokeStyle = 'rgba(0,0,0,.75)';
            ctx.fillStyle = fontColor || '#ffffff';
            ctx.strokeText(text, x, y);
            ctx.fillText(text, x, y);
        }

        function renderPreview(variant, showBoundingBox = false) {
            const canvas = variant === 'square' ? previewSquareCanvas : previewStoryCanvas;
            const ctx = variant === 'square' ? ctxSquare : ctxStory;
            const img = previewImages[variant];

            const natW = img && img.naturalWidth ? img.naturalWidth : 1080;
            const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

            const off = document.createElement('canvas');
            off.width = natW;
            off.height = natH;
            const og = off.getContext('2d');
            og.imageSmoothingQuality = 'high';

            if (img && img.naturalWidth) {
                og.drawImage(img, 0, 0, natW, natH);
            } else {
                og.fillStyle = '#10131a';
                og.fillRect(0, 0, natW, natH);
            }

            const prefix = variant === 'square' ? 'square' : 'story';
            const box = {
                leftPct: parseFloat(document.getElementById(prefix + 'LeftPct').value) || 5,
                topPct: parseFloat(document.getElementById(prefix + 'TopPct').value) || 78,
                widthPct: parseFloat(document.getElementById(prefix + 'WidthPct').value) || 90,
                heightPct: parseFloat(document.getElementById(prefix + 'HeightPct').value) || 12,
                hAlign: 'center',
                vAlign: 'middle'
            };
            const maxFontPx = parseInt(document.getElementById(prefix + 'MaxFontPx').value) || 80;

            if (showBoundingBox) {
                const boxLeft = Math.round(natW * (box.leftPct / 100));
                const boxTop = Math.round(natH * (box.topPct / 100));
                const boxWidth = Math.round(natW * (box.widthPct / 100));
                const boxHeight = Math.round(natH * (box.heightPct / 100));
                
                og.fillStyle = 'rgba(102, 126, 234, 0.15)';
                og.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                og.strokeStyle = 'rgba(102, 126, 234, 0.6)';
                og.lineWidth = Math.max(2, Math.round(Math.min(natW, natH) * 0.003));
                og.strokeRect(boxLeft, boxTop, boxWidth, boxHeight);
            }

            const state = drawingState[variant];
            if (state.hasDrawnBox) {
                const fontColor = document.getElementById(variant + 'FontColor').value || '#FF273E';
                drawTextAutoFit(og, 'COUPON-AREA', natW, natH, box, maxFontPx, fontColor);
            }

            const targetW = Math.max(1, Math.round(canvas.parentElement.clientWidth));
            const targetH = Math.max(1, Math.round(canvas.parentElement.clientHeight));
            const pixelRatio = window.devicePixelRatio || 2;
            canvas.width = targetW * pixelRatio;
            canvas.height = targetH * pixelRatio;
            canvas.style.width = targetW + 'px';
            canvas.style.height = targetH + 'px';
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(pixelRatio, pixelRatio);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, targetW, targetH);
            
            const scale = Math.min(targetW / natW, targetH / natH);
            const dw = Math.ceil(natW * scale);
            const dh = Math.ceil(natH * scale);
            const dx = Math.round((targetW - dw) / 2);
            const dy = Math.round((targetH - dh) / 2);
            
            ctx.drawImage(off, 0, 0, natW, natH, dx, dy, dw, dh);
        }

        let updatePreviewsTimeout = null;
        function updatePreviews() {
            if (updatePreviewsTimeout) {
                clearTimeout(updatePreviewsTimeout);
            }
            updatePreviewsTimeout = setTimeout(() => {
                renderPreview('square');
                renderPreview('story');
            }, 50);
        }
        
        function updatePreviewsImmediate() {
            renderPreview('square');
            renderPreview('story');
        }

        // Image upload handlers
        document.getElementById('squareImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.square.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.square = img;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        document.getElementById('storyImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.story.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.story = img;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // Slider sync
        function setupSliderSync(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            if (!slider || !input) return;
            
            slider.addEventListener('input', function() {
                input.value = parseFloat(this.value).toFixed(1);
                updatePreviews();
            });
            
            input.addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!isNaN(val)) {
                    slider.value = val;
                }
                updatePreviews();
            });
        }

        setupSliderSync('squareMaxFontPxSlider', 'squareMaxFontPx');
        setupSliderSync('storyMaxFontPxSlider', 'storyMaxFontPx');

        // Drag-to-draw
        function setupDragToDraw(canvasId, variant) {
            const canvas = document.getElementById(canvasId);
            const state = drawingState[variant];

            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            function convertToImagePercentages(startX, startY, endX, endY) {
                const rect = canvas.getBoundingClientRect();
                const canvasDisplayWidth = rect.width;
                const canvasDisplayHeight = rect.height;

                const img = previewImages[variant];
                const natW = img && img.naturalWidth ? img.naturalWidth : (variant === 'square' ? 1080 : 1080);
                const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

                const scale = Math.min(canvasDisplayWidth / natW, canvasDisplayHeight / natH);
                const scaledImageWidth = natW * scale;
                const scaledImageHeight = natH * scale;

                const offsetX = (canvasDisplayWidth - scaledImageWidth) / 2;
                const offsetY = (canvasDisplayHeight - scaledImageHeight) / 2;

                const imgX1 = (Math.min(startX, endX) - offsetX) / scaledImageWidth;
                const imgY1 = (Math.min(startY, endY) - offsetY) / scaledImageHeight;
                const imgX2 = (Math.max(startX, endX) - offsetX) / scaledImageWidth;
                const imgY2 = (Math.max(startY, endY) - offsetY) / scaledImageHeight;

                const leftPct = Math.max(0, Math.min(100, imgX1 * 100));
                const topPct = Math.max(0, Math.min(100, imgY1 * 100));
                const widthPct = Math.max(1, Math.min(100 - leftPct, (imgX2 - imgX1) * 100));
                const heightPct = Math.max(1, Math.min(100 - topPct, (imgY2 - imgY1) * 100));

                return { leftPct, topPct, widthPct, heightPct };
            }

            function drawDragRectangle() {
                if (!state.isDrawing) return;

                const ctx = variant === 'square' ? ctxSquare : ctxStory;
                
                renderPreview(variant, true);

                const x1 = Math.min(state.startX, state.currentX);
                const y1 = Math.min(state.startY, state.currentY);
                const width = Math.abs(state.currentX - state.startX);
                const height = Math.abs(state.currentY - state.startY);

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);

                ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                ctx.fillRect(x1, y1, width, height);
                ctx.restore();
            }

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCanvasCoordinates(e);
                state.isDrawing = true;
                state.startX = coords.x;
                state.startY = coords.y;
                state.currentX = coords.x;
                state.currentY = coords.y;
                renderPreview(variant, true);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                drawDragRectangle();
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                state.isDrawing = false;

                const minDragDistance = 10;
                if (Math.abs(state.currentX - state.startX) < minDragDistance || 
                    Math.abs(state.currentY - state.startY) < minDragDistance) {
                    renderPreview(variant);
                    return;
                }

                const percentages = convertToImagePercentages(
                    state.startX, state.startY, 
                    state.currentX, state.currentY
                );

                const prefix = variant === 'square' ? 'square' : 'story';
                document.getElementById(prefix + 'LeftPct').value = percentages.leftPct.toFixed(1);
                document.getElementById(prefix + 'TopPct').value = percentages.topPct.toFixed(1);
                document.getElementById(prefix + 'WidthPct').value = percentages.widthPct.toFixed(1);
                document.getElementById(prefix + 'HeightPct').value = percentages.heightPct.toFixed(1);

                state.hasDrawnBox = true;

                updatePreviewsImmediate();
            });

            canvas.addEventListener('mouseleave', (e) => {
                if (state.isDrawing) {
                    state.isDrawing = false;
                    renderPreview(variant);
                }
            });
        }

        setupDragToDraw('previewSquare', 'square');
        setupDragToDraw('previewStory', 'story');

        // Nudge controls
        function nudgePosition(variant, direction) {
            const prefix = variant === 'square' ? 'square' : 'story';
            const leftInput = document.getElementById(prefix + 'LeftPct');
            const topInput = document.getElementById(prefix + 'TopPct');
            
            const step = 0.5;
            let currentLeft = parseFloat(leftInput.value) || 5;
            let currentTop = parseFloat(topInput.value) || 78;
            
            switch(direction) {
                case 'up':
                    currentTop = Math.max(0, currentTop - step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'down':
                    currentTop = Math.min(100, currentTop + step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'left':
                    currentLeft = Math.max(0, currentLeft - step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
                case 'right':
                    currentLeft = Math.min(100, currentLeft + step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
            }
            
            updatePreviews();
        }

        // Campaign Management
        async function loadCampaigns() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading campaigns...</p>';
            
            try {
                const response = await authedFetch('/api/campaigns');
                const data = await response.json();
                
                if (!data.campaigns || data.campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">No campaigns found</p>';
                    return;
                }
                
                campaignsList.innerHTML = '';
                data.campaigns.forEach(campaign => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <div class="asset-item-info" style="flex: 1;">
                            <div class="asset-name">${campaign.title}</div>
                            <div class="asset-slug">${campaign.description} | ${campaign.start_date} to ${campaign.end_date}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="editCampaign(${campaign.id})"></div>
                            <div class="asset-delete-icon" onclick="deleteCampaign(${campaign.id}, '${campaign.title}')"></div>
                        </div>
                    `;
                    campaignsList.appendChild(item);
                });
            } catch (error) {
                campaignsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading campaigns</p>';
                console.error('Failed to load campaigns:', error);
            }
        }

        async function handleCampaignSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('title', document.getElementById('campaignTitle').value);
            formData.append('description', document.getElementById('campaignDescription').value);
            formData.append('start_date', document.getElementById('campaignStartDate').value);
            formData.append('end_date', document.getElementById('campaignEndDate').value);
            
            const editId = document.getElementById('campaignEditId').value;
            if (editId) {
                formData.append('id', editId);
            }
            
            const overlayFile = document.getElementById('campaignOverlay').files[0];
            if (overlayFile) {
                formData.append('overlay', overlayFile);
            } else if (document.getElementById('existingOverlayUrl').value) {
                formData.append('existing_overlay_url', document.getElementById('existingOverlayUrl').value);
            }
            
            const submitBtn = document.getElementById('campaignSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = editId ? 'Updating...' : 'Creating...';
            
            try {
                const authHeaders = await getAuthHeaders();
                delete authHeaders['Content-Type'];
                const response = await fetch(editId ? '/api/edit-campaign' : '/api/create-campaign', {
                    method: 'POST',
                    headers: authHeaders,
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('campaignAlert', data.message + ' ');
                    clearCampaignForm();
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Operation failed', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Operation failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editId ? 'Update Campaign' : 'Create Campaign';
            }
        }

        async function editCampaign(id) {
            try {
                const response = await authedFetch(`/api/campaigns`);
                const data = await response.json();
                const campaign = data.campaigns.find(c => c.id === id);
                
                if (campaign) {
                    document.getElementById('campaignTitle').value = campaign.title;
                    document.getElementById('campaignDescription').value = campaign.description;
                    document.getElementById('campaignStartDate').value = campaign.start_date;
                    document.getElementById('campaignEndDate').value = campaign.end_date;
                    document.getElementById('campaignEditId').value = campaign.id;
                    
                    if (campaign.overlay_url) {
                        document.getElementById('existingOverlayUrl').value = campaign.overlay_url;
                        document.getElementById('overlayPreviewImg').src = campaign.overlay_url;
                        document.getElementById('overlayPreview').style.display = 'block';
                    }
                    
                    document.getElementById('campaignFormTitle').textContent = 'Edit Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Update Campaign';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to load campaign: ' + error.message, true);
            }
        }

        async function deleteCampaign(id, title) {
            if (!confirm(`Delete campaign "${title}"?`)) return;
            
            try {
                const response = await authedFetch('/api/delete-campaign', {
                    method: 'POST',
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('campaignAlert', 'Campaign deleted successfully ');
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Delete failed', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Delete failed: ' + error.message, true);
            }
        }

        function handleOverlayPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('overlayPreviewImg').src = e.target.result;
                    document.getElementById('overlayPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearOverlay() {
            document.getElementById('campaignOverlay').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('existingOverlayUrl').value = '';
        }

        function clearCampaignForm() {
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignEditId').value = '';
            document.getElementById('existingOverlayUrl').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
            document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
        }

        // Broadcast Functions
        async function loadBroadcastData() {
            await Promise.all([
                loadActiveUsersCount(),
                loadBroadcastHistory()
            ]);
        }

        async function loadActiveUsersCount() {
            try {
                const response = await authedFetch('/api/broadcast-jobs');
                const data = await response.json();
                
                document.getElementById('activeUsersCount').textContent = data.active_users || 0;
            } catch (error) {
                console.error('Error loading active users:', error);
                document.getElementById('activeUsersCount').textContent = '?';
            }
        }

        async function loadBroadcastHistory() {
            try {
                const response = await authedFetch('/api/broadcast-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    document.getElementById('broadcastHistory').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            No broadcasts sent yet
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Message</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Recipients</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Sent</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Failed</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.jobs.forEach(job => {
                    const statusColor = {
                        'completed': '#10b981',
                        'processing': '#3b82f6',
                        'failed': '#ef4444',
                        'pending': '#f59e0b'
                    }[job.status] || '#718096';

                    const messagePreview = job.message.length > 50 
                        ? job.message.substring(0, 50) + '...' 
                        : job.message;

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px; font-size: 14px; color: #1a202c;">${messagePreview}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                                    ${job.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #4a5568;">${job.total_users}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #10b981; font-weight: 600;">${job.sent_count}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #ef4444; font-weight: 600;">${job.failed_count}</td>
                            <td style="padding: 12px; font-size: 13px; color: #718096;">${new Date(job.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('broadcastHistory').innerHTML = html;
            } catch (error) {
                console.error('Error loading broadcast history:', error);
                document.getElementById('broadcastHistory').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Error loading broadcast history
                    </div>
                `;
            }
        }

        async function sendBroadcast(event) {
            event.preventDefault();

            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showAlert('broadcastAlert', 'Please enter a message', true);
                return;
            }

            if (!confirm(`Send this broadcast to all active users?`)) {
                return;
            }

            document.getElementById('broadcastBtnText').style.display = 'none';
            document.getElementById('broadcastBtnSpinner').style.display = 'inline-block';
            document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await authedFetch('/api/broadcast', {
                    method: 'POST',
                    body: JSON.stringify({ message, days: 30 })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('broadcastAlert', ` Broadcast started! Sending to ${data.total_users} users. Job ID: ${data.job_id}`);
                    document.getElementById('broadcastForm').reset();
                    
                    setTimeout(() => loadBroadcastHistory(), 2000);
                } else {
                    showAlert('broadcastAlert', data.error || 'Failed to send broadcast', true);
                }
            } catch (error) {
                showAlert('broadcastAlert', 'Error: ' + error.message, true);
            } finally {
                document.getElementById('broadcastBtnText').style.display = 'inline';
                document.getElementById('broadcastBtnSpinner').style.display = 'none';
                document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = false;
            }
        }

        function previewBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message first');
                return;
            }

            const htmlMessage = message
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<strong>$1</strong>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">$1</code>')
                .replace(/\n/g, '<br>');

            const previewWindow = window.open('', 'Broadcast Preview', 'width=400,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Broadcast Preview</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            padding: 20px;
                            background: #0d1117;
                            color: #fff;
                        }
                        .message {
                            background: #1c2128;
                            padding: 16px;
                            border-radius: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                        }
                        .label {
                            color: #8b949e;
                            font-size: 12px;
                            margin-bottom: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="label"> Telegram Message Preview</div>
                    <div class="message">${htmlMessage}</div>
                </body>
                </html>
            `);
        }

        // Analytics Functions
        let currentAnalyticsDays = 7;
        let analyticsChart = null;
        let allInvalidCoupons = [];
        let dayOfWeekChart = null;

        async function changeAnalyticsPeriod(days) {
            currentAnalyticsDays = days;
            
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days == days) {
                    btn.classList.add('active');
                }
            });
            
            loadAnalytics();
        }

        async function loadAnalytics() {
            try {
                const [statsResponse, retentionResponse] = await Promise.all([
                    authedFetch(`/api/bot-stats?days=${currentAnalyticsDays}`),
                    authedFetch('/api/retention-rates')
                ]);
                
                if (!statsResponse.ok) {
                    throw new Error('Failed to load analytics');
                }

                const stats = await statsResponse.json();
                const retention = retentionResponse.ok ? await retentionResponse.json() : { day1: 0, day7: 0, day30: 0 };
                renderAnalyticsStats(stats, retention);
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analytics-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Failed to load analytics. Please try again.
                    </div>
                `;
            }
        }

        function renderAnalyticsStats(stats, retention = { day1: 0, day7: 0, day30: 0 }) {
            const content = document.getElementById('analytics-content');
            
            if (stats.total_uses === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <h2>No bot usage data yet</h2>
                        <p>Start using the Telegram bot to see statistics here.</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Total Uses</div>
                        <div class="analytics-stat-value">${stats.total_uses.toLocaleString()}</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Success Rate</div>
                        <div class="analytics-stat-value">${stats.success_rate}%</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Unique Users</div>
                        <div class="analytics-stat-value">${stats.unique_users.toLocaleString()}</div>
                    </div>
                </div>

                <div class="card chart-card">
                    <div class="card-title" id="usageChartTitle">Daily Usage</div>
                    <div class="chart-container">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>
                
                <div class="section-header">
                    <h3 class="section-title"> User Retention Metrics</h3>
                    <p class="section-subtitle">Independent metrics showing % of users who return after first use (all-time data)</p>
                </div>
                
                <div class="analytics-stats-grid retention-grid">
                    <div class="analytics-stat-card retention-card-day1">
                        <div class="analytics-stat-label">Day 1 Retention</div>
                        <div class="analytics-stat-value">${retention.day1}%</div>
                        <div class="analytics-stat-subtext">Users who return within 24-48h</div>
                    </div>
                    <div class="analytics-stat-card retention-card-day7">
                        <div class="analytics-stat-label">Day 7 Retention</div>
                        <div class="analytics-stat-value">${retention.day7}%</div>
                        <div class="analytics-stat-subtext">Users who return within 7-14 days</div>
                    </div>
                    <div class="analytics-stat-card retention-card-day30">
                        <div class="analytics-stat-label">Day 30 Retention</div>
                        <div class="analytics-stat-value">${retention.day30}%</div>
                        <div class="analytics-stat-subtext">Users who return within 30-60 days</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Most Active Users</div>
                    <div id="mostActiveUsersContainer">
                        <p class="loading-text">Loading most active users...</p>
                    </div>
                </div>

                <div class="analytics-row">
                    <div class="card">
                        <div id="dayOfWeekCardTitle" class="card-title"> Most Popular Days</div>
                        <div class="chart-container">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div id="dayOfWeekStatsText" class="day-of-week-stats"></div>
                    </div>

                    <div class="card">
                        <div class="card-title"> Popular Templates</div>
                        <div class="table-container">
                            ${renderAnalyticsTemplatesTable(stats.popular_templates)}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Popular Coupon Codes</div>
                    <div class="table-container">
                        ${renderAnalyticsCouponsTable(stats.popular_coupons)}
                    </div>
                </div>

                <div class="card" style="background: #fef2f2; border: 2px solid #fee2e2;">
                    <div class="card-title"> Invalid Coupon Attempts</div>
                    <div id="invalidCouponsContainer">
                        <p class="loading-text">Loading invalid coupon attempts...</p>
                    </div>
                </div>

                ${stats.errors && stats.errors.length > 0 ? `
                    <div class="card">
                        <h2 class="card-title">Error Breakdown</h2>
                        <div class="table-container">
                            ${renderAnalyticsErrorsTable(stats.errors)}
                        </div>
                    </div>
                ` : ''}
            `;

            renderAnalyticsChart(stats.daily_usage);
            
            setTimeout(() => {
                loadInvalidCoupons();
                loadMostActiveUsers();
                loadDayOfWeekStats();
            }, 0);
        }

        function renderAnalyticsTemplatesTable(templates) {
            if (!templates || templates.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No template usage data</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Template</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${templates.map(t => `
                            <tr>
                                <td>${t.template}</td>
                                <td>${t.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsCouponsTable(coupons) {
            if (!coupons || coupons.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No coupon usage data</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Coupon Code</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coupons.map(c => `
                            <tr>
                                <td>${c.coupon}</td>
                                <td>${c.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsErrorsTable(errors) {
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Error Type</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${errors.map(e => `
                            <tr>
                                <td>${e.type.replace(/_/g, ' ').toUpperCase()}</td>
                                <td>${e.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsChart(dailyData) {
            if (analyticsChart) {
                analyticsChart.destroy();
            }

            const ctx = document.getElementById('analyticsChart');
            if (!ctx) return;
            
            const sortedData = dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));

            analyticsChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedData.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Bot Uses',
                        data: sortedData.map(d => d.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#718096' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#718096' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // Invalid Coupon Attempts
        async function loadInvalidCoupons() {
            try {
                const response = await fetch(`/api/invalid-coupons?limit=1000&offset=0&days=${currentAnalyticsDays}`);
                const data = await response.json();
                
                allInvalidCoupons = data.attempts || [];
                renderInvalidCoupons(data.attempts || [], data.total || 0);
            } catch (error) {
                console.error('Error loading invalid coupons:', error);
                document.getElementById('invalidCouponsContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load invalid coupon attempts</p>
                `;
            }
        }

        function renderInvalidCoupons(attempts, total) {
            const container = document.getElementById('invalidCouponsContainer');
            
            if (attempts.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No invalid coupon attempts</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-secondary" onclick="exportInvalidCouponsCSV()" style="padding: 8px 16px;">
                         Export CSV
                    </button>
                    <span style="color: #4a5568;"><strong>${total.toLocaleString()}</strong> total invalid attempts</span>
                </div>
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead style="background: #fecaca;">
                            <tr>
                                <th>Invalid Code</th>
                                <th>Template Used</th>
                                <th>User</th>
                                <th>Timestamp</th>
                                <th>Attempts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allInvalidCoupons.map(a => {
                                let userDisplay;
                                const fullName = [a.first_name, a.last_name].filter(Boolean).join(' ');
                                const usernameLink = a.username ? `<a href="https://t.me/${a.username}" target="_blank" class="telegram-link">@${a.username}</a>` : '';
                                
                                if (fullName && a.username) {
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (a.username) {
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    userDisplay = fullName;
                                } else {
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr>
                                        <td><code>${a.coupon_code}</code></td>
                                        <td>${a.template_name || 'N/A'}</td>
                                        <td>${userDisplay}</td>
                                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                                        <td>${a.attempt_count || 1}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportInvalidCouponsCSV() {
            if (allInvalidCoupons.length === 0) {
                alert('No invalid coupon data to export');
                return;
            }

            const csvContent = [
                ['Coupon Code', 'Template', 'Username', 'First Name', 'Last Name', 'Timestamp', 'Attempts'],
                ...allInvalidCoupons.map(a => [
                    a.coupon_code,
                    a.template_name || 'N/A',
                    a.username || '',
                    a.first_name || '',
                    a.last_name || '',
                    new Date(a.timestamp).toISOString(),
                    a.attempt_count || 1
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `invalid-coupons-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // User Details Modal
        async function showUserDetails(chatId) {
            const modal = document.getElementById('userDetailsModal');
            const content = document.getElementById('userDetailsContent');
            
            modal.classList.add('active');
            content.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">Loading user details...</p>';
            
            try {
                const response = await fetch(`/api/user-activity/${chatId}`);
                const data = await response.json();
                
                const user = data.user || {};
                const history = data.history || [];
                
                let userDisplay;
                const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ');
                const usernameLink = user.username ? `<a href="https://t.me/${user.username}" target="_blank" class="telegram-link">@${user.username}</a>` : '';
                
                if (fullName && user.username) {
                    userDisplay = `${fullName} (${usernameLink})`;
                } else if (user.username) {
                    userDisplay = usernameLink;
                } else if (fullName) {
                    userDisplay = fullName;
                } else {
                    userDisplay = 'Unknown User';
                }
                
                content.innerHTML = `
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px; color: #1a202c;">User Profile</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <strong style="color: #4a5568;">User:</strong> ${userDisplay}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Chat ID:</strong> <code>${user.chat_id}</code>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Total Generations:</strong> ${user.total_generations || 0}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Unique Coupons:</strong> ${user.unique_coupons || 0}
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 12px; color: #1a202c;">Activity History</h3>
                    ${history.length === 0 ? `
                        <p style="color: #718096; text-align: center; padding: 20px;">No activity history</p>
                    ` : `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Template</th>
                                        <th>Coupon</th>
                                        <th>Status</th>
                                        <th>Error Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${history.map(h => {
                                        const isSuccess = h.success || h.status === 'success';
                                        const statusBadge = isSuccess 
                                            ? '<span class="status-badge status-success">Success</span>'
                                            : '<span class="status-badge status-error">Failed</span>';
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(h.timestamp).toLocaleString()}</td>
                                                <td>${h.template || 'N/A'}</td>
                                                <td><code>${h.coupon_code || 'N/A'}</code></td>
                                                <td>${statusBadge}</td>
                                                <td>${h.error_type || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                content.innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 40px;">
                        Failed to load user details. Please try again.
                    </p>
                `;
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
        }

        // Most Active Users Leaderboard
        async function loadMostActiveUsers() {
            try {
                const response = await authedFetch('/api/bot-users?limit=1000&offset=0');
                const data = await response.json();
                
                renderMostActiveUsers(data.users || []);
            } catch (error) {
                console.error('Error loading most active users:', error);
                document.getElementById('mostActiveUsersContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load most active users</p>
                `;
            }
        }

        function renderMostActiveUsers(users) {
            const container = document.getElementById('mostActiveUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No user data available</p>';
                return;
            }

            const badges = ['', '', ''];
            const rankClasses = ['leaderboard-rank-1', 'leaderboard-rank-2', 'leaderboard-rank-3'];

            container.innerHTML = `
                <div class="table-scroll">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Total Gens</th>
                                <th>Unique Coupons</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((u, index) => {
                                const rank = index + 1;
                                const badge = rank <= 3 ? badges[index] : '';
                                const rankClass = rank <= 3 ? rankClasses[index] : '';
                                
                                let userDisplay;
                                const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                                const usernameLink = u.username ? `<a href="https://t.me/${u.username}" target="_blank" class="telegram-link">@${u.username}</a>` : '';
                                
                                if (fullName && u.username) {
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (u.username) {
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    userDisplay = fullName;
                                } else {
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr class="${rankClass}">
                                        <td><span class="leaderboard-rank">${badge} #${rank}</span></td>
                                        <td>${userDisplay}</td>
                                        <td>${u.total_generations || 0}</td>
                                        <td>${u.unique_coupons || 0}</td>
                                        <td>${u.first_used ? new Date(u.first_used).toLocaleDateString() : 'N/A'}</td>
                                        <td>${u.last_used ? new Date(u.last_used).toLocaleDateString() : 'N/A'}</td>
                                        <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="showUserDetails(${u.chat_id})">View Details</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Utility function to capitalize first letter
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        // Day of Week / Hour Analytics
        async function loadDayOfWeekStats() {
            try {
                const response = await fetch(`/api/day-of-week-stats?days=${currentAnalyticsDays}`);
                const result = await response.json();
                
                const titleElement = document.getElementById('dayOfWeekCardTitle');
                if (result.type === 'hourly') {
                    titleElement.textContent = ' Most Popular Hours';
                } else {
                    titleElement.textContent = ' Most Popular Days';
                }
                
                if (result.data && result.data.length > 0) {
                    renderDayOfWeekChart(result.data, result.type);
                } else {
                    const chartContainer = document.querySelector('#dayOfWeekChart').parentElement;
                    chartContainer.innerHTML = `
                        <p style="color: #718096; text-align: center; padding: 40px;">No data available yet</p>
                    `;
                    document.getElementById('dayOfWeekStatsText').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading day-of-week analytics:', error);
                const chartContainer = document.querySelector('#dayOfWeekChart')?.parentElement;
                if (chartContainer) {
                    chartContainer.innerHTML = `
                        <p style="color: #ef4444; text-align: center; padding: 40px;">Failed to load analytics</p>
                    `;
                }
                document.getElementById('dayOfWeekStatsText').innerHTML = '';
            }
        }

        function renderDayOfWeekChart(data, type) {
            if (dayOfWeekChart) {
                dayOfWeekChart.destroy();
            }

            const ctx = document.getElementById('dayOfWeekChart');
            if (!ctx) return;

            const labels = data.map(d => d.label);
            const counts = data.map(d => d.count);
            
            const maxCount = Math.max(...counts);
            const backgroundColor = counts.map(count => 
                count === maxCount && maxCount > 0 ? '#fbbf24' : '#667eea'
            );

            const totalGenerations = counts.reduce((sum, count) => sum + count, 0);
            const mostPopularLabel = maxCount > 0 ? labels[counts.indexOf(maxCount)] : null;

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bot Uses',
                        data: counts,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const isPeak = value === maxCount && maxCount > 0;
                                    return `Uses: ${value}${isPeak ? '  Peak!' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            const labelType = type === 'hourly' ? 'Hour' : 'Day';
            if (mostPopularLabel) {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong> | 
                     Most Popular ${labelType}: <strong>${mostPopularLabel}</strong> (${maxCount} uses)
                `;
            } else {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong>
                `;
            }
        }

        // Initial render
        updatePreviewsImmediate();

    </script>

    <!-- User Details Modal -->
    <div class="modal-overlay" id="userDetailsModal">
        <div class="modal-box" style="max-width: 900px;">
            <div class="modal-title">User Details</div>
            <div id="userDetailsContent" style="margin: 20px 0; max-height: 500px; overflow-y: auto;">
                <p style="color: #718096; text-align: center;">Loading user details...</p>
            </div>
            <div style="text-align: center;">
                <button class="modal-btn modal-btn-cancel" onclick="closeUserDetailsModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
