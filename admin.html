<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | PromoStack</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo img {
            width: 220px;
            height: auto;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 32px;
            color: #1a202c;
        }

        /* Dual Sidebar Dashboard Layout */
        .app-container {
            display: grid;
            grid-template-columns: 60px 240px 1fr;
            min-height: 100vh;
        }

        /* Product Switcher Sidebar - 60px */
        .product-switcher {
            width: 60px;
            background: #0f1117;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 16px;
            z-index: 1001;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        }

        .product-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
        }

        .product-icon svg {
            width: 28px;
            height: 28px;
            color: #a0aec0;
            transition: all 0.3s ease;
        }

        .product-icon:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: scale(1.05);
        }

        .product-icon:hover svg {
            color: #667eea;
        }

        .product-icon.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5), 0 0 40px rgba(118, 75, 162, 0.3);
        }

        .product-icon.active svg {
            color: #ffffff;
        }

        /* Tooltip */
        .product-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            background: #1a202c;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .product-icon:hover::after {
            opacity: 1;
        }

        /* Feature Sidebar - 240px */
        .feature-sidebar {
            width: 240px;
            background: #1a1d29;
            color: #a0aec0;
            position: fixed;
            left: 60px;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .feature-sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breadcrumb {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            font-weight: 600;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-top: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .feature-nav {
            flex: 1;
            padding: 24px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            padding: 0 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a0aec0;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            color: #fff;
            border-left-color: #667eea;
        }

        .nav-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Main Content Area */
        .main-content {
            grid-column: 3;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .content-header {
            background: white;
            padding: 32px 40px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .content-header p {
            color: #718096;
            font-size: 14px;
        }

        .content-body {
            padding: 40px;
        }

        /* View Container */
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1002;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .mobile-menu-btn svg {
            width: 22px;
            height: 22px;
            stroke: #ffffff;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Common Styles */
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: opacity 0.2s;
            color: #7c8aff;
            vertical-align: middle;
        }

        .copy-btn:hover {
            opacity: 1;
        }

        .copy-btn svg {
            display: block;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
        }

        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f7fafc;
            font-size: 14px;
            color: #2d3748;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-buy {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-sell {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-won,
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-lost {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-pending,
        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-expired {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-revoked {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-free_plan {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        /* Bot Type Badges */
        .badge-aggressive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .badge-conservative {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .badge-custom {
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }
        
        .badge-legacy {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        /* Active Signal Banner */
        .active-signal-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .active-signal-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(102, 126, 234, 0); }
        }
        
        .active-signal-info {
            flex: 1;
        }
        
        .active-signal-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .active-signal-details {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .active-signal-meta {
            text-align: right;
        }
        
        .active-signal-time {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .active-signal-breakeven {
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Bot Settings Styles */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }
        
        @media (max-width: 900px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card-description {
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .bot-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .bot-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bot-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .bot-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .bot-option.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .bot-option-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .bot-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .bot-option-icon.aggressive {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .bot-option-icon.conservative {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .bot-option-icon.custom {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
        }
        
        .bot-option-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .bot-option-description {
            font-size: 13px;
            color: #718096;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .bot-option-indicators {
            font-size: 11px;
            color: #a0aec0;
            font-family: monospace;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-info {
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-label {
            color: #718096;
            font-size: 13px;
        }
        
        .status-value {
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
            text-transform: capitalize;
        }
        
        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
        }
        
        .bot-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .bot-stat {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .bot-stat-label {
            color: #718096;
        }
        
        .bot-stat-value {
            font-weight: 600;
            color: #2d3748;
        }

        /* Multi-TP Configuration Styles */
        .tp-config-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
        }
        
        .tp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .tp-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tp-count-selector {
            display: flex;
            gap: 8px;
        }
        
        .tp-count-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tp-count-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .tp-count-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }
        
        .tp-levels {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .tp-level {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .tp-level.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .tp-level-badge {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .tp-level-badge.tp1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .tp-level-badge.tp2 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .tp-level-badge.tp3 {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .tp-level-info {
            flex: 1;
        }
        
        .tp-level-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 2px;
        }
        
        .tp-level-desc {
            font-size: 12px;
            color: #64748b;
        }
        
        .tp-level-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tp-pct-input {
            width: 70px;
            height: 40px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            background: white;
            transition: all 0.2s;
        }
        
        .tp-pct-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        .tp-pct-label {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
        }
        
        .tp-total {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .tp-total-label {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }
        
        .tp-total-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .tp-total-value.valid {
            color: #10b981;
        }
        
        .tp-total-value.invalid {
            color: #ef4444;
        }
        
        .settings-section {
            margin-bottom: 32px;
        }
        
        .settings-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .settings-card-modern {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .strategy-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .strategy-card {
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            background: white;
        }
        
        .strategy-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
        }
        
        .strategy-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }
        
        .strategy-card.active-strategy {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
        }
        
        .strategy-card.active-strategy::after {
            content: 'ACTIVE';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 10px;
            font-weight: 700;
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        
        .strategy-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .strategy-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .strategy-icon.aggressive {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .strategy-icon.conservative {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .strategy-icon.custom {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
        }
        
        .strategy-name {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 6px;
        }
        
        .strategy-desc {
            font-size: 12px;
            color: #64748b;
            line-height: 1.5;
        }
        
        .guardrails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .guardrail-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .guardrail-label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .guardrail-input {
            width: 100%;
            height: 44px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0 12px;
            font-size: 15px;
            font-weight: 500;
            color: #1a202c;
            background: white;
            transition: all 0.2s;
        }
        
        .guardrail-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        .guardrail-hint {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
        }
        
        .session-hours-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-hours-row input {
            width: 70px;
        }
        
        .session-hours-row span {
            color: #64748b;
            font-size: 13px;
        }
        
        .status-card-modern {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 14px;
        }
        
        .status-item-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .status-item-value {
            font-size: 15px;
            font-weight: 600;
            color: white;
        }
        
        .status-item-value.positive {
            color: #10b981;
        }
        
        .status-item-value.negative {
            color: #ef4444;
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .custom-modal-overlay.active {
            display: flex;
        }
        .custom-modal {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .custom-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
        }
        .custom-modal-message {
            color: #a0a0b0;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .custom-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .custom-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .custom-modal-btn-cancel {
            background: #3d3d4d;
            color: #fff;
        }
        .custom-modal-btn-cancel:hover {
            background: #4d4d5d;
        }
        .custom-modal-btn-confirm {
            background: #7c3aed;
            color: #fff;
        }
        .custom-modal-btn-confirm:hover {
            background: #6d28d9;
        }
        .custom-modal-btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .custom-modal-btn-danger:hover {
            background: #dc2626;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .stat-value.positive {
            color: #48bb78;
        }

        .stat-value.negative {
            color: #f56565;
        }

        .stat-subtext {
            font-size: 12px;
            color: #a0aec0;
        }

        /* Analytics Chart Card */
        .chart-card {
            margin: 24px 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .day-of-week-stats {
            margin-top: 20px;
            text-align: center;
            color: #4a5568;
        }

        /* Section Headers */
        .section-header {
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-title {
            margin: 0;
            color: #1a202c;
            font-size: 18px;
        }

        .section-subtitle {
            margin: 8px 0 0 0;
            color: #718096;
            font-size: 13px;
        }

        /* Retention Grid */
        .retention-grid {
            margin-bottom: 24px;
        }

        .retention-card-day1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .retention-card-day7 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .retention-card-day30 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .retention-card-day1 .analytics-stat-label,
        .retention-card-day7 .analytics-stat-label,
        .retention-card-day30 .analytics-stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .retention-card-day1 .analytics-stat-value,
        .retention-card-day7 .analytics-stat-value,
        .retention-card-day30 .analytics-stat-value {
            color: white;
        }

        .analytics-stat-subtext {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            margin-top: 4px;
        }

        .loading-text {
            color: #718096;
            text-align: center;
            padding: 20px;
        }

        /* Analytics Stats Grid */
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .analytics-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 24px;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .analytics-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
        }

        .analytics-stat-label {
            font-size: 13px;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Analytics Tables */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .analytics-table thead {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .analytics-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-size: 14px;
        }

        .analytics-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .analytics-table tbody tr:hover {
            background: #f8fafc;
        }

        .analytics-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Scrollable Table Container */
        .table-scroll {
            max-height: 360px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Side-by-side layout for Analytics */
        .analytics-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .analytics-row .card {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 1024px) {
            .analytics-row {
                flex-direction: column;
            }
            
            .analytics-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (max-width: 768px) {
            .analytics-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table thead {
            background: #f7fafc;
        }

        .leaderboard-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .leaderboard-table tbody tr {
            transition: transform 0.2s;
        }

        .leaderboard-table tbody tr:hover {
            transform: scale(1.01);
        }

        .leaderboard-rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%) !important;
        }

        .leaderboard-rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15) 0%, rgba(192, 192, 192, 0.05) 100%) !important;
        }

        .leaderboard-rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15) 0%, rgba(205, 127, 50, 0.05) 100%) !important;
        }

        .leaderboard-rank {
            font-weight: 700;
            font-size: 16px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Telegram Link */
        .telegram-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }

        /* Placeholder */
        .placeholder-view {
            text-align: center;
            padding: 80px 20px;
        }

        .placeholder-view h2 {
            font-size: 24px;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .placeholder-view p {
            color: #718096;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #a0a0b0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .product-switcher,
            .feature-sidebar {
                transform: translateX(-100%);
            }

            .product-switcher.mobile-open,
            .feature-sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: 60px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .content-header {
                padding: 20px 16px;
            }

            .content-header h1 {
                font-size: 22px;
            }

            .content-body {
                padding: 16px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 15px;
            color: #718096;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #edf2f7;
            color: #4a5568;
        }

        .modal-btn-cancel:hover {
            background: #e2e8f0;
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
        }

        /* Filter row */
        .filters-row {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        /* Template Manager Styles */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #718096;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hint {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 6px;
        }

        .row {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .template-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        @media (max-width: 968px) {
            .section-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-label {
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-frame {
            position: relative;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-frame.square {
            aspect-ratio: 1 / 1;
            max-width: 400px;
        }

        .preview-frame.story {
            aspect-ratio: 9 / 16;
            max-width: 300px;
        }

        .preview-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 13px;
            color: #a0aec0;
            text-align: center;
            pointer-events: none;
            z-index: 1;
        }

        .preview-frame canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }

        .color-picker-group {
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .color-picker-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
        }

        .color-swatches {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .color-swatches > div {
            text-align: center;
        }

        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .color-swatch.red {
            background: #FF273E;
        }

        .color-swatch.white {
            background: #FFFFFF;
            border: 2px solid #e2e8f0;
        }

        .color-swatch-label {
            font-size: 11px;
            color: #718096;
            margin-top: 6px;
            font-weight: 600;
        }

        .nudge-controls {
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .nudge-controls-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            text-align: center;
        }

        .nudge-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
        }

        .nudge-btn {
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: #667eea;
        }

        .nudge-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .nudge-btn.nudge-up {
            grid-column: 2;
        }

        .nudge-btn.nudge-left {
            grid-column: 1;
            grid-row: 2;
        }

        .nudge-btn.nudge-right {
            grid-column: 3;
            grid-row: 2;
        }

        .nudge-btn.nudge-down {
            grid-column: 2;
            grid-row: 3;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        /* Assets List Styles */
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .delete-selected-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .asset-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .asset-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .asset-item-info {
            flex: 1;
        }

        .asset-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .asset-slug {
            font-size: 13px;
            color: #a0aec0;
            font-family: 'Courier New', monospace;
        }

        .telegram-toggle-container {
            display: flex;
            align-items: center;
        }

        .telegram-toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        .telegram-toggle-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .telegram-toggle-slider {
            width: 48px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }

        .telegram-toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .telegram-toggle-checkbox:checked + .telegram-toggle-slider {
            background: #10b981;
        }

        .telegram-toggle-checkbox:checked + .telegram-toggle-slider::before {
            transform: translateX(24px);
        }

        .telegram-toggle-text {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            min-width: 80px;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .asset-edit-icon,
        .asset-delete-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .asset-edit-icon {
            background: #edf2f7;
            color: #667eea;
        }

        .asset-edit-icon:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .asset-delete-icon {
            background: #fed7d7;
            color: #ef4444;
        }

        .asset-delete-icon:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        /* Modal Icon */
        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Analytics Filter Buttons */
        .analytics-filter-btn {
            padding: 10px 20px;
            background: #edf2f7;
            color: #4a5568;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
        }

        .analytics-filter-btn:hover {
            background: #e2e8f0;
        }

        .analytics-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        /* Table Container */
        .table-container {
            overflow-x: auto;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Subscription Detail Modal - Dark Theme */
        .subscription-detail-modal {
            background: #1a1d29;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .detail-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .detail-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #a0aec0;
        }

        .detail-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .detail-modal-body {
            padding: 24px 28px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 13px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            min-width: 140px;
        }

        .detail-value {
            font-size: 14px;
            color: #e2e8f0;
            text-align: right;
            word-break: break-word;
            flex: 1;
            margin-left: 16px;
        }

        .detail-value a {
            color: #667eea;
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .subscription-detail-modal .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .subscription-detail-modal::-webkit-scrollbar {
            width: 8px;
        }

        .subscription-detail-modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .subscription-detail-modal::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        .subscription-detail-modal::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Billing Section Styles */
        .billing-divider {
            margin: 20px 0;
            padding-top: 20px;
            border-top: 2px solid rgba(102, 126, 234, 0.3);
        }

        .billing-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-section-title::before {
            content: '';
        }

        .billing-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #a0aec0;
            font-size: 14px;
            gap: 12px;
        }

        .billing-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: billing-spin 0.8s linear infinite;
        }

        @keyframes billing-spin {
            to { transform: rotate(360deg); }
        }

        .billing-error {
            padding: 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #f87171;
            font-size: 13px;
            text-align: center;
        }

        .billing-na {
            padding: 16px;
            background: rgba(107, 114, 128, 0.1);
            border: 1px solid rgba(107, 114, 128, 0.3);
            border-radius: 8px;
            color: #9ca3af;
            font-size: 13px;
            text-align: center;
        }

        /* Stripe Status Badges */
        .stripe-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stripe-status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .stripe-status-past_due {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .stripe-status-canceled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stripe-status-unpaid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stripe-status-trialing {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .stripe-status-incomplete {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .stripe-status-incomplete_expired {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .stripe-status-paused {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .cancel-warning {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 146, 60, 0.3);
            border-radius: 6px;
            color: #fb923c;
            font-size: 12px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Login Page (hidden initially to prevent flash) -->
    <div class="login-page hidden" id="loginPage">
        <div class="login-logo">
            <img src="/assets/promostack-logo.png" alt="PromoStack" />
        </div>
        <div class="login-card">
            <h1 class="login-title"> Admin Login</h1>
            <div id="loginAlert"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 12px;">Login</button>
                <a href="https://dash.promostack.io" class="btn btn-secondary" style="width: 100%; display: block; text-align: center; text-decoration: none;">Visit Frontend</a>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="app-container hidden" id="dashboard">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

        <!-- Product Switcher Sidebar (60px) -->
        <aside class="product-switcher" id="productSwitcher">
            <div class="product-icon active" data-tooltip="Coupon Bot" onclick="switchProduct('coupon')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
                </svg>
            </div>
            <div class="product-icon" data-tooltip="Forex Signals Bot" onclick="switchProduct('forex')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                </svg>
            </div>
        </aside>

        <!-- Feature Sidebar (240px) -->
        <aside class="feature-sidebar" id="featureSidebar">
            <div class="feature-sidebar-header">
                <div class="breadcrumb">Dashboard</div>
                <div class="product-name" id="productName">Coupon Bot</div>
            </div>

            <nav class="feature-nav" id="featureNav">
                <!-- Navigation will be populated by JavaScript -->
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="handleLogout()">
                    <span></span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Coupon Bot Views -->
            <div id="coupon-templates" class="view-container active">
                <div class="content-header">
                    <h1>Template Manager</h1>
                    <p>Upload and manage your promotional templates with drag-to-draw coupon positioning</p>
                </div>

                <div class="content-body">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('upload')">Upload Template</button>
                        <button class="tab" onclick="switchTab('assets')">Current Assets</button>
                    </div>

                    <!-- Upload Tab -->
                    <div id="uploadTab" class="tab-content active">
                        <div id="uploadAlert"></div>

                        <form id="templateForm" onsubmit="handleUpload(event)">
                            <div class="card">
                                <div class="form-group">
                                    <label for="name">Template Name *</label>
                                    <input type="text" id="name" required placeholder="e.g., Flash Sale">
                                    <div class="hint">This will appear in the dropdown</div>
                                </div>

                                <div class="form-group" style="display: none;">
                                    <label for="slug">Slug *</label>
                                    <input type="text" id="slug" required pattern="[a-z0-9-]+" placeholder="e.g., flash-sale">
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Square Image (1:1)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="squareImage">Square PNG (optional)</label>
                                            <input type="file" id="squareImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="squareLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="squareHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="squareMaxFontPx">Font Size</label>
                                            <input type="range" id="squareMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="squareMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="squareShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('square', 'up')"></button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('square', 'left')"></button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('square', 'right')"></button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('square', 'down')"></button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="square" onclick="selectColor('#FF273E', 'square')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="square" onclick="selectColor('#FFFFFF', 'square')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame square">
                                            <div class="preview-hint"> Click and draw coupon area</div>
                                            <canvas id="previewSquare"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Story Image (9:16)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="storyImage">Portrait PNG (optional)</label>
                                            <input type="file" id="storyImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="storyLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="storyHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="storyMaxFontPx">Font Size</label>
                                            <input type="range" id="storyMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="storyMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="storyShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('story', 'up')"></button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('story', 'left')"></button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('story', 'right')"></button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('story', 'down')"></button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="story" onclick="selectColor('#FF273E', 'story')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="story" onclick="selectColor('#FFFFFF', 'story')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame story">
                                            <div class="preview-hint"> Click and draw coupon area</div>
                                            <canvas id="previewStory"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="squareFontColor" value="#FF273E">
                            <input type="hidden" id="storyFontColor" value="#FF273E">
                            <input type="hidden" id="isEditing" value="false">

                            <div style="display: flex; gap: 12px;">
                                <button type="button" class="btn btn-secondary" onclick="clearTemplateForm()">New Template</button>
                                <button type="submit" class="btn" id="submitBtn">Upload Template</button>
                            </div>
                        </form>
                    </div>

                    <!-- Assets Tab -->
                    <div id="assetsTab" class="tab-content">
                        <div class="assets-header">
                            <label class="select-all-container">
                                <input type="checkbox" id="selectAllTemplates" onchange="toggleSelectAll()">
                                <span>Select All</span>
                            </label>
                            <button type="button" class="delete-selected-btn" onclick="deleteSelectedTemplates()">Delete Selected</button>
                        </div>
                        <div id="assetsList" class="assets-list">
                            <p style="color: #718096; text-align: center;">Loading templates...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-analytics" class="view-container">
                <div class="content-header">
                    <h1> Bot Analytics</h1>
                    <p>Track your Telegram bot usage and performance</p>
                </div>

                <div class="content-body">
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="analytics-filter-btn" data-days="today" onclick="changeAnalyticsPeriod('today')">Today</button>
                            <button class="analytics-filter-btn" data-days="yesterday" onclick="changeAnalyticsPeriod('yesterday')">Yesterday</button>
                            <button class="analytics-filter-btn active" data-days="7" onclick="changeAnalyticsPeriod(7)">Last 7 Days</button>
                            <button class="analytics-filter-btn" data-days="30" onclick="changeAnalyticsPeriod(30)">Last 30 Days</button>
                            <button class="analytics-filter-btn" data-days="90" onclick="changeAnalyticsPeriod(90)">Last 90 Days</button>
                        </div>
                    </div>

                    <div id="analytics-content">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            Loading statistics...
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-broadcast" class="view-container">
                <div class="content-header">
                    <h1> Broadcast Messages</h1>
                    <p>Send announcements to all active Telegram bot users</p>
                </div>

                <div class="content-body">
                    <!-- Active Users Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Active Users</div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="activeUsersCount">
                                <div class="spinner"></div>
                            </div>
                            <div style="color: #718096; margin-top: 8px;">users active in the last 30 days</div>
                        </div>
                    </div>

                    <!-- Broadcast Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Send Broadcast</div>
                        <div id="broadcastAlert"></div>
                        
                        <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                            <div class="form-group">
                                <label for="broadcastMessage">Message</label>
                                <textarea 
                                    id="broadcastMessage" 
                                    rows="6" 
                                    required 
                                    placeholder=" New templates available! Use /generate to create promotional images with your saved coupon code."
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                                <div class="hint">Supports Markdown formatting (*bold*, _italic_, `code`)</div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="previewBroadcast()">Preview</button>
                                <button type="submit" class="btn">
                                    <span id="broadcastBtnText">Send Broadcast</span>
                                    <span id="broadcastBtnSpinner" class="spinner" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Broadcast History -->
                    <div class="card">
                        <div class="card-title">Broadcast History</div>
                        <div id="broadcastHistory">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading broadcast history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-campaigns" class="view-container">
                <div class="content-header">
                    <h1> Campaigns</h1>
                    <p>Create and manage promotional campaigns with user submissions</p>
                </div>

                <div class="content-body">
                    <!-- Campaign Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" id="campaignFormTitle">Create Campaign</div>
                        <div id="campaignAlert"></div>
                        
                        <form id="campaignForm" onsubmit="handleCampaignSubmit(event)">
                            <div class="form-group">
                                <label for="campaignTitle">Campaign Title *</label>
                                <input type="text" id="campaignTitle" required placeholder="e.g., Summer Sale 2024">
                            </div>

                            <div class="form-group">
                                <label for="campaignDescription">Description *</label>
                                <textarea 
                                    id="campaignDescription" 
                                    rows="3" 
                                    required 
                                    placeholder="Brief description of the campaign"
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="campaignStartDate">Start Date *</label>
                                    <input type="date" id="campaignStartDate" required>
                                </div>

                                <div class="form-group">
                                    <label for="campaignEndDate">End Date *</label>
                                    <input type="date" id="campaignEndDate" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="campaignOverlay">Overlay Image (Optional)</label>
                                <input type="file" id="campaignOverlay" accept="image/*" onchange="handleOverlayPreview(event)">
                                <div class="hint">Upload an image to overlay on generated coupons</div>
                            </div>

                            <div id="overlayPreview" style="display: none; margin-top: 12px;">
                                <div style="position: relative; display: inline-block;">
                                    <img id="overlayPreviewImg" style="max-width: 200px; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    <button type="button" onclick="clearOverlay()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                </div>
                            </div>

                            <input type="hidden" id="campaignEditId" value="">
                            <input type="hidden" id="existingOverlayUrl" value="">

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="clearCampaignForm()">Reset</button>
                                <button type="submit" class="btn" id="campaignSubmitBtn">Create Campaign</button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Campaigns -->
                    <div class="card">
                        <div class="card-title">Active Campaigns</div>
                        <div id="campaignsList">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading campaigns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="coupon-settings" class="view-container">
                <div class="content-header">
                    <h1>Settings</h1>
                    <p>Configure Coupon Bot settings</p>
                </div>
                <div class="content-body">
                    <div class="placeholder-view">
                        <h2> Settings Coming Soon</h2>
                        <p>Settings configuration will be available soon</p>
                    </div>
                </div>
            </div>

            <!-- Forex Bot Views -->
            <div id="forex-subscriptions" class="view-container">
                <div class="content-header">
                    <h1>Telegram Subscriptions</h1>
                    <p>Manage EntryLab subscriber access to private channel</p>
                </div>
                <div class="content-body">
                    <div class="controls" style="margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 300px;">
                            <input type="text" id="subscriptionSearchInput" placeholder="Search by email, name, or Stripe ID..." style="width: 100%;" oninput="searchSubscriptions(this.value)">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn active" data-status="all" onclick="filterSubscriptions('all')">All</button>
                            <button class="btn btn-secondary" data-status="active" onclick="filterSubscriptions('active')">Active</button>
                            <button class="btn btn-secondary" data-status="free_plan" onclick="filterSubscriptions('free_plan')">Free Plan</button>
                            <button class="btn btn-secondary" data-status="revoked" onclick="filterSubscriptions('revoked')">Revoked</button>
                        </div>
                    </div>
                    <div id="subscriptionStats" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Paid Subscribers</div>
                            <div class="stat-value" id="paidSubscribers">--</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Active</div>
                            <div class="stat-value" id="activeSubscribers">--</div>
                            <div class="stat-subtext">Joined channel</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Free Plan</div>
                            <div class="stat-value" id="freePlanSubscribers">--</div>
                            <div class="stat-subtext">Email captured</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Net Revenue</div>
                            <div class="stat-value" id="netRevenue">$--</div>
                            <div class="stat-subtext" id="netRevenueSubtext">All time</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Rebill This Month</div>
                            <div class="stat-value" id="monthlyRebill">$--</div>
                            <div class="stat-subtext">Expected renewals</div>
                        </div>
                    </div>
                    <div class="card">
                        <div id="subscriptionsContent">
                            <div class="loading">Loading subscriptions...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forex-conversions" class="view-container">
                <div class="content-header">
                    <h1>Conversion Analytics</h1>
                    <p>Track free-to-VIP conversions and marketing attribution</p>
                </div>
                <div class="content-body">
                    <div id="conversionStats" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Total Free Leads</div>
                            <div class="stat-value" id="totalFreeLeads">--</div>
                            <div class="stat-subtext">Free signups</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Total Conversions</div>
                            <div class="stat-value" id="totalConversions">--</div>
                            <div class="stat-subtext">Upgraded to VIP</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Conversion Rate</div>
                            <div class="stat-value" id="conversionRate">--%</div>
                            <div class="stat-subtext">Free to VIP</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Avg Days to Convert</div>
                            <div class="stat-value" id="avgConversionDays">--</div>
                            <div class="stat-subtext">Free to paid</div>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 150px;">
                            <div class="stat-label">Conversion Revenue</div>
                            <div class="stat-value" id="conversionRevenue">$--</div>
                            <div class="stat-subtext">From converted users</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Leads by Source</div>
                        <div id="leadsBySource" style="padding: 20px;">
                            <div class="loading">Loading lead attribution...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Revenue by Source</div>
                        <div id="revenueBySource" style="padding: 20px;">
                            <div class="loading">Loading attribution data...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-title">Revenue by Campaign</div>
                        <div id="revenueByCampaign" style="padding: 20px;">
                            <div class="loading">Loading campaign data...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Recent Conversions</div>
                        <div id="recentConversions" style="padding: 20px;">
                            <div class="loading">Loading conversions...</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-title">All Leads</div>
                        <div id="allLeadsTable" style="padding: 20px; overflow-x: auto;">
                            <div class="loading">Loading leads...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forex-signals" class="view-container">
                <div class="content-header">
                    <h1>Forex Signals Monitor</h1>
                    <p>XAU/USD trading signals with live performance metrics</p>
                </div>
                <div class="content-body">
                    <div id="activeSignalBanner" class="active-signal-banner" style="display: none;">
                        <div class="active-signal-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="active-signal-info">
                            <div class="active-signal-title">Active Signal</div>
                            <div class="active-signal-details" id="activeSignalDetails">Loading...</div>
                        </div>
                        <div class="active-signal-meta">
                            <div class="active-signal-time" id="activeSignalTime"></div>
                            <div class="active-signal-breakeven" id="activeSignalBreakeven"></div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="winRate">--%</div>
                            <div class="stat-subtext" id="winRateSubtext">Loading...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Pips</div>
                            <div class="stat-value" id="totalPips">--</div>
                            <div class="stat-subtext">Net profit/loss</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Signals</div>
                            <div class="stat-value" id="totalSignals">--</div>
                            <div class="stat-subtext" id="signalsBreakdown">Loading...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Bot</div>
                            <div class="stat-value" id="activeBotType" style="text-transform: capitalize;">--</div>
                            <div class="stat-subtext" id="activeBotSubtext">Strategy mode</div>
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Bot Type</label>
                            <select id="filterBotType">
                                <option value="all">All Bots</option>
                                <option value="aggressive">Aggressive</option>
                                <option value="conservative">Conservative</option>
                                <option value="custom">Custom</option>
                                <option value="legacy">Legacy</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Signal Type</label>
                            <select id="filterType">
                                <option value="all">All Signals</option>
                                <option value="BUY">BUY Only</option>
                                <option value="SELL">SELL Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="won">Won</option>
                                <option value="lost">Lost</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Limit</label>
                            <select id="filterLimit">
                                <option value="50">Last 50</option>
                                <option value="100" selected>Last 100</option>
                                <option value="200">Last 200</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Trading Signals</h2>
                        <div id="signalsTableContent">
                            <div class="loading">Loading signals...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="forex-performance" class="view-container">
                <div class="content-header">
                    <h1>Performance Stats</h1>
                    <p>Detailed performance analytics</p>
                </div>
                <div class="content-body">
                    <div class="placeholder-view">
                        <h2> Performance Stats Coming Soon</h2>
                        <p>Detailed performance analytics will be available soon</p>
                    </div>
                </div>
            </div>

            <div id="forex-settings" class="view-container">
                <div class="content-header">
                    <h1>Bot Settings</h1>
                    <p>Configure your trading strategy and risk management</p>
                </div>
                <div class="content-body">
                    <div id="botSwitchError" class="alert alert-error" style="display: none;"></div>
                    <div id="botSwitchSuccess" class="alert alert-success" style="display: none;"></div>
                    <div id="guardrailError" class="alert alert-error" style="display: none;"></div>
                    <div id="guardrailSuccess" class="alert alert-success" style="display: none;"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 340px; gap: 24px;">
                        <div>
                            <div class="settings-section">
                                <div class="settings-section-title">Strategy Selection</div>
                                <div class="strategy-cards">
                                    <div class="strategy-card" data-bot="aggressive" onclick="selectBot('aggressive')">
                                        <div class="strategy-icon aggressive">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Aggressive</div>
                                        <div class="strategy-desc">High frequency with momentum-based entries</div>
                                    </div>
                                    
                                    <div class="strategy-card" data-bot="conservative" onclick="selectBot('conservative')">
                                        <div class="strategy-icon conservative">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Conservative</div>
                                        <div class="strategy-desc">Confirmed trends with multi-indicator alignment</div>
                                    </div>
                                    
                                    <div class="strategy-card" data-bot="custom" onclick="selectBot('custom')">
                                        <div class="strategy-icon custom">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                                            </svg>
                                        </div>
                                        <div class="strategy-name">Custom</div>
                                        <div class="strategy-desc">Configurable thresholds you control</div>
                                    </div>
                                </div>
                                <button id="switchBotBtn" class="btn-primary" onclick="switchActiveBot()" disabled style="margin-top: 16px;">
                                    <span id="switchBotBtnText">Select a strategy to switch</span>
                                </button>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-title">Take Profit Configuration</div>
                                <div class="tp-config-card">
                                    <div class="tp-header">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                                            </svg>
                                            TP Levels
                                        </h3>
                                        <div class="tp-count-selector">
                                            <button class="tp-count-btn" data-count="1" onclick="setTpCount(1)">1</button>
                                            <button class="tp-count-btn" data-count="2" onclick="setTpCount(2)">2</button>
                                            <button class="tp-count-btn active" data-count="3" onclick="setTpCount(3)">3</button>
                                        </div>
                                    </div>
                                    
                                    <div class="tp-levels">
                                        <div class="tp-level" id="tpLevel1">
                                            <div class="tp-level-badge tp1">TP1</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">First Target</div>
                                                <div class="tp-level-desc">Quick profit lock-in</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp1Pct" value="50" min="10" max="100" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tp-level" id="tpLevel2">
                                            <div class="tp-level-badge tp2">TP2</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">Second Target</div>
                                                <div class="tp-level-desc">Extended move capture</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp2Pct" value="30" min="0" max="90" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="tp-level" id="tpLevel3">
                                            <div class="tp-level-badge tp3">TP3</div>
                                            <div class="tp-level-info">
                                                <div class="tp-level-title">Final Target</div>
                                                <div class="tp-level-desc">Maximum profit zone</div>
                                            </div>
                                            <div class="tp-level-input">
                                                <input type="number" class="tp-pct-input" id="tp3Pct" value="20" min="0" max="80" onchange="updateTpTotal()">
                                                <span class="tp-pct-label">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="tp-total">
                                        <span class="tp-total-label">Total Position</span>
                                        <span class="tp-total-value valid" id="tpTotalValue">100%</span>
                                    </div>
                                    
                                    <button class="btn-primary" onclick="saveTpConfig()" style="margin-top: 16px;">
                                        Save TP Configuration
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-title">Risk Management</div>
                                <div class="settings-card-modern">
                                    <div class="guardrails-grid">
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                                </svg>
                                                Daily Loss Cap
                                            </label>
                                            <input type="number" class="guardrail-input" id="dailyLossCap" value="50" min="10" max="200" step="5">
                                            <div class="guardrail-hint">Stop signals after losing this many pips</div>
                                        </div>
                                        
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Loss Throttle
                                            </label>
                                            <input type="number" class="guardrail-input" id="backToBackThrottle" value="30" min="5" max="120" step="5">
                                            <div class="guardrail-hint">Minutes to wait after a loss</div>
                                        </div>
                                        
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                                                </svg>
                                                Session Window
                                            </label>
                                            <select class="guardrail-input" id="sessionFilterEnabled">
                                                <option value="true">London/NY Hours Only</option>
                                                <option value="false">24/5 Trading</option>
                                            </select>
                                            <div class="guardrail-hint">High-liquidity session filter</div>
                                        </div>
                                        
                                        <div class="guardrail-item">
                                            <label class="guardrail-label">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                                </svg>
                                                Session Hours (UTC)
                                            </label>
                                            <div class="session-hours-row">
                                                <input type="number" class="guardrail-input" id="sessionStartHour" value="8" min="0" max="23">
                                                <span>to</span>
                                                <input type="number" class="guardrail-input" id="sessionEndHour" value="21" min="0" max="23">
                                            </div>
                                            <div class="guardrail-hint">Default: 8-21 UTC</div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn-primary" onclick="saveGuardrails()" style="margin-top: 20px;">
                                        Save Risk Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="status-card-modern" style="position: sticky; top: 24px;">
                                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #e2e8f0;">Live Status</h3>
                                <div class="status-grid">
                                    <div class="status-item">
                                        <div class="status-item-label">Active Bot</div>
                                        <div class="status-item-value" id="settingsActiveBot" style="text-transform: capitalize;">--</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Open Signal</div>
                                        <div class="status-item-value" id="settingsOpenSignal">None</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Daily P/L</div>
                                        <div class="status-item-value" id="dailyPnlDisplay">--</div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-item-label">Session</div>
                                        <div class="status-item-value" id="currentSessionDisplay">--</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <h4 style="font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Signals by Bot</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Aggressive</span>
                                            <span style="font-weight: 600; color: #f56565;" id="aggressiveCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Conservative</span>
                                            <span style="font-weight: 600; color: #48bb78;" id="conservativeCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Custom</span>
                                            <span style="font-weight: 600; color: #667eea;" id="customCount">--</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #94a3b8;">Legacy</span>
                                            <span style="font-weight: 600; color: #a0aec0;" id="legacyCount">--</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                        <span style="color: #94a3b8;">Last Signal</span>
                                        <span style="font-weight: 500; color: #e2e8f0;" id="lastSignalDisplay">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="modal-box">
            <div class="modal-title">Subscription Details</div>
            <div id="modalDetails"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('subscriptionModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon"></div>
            <div class="modal-title" id="modalTitle">Delete Template?</div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Subscription Detail Modal (Dark Theme) -->
    <div class="modal-overlay" id="subscriptionDetailModal">
        <div class="subscription-detail-modal">
            <div class="detail-modal-header">
                <h2 class="detail-modal-title">Subscriber Details</h2>
                <button class="detail-modal-close" onclick="closeSubscriptionDetailModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="detail-modal-body" id="subscriptionDetailContent">
            </div>
        </div>
    </div>

    <!-- Custom Confirm/Alert Modal -->
    <div class="custom-modal-overlay" id="customModal">
        <div class="custom-modal">
            <div class="custom-modal-title" id="customModalTitle">Confirm Action</div>
            <div class="custom-modal-message" id="customModalMessage"></div>
            <div class="custom-modal-buttons" id="customModalButtons"></div>
        </div>
    </div>

    <script>
        // App State Management
        const appState = {
            activeProduct: 'coupon',
            activeView: 'templates',
            isLoggedIn: false,
            isMobileMenuOpen: false
        };

        // Product Navigation Structure
        const productNavigation = {
            coupon: [
                { id: 'templates', label: 'Templates', icon: 'M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42' },
                { id: 'analytics', label: 'Analytics', icon: 'M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z' },
                { id: 'broadcast', label: 'Broadcast', icon: 'M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46' },
                { id: 'campaigns', label: 'Campaigns', icon: 'M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0l-5.571 3-5.571-3' },
                { id: 'settings', label: 'Settings', icon: 'M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28ZM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z' }
            ],
            forex: [
                { id: 'subscriptions', label: 'Subscriptions', icon: 'M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z' },
                { id: 'conversions', label: 'Conversions', icon: 'M2.25 18L9 11.25l4.306 4.306a11.95 11.95 0 015.814-5.518l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941' },
                { id: 'signals', label: 'Signals Monitor', icon: 'M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941' },
                { id: 'performance', label: 'Performance Stats', icon: 'M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z' },
                { id: 'settings', label: 'Settings', icon: 'M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28ZM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z' }
            ]
        };

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkAuth();
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth', {
                    credentials: 'include'
                });
                if (response.ok) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    appState.isLoggedIn = true;
                    initializeRouting();
                } else {
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('dashboard').classList.add('hidden');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        }

        function initializeApp() {
            renderFeatureNav();
        }

        function initializeRouting() {
            // Load route from hash on page load
            loadRouteFromHash();
            
            // Listen for hash changes
            window.addEventListener('hashchange', loadRouteFromHash);
        }

        function loadRouteFromHash() {
            const hash = window.location.hash.substring(1); // Remove #
            if (!hash) {
                navigateTo('coupon', 'templates', false);
                return;
            }

            const [product, view] = hash.split('/');
            if (product && view) {
                navigateTo(product, view, false);
            } else {
                navigateTo('coupon', 'templates', false);
            }
        }

        function renderFeatureNav() {
            const nav = document.getElementById('featureNav');
            const items = productNavigation[appState.activeProduct];
            
            nav.innerHTML = `
                <div class="nav-section">
                    <div class="nav-section-title">Navigation</div>
                    ${items.map(item => `
                        <a class="nav-item ${item.id === appState.activeView ? 'active' : ''}" onclick="navigateTo('${appState.activeProduct}', '${item.id}')">
                            <span class="nav-item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${item.icon}" />
                                </svg>
                            </span>
                            <span class="nav-item-text">${item.label}</span>
                        </a>
                    `).join('')}
                </div>
            `;
        }

        function switchProduct(product) {
            if (appState.activeProduct === product) return;
            
            appState.activeProduct = product;
            appState.activeView = productNavigation[product][0].id;
            
            // Update product icons
            document.querySelectorAll('.product-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            event.target.closest('.product-icon').classList.add('active');
            
            // Update product name
            document.getElementById('productName').textContent = product === 'coupon' ? 'Coupon Bot' : 'Forex Signals Bot';
            
            // Render new navigation
            renderFeatureNav();
            
            // Navigate to first view of new product
            navigateTo(product, appState.activeView);
            
            closeMobileMenu();
        }

        function navigateTo(product, view, updateHash = true) {
            appState.activeProduct = product;
            appState.activeView = view;
            
            // Update URL hash
            if (updateHash) {
                window.location.hash = `${product}/${view}`;
            }
            
            // Update product name
            document.getElementById('productName').textContent = product === 'coupon' ? 'Coupon Bot' : 'Forex Signals Bot';
            
            // Update active product icon
            const productIcons = document.querySelectorAll('.product-icon');
            productIcons.forEach((icon, index) => {
                if ((index === 0 && product === 'coupon') || (index === 1 && product === 'forex')) {
                    icon.classList.add('active');
                } else {
                    icon.classList.remove('active');
                }
            });
            
            // Hide all views
            document.querySelectorAll('.view-container').forEach(v => {
                v.classList.remove('active');
            });
            
            // Show active view
            const viewId = `${product}-${view}`;
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
                
                // Load data for specific views
                if (viewId === 'coupon-templates') {
                    loadAssets();
                } else if (viewId === 'coupon-analytics') {
                    loadAnalytics();
                } else if (viewId === 'forex-subscriptions') {
                    loadSubscriptions();
                } else if (viewId === 'forex-conversions') {
                    loadConversions();
                } else if (viewId === 'forex-signals') {
                    loadForexSignals();
                } else if (viewId === 'forex-settings') {
                    loadForexSettings();
                }
            }
            
            // Update navigation active state
            renderFeatureNav();
            
            closeMobileMenu();
        }

        // Login/Logout
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    appState.isLoggedIn = true;
                    initializeRouting();
                } else {
                    showAlert('loginAlert', data.error || 'Invalid password', true);
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed: ' + error.message, true);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('password').value = '';
                appState.isLoggedIn = false;
                window.location.hash = '';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        function showAlert(elementId, message, isError = false) {
            const alert = document.getElementById(elementId);
            alert.className = isError ? 'alert alert-error' : 'alert alert-success';
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Mobile Menu
        function toggleMobileMenu() {
            const switcher = document.getElementById('productSwitcher');
            const sidebar = document.getElementById('featureSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            switcher.classList.toggle('mobile-open');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            appState.isMobileMenuOpen = !appState.isMobileMenuOpen;
        }

        function closeMobileMenu() {
            const switcher = document.getElementById('productSwitcher');
            const sidebar = document.getElementById('featureSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            switcher.classList.remove('mobile-open');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            appState.isMobileMenuOpen = false;
        }

        // Custom Modal Functions
        let modalResolve = null;
        
        function showCustomModal(title, message, options = {}) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                document.getElementById('customModalTitle').textContent = title;
                document.getElementById('customModalMessage').innerHTML = message;
                
                const buttonsHtml = options.type === 'alert' 
                    ? `<button class="custom-modal-btn custom-modal-btn-confirm" onclick="resolveModal(true)">OK</button>`
                    : `
                        <button class="custom-modal-btn custom-modal-btn-cancel" onclick="resolveModal(false)">Cancel</button>
                        <button class="custom-modal-btn ${options.danger ? 'custom-modal-btn-danger' : 'custom-modal-btn-confirm'}" onclick="resolveModal(true)">${options.confirmText || 'Confirm'}</button>
                    `;
                
                document.getElementById('customModalButtons').innerHTML = buttonsHtml;
                document.getElementById('customModal').classList.add('active');
            });
        }
        
        function resolveModal(result) {
            document.getElementById('customModal').classList.remove('active');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }
        
        function showModalAlert(title, message) {
            return showCustomModal(title, message, { type: 'alert' });
        }
        
        function showModalConfirm(title, message, options = {}) {
            return showCustomModal(title, message, options);
        }

        // Conversion Analytics Functions
        async function loadConversions() {
            try {
                const response = await fetch('/api/telegram/conversion-analytics', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load conversions');
                
                const data = await response.json();
                const summary = data.summary || {};
                
                // Update stat cards
                document.getElementById('totalFreeLeads').textContent = summary.total_free_signups || 0;
                document.getElementById('totalConversions').textContent = summary.total_conversions || 0;
                document.getElementById('conversionRate').textContent = `${(summary.conversion_rate || 0).toFixed(1)}%`;
                document.getElementById('avgConversionDays').textContent = summary.avg_conversion_days > 0 ? summary.avg_conversion_days.toFixed(1) : '--';
                document.getElementById('conversionRevenue').textContent = `$${(summary.conversion_revenue || 0).toFixed(0)}`;
                
                // Render leads by source (free signups funnel)
                renderLeadsBySource(data.funnel_by_source);
                
                // Render revenue by source
                renderRevenueBySource(data.by_source);
                
                // Render revenue by campaign
                renderRevenueByCampaign(data.by_campaign);
                
                // Render recent conversions
                renderRecentConversions(data.recent_conversions);
                
                // Render all leads table
                renderAllLeads(data.all_leads);
                
            } catch (error) {
                console.error('Error loading conversions:', error);
                document.getElementById('revenueBySource').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
            }
        }
        
        function renderLeadsBySource(leads) {
            const container = document.getElementById('leadsBySource');
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No leads yet. Free signups will appear here with their UTM attribution.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Signups</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Converted</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Conv. Rate</th>';
            html += '</tr></thead><tbody>';
            
            leads.forEach(lead => {
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${lead.source || '(Direct)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${lead.signups}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${lead.converted}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: ${lead.conversion_rate > 0 ? '#48bb78' : '#718096'};">${lead.conversion_rate}%</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderRevenueBySource(sources) {
            const container = document.getElementById('revenueBySource');
            if (!sources || sources.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No attribution data yet. UTM parameters will be tracked when users sign up.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Conversions</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Revenue</th>';
            html += '</tr></thead><tbody>';
            
            sources.forEach(source => {
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${source.source || '(Direct)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${source.conversions}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #48bb78;">$${source.revenue.toFixed(0)}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderRevenueByCampaign(campaigns) {
            const container = document.getElementById('revenueByCampaign');
            if (!campaigns || campaigns.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No campaign data yet. Add utm_campaign parameters to track campaigns.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Campaign</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Conversions</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Revenue</th>';
            html += '</tr></thead><tbody>';
            
            campaigns.forEach(campaign => {
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${campaign.campaign || '(None)'}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${campaign.conversions}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #48bb78;">$${campaign.revenue.toFixed(0)}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderRecentConversions(conversions) {
            const container = document.getElementById('recentConversions');
            if (!conversions || conversions.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No conversions yet. When free users upgrade to VIP, they\'ll appear here.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 1px solid #2d3748;">';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Email</th>';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Converted</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Days</th>';
            html += '<th style="text-align: right; padding: 10px; color: #a0aec0;">Amount</th>';
            html += '<th style="text-align: left; padding: 10px; color: #a0aec0;">Source</th>';
            html += '</tr></thead><tbody>';
            
            conversions.forEach(conv => {
                const convDate = conv.converted_at ? new Date(conv.converted_at).toLocaleDateString() : '--';
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 10px;">${conv.email}</td>`;
                html += `<td style="padding: 10px;">${convDate}</td>`;
                html += `<td style="padding: 10px; text-align: right;">${conv.days_to_convert || '--'}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #48bb78;">$${(conv.amount || 0).toFixed(0)}</td>`;
                html += `<td style="padding: 10px;">${conv.source || '(Direct)'}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function renderAllLeads(leads) {
            const container = document.getElementById('allLeadsTable');
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div style="color: #718096; text-align: center;">No leads yet. Sign ups will appear here.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead><tr style="border-bottom: 2px solid #2d3748; background: #1a202c;">';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Status</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Email</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Name</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Source</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Campaign</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Signup Date</th>';
            html += '<th style="text-align: right; padding: 12px 10px; color: #a0aec0;">Revenue</th>';
            html += '<th style="text-align: left; padding: 12px 10px; color: #a0aec0;">Telegram</th>';
            html += '</tr></thead><tbody>';
            
            leads.forEach(lead => {
                const signupDate = lead.signup_date ? new Date(lead.signup_date).toLocaleDateString() : '--';
                const statusTag = lead.is_converted 
                    ? '<span style="background: #48bb78; color: #1a202c; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">SALE</span>'
                    : '<span style="background: #4a5568; color: #e2e8f0; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">LEAD</span>';
                const revenue = lead.is_converted ? `<span style="color: #48bb78; font-weight: 600;">$${lead.amount.toFixed(0)}</span>` : '<span style="color: #718096;">--</span>';
                const telegram = lead.telegram ? `@${lead.telegram}` : '<span style="color: #718096;">--</span>';
                
                html += `<tr style="border-bottom: 1px solid #2d3748;">`;
                html += `<td style="padding: 12px 10px;">${statusTag}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.email}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.name || '<span style="color: #718096;">--</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.source || '<span style="color: #718096;">direct</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${lead.campaign || '<span style="color: #718096;">--</span>'}</td>`;
                html += `<td style="padding: 12px 10px;">${signupDate}</td>`;
                html += `<td style="padding: 12px 10px; text-align: right;">${revenue}</td>`;
                html += `<td style="padding: 12px 10px;">${telegram}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Subscriptions Functions
        let allSubscriptions = [];
        let currentFilter = 'all';

        function getDisplayStatus(sub) {
            if (sub.status === 'revoked') return 'revoked';
            if (sub.amount_paid > 0) return 'active';
            return 'free_plan';
        }

        async function loadSubscriptions() {
            try {
                const url = `/api/telegram-subscriptions?include_test=true`;
                const response = await fetch(url, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load subscriptions');
                
                const data = await response.json();
                allSubscriptions = data.subscriptions || [];
                updateSubscriptionStats();
                renderSubscriptions();
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                document.getElementById('subscriptionsContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading subscriptions</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateSubscriptionStats() {
            const paidSubs = allSubscriptions.filter(s => s.amount_paid > 0 && s.status !== 'revoked');
            const paidCount = paidSubs.length;
            const activePaid = paidSubs.filter(s => s.status === 'active').length;
            const freePlanSubs = allSubscriptions.filter(s => 
                (s.amount_paid === 0 || s.amount_paid === null) && s.status !== 'revoked'
            ).length;
            
            document.getElementById('paidSubscribers').textContent = paidCount;
            document.getElementById('activeSubscribers').textContent = activePaid;
            document.getElementById('freePlanSubscribers').textContent = freePlanSubs;
            
            // Fetch revenue metrics from Stripe
            fetchRevenueMetrics();
        }
        
        async function fetchRevenueMetrics() {
            try {
                const response = await fetch('/api/telegram/revenue-metrics', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to fetch revenue metrics');
                
                const metrics = await response.json();
                
                document.getElementById('netRevenue').textContent = `$${metrics.total_revenue.toFixed(0)}`;
                document.getElementById('monthlyRebill').textContent = `$${metrics.monthly_rebill.toFixed(0)}`;
                
                if (metrics.source === 'database_fallback') {
                    document.getElementById('netRevenueSubtext').textContent = 'From database';
                } else {
                    document.getElementById('netRevenueSubtext').textContent = 'All time (net)';
                }
                
            } catch (error) {
                console.error('Error fetching revenue metrics:', error);
                // Fallback to database amounts
                const paidSubs = allSubscriptions.filter(s => s.amount_paid > 0 && s.status !== 'revoked');
                const totalFromDb = paidSubs.reduce((sum, s) => sum + (s.amount_paid || 0), 0);
                document.getElementById('netRevenue').textContent = `$${totalFromDb.toFixed(0)}`;
                document.getElementById('monthlyRebill').textContent = '$--';
                document.getElementById('netRevenueSubtext').textContent = 'From database';
            }
        }

        function filterSubscriptions(status) {
            currentFilter = status;
            
            document.querySelectorAll('[data-status]').forEach(btn => {
                if (btn.getAttribute('data-status') === status) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('active');
                } else {
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('active');
                }
            });
            
            renderSubscriptions();
        }

        function searchSubscriptions(query) {
            renderSubscriptions(query.toLowerCase());
        }

        function renderSubscriptions(searchQuery = '') {
            let filtered = currentFilter === 'all' 
                ? allSubscriptions 
                : allSubscriptions.filter(sub => getDisplayStatus(sub) === currentFilter);
            
            if (searchQuery) {
                filtered = filtered.filter(sub => 
                    (sub.email && sub.email.toLowerCase().includes(searchQuery)) ||
                    (sub.name && sub.name.toLowerCase().includes(searchQuery)) ||
                    (sub.telegram_username && sub.telegram_username.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_customer_id && sub.stripe_customer_id.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_subscription_id && sub.stripe_subscription_id.toLowerCase().includes(searchQuery))
                );
            }

            if (filtered.length === 0) {
                document.getElementById('subscriptionsContent').innerHTML = `
                    <div class="empty-state">No subscriptions found</div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Stripe IDs</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Telegram</th>
                            <th>Signed Up</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((sub, index) => {
                            const displayStatus = getDisplayStatus(sub);
                            const statusLabel = displayStatus === 'free_plan' ? 'FREE PLAN' : displayStatus.toUpperCase();
                            return `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 0.9rem;">${sub.email}</span>
                                        <button onclick="copyToClipboard('${sub.email}', this)" class="copy-btn" title="Copy email">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td style="font-size: 0.8rem; font-family: monospace;">
                                    ${sub.stripe_customer_id ? `<div title="Customer ID" style="color: #a0a0b0;">cus: ${sub.stripe_customer_id.substring(0, 14)}...</div>` : '<div style="color: #666;">No Stripe ID</div>'}
                                    ${sub.stripe_subscription_id ? `<div title="Subscription ID" style="color: #7c8aff;">sub: ${sub.stripe_subscription_id.substring(0, 14)}...</div>` : ''}
                                </td>
                                <td>
                                    <div>${sub.plan_type || (sub.amount_paid > 0 ? 'Premium' : 'Free')}</div>
                                    <div style="color: ${sub.amount_paid > 0 ? '#4caf50' : '#666'}; font-weight: bold;">$${sub.amount_paid || '0'}</div>
                                </td>
                                <td><span class="badge status-${displayStatus}">${statusLabel}</span></td>
                                <td>${sub.telegram_username ? `@${sub.telegram_username}` : '<span style="color: #666;">Not joined</span>'}</td>
                                <td>${formatDate(sub.created_at)}</td>
                                <td>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="showSubscriptionDetails(${index})">View Details</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('subscriptionsContent').innerHTML = html;
        }
        
        function showSubscriptionDetails(index) {
            let filtered = currentFilter === 'all' 
                ? allSubscriptions 
                : allSubscriptions.filter(sub => getDisplayStatus(sub) === currentFilter);
            
            const searchInput = document.getElementById('subscriptionSearchInput');
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            
            if (searchQuery) {
                filtered = filtered.filter(sub => 
                    (sub.email && sub.email.toLowerCase().includes(searchQuery)) ||
                    (sub.name && sub.name.toLowerCase().includes(searchQuery)) ||
                    (sub.telegram_username && sub.telegram_username.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_customer_id && sub.stripe_customer_id.toLowerCase().includes(searchQuery)) ||
                    (sub.stripe_subscription_id && sub.stripe_subscription_id.toLowerCase().includes(searchQuery))
                );
            }
            
            const sub = filtered[index];
            if (!sub) return;
            
            const isPaidUser = parseFloat(sub.amount_paid || 0) > 0;
            const hasStripeSubscription = !!sub.stripe_subscription_id;
            
            let billingSection = '';
            if (!isPaidUser) {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div class="billing-na">N/A - Free user</div>
                    </div>
                `;
            } else if (!hasStripeSubscription) {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div class="billing-na">No Stripe subscription linked</div>
                    </div>
                `;
            } else {
                billingSection = `
                    <div class="billing-divider">
                        <div class="billing-section-title">Billing Information</div>
                        <div id="billingContent">
                            <div class="billing-loading">
                                <div class="billing-loading-spinner"></div>
                                Loading billing info...
                            </div>
                        </div>
                        <div id="cancelActions" class="cancel-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.85rem; color: #a0a0b0; margin-bottom: 10px;">Subscription Actions</div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="cancelSubscription(${sub.id}, false)" class="btn-cancel-period" style="padding: 8px 16px; background: #f59e0b; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    Cancel at Period End
                                </button>
                                <button onclick="cancelSubscription(${sub.id}, true)" class="btn-cancel-now" style="padding: 8px 16px; background: #ef4444; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    Cancel Immediately
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                                <strong>Cancel at Period End:</strong> User keeps access until billing period ends<br>
                                <strong>Cancel Immediately:</strong> User loses access and is removed from channel now
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const modalContent = `
                <div class="detail-row">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${sub.name || 'Unknown'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${sub.email || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Plan Type</div>
                    <div class="detail-value">${sub.plan_type || 'Premium'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Amount Paid</div>
                    <div class="detail-value" style="color: #4caf50; font-weight: bold;">$${sub.amount_paid || '0'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="badge status-${sub.status}">${sub.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Telegram Username</div>
                    <div class="detail-value">${sub.telegram_username ? `@${sub.telegram_username}` : 'Not joined'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Telegram User ID</div>
                    <div class="detail-value">${sub.telegram_user_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Stripe Customer ID</div>
                    <div class="detail-value" style="font-family: monospace; word-break: break-all;">${sub.stripe_customer_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Stripe Subscription ID</div>
                    <div class="detail-value" style="font-family: monospace; word-break: break-all;">${sub.stripe_subscription_id || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Invite Link</div>
                    <div class="detail-value" style="word-break: break-all;">${sub.invite_link ? `<a href="${sub.invite_link}" target="_blank" style="color: #667eea;">${sub.invite_link}</a>` : 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Signed Up</div>
                    <div class="detail-value">${formatDateFull(sub.created_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Joined At</div>
                    <div class="detail-value">${formatDateFull(sub.joined_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Last Seen At</div>
                    <div class="detail-value">${formatDateFull(sub.last_seen_at)}</div>
                </div>
                ${sub.revoked_at ? `
                <div class="detail-row">
                    <div class="detail-label">Revoked At</div>
                    <div class="detail-value" style="color: #ef4444;">${formatDateFull(sub.revoked_at)}</div>
                </div>
                ` : ''}
                ${billingSection}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                    <div style="font-size: 0.85rem; color: #a0a0b0; margin-bottom: 10px;">Danger Zone</div>
                    <button onclick="deleteSubscription(${sub.id}, '${(sub.email || '').replace(/'/g, "\\'")}', ${sub.telegram_user_id || 'null'})" 
                            style="padding: 10px 20px; background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%;">
                         Delete This Record
                    </button>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                        Permanently deletes this subscription record from the database. Cannot be undone.
                    </div>
                </div>
            `;
            
            document.getElementById('subscriptionDetailContent').innerHTML = modalContent;
            document.getElementById('subscriptionDetailModal').classList.add('active');
            
            if (isPaidUser && hasStripeSubscription) {
                fetchBillingInfo(sub.id);
            }
        }
        
        async function fetchBillingInfo(subscriptionId) {
            const billingContainer = document.getElementById('billingContent');
            if (!billingContainer) return;
            
            try {
                const response = await fetch(`/api/telegram/billing/${subscriptionId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch billing info');
                }
                
                const data = await response.json();
                const billing = data.billing;
                const billingStatus = data.billing_status;
                
                // Handle different billing statuses
                if (billingStatus === 'free_user') {
                    billingContainer.innerHTML = `
                        <div class="billing-na">N/A - Free user</div>
                    `;
                    return;
                }
                
                if (billingStatus === 'no_stripe_ids') {
                    billingContainer.innerHTML = `
                        <div class="billing-error">No Stripe subscription linked</div>
                    `;
                    return;
                }
                
                if (billingStatus === 'stripe_error' || !billing) {
                    const errorMsg = data.error || 'Unable to fetch billing info from Stripe';
                    billingContainer.innerHTML = `
                        <div class="billing-error">${errorMsg}</div>
                    `;
                    return;
                }
                
                // Success - render billing info
                const billingHtml = renderBillingInfo(billing);
                billingContainer.innerHTML = billingHtml;
                
            } catch (error) {
                console.error('Error fetching billing info:', error);
                billingContainer.innerHTML = `
                    <div class="billing-error">Unable to load billing info</div>
                `;
            }
        }
        
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief visual feedback with checkmark
                const svg = btn.querySelector('svg');
                const originalSvg = svg.outerHTML;
                svg.outerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                btn.style.opacity = '1';
                setTimeout(() => {
                    btn.innerHTML = originalSvg;
                    btn.style.opacity = '';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        async function cleanupTestData() {
            const confirmed = await showModalConfirm(
                'Delete Test Data',
                'This will remove records with:<br><br> Emails starting with test@ or demo@<br> Emails ending with @example.com<br> That have fake payment amounts<br><br><strong>Real subscriber data will NOT be affected.</strong>',
                { danger: true, confirmText: 'Delete Test Data' }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/telegram/cleanup-test-data', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const deletedList = result.deleted.length > 0 
                        ? result.deleted.map(r => ` ${r.email} ($${r.amount})`).join('<br>') 
                        : 'None found';
                    await showModalAlert('Success', `${result.message}<br><br>${deletedList}`);
                    loadSubscriptions();
                } else {
                    await showModalAlert('Error', `Failed to cleanup: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cleaning up test data:', error);
                await showModalAlert('Error', `Error: ${error.message}`);
            }
        }
        
        async function cancelSubscription(subscriptionId, cancelImmediately) {
            const actionText = cancelImmediately ? 'Cancel Immediately' : 'Cancel at Period End';
            const warningText = cancelImmediately 
                ? 'This will <strong>immediately revoke access</strong> and remove the user from the Telegram channel.'
                : 'This will cancel the subscription at the end of the current billing period. The user will <strong>retain access until then</strong>.';
            
            const confirmed = await showModalConfirm(actionText, warningText, { 
                danger: cancelImmediately,
                confirmText: cancelImmediately ? 'Cancel Now' : 'Cancel at Period End'
            });
            
            if (!confirmed) return;
            
            const cancelActions = document.getElementById('cancelActions');
            if (cancelActions) {
                cancelActions.innerHTML = `
                    <div style="color: #a0a0b0; display: flex; align-items: center; gap: 10px;">
                        <div class="billing-loading-spinner"></div>
                        Processing cancellation...
                    </div>
                `;
            }
            
            try {
                const response = await fetch('/api/telegram/cancel-subscription', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscriptionId: subscriptionId,
                        cancelImmediately: cancelImmediately
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (cancelActions) {
                        cancelActions.innerHTML = `
                            <div style="color: #4caf50; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                                 ${result.message}
                            </div>
                        `;
                    }
                    
                    // Refresh the billing info after a short delay
                    setTimeout(() => {
                        fetchBillingInfo(subscriptionId);
                        loadSubscriptions(); // Refresh the main list
                    }, 1500);
                } else {
                    if (cancelActions) {
                        cancelActions.innerHTML = `
                            <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                                 Failed to cancel: ${result.error || 'Unknown error'}
                            </div>
                            <button onclick="showSubscriptionDetails(${subscriptionId})" style="margin-top: 10px; padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
                                Try Again
                            </button>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error canceling subscription:', error);
                if (cancelActions) {
                    cancelActions.innerHTML = `
                        <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                             Error: ${error.message}
                        </div>
                        <button onclick="showSubscriptionDetails(${subscriptionId})" style="margin-top: 10px; padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    `;
                }
            }
        }
        
        async function deleteSubscription(subscriptionId, email, telegramUserId) {
            const confirmed = await showModalConfirm(
                'Delete Subscription Record',
                `<strong>Email:</strong> ${email}<br><br>This action cannot be undone. The record will be permanently removed from the database.`,
                { danger: true, confirmText: 'Delete' }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/telegram/delete-subscription', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscriptionId: subscriptionId,
                        telegramUserId: telegramUserId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await showModalAlert('Success', `Deleted successfully: ${email}`);
                    closeSubscriptionDetailModal();
                    loadSubscriptions();
                } else {
                    await showModalAlert('Error', `Failed to delete: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting subscription:', error);
                await showModalAlert('Error', `Error: ${error.message}`);
            }
        }
        
        function renderBillingInfo(billing) {
            const formatCurrency = (amount, currency) => {
                const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '' : currency === 'GBP' ? '' : currency + ' ';
                return `${symbol}${parseFloat(amount).toFixed(2)}`;
            };
            
            const formatBillingDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            const formatBillingInterval = (interval, count) => {
                if (count === 1) {
                    return interval === 'month' ? 'Monthly' : interval === 'year' ? 'Yearly' : interval;
                }
                return `Every ${count} ${interval}s`;
            };
            
            const statusClass = `stripe-status stripe-status-${billing.status}`;
            
            let cancelWarning = '';
            if (billing.cancel_at_period_end) {
                cancelWarning = `
                    <div class="detail-row">
                        <div class="detail-label">Cancel Status</div>
                        <div class="detail-value">
                            <span class="cancel-warning"> Cancels at period end</span>
                        </div>
                    </div>
                `;
            }
            
            let canceledAt = '';
            if (billing.canceled_at) {
                canceledAt = `
                    <div class="detail-row">
                        <div class="detail-label">Canceled At</div>
                        <div class="detail-value" style="color: #ef4444;">${formatBillingDate(billing.canceled_at)}</div>
                    </div>
                `;
            }
            
            let lastPayment = 'N/A';
            if (billing.latest_invoice && billing.latest_invoice.paid_at) {
                lastPayment = `${formatBillingDate(billing.latest_invoice.paid_at)} - ${formatCurrency(billing.latest_invoice.amount_paid, billing.latest_invoice.currency)}`;
            }
            
            let nextPayment = 'N/A';
            if (billing.upcoming_invoice && billing.upcoming_invoice.next_payment_attempt) {
                nextPayment = `${formatBillingDate(billing.upcoming_invoice.next_payment_attempt)} - ${formatCurrency(billing.upcoming_invoice.amount_due, billing.upcoming_invoice.currency)}`;
            }
            
            return `
                <div class="detail-row">
                    <div class="detail-label">Stripe Status</div>
                    <div class="detail-value"><span class="${statusClass}">${billing.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Billing Cycle</div>
                    <div class="detail-value">${formatBillingInterval(billing.billing_interval, billing.billing_interval_count)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Current Period</div>
                    <div class="detail-value">${formatBillingDate(billing.current_period_start)}  ${formatBillingDate(billing.current_period_end)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Last Payment</div>
                    <div class="detail-value" style="color: #10b981;">${lastPayment}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Next Payment Due</div>
                    <div class="detail-value">${nextPayment}</div>
                </div>
                ${cancelWarning}
                ${canceledAt}
            `;
        }
        
        function closeSubscriptionDetailModal() {
            document.getElementById('subscriptionDetailModal').classList.remove('active');
        }
        
        function formatDateFull(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Forex Signals Functions
        let allSignals = [];
        let botStatus = null;
        let selectedBotType = null;

        async function loadForexSignals() {
            try {
                const limit = document.getElementById('filterLimit')?.value || 100;
                const response = await fetch(`/api/forex-signals?limit=${limit}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load signals');
                
                allSignals = await response.json();
                applySignalFilters();
                updateForexMetrics();
                loadBotStatus();
            } catch (error) {
                console.error('Error loading signals:', error);
                document.getElementById('signalsTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading signals</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadBotStatus() {
            try {
                const response = await fetch('/api/signal-bot/status', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load bot status');
                
                botStatus = await response.json();
                updateBotStatusUI();
                updateActiveSignalBanner();
            } catch (error) {
                console.error('Error loading bot status:', error);
            }
        }

        function updateBotStatusUI() {
            if (!botStatus) return;
            
            // Update signals page
            const activeBotEl = document.getElementById('activeBotType');
            if (activeBotEl) {
                activeBotEl.textContent = botStatus.active_bot || '--';
            }
            
            // Update settings page
            const settingsActiveBot = document.getElementById('settingsActiveBot');
            if (settingsActiveBot) {
                settingsActiveBot.textContent = botStatus.active_bot || '--';
            }
            
            const settingsOpenSignal = document.getElementById('settingsOpenSignal');
            if (settingsOpenSignal) {
                if (botStatus.open_signal) {
                    settingsOpenSignal.innerHTML = `<span style="color: #667eea;">#${botStatus.open_signal.id} (${botStatus.open_signal.signal_type})</span>`;
                } else {
                    settingsOpenSignal.textContent = 'None';
                }
            }
            
            // Update signal counts
            const aggressiveCount = document.getElementById('aggressiveCount');
            const conservativeCount = document.getElementById('conservativeCount');
            const customCount = document.getElementById('customCount');
            const legacyCount = document.getElementById('legacyCount');
            
            if (aggressiveCount) aggressiveCount.textContent = botStatus.recent_signals?.aggressive || 0;
            if (conservativeCount) conservativeCount.textContent = botStatus.recent_signals?.conservative || 0;
            if (customCount) customCount.textContent = botStatus.recent_signals?.custom || 0;
            if (legacyCount) legacyCount.textContent = botStatus.recent_signals?.legacy || 0;
            
            // Update bot option active states
            document.querySelectorAll('.bot-option').forEach(opt => {
                opt.classList.remove('active', 'selected');
                if (opt.dataset.bot === botStatus.active_bot) {
                    opt.classList.add('active');
                }
            });
        }

        function updateActiveSignalBanner() {
            const banner = document.getElementById('activeSignalBanner');
            if (!banner) return;
            
            if (botStatus?.open_signal) {
                const signal = botStatus.open_signal;
                banner.style.display = 'flex';
                
                document.getElementById('activeSignalDetails').innerHTML = 
                    `${signal.signal_type} @ $${signal.entry_price?.toFixed(2)} | TP: $${signal.take_profit?.toFixed(2)} | SL: $${signal.stop_loss?.toFixed(2)}`;
                
                // Calculate time open
                const postedAt = new Date(signal.posted_at);
                const now = new Date();
                const hoursOpen = Math.floor((now - postedAt) / (1000 * 60 * 60));
                const minsOpen = Math.floor(((now - postedAt) / (1000 * 60)) % 60);
                document.getElementById('activeSignalTime').textContent = `${hoursOpen}h ${minsOpen}m open`;
                
                // Breakeven status
                const breakevenEl = document.getElementById('activeSignalBreakeven');
                if (signal.breakeven_set) {
                    breakevenEl.textContent = 'Breakeven Protected';
                    breakevenEl.style.color = '#10b981';
                } else {
                    breakevenEl.textContent = '';
                }
            } else {
                banner.style.display = 'none';
            }
        }

        function applySignalFilters() {
            const typeFilter = document.getElementById('filterType')?.value || 'all';
            const statusFilter = document.getElementById('filterStatus')?.value || 'all';
            const botTypeFilter = document.getElementById('filterBotType')?.value || 'all';
            
            let filtered = allSignals.filter(signal => {
                if (typeFilter !== 'all' && signal.signal_type !== typeFilter) return false;
                if (statusFilter !== 'all' && signal.status !== statusFilter) return false;
                if (botTypeFilter !== 'all' && signal.bot_type !== botTypeFilter) return false;
                return true;
            });
            
            renderSignalsTable(filtered);
        }

        function renderSignalsTable(signals) {
            if (signals.length === 0) {
                document.getElementById('signalsTableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No signals found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Date/Time</th>
                            <th>Bot</th>
                            <th>Type</th>
                            <th>Entry</th>
                            <th>TP</th>
                            <th>SL</th>
                            <th>Status</th>
                            <th>Pips</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${signals.map(signal => {
                            const signalDate = new Date(signal.posted_at);
                            const dayName = signalDate.toLocaleString('en-US', { weekday: 'short' });
                            const date = signalDate.toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const pips = signal.result_pips || 0;
                            const pipsDisplay = pips > 0 ? `+${pips.toFixed(2)}` : pips.toFixed(2);
                            const botType = signal.bot_type || 'custom';
                            
                            return `
                                <tr>
                                    <td style="font-weight: 500; color: #a0aec0;">${dayName}</td>
                                    <td>${date}</td>
                                    <td><span class="badge badge-${botType}" style="text-transform: capitalize;">${botType}</span></td>
                                    <td><span class="badge badge-${signal.signal_type.toLowerCase()}">${signal.signal_type}</span></td>
                                    <td>$${signal.entry_price ? signal.entry_price.toFixed(2) : '--'}</td>
                                    <td>$${signal.take_profit ? signal.take_profit.toFixed(2) : '--'}</td>
                                    <td>$${signal.stop_loss ? signal.stop_loss.toFixed(2) : '--'}</td>
                                    <td><span class="badge badge-${signal.status}">${signal.status}</span></td>
                                    <td style="color: ${pips >= 0 ? '#48bb78' : '#f56565'}; font-weight: 600;">${pipsDisplay}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('signalsTableContent').innerHTML = html;
        }

        function updateForexMetrics() {
            const completed = allSignals.filter(s => s.status === 'won' || s.status === 'lost');
            const won = allSignals.filter(s => s.status === 'won').length;
            const total = completed.length;
            const winRate = total > 0 ? ((won / total) * 100).toFixed(1) : 0;
            const totalPips = allSignals.reduce((sum, s) => sum + (s.result_pips || 0), 0);

            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('winRateSubtext').textContent = `${won} won / ${total} total`;
            document.getElementById('totalPips').textContent = totalPips.toFixed(2);
            document.getElementById('totalSignals').textContent = allSignals.length;
            document.getElementById('signalsBreakdown').textContent = `${completed.length} completed`;
            
            // Apply color to total pips
            const pipsEl = document.getElementById('totalPips');
            if (totalPips >= 0) {
                pipsEl.classList.add('positive');
                pipsEl.classList.remove('negative');
            } else {
                pipsEl.classList.add('negative');
                pipsEl.classList.remove('positive');
            }
        }

        // Bot Settings Functions
        function selectBot(botType) {
            if (botStatus?.open_signal) {
                return;
            }
            
            selectedBotType = botType;
            
            document.querySelectorAll('.bot-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.bot === botType && botType !== botStatus?.active_bot) {
                    opt.classList.add('selected');
                }
            });
            
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.bot === botType && botType !== botStatus?.active_bot) {
                    card.classList.add('selected');
                }
            });
            
            const switchBtn = document.getElementById('switchBotBtn');
            const switchBtnText = document.getElementById('switchBotBtnText');
            
            if (botType === botStatus?.active_bot) {
                switchBtn.disabled = true;
                switchBtnText.textContent = `${botType} is already active`;
            } else {
                switchBtn.disabled = false;
                switchBtnText.textContent = `Switch to ${botType}`;
            }
        }

        async function switchActiveBot() {
            if (!selectedBotType || selectedBotType === botStatus?.active_bot) return;
            
            const switchBtn = document.getElementById('switchBotBtn');
            const switchBtnText = document.getElementById('switchBotBtnText');
            const errorEl = document.getElementById('botSwitchError');
            const successEl = document.getElementById('botSwitchSuccess');
            
            switchBtn.disabled = true;
            switchBtnText.textContent = 'Switching...';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/signal-bot/set-active', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bot_type: selectedBotType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    successEl.textContent = result.message;
                    successEl.style.display = 'block';
                    await loadBotStatus();
                    updateStrategyCards();
                    switchBtnText.textContent = 'Select a strategy to switch';
                    selectedBotType = null;
                } else {
                    errorEl.textContent = result.error;
                    errorEl.style.display = 'block';
                    switchBtnText.textContent = `Switch to ${selectedBotType}`;
                    switchBtn.disabled = false;
                }
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                switchBtnText.textContent = `Switch to ${selectedBotType}`;
                switchBtn.disabled = false;
            }
        }

        async function loadForexSettings() {
            await loadBotStatus();
            await loadTpConfig();
            await loadGuardrailSettings();
            updateStrategyCards();
        }
        
        function updateStrategyCards() {
            const cards = document.querySelectorAll('.strategy-card');
            cards.forEach(card => {
                card.classList.remove('active-strategy', 'selected');
                if (card.dataset.bot === currentActiveBot) {
                    card.classList.add('active-strategy');
                }
            });
        }
        
        let currentTpCount = 3;
        
        function setTpCount(count) {
            currentTpCount = count;
            
            document.querySelectorAll('.tp-count-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.count) === count) {
                    btn.classList.add('active');
                }
            });
            
            const tp2Level = document.getElementById('tpLevel2');
            const tp3Level = document.getElementById('tpLevel3');
            
            if (count === 1) {
                tp2Level.classList.add('disabled');
                tp3Level.classList.add('disabled');
                document.getElementById('tp1Pct').value = 100;
                document.getElementById('tp2Pct').value = 0;
                document.getElementById('tp3Pct').value = 0;
            } else if (count === 2) {
                tp2Level.classList.remove('disabled');
                tp3Level.classList.add('disabled');
                document.getElementById('tp3Pct').value = 0;
            } else {
                tp2Level.classList.remove('disabled');
                tp3Level.classList.remove('disabled');
            }
            
            updateTpTotal();
        }
        
        function updateTpTotal() {
            const tp1 = parseInt(document.getElementById('tp1Pct').value) || 0;
            const tp2 = parseInt(document.getElementById('tp2Pct').value) || 0;
            const tp3 = parseInt(document.getElementById('tp3Pct').value) || 0;
            
            const total = tp1 + tp2 + tp3;
            const totalEl = document.getElementById('tpTotalValue');
            
            totalEl.textContent = `${total}%`;
            
            if (total === 100) {
                totalEl.classList.remove('invalid');
                totalEl.classList.add('valid');
            } else {
                totalEl.classList.remove('valid');
                totalEl.classList.add('invalid');
            }
        }
        
        async function loadTpConfig() {
            try {
                const response = await fetch('/api/forex-tp-config', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentTpCount = data.tp_count || 3;
                        document.getElementById('tp1Pct').value = data.tp1_percentage || 50;
                        document.getElementById('tp2Pct').value = data.tp2_percentage || 30;
                        document.getElementById('tp3Pct').value = data.tp3_percentage || 20;
                        
                        setTpCount(currentTpCount);
                    }
                }
            } catch (error) {
                console.error('Failed to load TP config:', error);
            }
        }
        
        async function saveTpConfig() {
            const tp1 = parseInt(document.getElementById('tp1Pct').value) || 0;
            const tp2 = parseInt(document.getElementById('tp2Pct').value) || 0;
            const tp3 = parseInt(document.getElementById('tp3Pct').value) || 0;
            
            if (tp1 + tp2 + tp3 !== 100) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = 'TP percentages must add up to 100%';
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
                return;
            }
            
            try {
                const response = await fetch('/api/forex-tp-config', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tp_count: currentTpCount,
                        tp1_percentage: tp1,
                        tp2_percentage: tp2,
                        tp3_percentage: tp3
                    })
                });
                
                const result = await response.json();
                
                const successEl = document.getElementById('guardrailSuccess');
                const errorEl = document.getElementById('guardrailError');
                
                if (result.success) {
                    successEl.textContent = 'TP configuration saved successfully';
                    successEl.style.display = 'block';
                    setTimeout(() => successEl.style.display = 'none', 5000);
                } else {
                    errorEl.textContent = result.error || 'Failed to save TP configuration';
                    errorEl.style.display = 'block';
                    setTimeout(() => errorEl.style.display = 'none', 5000);
                }
            } catch (error) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }
        
        async function saveGuardrails() {
            try {
                const dailyLossCap = document.getElementById('dailyLossCap').value;
                const backToBackThrottle = document.getElementById('backToBackThrottle').value;
                const sessionFilterEnabled = document.getElementById('sessionFilterEnabled').value;
                const sessionStartHour = document.getElementById('sessionStartHour').value;
                const sessionEndHour = document.getElementById('sessionEndHour').value;
                
                const response = await fetch('/api/forex-config', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        daily_loss_cap_pips: parseFloat(dailyLossCap),
                        back_to_back_throttle_minutes: parseInt(backToBackThrottle),
                        session_filter_enabled: sessionFilterEnabled,
                        session_start_hour_utc: parseInt(sessionStartHour),
                        session_end_hour_utc: parseInt(sessionEndHour)
                    })
                });
                
                const result = await response.json();
                
                const successEl = document.getElementById('guardrailSuccess');
                const errorEl = document.getElementById('guardrailError');
                
                if (result.success) {
                    successEl.textContent = 'Risk settings saved successfully';
                    successEl.style.display = 'block';
                    setTimeout(() => successEl.style.display = 'none', 5000);
                } else {
                    errorEl.textContent = result.error || 'Failed to save risk settings';
                    errorEl.style.display = 'block';
                    setTimeout(() => errorEl.style.display = 'none', 5000);
                }
            } catch (error) {
                const errorEl = document.getElementById('guardrailError');
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }
        
        async function loadGuardrailSettings() {
            try {
                const response = await fetch('/api/forex-config', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dailyLossCap').value = data.daily_loss_cap_pips || 50;
                    document.getElementById('backToBackThrottle').value = data.back_to_back_throttle_minutes || 30;
                    document.getElementById('sessionFilterEnabled').value = data.session_filter_enabled === 'true' || data.session_filter_enabled === true ? 'true' : 'false';
                    document.getElementById('sessionStartHour').value = data.session_start_hour_utc || 8;
                    document.getElementById('sessionEndHour').value = data.session_end_hour_utc || 21;
                    
                    // Update daily P/L display
                    const dailyPnl = data.daily_pnl || 0;
                    const pnlDisplay = document.getElementById('dailyPnlDisplay');
                    if (pnlDisplay) {
                        pnlDisplay.textContent = dailyPnl >= 0 ? `+${dailyPnl.toFixed(1)} pips` : `${dailyPnl.toFixed(1)} pips`;
                        pnlDisplay.className = 'status-item-value ' + (dailyPnl >= 0 ? 'positive' : 'negative');
                    }
                    
                    // Update session display
                    const sessionDisplay = document.getElementById('currentSessionDisplay');
                    if (sessionDisplay) {
                        const now = new Date();
                        const utcHour = now.getUTCHours();
                        const start = parseInt(data.session_start_hour_utc) || 8;
                        const end = parseInt(data.session_end_hour_utc) || 21;
                        const isActive = utcHour >= start && utcHour < end;
                        sessionDisplay.textContent = isActive ? 'Active' : 'Closed';
                        sessionDisplay.className = 'status-item-value ' + (isActive ? 'positive' : '');
                    }
                }
            } catch (error) {
                console.error('Failed to load guardrail settings:', error);
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Add event listeners for forex filters
        setTimeout(() => {
            const filterType = document.getElementById('filterType');
            const filterStatus = document.getElementById('filterStatus');
            const filterLimit = document.getElementById('filterLimit');
            const filterBotType = document.getElementById('filterBotType');
            
            if (filterType) filterType.addEventListener('change', applySignalFilters);
            if (filterStatus) filterStatus.addEventListener('change', applySignalFilters);
            if (filterLimit) filterLimit.addEventListener('change', loadForexSignals);
            if (filterBotType) filterBotType.addEventListener('change', applySignalFilters);
        }, 1000);

        // ============================================
        // COUPON BOT FUNCTIONS (Template Manager, Campaigns, Broadcast, Analytics)
        // ============================================

        // Global variables for template manager
        let isEditingTemplate = false;
        let deleteConfirmCallback = null;

        // Tab switching
        function switchTab(tabName) {
            const uploadTab = document.getElementById('uploadTab');
            const assetsTab = document.getElementById('assetsTab');
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (tabName === 'upload') {
                uploadTab.classList.add('active');
                assetsTab.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                uploadTab.classList.remove('active');
                assetsTab.classList.add('active');
                tabs[1].classList.add('active');
            }
        }

        // Alert display
        function showAlert(elementId, message, isError = false) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.style.padding = '12px';
            alertDiv.style.marginBottom = '16px';
            alertDiv.style.borderRadius = '8px';
            alertDiv.style.backgroundColor = isError ? '#fee' : '#efe';
            alertDiv.style.color = isError ? '#c33' : '#363';
            alertDiv.style.border = `1px solid ${isError ? '#fcc' : '#cfc'}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // Clear template form
        function clearTemplateForm() {
            document.getElementById('templateForm').reset();
            document.getElementById('name').value = '';
            document.getElementById('slug').value = '';
            
            const slugInput = document.getElementById('slug');
            slugInput.readOnly = false;
            slugInput.style.backgroundColor = '';
            slugInput.style.cursor = '';
            
            isEditingTemplate = false;
            
            previewImages.square = null;
            previewImages.story = null;
            
            document.getElementById('squareFontColor').value = '#FF273E';
            document.getElementById('storyFontColor').value = '#FF273E';
            
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === '#FF273E') {
                    swatch.classList.add('selected');
                }
            });
            
            const squareCanvas = document.getElementById('previewSquare');
            const storyCanvas = document.getElementById('previewStory');
            if (squareCanvas) {
                const ctx = squareCanvas.getContext('2d');
                ctx.clearRect(0, 0, squareCanvas.width, squareCanvas.height);
            }
            if (storyCanvas) {
                const ctx = storyCanvas.getContext('2d');
                ctx.clearRect(0, 0, storyCanvas.width, storyCanvas.height);
            }
            
            document.getElementById('isEditing').value = 'false';
            document.getElementById('submitBtn').textContent = 'Upload Template';
            
            console.log('[FORM] Template form cleared for new upload');
        }

        // Handle template upload
        async function handleUpload(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            const nameValue = document.getElementById('name').value;
            const slugInput = document.getElementById('slug');
            const slugValue = slugInput.value;
            
            formData.append('name', nameValue);
            formData.append('slug', slugValue);
            
            const squareFile = document.getElementById('squareImage').files[0];
            const storyFile = document.getElementById('storyImage').files[0];
            if (squareFile) formData.append('squareImage', squareFile);
            if (storyFile) formData.append('storyImage', storyFile);
            
            formData.append('squareLeftPct', document.getElementById('squareLeftPct').value);
            formData.append('squareTopPct', document.getElementById('squareTopPct').value);
            formData.append('squareWidthPct', document.getElementById('squareWidthPct').value);
            formData.append('squareHeightPct', document.getElementById('squareHeightPct').value);
            formData.append('squareHAlign', 'center');
            formData.append('squareVAlign', 'middle');
            formData.append('squareMaxFontPx', document.getElementById('squareMaxFontPx').value);
            formData.append('squareShowLogo', document.getElementById('squareShowLogo').checked);
            
            formData.append('storyLeftPct', document.getElementById('storyLeftPct').value);
            formData.append('storyTopPct', document.getElementById('storyTopPct').value);
            formData.append('storyWidthPct', document.getElementById('storyWidthPct').value);
            formData.append('storyHeightPct', document.getElementById('storyHeightPct').value);
            formData.append('storyHAlign', 'center');
            formData.append('storyVAlign', 'middle');
            formData.append('storyMaxFontPx', document.getElementById('storyMaxFontPx').value);
            formData.append('storyShowLogo', document.getElementById('storyShowLogo').checked);
            
            formData.append('squareFontColor', document.getElementById('squareFontColor').value);
            formData.append('storyFontColor', document.getElementById('storyFontColor').value);

            try {
                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('uploadAlert', data.message + ' ');
                    clearTemplateForm();
                    isEditingTemplate = false;
                    drawingState.square.hasDrawnBox = false;
                    drawingState.story.hasDrawnBox = false;
                    updatePreviewsImmediate();
                    loadAssets();
                } else {
                    showAlert('uploadAlert', data.error || 'Upload failed', true);
                }
            } catch (error) {
                showAlert('uploadAlert', 'Upload failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Template';
            }
        }

        // Auto-generate slug from name
        document.getElementById('name').addEventListener('input', function(e) {
            if (!isEditingTemplate) {
                const slug = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('slug').value = slug;
            }
        });

        // Load templates/assets
        async function loadAssets() {
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading templates...</p>';
            
            try {
                let response;
                try {
                    response = await fetch('https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/index.json?ts=' + Date.now());
                } catch (_) {
                    response = await fetch('/assets/templates/index.json?ts=' + Date.now());
                }
                const data = await response.json();
                
                if (!data.templates || data.templates.length === 0) {
                    assetsList.innerHTML = '<p style="color: #718096; text-align: center;">No templates found</p>';
                    return;
                }
                
                assetsList.innerHTML = '';
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    const telegramEnabled = template.telegramEnabled !== false;
                    item.innerHTML = `
                        <input type="checkbox" class="template-checkbox" data-slug="${template.slug}" data-name="${template.name}" onchange="updateSelectAllState()">
                        <div class="asset-item-info">
                            <div class="asset-name">${template.name}</div>
                            <div class="asset-slug">${template.slug}</div>
                        </div>
                        <div class="telegram-toggle-container" title="${telegramEnabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot'}">
                            <label class="telegram-toggle-label">
                                <input type="checkbox" class="telegram-toggle-checkbox" data-slug="${template.slug}" ${telegramEnabled ? 'checked' : ''} onchange="toggleTelegramVisibility(event, '${template.slug}', this.checked)">
                                <span class="telegram-toggle-slider"></span>
                                <span class="telegram-toggle-text">${telegramEnabled ? ' Telegram' : ' Telegram'}</span>
                            </label>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="loadTemplateForEdit('${template.slug}')"></div>
                            <div class="asset-delete-icon" onclick="deleteTemplate('${template.slug}', '${template.name}')"></div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                });
                
                document.getElementById('selectAllTemplates').checked = false;
            } catch (error) {
                assetsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading templates</p>';
                console.error('Failed to load assets:', error);
            }
        }

        // Load template for editing
        async function loadTemplateForEdit(slug) {
            try {
                let response;
                try {
                    response = await fetch(`https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/meta.json?ts=${Date.now()}`);
                } catch (_) {
                    response = await fetch(`/assets/templates/${slug}/meta.json?ts=${Date.now()}`);
                }
                const meta = await response.json();
                
                switchTab('upload');
                
                isEditingTemplate = true;
                document.getElementById('isEditing').value = 'true';
                document.getElementById('name').value = meta.name || slug;
                const slugInput = document.getElementById('slug');
                slugInput.value = slug;
                slugInput.readOnly = true;
                slugInput.style.backgroundColor = '#f3f4f6';
                slugInput.style.cursor = 'not-allowed';
                document.getElementById('submitBtn').textContent = 'Update Template';
                
                document.getElementById('squareLeftPct').value = meta.square?.box?.leftPct || meta.square?.leftPct || 5;
                document.getElementById('squareTopPct').value = meta.square?.box?.topPct || meta.square?.topPct || 78;
                document.getElementById('squareWidthPct').value = meta.square?.box?.widthPct || meta.square?.widthPct || 90;
                document.getElementById('squareHeightPct').value = meta.square?.box?.heightPct || meta.square?.heightPct || 12;
                document.getElementById('squareMaxFontPx').value = meta.square?.maxFontPx || 80;
                document.getElementById('squareShowLogo').checked = meta.square?.showLogo !== false;
                
                document.getElementById('storyLeftPct').value = meta.story?.box?.leftPct || meta.story?.leftPct || 5;
                document.getElementById('storyTopPct').value = meta.story?.box?.topPct || meta.story?.topPct || 78;
                document.getElementById('storyWidthPct').value = meta.story?.box?.widthPct || meta.story?.widthPct || 90;
                document.getElementById('storyHeightPct').value = meta.story?.box?.heightPct || meta.story?.heightPct || 12;
                document.getElementById('storyMaxFontPx').value = meta.story?.maxFontPx || 80;
                document.getElementById('storyShowLogo').checked = meta.story?.showLogo !== false;
                
                const squareFontColor = meta.square?.fontColor || '#FF273E';
                const storyFontColor = meta.story?.fontColor || '#FF273E';
                document.getElementById('squareFontColor').value = squareFontColor;
                document.getElementById('storyFontColor').value = storyFontColor;
                selectColor(squareFontColor, 'square');
                selectColor(storyFontColor, 'story');
                
                drawingState.square.hasDrawnBox = true;
                if (meta.story) {
                    drawingState.story.hasDrawnBox = true;
                }
                
                const squareImg = new Image();
                squareImg.onload = async function() {
                    try {
                        await squareImg.decode();
                        previewImages.square = squareImg;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square image decode failed:', e);
                    }
                };
                
                try {
                    squareImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/square.png?ts=${Date.now()}`;
                } catch (_) {
                    squareImg.src = `/assets/templates/${slug}/square.png?ts=${Date.now()}`;
                }
                
                if (meta.story) {
                    const storyImg = new Image();
                    storyImg.onload = async function() {
                        try {
                            await storyImg.decode();
                            previewImages.story = storyImg;
                            renderPreview('story');
                        } catch(e) {
                            console.error('Story image decode failed:', e);
                        }
                    };
                    
                    try {
                        storyImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/story.png?ts=${Date.now()}`;
                    } catch (_) {
                        storyImg.src = `/assets/templates/${slug}/story.png?ts=${Date.now()}`;
                    }
                }
                
                document.getElementById('submitBtn').textContent = 'Update Template';
                
            } catch (error) {
                showAlert('uploadAlert', 'Failed to load template: ' + error.message, true);
                console.error('Error loading template for edit:', error);
            }
        }

        // Delete template
        function deleteTemplate(slug, name) {
            document.getElementById('modalTitle').textContent = 'Delete Template?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                try {
                    const response = await fetch('/api/delete-template', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showAlert('uploadAlert', `Template "${name}" deleted successfully `);
                        loadAssets();
                    } else {
                        showAlert('uploadAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('uploadAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteConfirmCallback = null;
        }

        // Toggle Telegram visibility
        async function toggleTelegramVisibility(event, slug, enabled) {
            const checkbox = event.target;
            const label = checkbox.closest('.telegram-toggle-label');
            const toggleText = label.querySelector('.telegram-toggle-text');
            const container = checkbox.closest('.telegram-toggle-container');
            
            try {
                const response = await fetch('/api/toggle-telegram-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug, enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    toggleText.textContent = enabled ? ' Telegram' : ' Telegram';
                    container.title = enabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot';
                    const statusMsg = enabled ? 'enabled' : 'disabled';
                    showAlert('uploadAlert', `Template "${slug}" ${statusMsg} for Telegram `);
                } else {
                    checkbox.checked = !enabled;
                    showAlert('uploadAlert', 'Failed to update: ' + data.error, true);
                }
            } catch (error) {
                checkbox.checked = !enabled;
                showAlert('uploadAlert', 'Failed to update Telegram visibility: ' + error.message, true);
                console.error('Toggle error:', error);
            }
        }

        // Bulk delete
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllTemplates').checked;
            document.querySelectorAll('.template-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.template-checkbox');
            const checkedBoxes = document.querySelectorAll('.template-checkbox:checked');
            document.getElementById('selectAllTemplates').checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }

        function deleteSelectedTemplates() {
            const selected = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => ({
                slug: cb.dataset.slug,
                name: cb.dataset.name
            }));
            
            if (selected.length === 0) {
                showAlert('uploadAlert', 'No templates selected', true);
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Delete Multiple Templates?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete ${selected.length} template(s)? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                let successCount = 0;
                let failCount = 0;
                
                for (const template of selected) {
                    try {
                        const response = await fetch('/api/delete-template', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug: template.slug })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                if (successCount > 0) {
                    showAlert('uploadAlert', `Successfully deleted ${successCount} template(s) `);
                }
                if (failCount > 0) {
                    showAlert('uploadAlert', `Failed to delete ${failCount} template(s)`, true);
                }
                
                loadAssets();
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        // Color selection
        function selectColor(color, variant) {
            document.querySelectorAll(`.color-swatch[data-variant="${variant}"]`).forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
            document.getElementById(variant + 'FontColor').value = color;
            updatePreviews();
        }

        // Canvas preview setup
        const previewSquareCanvas = document.getElementById('previewSquare');
        const previewStoryCanvas = document.getElementById('previewStory');
        const ctxSquare = previewSquareCanvas.getContext('2d');
        const ctxStory = previewStoryCanvas.getContext('2d');

        const previewImages = {
            square: null,
            story: null
        };

        const drawingState = {
            square: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false },
            story: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false }
        };

        function computeAutoFontPx(ctx, text, maxWidth, maxHeight, minPx) {
            let lo = minPx, hi = maxHeight;
            while (hi - lo > 1) {
                const mid = Math.floor((lo + hi) / 2);
                ctx.font = `700 ${mid}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
                const metrics = ctx.measureText(text);
                if (metrics.width <= maxWidth) {
                    lo = mid;
                } else {
                    hi = mid;
                }
            }
            return lo;
        }

        function drawTextAutoFit(ctx, text, natW, natH, box, maxPx, fontColor) {
            const left = Math.round(natW * (box.leftPct / 100));
            const top = Math.round(natH * (box.topPct / 100));
            const width = Math.round(natW * (box.widthPct / 100));
            const height = Math.round(natH * (box.heightPct / 100));

            const cap = Math.min(maxPx, height);
            const px = computeAutoFontPx(ctx, text, width, cap, 8);

            const hAlign = (box?.hAlign || 'center');
            let x = left;
            let textAlign = 'left';
            if (hAlign === 'center') {
                x = left + Math.round(width / 2);
                textAlign = 'center';
            } else if (hAlign === 'right') {
                x = left + width;
                textAlign = 'right';
            }

            const vAlign = (box?.vAlign || 'bottom');
            let y = top + px;
            if (vAlign === 'middle') {
                y = top + Math.round(height / 2) + Math.round(px * 0.35);
            } else if (vAlign === 'bottom') {
                y = top + height;
            }

            ctx.font = `700 ${px}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'alphabetic';
            ctx.lineJoin = 'round';
            ctx.lineWidth = Math.max(2, Math.floor(px * 0.08));
            ctx.strokeStyle = 'rgba(0,0,0,.75)';
            ctx.fillStyle = fontColor || '#ffffff';
            ctx.strokeText(text, x, y);
            ctx.fillText(text, x, y);
        }

        function renderPreview(variant, showBoundingBox = false) {
            const canvas = variant === 'square' ? previewSquareCanvas : previewStoryCanvas;
            const ctx = variant === 'square' ? ctxSquare : ctxStory;
            const img = previewImages[variant];

            const natW = img && img.naturalWidth ? img.naturalWidth : 1080;
            const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

            const off = document.createElement('canvas');
            off.width = natW;
            off.height = natH;
            const og = off.getContext('2d');
            og.imageSmoothingQuality = 'high';

            if (img && img.naturalWidth) {
                og.drawImage(img, 0, 0, natW, natH);
            } else {
                og.fillStyle = '#10131a';
                og.fillRect(0, 0, natW, natH);
            }

            const prefix = variant === 'square' ? 'square' : 'story';
            const box = {
                leftPct: parseFloat(document.getElementById(prefix + 'LeftPct').value) || 5,
                topPct: parseFloat(document.getElementById(prefix + 'TopPct').value) || 78,
                widthPct: parseFloat(document.getElementById(prefix + 'WidthPct').value) || 90,
                heightPct: parseFloat(document.getElementById(prefix + 'HeightPct').value) || 12,
                hAlign: 'center',
                vAlign: 'middle'
            };
            const maxFontPx = parseInt(document.getElementById(prefix + 'MaxFontPx').value) || 80;

            if (showBoundingBox) {
                const boxLeft = Math.round(natW * (box.leftPct / 100));
                const boxTop = Math.round(natH * (box.topPct / 100));
                const boxWidth = Math.round(natW * (box.widthPct / 100));
                const boxHeight = Math.round(natH * (box.heightPct / 100));
                
                og.fillStyle = 'rgba(102, 126, 234, 0.15)';
                og.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                og.strokeStyle = 'rgba(102, 126, 234, 0.6)';
                og.lineWidth = Math.max(2, Math.round(Math.min(natW, natH) * 0.003));
                og.strokeRect(boxLeft, boxTop, boxWidth, boxHeight);
            }

            const state = drawingState[variant];
            if (state.hasDrawnBox) {
                const fontColor = document.getElementById(variant + 'FontColor').value || '#FF273E';
                drawTextAutoFit(og, 'COUPON-AREA', natW, natH, box, maxFontPx, fontColor);
            }

            const targetW = Math.max(1, Math.round(canvas.parentElement.clientWidth));
            const targetH = Math.max(1, Math.round(canvas.parentElement.clientHeight));
            const pixelRatio = window.devicePixelRatio || 2;
            canvas.width = targetW * pixelRatio;
            canvas.height = targetH * pixelRatio;
            canvas.style.width = targetW + 'px';
            canvas.style.height = targetH + 'px';
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(pixelRatio, pixelRatio);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, targetW, targetH);
            
            const scale = Math.min(targetW / natW, targetH / natH);
            const dw = Math.ceil(natW * scale);
            const dh = Math.ceil(natH * scale);
            const dx = Math.round((targetW - dw) / 2);
            const dy = Math.round((targetH - dh) / 2);
            
            ctx.drawImage(off, 0, 0, natW, natH, dx, dy, dw, dh);
        }

        let updatePreviewsTimeout = null;
        function updatePreviews() {
            if (updatePreviewsTimeout) {
                clearTimeout(updatePreviewsTimeout);
            }
            updatePreviewsTimeout = setTimeout(() => {
                renderPreview('square');
                renderPreview('story');
            }, 50);
        }
        
        function updatePreviewsImmediate() {
            renderPreview('square');
            renderPreview('story');
        }

        // Image upload handlers
        document.getElementById('squareImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.square.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.square = img;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        document.getElementById('storyImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.story.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.story = img;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // Slider sync
        function setupSliderSync(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            if (!slider || !input) return;
            
            slider.addEventListener('input', function() {
                input.value = parseFloat(this.value).toFixed(1);
                updatePreviews();
            });
            
            input.addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!isNaN(val)) {
                    slider.value = val;
                }
                updatePreviews();
            });
        }

        setupSliderSync('squareMaxFontPxSlider', 'squareMaxFontPx');
        setupSliderSync('storyMaxFontPxSlider', 'storyMaxFontPx');

        // Drag-to-draw
        function setupDragToDraw(canvasId, variant) {
            const canvas = document.getElementById(canvasId);
            const state = drawingState[variant];

            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            function convertToImagePercentages(startX, startY, endX, endY) {
                const rect = canvas.getBoundingClientRect();
                const canvasDisplayWidth = rect.width;
                const canvasDisplayHeight = rect.height;

                const img = previewImages[variant];
                const natW = img && img.naturalWidth ? img.naturalWidth : (variant === 'square' ? 1080 : 1080);
                const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

                const scale = Math.min(canvasDisplayWidth / natW, canvasDisplayHeight / natH);
                const scaledImageWidth = natW * scale;
                const scaledImageHeight = natH * scale;

                const offsetX = (canvasDisplayWidth - scaledImageWidth) / 2;
                const offsetY = (canvasDisplayHeight - scaledImageHeight) / 2;

                const imgX1 = (Math.min(startX, endX) - offsetX) / scaledImageWidth;
                const imgY1 = (Math.min(startY, endY) - offsetY) / scaledImageHeight;
                const imgX2 = (Math.max(startX, endX) - offsetX) / scaledImageWidth;
                const imgY2 = (Math.max(startY, endY) - offsetY) / scaledImageHeight;

                const leftPct = Math.max(0, Math.min(100, imgX1 * 100));
                const topPct = Math.max(0, Math.min(100, imgY1 * 100));
                const widthPct = Math.max(1, Math.min(100 - leftPct, (imgX2 - imgX1) * 100));
                const heightPct = Math.max(1, Math.min(100 - topPct, (imgY2 - imgY1) * 100));

                return { leftPct, topPct, widthPct, heightPct };
            }

            function drawDragRectangle() {
                if (!state.isDrawing) return;

                const ctx = variant === 'square' ? ctxSquare : ctxStory;
                
                renderPreview(variant, true);

                const x1 = Math.min(state.startX, state.currentX);
                const y1 = Math.min(state.startY, state.currentY);
                const width = Math.abs(state.currentX - state.startX);
                const height = Math.abs(state.currentY - state.startY);

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);

                ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                ctx.fillRect(x1, y1, width, height);
                ctx.restore();
            }

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCanvasCoordinates(e);
                state.isDrawing = true;
                state.startX = coords.x;
                state.startY = coords.y;
                state.currentX = coords.x;
                state.currentY = coords.y;
                renderPreview(variant, true);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                drawDragRectangle();
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                state.isDrawing = false;

                const minDragDistance = 10;
                if (Math.abs(state.currentX - state.startX) < minDragDistance || 
                    Math.abs(state.currentY - state.startY) < minDragDistance) {
                    renderPreview(variant);
                    return;
                }

                const percentages = convertToImagePercentages(
                    state.startX, state.startY, 
                    state.currentX, state.currentY
                );

                const prefix = variant === 'square' ? 'square' : 'story';
                document.getElementById(prefix + 'LeftPct').value = percentages.leftPct.toFixed(1);
                document.getElementById(prefix + 'TopPct').value = percentages.topPct.toFixed(1);
                document.getElementById(prefix + 'WidthPct').value = percentages.widthPct.toFixed(1);
                document.getElementById(prefix + 'HeightPct').value = percentages.heightPct.toFixed(1);

                state.hasDrawnBox = true;

                updatePreviewsImmediate();
            });

            canvas.addEventListener('mouseleave', (e) => {
                if (state.isDrawing) {
                    state.isDrawing = false;
                    renderPreview(variant);
                }
            });
        }

        setupDragToDraw('previewSquare', 'square');
        setupDragToDraw('previewStory', 'story');

        // Nudge controls
        function nudgePosition(variant, direction) {
            const prefix = variant === 'square' ? 'square' : 'story';
            const leftInput = document.getElementById(prefix + 'LeftPct');
            const topInput = document.getElementById(prefix + 'TopPct');
            
            const step = 0.5;
            let currentLeft = parseFloat(leftInput.value) || 5;
            let currentTop = parseFloat(topInput.value) || 78;
            
            switch(direction) {
                case 'up':
                    currentTop = Math.max(0, currentTop - step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'down':
                    currentTop = Math.min(100, currentTop + step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'left':
                    currentLeft = Math.max(0, currentLeft - step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
                case 'right':
                    currentLeft = Math.min(100, currentLeft + step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
            }
            
            updatePreviews();
        }

        // Campaign Management
        async function loadCampaigns() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading campaigns...</p>';
            
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                
                if (!data.campaigns || data.campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">No campaigns found</p>';
                    return;
                }
                
                campaignsList.innerHTML = '';
                data.campaigns.forEach(campaign => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <div class="asset-item-info" style="flex: 1;">
                            <div class="asset-name">${campaign.title}</div>
                            <div class="asset-slug">${campaign.description} | ${campaign.start_date} to ${campaign.end_date}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="editCampaign(${campaign.id})"></div>
                            <div class="asset-delete-icon" onclick="deleteCampaign(${campaign.id}, '${campaign.title}')"></div>
                        </div>
                    `;
                    campaignsList.appendChild(item);
                });
            } catch (error) {
                campaignsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading campaigns</p>';
                console.error('Failed to load campaigns:', error);
            }
        }

        async function handleCampaignSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('title', document.getElementById('campaignTitle').value);
            formData.append('description', document.getElementById('campaignDescription').value);
            formData.append('start_date', document.getElementById('campaignStartDate').value);
            formData.append('end_date', document.getElementById('campaignEndDate').value);
            
            const editId = document.getElementById('campaignEditId').value;
            if (editId) {
                formData.append('id', editId);
            }
            
            const overlayFile = document.getElementById('campaignOverlay').files[0];
            if (overlayFile) {
                formData.append('overlay', overlayFile);
            } else if (document.getElementById('existingOverlayUrl').value) {
                formData.append('existing_overlay_url', document.getElementById('existingOverlayUrl').value);
            }
            
            const submitBtn = document.getElementById('campaignSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = editId ? 'Updating...' : 'Creating...';
            
            try {
                const response = await fetch(editId ? '/api/edit-campaign' : '/api/create-campaign', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('campaignAlert', data.message + ' ');
                    clearCampaignForm();
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Operation failed', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Operation failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editId ? 'Update Campaign' : 'Create Campaign';
            }
        }

        async function editCampaign(id) {
            try {
                const response = await fetch(`/api/campaigns`);
                const data = await response.json();
                const campaign = data.campaigns.find(c => c.id === id);
                
                if (campaign) {
                    document.getElementById('campaignTitle').value = campaign.title;
                    document.getElementById('campaignDescription').value = campaign.description;
                    document.getElementById('campaignStartDate').value = campaign.start_date;
                    document.getElementById('campaignEndDate').value = campaign.end_date;
                    document.getElementById('campaignEditId').value = campaign.id;
                    
                    if (campaign.overlay_url) {
                        document.getElementById('existingOverlayUrl').value = campaign.overlay_url;
                        document.getElementById('overlayPreviewImg').src = campaign.overlay_url;
                        document.getElementById('overlayPreview').style.display = 'block';
                    }
                    
                    document.getElementById('campaignFormTitle').textContent = 'Edit Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Update Campaign';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to load campaign: ' + error.message, true);
            }
        }

        async function deleteCampaign(id, title) {
            if (!confirm(`Delete campaign "${title}"?`)) return;
            
            try {
                const response = await fetch('/api/delete-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('campaignAlert', 'Campaign deleted successfully ');
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Delete failed', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Delete failed: ' + error.message, true);
            }
        }

        function handleOverlayPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('overlayPreviewImg').src = e.target.result;
                    document.getElementById('overlayPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearOverlay() {
            document.getElementById('campaignOverlay').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('existingOverlayUrl').value = '';
        }

        function clearCampaignForm() {
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignEditId').value = '';
            document.getElementById('existingOverlayUrl').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
            document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
        }

        // Broadcast Functions
        async function loadBroadcastData() {
            await Promise.all([
                loadActiveUsersCount(),
                loadBroadcastHistory()
            ]);
        }

        async function loadActiveUsersCount() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                document.getElementById('activeUsersCount').textContent = data.active_users || 0;
            } catch (error) {
                console.error('Error loading active users:', error);
                document.getElementById('activeUsersCount').textContent = '?';
            }
        }

        async function loadBroadcastHistory() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    document.getElementById('broadcastHistory').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            No broadcasts sent yet
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Message</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Recipients</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Sent</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Failed</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.jobs.forEach(job => {
                    const statusColor = {
                        'completed': '#10b981',
                        'processing': '#3b82f6',
                        'failed': '#ef4444',
                        'pending': '#f59e0b'
                    }[job.status] || '#718096';

                    const messagePreview = job.message.length > 50 
                        ? job.message.substring(0, 50) + '...' 
                        : job.message;

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px; font-size: 14px; color: #1a202c;">${messagePreview}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                                    ${job.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #4a5568;">${job.total_users}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #10b981; font-weight: 600;">${job.sent_count}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #ef4444; font-weight: 600;">${job.failed_count}</td>
                            <td style="padding: 12px; font-size: 13px; color: #718096;">${new Date(job.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('broadcastHistory').innerHTML = html;
            } catch (error) {
                console.error('Error loading broadcast history:', error);
                document.getElementById('broadcastHistory').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Error loading broadcast history
                    </div>
                `;
            }
        }

        async function sendBroadcast(event) {
            event.preventDefault();

            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showAlert('broadcastAlert', 'Please enter a message', true);
                return;
            }

            if (!confirm(`Send this broadcast to all active users?`)) {
                return;
            }

            document.getElementById('broadcastBtnText').style.display = 'none';
            document.getElementById('broadcastBtnSpinner').style.display = 'inline-block';
            document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, days: 30 })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('broadcastAlert', ` Broadcast started! Sending to ${data.total_users} users. Job ID: ${data.job_id}`);
                    document.getElementById('broadcastForm').reset();
                    
                    setTimeout(() => loadBroadcastHistory(), 2000);
                } else {
                    showAlert('broadcastAlert', data.error || 'Failed to send broadcast', true);
                }
            } catch (error) {
                showAlert('broadcastAlert', 'Error: ' + error.message, true);
            } finally {
                document.getElementById('broadcastBtnText').style.display = 'inline';
                document.getElementById('broadcastBtnSpinner').style.display = 'none';
                document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = false;
            }
        }

        function previewBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message first');
                return;
            }

            const htmlMessage = message
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<strong>$1</strong>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">$1</code>')
                .replace(/\n/g, '<br>');

            const previewWindow = window.open('', 'Broadcast Preview', 'width=400,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Broadcast Preview</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            padding: 20px;
                            background: #0d1117;
                            color: #fff;
                        }
                        .message {
                            background: #1c2128;
                            padding: 16px;
                            border-radius: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                        }
                        .label {
                            color: #8b949e;
                            font-size: 12px;
                            margin-bottom: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="label"> Telegram Message Preview</div>
                    <div class="message">${htmlMessage}</div>
                </body>
                </html>
            `);
        }

        // Analytics Functions
        let currentAnalyticsDays = 7;
        let analyticsChart = null;
        let allInvalidCoupons = [];
        let dayOfWeekChart = null;

        async function changeAnalyticsPeriod(days) {
            currentAnalyticsDays = days;
            
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.days == days) {
                    btn.classList.add('active');
                }
            });
            
            loadAnalytics();
        }

        async function loadAnalytics() {
            try {
                const [statsResponse, retentionResponse] = await Promise.all([
                    fetch(`/api/bot-stats?days=${currentAnalyticsDays}`),
                    fetch('/api/retention-rates')
                ]);
                
                if (!statsResponse.ok) {
                    throw new Error('Failed to load analytics');
                }

                const stats = await statsResponse.json();
                const retention = retentionResponse.ok ? await retentionResponse.json() : { day1: 0, day7: 0, day30: 0 };
                renderAnalyticsStats(stats, retention);
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analytics-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Failed to load analytics. Please try again.
                    </div>
                `;
            }
        }

        function renderAnalyticsStats(stats, retention = { day1: 0, day7: 0, day30: 0 }) {
            const content = document.getElementById('analytics-content');
            
            if (stats.total_uses === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <h2>No bot usage data yet</h2>
                        <p>Start using the Telegram bot to see statistics here.</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Total Uses</div>
                        <div class="analytics-stat-value">${stats.total_uses.toLocaleString()}</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Success Rate</div>
                        <div class="analytics-stat-value">${stats.success_rate}%</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Unique Users</div>
                        <div class="analytics-stat-value">${stats.unique_users.toLocaleString()}</div>
                    </div>
                </div>

                <div class="card chart-card">
                    <div class="card-title" id="usageChartTitle">Daily Usage</div>
                    <div class="chart-container">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>
                
                <div class="section-header">
                    <h3 class="section-title"> User Retention Metrics</h3>
                    <p class="section-subtitle">Independent metrics showing % of users who return after first use (all-time data)</p>
                </div>
                
                <div class="analytics-stats-grid retention-grid">
                    <div class="analytics-stat-card retention-card-day1">
                        <div class="analytics-stat-label">Day 1 Retention</div>
                        <div class="analytics-stat-value">${retention.day1}%</div>
                        <div class="analytics-stat-subtext">Users who return within 24-48h</div>
                    </div>
                    <div class="analytics-stat-card retention-card-day7">
                        <div class="analytics-stat-label">Day 7 Retention</div>
                        <div class="analytics-stat-value">${retention.day7}%</div>
                        <div class="analytics-stat-subtext">Users who return within 7-14 days</div>
                    </div>
                    <div class="analytics-stat-card retention-card-day30">
                        <div class="analytics-stat-label">Day 30 Retention</div>
                        <div class="analytics-stat-value">${retention.day30}%</div>
                        <div class="analytics-stat-subtext">Users who return within 30-60 days</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Most Active Users</div>
                    <div id="mostActiveUsersContainer">
                        <p class="loading-text">Loading most active users...</p>
                    </div>
                </div>

                <div class="analytics-row">
                    <div class="card">
                        <div id="dayOfWeekCardTitle" class="card-title"> Most Popular Days</div>
                        <div class="chart-container">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div id="dayOfWeekStatsText" class="day-of-week-stats"></div>
                    </div>

                    <div class="card">
                        <div class="card-title"> Popular Templates</div>
                        <div class="table-container">
                            ${renderAnalyticsTemplatesTable(stats.popular_templates)}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Popular Coupon Codes</div>
                    <div class="table-container">
                        ${renderAnalyticsCouponsTable(stats.popular_coupons)}
                    </div>
                </div>

                <div class="card" style="background: #fef2f2; border: 2px solid #fee2e2;">
                    <div class="card-title"> Invalid Coupon Attempts</div>
                    <div id="invalidCouponsContainer">
                        <p class="loading-text">Loading invalid coupon attempts...</p>
                    </div>
                </div>

                ${stats.errors && stats.errors.length > 0 ? `
                    <div class="card">
                        <h2 class="card-title">Error Breakdown</h2>
                        <div class="table-container">
                            ${renderAnalyticsErrorsTable(stats.errors)}
                        </div>
                    </div>
                ` : ''}
            `;

            renderAnalyticsChart(stats.daily_usage);
            
            setTimeout(() => {
                loadInvalidCoupons();
                loadMostActiveUsers();
                loadDayOfWeekStats();
            }, 0);
        }

        function renderAnalyticsTemplatesTable(templates) {
            if (!templates || templates.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No template usage data</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Template</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${templates.map(t => `
                            <tr>
                                <td>${t.template}</td>
                                <td>${t.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsCouponsTable(coupons) {
            if (!coupons || coupons.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No coupon usage data</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Coupon Code</th>
                            <th>Uses</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coupons.map(c => `
                            <tr>
                                <td>${c.coupon}</td>
                                <td>${c.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsErrorsTable(errors) {
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Error Type</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${errors.map(e => `
                            <tr>
                                <td>${e.type.replace(/_/g, ' ').toUpperCase()}</td>
                                <td>${e.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAnalyticsChart(dailyData) {
            if (analyticsChart) {
                analyticsChart.destroy();
            }

            const ctx = document.getElementById('analyticsChart');
            if (!ctx) return;
            
            const sortedData = dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));

            analyticsChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedData.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Bot Uses',
                        data: sortedData.map(d => d.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#718096' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#718096' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // Invalid Coupon Attempts
        async function loadInvalidCoupons() {
            try {
                const response = await fetch(`/api/invalid-coupons?limit=1000&offset=0&days=${currentAnalyticsDays}`);
                const data = await response.json();
                
                allInvalidCoupons = data.attempts || [];
                renderInvalidCoupons(data.attempts || [], data.total || 0);
            } catch (error) {
                console.error('Error loading invalid coupons:', error);
                document.getElementById('invalidCouponsContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load invalid coupon attempts</p>
                `;
            }
        }

        function renderInvalidCoupons(attempts, total) {
            const container = document.getElementById('invalidCouponsContainer');
            
            if (attempts.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No invalid coupon attempts</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-secondary" onclick="exportInvalidCouponsCSV()" style="padding: 8px 16px;">
                         Export CSV
                    </button>
                    <span style="color: #4a5568;"><strong>${total.toLocaleString()}</strong> total invalid attempts</span>
                </div>
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead style="background: #fecaca;">
                            <tr>
                                <th>Invalid Code</th>
                                <th>Template Used</th>
                                <th>User</th>
                                <th>Timestamp</th>
                                <th>Attempts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allInvalidCoupons.map(a => {
                                let userDisplay;
                                const fullName = [a.first_name, a.last_name].filter(Boolean).join(' ');
                                const usernameLink = a.username ? `<a href="https://t.me/${a.username}" target="_blank" class="telegram-link">@${a.username}</a>` : '';
                                
                                if (fullName && a.username) {
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (a.username) {
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    userDisplay = fullName;
                                } else {
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr>
                                        <td><code>${a.coupon_code}</code></td>
                                        <td>${a.template_name || 'N/A'}</td>
                                        <td>${userDisplay}</td>
                                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                                        <td>${a.attempt_count || 1}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportInvalidCouponsCSV() {
            if (allInvalidCoupons.length === 0) {
                alert('No invalid coupon data to export');
                return;
            }

            const csvContent = [
                ['Coupon Code', 'Template', 'Username', 'First Name', 'Last Name', 'Timestamp', 'Attempts'],
                ...allInvalidCoupons.map(a => [
                    a.coupon_code,
                    a.template_name || 'N/A',
                    a.username || '',
                    a.first_name || '',
                    a.last_name || '',
                    new Date(a.timestamp).toISOString(),
                    a.attempt_count || 1
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `invalid-coupons-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // User Details Modal
        async function showUserDetails(chatId) {
            const modal = document.getElementById('userDetailsModal');
            const content = document.getElementById('userDetailsContent');
            
            modal.classList.add('active');
            content.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">Loading user details...</p>';
            
            try {
                const response = await fetch(`/api/user-activity/${chatId}`);
                const data = await response.json();
                
                const user = data.user || {};
                const history = data.history || [];
                
                let userDisplay;
                const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ');
                const usernameLink = user.username ? `<a href="https://t.me/${user.username}" target="_blank" class="telegram-link">@${user.username}</a>` : '';
                
                if (fullName && user.username) {
                    userDisplay = `${fullName} (${usernameLink})`;
                } else if (user.username) {
                    userDisplay = usernameLink;
                } else if (fullName) {
                    userDisplay = fullName;
                } else {
                    userDisplay = 'Unknown User';
                }
                
                content.innerHTML = `
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px; color: #1a202c;">User Profile</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <strong style="color: #4a5568;">User:</strong> ${userDisplay}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Chat ID:</strong> <code>${user.chat_id}</code>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Total Generations:</strong> ${user.total_generations || 0}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Unique Coupons:</strong> ${user.unique_coupons || 0}
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 12px; color: #1a202c;">Activity History</h3>
                    ${history.length === 0 ? `
                        <p style="color: #718096; text-align: center; padding: 20px;">No activity history</p>
                    ` : `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Template</th>
                                        <th>Coupon</th>
                                        <th>Status</th>
                                        <th>Error Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${history.map(h => {
                                        const isSuccess = h.success || h.status === 'success';
                                        const statusBadge = isSuccess 
                                            ? '<span class="status-badge status-success">Success</span>'
                                            : '<span class="status-badge status-error">Failed</span>';
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(h.timestamp).toLocaleString()}</td>
                                                <td>${h.template || 'N/A'}</td>
                                                <td><code>${h.coupon_code || 'N/A'}</code></td>
                                                <td>${statusBadge}</td>
                                                <td>${h.error_type || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                content.innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 40px;">
                        Failed to load user details. Please try again.
                    </p>
                `;
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
        }

        // Most Active Users Leaderboard
        async function loadMostActiveUsers() {
            try {
                const response = await fetch('/api/bot-users?limit=1000&offset=0');
                const data = await response.json();
                
                renderMostActiveUsers(data.users || []);
            } catch (error) {
                console.error('Error loading most active users:', error);
                document.getElementById('mostActiveUsersContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load most active users</p>
                `;
            }
        }

        function renderMostActiveUsers(users) {
            const container = document.getElementById('mostActiveUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No user data available</p>';
                return;
            }

            const badges = ['', '', ''];
            const rankClasses = ['leaderboard-rank-1', 'leaderboard-rank-2', 'leaderboard-rank-3'];

            container.innerHTML = `
                <div class="table-scroll">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Total Gens</th>
                                <th>Unique Coupons</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((u, index) => {
                                const rank = index + 1;
                                const badge = rank <= 3 ? badges[index] : '';
                                const rankClass = rank <= 3 ? rankClasses[index] : '';
                                
                                let userDisplay;
                                const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                                const usernameLink = u.username ? `<a href="https://t.me/${u.username}" target="_blank" class="telegram-link">@${u.username}</a>` : '';
                                
                                if (fullName && u.username) {
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (u.username) {
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    userDisplay = fullName;
                                } else {
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr class="${rankClass}">
                                        <td><span class="leaderboard-rank">${badge} #${rank}</span></td>
                                        <td>${userDisplay}</td>
                                        <td>${u.total_generations || 0}</td>
                                        <td>${u.unique_coupons || 0}</td>
                                        <td>${u.first_used ? new Date(u.first_used).toLocaleDateString() : 'N/A'}</td>
                                        <td>${u.last_used ? new Date(u.last_used).toLocaleDateString() : 'N/A'}</td>
                                        <td><button class="view-details-btn" style="padding: 6px 12px; font-size: 12px; border: 2px solid #7c3aed; color: #7c3aed; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onclick="showUserDetails(${u.chat_id})">View Details</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Utility function to capitalize first letter
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        // Day of Week / Hour Analytics
        async function loadDayOfWeekStats() {
            try {
                const response = await fetch(`/api/day-of-week-stats?days=${currentAnalyticsDays}`);
                const result = await response.json();
                
                const titleElement = document.getElementById('dayOfWeekCardTitle');
                if (result.type === 'hourly') {
                    titleElement.textContent = ' Most Popular Hours';
                } else {
                    titleElement.textContent = ' Most Popular Days';
                }
                
                if (result.data && result.data.length > 0) {
                    renderDayOfWeekChart(result.data, result.type);
                } else {
                    const chartContainer = document.querySelector('#dayOfWeekChart').parentElement;
                    chartContainer.innerHTML = `
                        <p style="color: #718096; text-align: center; padding: 40px;">No data available yet</p>
                    `;
                    document.getElementById('dayOfWeekStatsText').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading day-of-week analytics:', error);
                const chartContainer = document.querySelector('#dayOfWeekChart')?.parentElement;
                if (chartContainer) {
                    chartContainer.innerHTML = `
                        <p style="color: #ef4444; text-align: center; padding: 40px;">Failed to load analytics</p>
                    `;
                }
                document.getElementById('dayOfWeekStatsText').innerHTML = '';
            }
        }

        function renderDayOfWeekChart(data, type) {
            if (dayOfWeekChart) {
                dayOfWeekChart.destroy();
            }

            const ctx = document.getElementById('dayOfWeekChart');
            if (!ctx) return;

            const labels = data.map(d => d.label);
            const counts = data.map(d => d.count);
            
            const maxCount = Math.max(...counts);
            const backgroundColor = counts.map(count => 
                count === maxCount && maxCount > 0 ? '#fbbf24' : '#667eea'
            );

            const totalGenerations = counts.reduce((sum, count) => sum + count, 0);
            const mostPopularLabel = maxCount > 0 ? labels[counts.indexOf(maxCount)] : null;

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bot Uses',
                        data: counts,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const isPeak = value === maxCount && maxCount > 0;
                                    return `Uses: ${value}${isPeak ? '  Peak!' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            const labelType = type === 'hourly' ? 'Hour' : 'Day';
            if (mostPopularLabel) {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong> | 
                     Most Popular ${labelType}: <strong>${mostPopularLabel}</strong> (${maxCount} uses)
                `;
            } else {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong>
                `;
            }
        }

        // Initial render
        updatePreviewsImmediate();

    </script>

    <!-- User Details Modal -->
    <div class="modal-overlay" id="userDetailsModal">
        <div class="modal-box" style="max-width: 900px;">
            <div class="modal-title">User Details</div>
            <div id="userDetailsContent" style="margin: 20px 0; max-height: 500px; overflow-y: auto;">
                <p style="color: #718096; text-align: center;">Loading user details...</p>
            </div>
            <div style="text-align: center;">
                <button class="modal-btn modal-btn-cancel" onclick="closeUserDetailsModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
