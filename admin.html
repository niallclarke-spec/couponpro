<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | PromoStack</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo img {
            width: 220px;
            height: auto;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 32px;
            color: #1a202c;
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #1a1d29;
            color: #a0aec0;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo img {
            width: 180px;
            height: auto;
        }

        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            padding: 0 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a0aec0;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            color: #fff;
            border-left-color: #667eea;
        }

        .nav-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .content-header {
            background: white;
            padding: 32px 40px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .content-header p {
            color: #718096;
            font-size: 14px;
        }

        .content-body {
            padding: 40px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            color: #2d3748;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .hint {
            font-size: 12px;
            color: #718096;
            margin-top: 6px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* View Details Button - Purple Theme */
        .view-details-btn:hover {
            background: #7c3aed !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }

        /* Analytics Filter Buttons */
        .analytics-filter-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 10px 20px;
            margin: 0 6px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .analytics-filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .analytics-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        /* Analytics Stats Grid */
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .analytics-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 24px;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .analytics-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
        }

        .analytics-stat-label {
            font-size: 13px;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Analytics Section Containers */
        .analytics-section {
            margin-bottom: 32px;
        }

        .analytics-section:last-child {
            margin-bottom: 0;
        }

        /* Analytics Tables */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .analytics-table thead {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .analytics-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-size: 14px;
        }

        .analytics-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .analytics-table tbody tr:hover {
            background: #f8fafc;
        }

        .analytics-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Scrollable Table Container */
        .table-scroll {
            max-height: 360px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Side-by-side layout for Device Analytics and Popular Templates */
        .analytics-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .analytics-row .card {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 1024px) {
            .analytics-row {
                flex-direction: column;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #718096;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Assets/Templates List */
        .assets-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .delete-selected-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .asset-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .asset-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
            transform: translateX(4px);
        }

        .template-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
            flex-shrink: 0;
        }

        .asset-item-info {
            flex: 1;
        }

        .asset-name {
            font-weight: 600;
            color: #1a202c;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .asset-slug {
            font-size: 13px;
            color: #718096;
        }

        .telegram-toggle-container {
            display: flex;
            align-items: center;
            margin-right: 12px;
        }

        .telegram-toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .telegram-toggle-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .telegram-toggle-text {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .telegram-toggle-checkbox:checked + .telegram-toggle-slider + .telegram-toggle-text {
            color: #10b981;
        }

        .telegram-toggle-checkbox:not(:checked) + .telegram-toggle-slider + .telegram-toggle-text {
            color: #94a3b8;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .asset-edit-icon,
        .asset-delete-icon {
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }

        .asset-edit-icon {
            color: #667eea;
        }

        .asset-edit-icon:hover {
            transform: scale(1.2);
        }

        .asset-delete-icon {
            color: #ef4444;
        }

        .asset-delete-icon:hover {
            transform: scale(1.2);
        }

        /* Template Section */
        .template-section {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            background: #fafbfc;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .section-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
        }

        .preview-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .preview-frame {
            position: relative;
            background: #0a0b10;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .preview-frame.square {
            aspect-ratio: 1/1;
        }

        .preview-frame.story {
            aspect-ratio: 9/16;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .preview-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 10;
        }

        /* Row Layout */
        .row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* Slider */
        .slider {
            width: 100%;
            max-width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            margin-bottom: 8px;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        /* Color Picker */
        .color-picker-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .color-swatches {
            display: flex;
            gap: 12px;
        }

        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,.25);
        }

        .color-swatch.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(0,0,0,.25);
        }

        .color-swatch.red {
            background: #FF273E;
        }

        .color-swatch.white {
            background: #FFFFFF;
            border: 1px solid #e2e8f0;
        }

        .color-swatch-label {
            font-size: 11px;
            color: #718096;
            text-align: center;
            margin-top: 4px;
        }

        /* Nudge Controls */
        .nudge-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
            align-items: center;
        }

        .nudge-controls-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .nudge-buttons {
            display: grid;
            grid-template-columns: repeat(3, 36px);
            grid-template-rows: repeat(3, 36px);
            gap: 6px;
        }

        .nudge-btn {
            background: white;
            color: #667eea;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nudge-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .nudge-up { grid-column: 2; grid-row: 1; }
        .nudge-left { grid-column: 1; grid-row: 2; }
        .nudge-right { grid-column: 3; grid-row: 2; }
        .nudge-down { grid-column: 2; grid-row: 3; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: scale(0.95) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            text-align: center;
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 15px;
            color: #718096;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #edf2f7;
            color: #4a5568;
        }

        .modal-btn-cancel:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table thead {
            background: #f7fafc;
        }

        .leaderboard-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .leaderboard-table tbody tr {
            transition: transform 0.2s;
        }

        .leaderboard-table tbody tr:hover {
            transform: scale(1.01);
        }

        .leaderboard-rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%) !important;
        }

        .leaderboard-rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15) 0%, rgba(192, 192, 192, 0.05) 100%) !important;
        }

        .leaderboard-rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15) 0%, rgba(205, 127, 50, 0.05) 100%) !important;
        }

        .leaderboard-rank {
            font-weight: 700;
            font-size: 16px;
        }

        .view-all-users-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 16px;
        }

        .view-all-users-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .mobile-menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .mobile-menu-btn:active {
            transform: translateY(0);
        }

        .mobile-menu-btn svg {
            width: 22px;
            height: 22px;
            stroke: #ffffff;
            display: block;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .analytics-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding-top: 68px;
            }

            .content-header {
                padding: 20px 16px;
            }

            .content-header h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }

            .content-header p {
                font-size: 13px;
            }

            .content-body {
                padding: 16px;
            }

            .card {
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .card-title {
                font-size: 16px;
                margin-bottom: 16px;
            }

            /* Analytics Stats Grid - Mobile Optimized */
            .analytics-stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 20px;
            }

            .analytics-stat-card {
                padding: 18px;
                border-radius: 12px;
            }

            .analytics-stat-label {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .analytics-stat-value {
                font-size: 32px;
                font-weight: 700;
            }

            .analytics-stat-subtext {
                font-size: 11px;
                margin-top: 6px;
            }

            /* Retention Cards */
            .retention-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .retention-card {
                padding: 16px;
            }

            .retention-value {
                font-size: 28px;
            }

            /* Chart containers */
            .chart-container {
                height: 280px !important;
                margin-bottom: 16px;
            }

            /* Tabs */
            .tabs {
                gap: 6px;
                margin-bottom: 20px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                flex-wrap: nowrap;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 10px 16px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Analytics Sections */
            .analytics-section {
                margin-bottom: 20px;
            }

            .analytics-row {
                flex-direction: column;
                gap: 16px;
            }

            /* Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            table {
                font-size: 13px;
            }

            th, td {
                padding: 10px 8px;
            }

            th {
                font-size: 12px;
            }

            /* Row/Grid layouts */
            .row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Filters */
            .filter-section {
                flex-direction: column;
                gap: 12px;
                align-items: stretch !important;
            }

            .filter-row {
                flex-direction: column;
                gap: 12px;
            }

            select, input {
                font-size: 14px;
                padding: 10px 12px;
            }

            button {
                padding: 10px 16px;
                font-size: 14px;
            }

            /* Popular Templates */
            .popular-template-item {
                padding: 14px;
            }

            .template-name {
                font-size: 14px;
            }

            .template-count {
                font-size: 13px;
            }

            /* Error items */
            .error-item {
                padding: 14px;
            }

            /* Day of week stats */
            #dayOfWeekStatsText {
                font-size: 12px;
                line-height: 1.6;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .content-body {
                padding: 32px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Telegram Links */
        .telegram-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .telegram-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        /* Load More Button */
        .load-more-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 16px;
        }

        .load-more-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page hidden" id="loginPage">
        <div class="login-logo">
            <img src="/assets/promostack-logo.png" alt="PromoStack" />
        </div>
        <div class="login-card">
            <h1 class="login-title">üîê Admin Login</h1>
            <div id="loginAlert"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 12px;">Login</button>
                <a href="https://dash.promostack.io" class="btn btn-secondary" style="width: 100%; display: block; text-align: center; text-decoration: none;">Visit Frontend</a>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard hidden" id="dashboard">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="Toggle menu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="/assets/promostack-logo.png" alt="PromoStack" />
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="showView('templates')">
                        <span class="nav-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                            </svg>
                        </span>
                        <span class="nav-item-text">Template Manager</span>
                    </a>
                    <a class="nav-item" onclick="showView('analytics')">
                        <span class="nav-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                            </svg>
                        </span>
                        <span class="nav-item-text">Bot Analytics</span>
                    </a>
                    <a class="nav-item" onclick="showView('broadcast')">
                        <span class="nav-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46" />
                            </svg>
                        </span>
                        <span class="nav-item-text">Broadcast</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <a class="nav-item" onclick="showView('configuration')">
                        <span class="nav-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="transform: translateY(-1px);">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        </span>
                        <span class="nav-item-text">Configuration</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="handleLogout()">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Templates View -->
            <div id="templatesView" class="view-container">
                <div class="content-header">
                    <h1>Template Manager</h1>
                    <p>Upload and manage your promotional templates with drag-to-draw coupon positioning</p>
                </div>

                <div class="content-body">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('upload')">Upload Template</button>
                        <button class="tab" onclick="switchTab('assets')">Current Assets</button>
                    </div>

                    <!-- Upload Tab -->
                    <div id="uploadTab" class="tab-content active">
                        <div id="uploadAlert"></div>

                        <form id="templateForm" onsubmit="handleUpload(event)">
                            <div class="card">
                                <div class="form-group">
                                    <label for="name">Template Name *</label>
                                    <input type="text" id="name" required placeholder="e.g., Flash Sale">
                                    <div class="hint">This will appear in the dropdown</div>
                                </div>

                                <div class="form-group" style="display: none;">
                                    <label for="slug">Slug *</label>
                                    <input type="text" id="slug" required pattern="[a-z0-9-]+" placeholder="e.g., flash-sale">
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Square Image (1:1)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="squareImage">Square PNG (optional)</label>
                                            <input type="file" id="squareImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="squareLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="squareWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="squareHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="squareMaxFontPx">Font Size</label>
                                            <input type="range" id="squareMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="squareMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="squareShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('square', 'up')">‚Üë</button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('square', 'left')">‚Üê</button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('square', 'right')">‚Üí</button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('square', 'down')">‚Üì</button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="square" onclick="selectColor('#FF273E', 'square')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="square" onclick="selectColor('#FFFFFF', 'square')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame square">
                                            <div class="preview-hint">‚ÑπÔ∏è Click and draw coupon area</div>
                                            <canvas id="previewSquare"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="template-section">
                                <div class="section-title">Story Image (9:16)</div>
                                
                                <div class="section-grid">
                                    <div class="controls-column">
                                        <div class="form-group">
                                            <label for="storyImage">Portrait PNG (optional)</label>
                                            <input type="file" id="storyImage" accept="image/png">
                                            <div class="hint">Upload at least one variant</div>
                                        </div>

                                        <div class="row" style="display: none;">
                                            <div class="form-group">
                                                <input type="number" id="storyLeftPct" value="5" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyTopPct" value="78" min="0" max="100" step="0.1" required>
                                            </div>
                                            <div class="form-group">
                                                <input type="number" id="storyWidthPct" value="25" min="0" max="100" step="0.1" required>
                                            </div>
                                        </div>

                                        <div class="form-group" style="display: none;">
                                            <input type="number" id="storyHeightPct" value="12" min="0" max="100" step="0.1" required>
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label for="storyMaxFontPx">Font Size</label>
                                            <input type="range" id="storyMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                            <input type="number" id="storyMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                                        </div>

                                        <div class="form-group" style="text-align: center;">
                                            <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#2d3748;margin:0;padding:10px 0;">
                                                <input id="storyShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                                <span>Show Logo</span>
                                            </label>
                                        </div>

                                        <div class="nudge-controls">
                                            <label class="nudge-controls-label">Fine-Tune Position</label>
                                            <div class="nudge-buttons">
                                                <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('story', 'up')">‚Üë</button>
                                                <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('story', 'left')">‚Üê</button>
                                                <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('story', 'right')">‚Üí</button>
                                                <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('story', 'down')">‚Üì</button>
                                            </div>
                                        </div>

                                        <div class="color-picker-group" style="margin-top: 16px;">
                                            <label>Text Color</label>
                                            <div class="color-swatches">
                                                <div>
                                                    <div class="color-swatch red selected" data-color="#FF273E" data-variant="story" onclick="selectColor('#FF273E', 'story')"></div>
                                                    <div class="color-swatch-label">Red</div>
                                                </div>
                                                <div>
                                                    <div class="color-swatch white" data-color="#FFFFFF" data-variant="story" onclick="selectColor('#FFFFFF', 'story')"></div>
                                                    <div class="color-swatch-label">White</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-column">
                                        <div class="preview-label">Preview</div>
                                        <div class="preview-frame story">
                                            <div class="preview-hint">‚ÑπÔ∏è Click and draw coupon area</div>
                                            <canvas id="previewStory"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="squareFontColor" value="#FF273E">
                            <input type="hidden" id="storyFontColor" value="#FF273E">
                            <input type="hidden" id="isEditing" value="false">

                            <div style="display: flex; gap: 12px;">
                                <button type="button" class="btn btn-secondary" onclick="clearTemplateForm()">New Template</button>
                                <button type="submit" class="btn" id="submitBtn">Upload Template</button>
                            </div>
                        </form>
                    </div>

                    <!-- Assets Tab -->
                    <div id="assetsTab" class="tab-content">
                        <div class="assets-header">
                            <label class="select-all-container">
                                <input type="checkbox" id="selectAllTemplates" onchange="toggleSelectAll()">
                                <span>Select All</span>
                            </label>
                            <button type="button" class="delete-selected-btn" onclick="deleteSelectedTemplates()">Delete Selected</button>
                        </div>
                        <div id="assetsList" class="assets-list">
                            <p style="color: #718096; text-align: center;">Loading templates...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot Analytics View -->
            <div id="analyticsView" class="view-container hidden">
                <div class="content-header">
                    <h1>üìä Bot Analytics</h1>
                    <p>Track your Telegram bot usage and performance</p>
                </div>

                <div class="content-body">
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="analytics-filter-btn" data-days="today" onclick="changeAnalyticsPeriod('today')">Today</button>
                            <button class="analytics-filter-btn" data-days="yesterday" onclick="changeAnalyticsPeriod('yesterday')">Yesterday</button>
                            <button class="analytics-filter-btn active" data-days="7" onclick="changeAnalyticsPeriod(7)">Last 7 Days</button>
                            <button class="analytics-filter-btn" data-days="30" onclick="changeAnalyticsPeriod(30)">Last 30 Days</button>
                            <button class="analytics-filter-btn" data-days="90" onclick="changeAnalyticsPeriod(90)">Last 90 Days</button>
                        </div>
                    </div>

                    <div id="analytics-content">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            Loading statistics...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broadcast View -->
            <div id="broadcastView" class="view-container hidden">
                <div class="content-header">
                    <h1>üì¢ Broadcast Messages</h1>
                    <p>Send announcements to all active Telegram bot users</p>
                </div>

                <div class="content-body">
                    <!-- Active Users Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Active Users</div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="activeUsersCount">
                                <div class="spinner"></div>
                            </div>
                            <div style="color: #718096; margin-top: 8px;">users active in the last 30 days</div>
                        </div>
                    </div>

                    <!-- Broadcast Form -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title">Send Broadcast</div>
                        <div id="broadcastAlert"></div>
                        
                        <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                            <div class="form-group">
                                <label for="broadcastMessage">Message</label>
                                <textarea 
                                    id="broadcastMessage" 
                                    rows="6" 
                                    required 
                                    placeholder="üéâ New templates available! Use /generate to create promotional images with your saved coupon code."
                                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                                ></textarea>
                                <div class="hint">Supports Markdown formatting (*bold*, _italic_, `code`)</div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" onclick="previewBroadcast()">Preview</button>
                                <button type="submit" class="btn">
                                    <span id="broadcastBtnText">Send Broadcast</span>
                                    <span id="broadcastBtnSpinner" class="spinner" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Broadcast History -->
                    <div class="card">
                        <div class="card-title">Broadcast History</div>
                        <div id="broadcastHistory">
                            <div style="text-align: center; padding: 40px; color: #718096;">
                                Loading broadcast history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration View -->
            <div id="configurationView" class="view-container hidden">
                <div class="content-header">
                    <h1>Configuration</h1>
                    <p>System settings and configuration options</p>
                </div>

                <div class="content-body">
                    <div class="card">
                        <div class="card-title">Settings</div>
                        <p style="color: #718096; font-size: 14px;">
                            Configuration options coming soon...
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">üóëÔ∏è</div>
            <div class="modal-title" id="modalTitle">Delete Template?</div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Campaign Submissions Modal -->
    <div class="modal-overlay" id="submissionsModal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title" id="submissionsModalTitle">Campaign Submissions</div>
            <div id="submissionsContent" style="margin: 20px 0; max-height: 400px; overflow-y: auto;">
                <p style="color: #718096; text-align: center;">Loading submissions...</p>
            </div>
            <div style="text-align: center;">
                <button class="modal-btn modal-btn-cancel" onclick="closeSubmissionsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal-overlay" id="userDetailsModal">
        <div class="modal-box" style="max-width: 900px;">
            <div class="modal-title">User Details</div>
            <div id="userDetailsContent" style="margin: 20px 0; max-height: 500px; overflow-y: auto;">
                <p style="color: #718096; text-align: center;">Loading user details...</p>
            </div>
            <div style="text-align: center;">
                <button class="modal-btn modal-btn-cancel" onclick="closeUserDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile Sidebar Toggle
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // View Management
        function showView(viewName) {
            // Close mobile sidebar when navigating
            closeMobileSidebar();

            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.add('hidden');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (viewName === 'templates') {
                document.getElementById('templatesView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (viewName === 'analytics') {
                document.getElementById('analyticsView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                loadAnalytics();
            } else if (viewName === 'broadcast') {
                document.getElementById('broadcastView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                loadBroadcastData();
            } else if (viewName === 'configuration') {
                document.getElementById('configurationView').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[3].classList.add('active');
            }
        }

        // Login/Logout
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadAssets();
                } else {
                    showAlert('loginAlert', data.error || 'Invalid password', true);
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed: ' + error.message, true);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Bot Analytics
        let currentAnalyticsDays = 7;
        let dailyChart = null;
        let isEditingTemplate = false;
        
        // Coupon filter state
        let couponFilterDays = 30;
        let couponFilterTemplate = 'all';
        let availableTemplates = [];

        async function loadAnalytics() {
            try {
                let url = `/api/bot-stats?days=${currentAnalyticsDays}`;
                
                if (couponFilterTemplate && couponFilterTemplate !== 'all' && couponFilterTemplate !== 'null') {
                    url += `&template=${encodeURIComponent(couponFilterTemplate)}`;
                }
                
                const [statsResponse, retentionResponse] = await Promise.all([
                    fetch(url),
                    fetch('/api/retention-rates')
                ]);
                
                if (!statsResponse.ok) {
                    throw new Error('Failed to load stats');
                }

                const stats = await statsResponse.json();
                const retention = retentionResponse.ok ? await retentionResponse.json() : { day1: 0, day7: 0, day30: 0 };
                
                availableTemplates = stats.popular_templates || [];
                renderAnalytics(stats, retention);
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('analytics-content').innerHTML = `
                    <div class="card">
                        <p style="color: #e53e3e; text-align: center;">Failed to load statistics. Please try again.</p>
                    </div>
                `;
            }
        }

        function changeAnalyticsPeriod(days) {
            currentAnalyticsDays = days;
            
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            loadAnalytics();
        }

        function renderAnalytics(stats, retention = { day1: 0, day7: 0, day30: 0 }) {
            const content = document.getElementById('analytics-content');
            
            if (stats.total_uses === 0) {
                content.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            <h2 style="margin-bottom: 12px;">No bot usage data yet</h2>
                            <p>Start using the Telegram bot to see statistics here.</p>
                        </div>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Total Uses</div>
                        <div class="analytics-stat-value">${stats.total_uses.toLocaleString()}</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Success Rate</div>
                        <div class="analytics-stat-value">${stats.success_rate}%</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-label">Unique Users</div>
                        <div class="analytics-stat-value">${stats.unique_users.toLocaleString()}</div>
                    </div>
                </div>

                <div class="card" style="margin: 24px 0;">
                    <div class="card-title" id="usageChartTitle">Daily Usage</div>
                    <canvas id="dailyChart" style="max-height: 300px;"></canvas>
                </div>
                
                <div style="margin: 32px 0 16px 0; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
                    <h3 style="margin: 0; color: #1a202c; font-size: 18px;">üìà User Retention Metrics</h3>
                    <p style="margin: 8px 0 0 0; color: #718096; font-size: 13px;">Independent metrics showing % of users who return after first use (all-time data)</p>
                </div>
                
                <div class="analytics-stats-grid" style="margin-bottom: 24px;">
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="analytics-stat-label" style="color: rgba(255, 255, 255, 0.9);">Day 1 Retention</div>
                        <div class="analytics-stat-value" style="color: white;">${retention.day1}%</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 11px; margin-top: 4px;">Users who return within 24-48h</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="analytics-stat-label" style="color: rgba(255, 255, 255, 0.9);">Day 7 Retention</div>
                        <div class="analytics-stat-value" style="color: white;">${retention.day7}%</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 11px; margin-top: 4px;">Users who return within 7-14 days</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="analytics-stat-label" style="color: rgba(255, 255, 255, 0.9);">Day 30 Retention</div>
                        <div class="analytics-stat-value" style="color: white;">${retention.day30}%</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 11px; margin-top: 4px;">Users who return within 30-60 days</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-title">üèÜ Most Active Users</div>
                    <div id="mostActiveUsersContainer">
                        <p style="color: #718096; text-align: center; padding: 20px;">Loading most active users...</p>
                    </div>
                </div>

                <div class="analytics-row">
                    <div class="card">
                        <div id="dayOfWeekCardTitle" class="card-title">üìÖ Most Popular Days</div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div id="dayOfWeekStatsText" style="margin-top: 20px; text-align: center; color: #4a5568;"></div>
                    </div>

                    <div class="card">
                        <div class="card-title">üìä Most Popular Templates</div>
                        ${renderTemplatesTable(stats.popular_templates)}
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-title">üéüÔ∏è Popular Coupon Codes</div>
                    ${renderCouponsTable(stats.popular_coupons)}
                </div>

                <div class="card" style="margin-bottom: 24px; background: #fef2f2; border: 2px solid #fee2e2;">
                    <div class="card-title">‚ö†Ô∏è Invalid Coupon Attempts</div>
                    <div id="invalidCouponsContainer">
                        <p style="color: #718096; text-align: center; padding: 20px;">Loading invalid coupon attempts...</p>
                    </div>
                </div>

                ${stats.errors.length > 0 ? `
                    <div class="card">
                        <div class="card-title">Error Breakdown</div>
                        ${renderErrorsTable(stats.errors)}
                    </div>
                ` : ''}
            `;

            renderDailyChart(stats.usage_data || stats.daily_usage, stats.granularity || 'daily');
            
            // Initialize coupon pagination after DOM is ready (only if we have coupons and the container exists)
            setTimeout(() => {
                const container = document.getElementById('couponsTableContainer');
                if (container && allCoupons.length > 0) {
                    renderCouponPage();
                }
                
                // Load invalid coupons, most active users, and day-of-week analytics
                loadInvalidCoupons();
                loadMostActiveUsers();
                loadDayOfWeekStats();
            }, 0);
        }

        function renderTemplatesTable(templates) {
            if (templates.length === 0) {
                return '<p style="color: #718096; text-align: center; padding: 20px;">No template usage data</p>';
            }

            return `
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Template</th>
                                <th>Uses</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${templates.map((t, idx) => {
                                let trophy = '';
                                if (idx === 0) trophy = 'üèÜ ';
                                else if (idx === 1) trophy = 'ü•à ';
                                else if (idx === 2) trophy = 'ü•â ';
                                return `
                                    <tr>
                                        <td>${trophy}${t.template}</td>
                                        <td><strong>${t.count.toLocaleString()}</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        let allCoupons = [];

        function renderCouponsTable(coupons) {
            // Always reset state, even for empty datasets
            allCoupons = coupons || [];
            
            const hasActiveFilters = couponFilterDays !== 30 || (couponFilterTemplate && couponFilterTemplate !== 'all' && couponFilterTemplate !== 'null');
            
            const filterControlsHtml = `
                <div style="margin-bottom: 20px; padding: 16px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: #4a5568; font-weight: 600;">Date Range</label>
                            <select id="couponFilterDaysSelect" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 13px;">
                                <option value="3" ${couponFilterDays === 3 ? 'selected' : ''}>Last 3 days</option>
                                <option value="7" ${couponFilterDays === 7 ? 'selected' : ''}>Last 7 days</option>
                                <option value="30" ${couponFilterDays === 30 ? 'selected' : ''}>Last 30 days</option>
                                <option value="90" ${couponFilterDays === 90 ? 'selected' : ''}>Last 90 days</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: #4a5568; font-weight: 600;">Template</label>
                            <select id="couponFilterTemplateSelect" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 13px;">
                                <option value="">All Templates</option>
                                ${availableTemplates.map(t => `
                                    <option value="${t.template}" ${couponFilterTemplate === t.template ? 'selected' : ''}>
                                        ${t.template} (${t.count} uses)
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" onclick="applyCouponFilters()" style="padding: 8px 20px; white-space: nowrap;">
                                Apply Filters
                            </button>
                            ${hasActiveFilters ? `
                                <button class="btn btn-secondary" onclick="clearCouponFilters()" style="padding: 8px 16px; white-space: nowrap;">
                                    Clear Filters
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${hasActiveFilters ? `
                        <div style="margin-top: 12px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 13px; color: #4a5568;">
                            <strong>Filtered by:</strong> 
                            Last ${couponFilterDays} days
                            ${(couponFilterTemplate && couponFilterTemplate !== 'all' && couponFilterTemplate !== 'null') ? `, Template: <span style="color: #667eea; font-weight: 600;">${couponFilterTemplate}</span>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (allCoupons.length === 0) {
                return filterControlsHtml + '<p style="color: #718096; text-align: center; padding: 20px;">No coupon usage data</p>';
            }
            
            return filterControlsHtml + `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-secondary" onclick="exportCouponsCSV()" style="padding: 8px 16px;">
                        üì• Export CSV
                    </button>
                    <div id="couponPagination" style="display: flex; gap: 12px; align-items: center;">
                    </div>
                </div>
                <div id="couponsTableContainer"></div>
            `;
        }

        function renderCouponPage() {
            const tableHtml = `
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Coupon Code</th>
                                <th>Uses</th>
                                <th>Unique Users</th>
                                <th>Generated By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allCoupons.map(c => `
                                <tr>
                                    <td>${c.coupon}</td>
                                    <td>${c.count.toLocaleString()}</td>
                                    <td>${(c.unique_users || 0).toLocaleString()}</td>
                                    <td>${c.generated_by || 'Unknown'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            const summaryHtml = `<span style="color: #4a5568;">Showing all ${allCoupons.length} coupons</span>`;

            document.getElementById('couponsTableContainer').innerHTML = tableHtml;
            document.getElementById('couponPagination').innerHTML = summaryHtml;
        }


        function applyCouponFilters() {
            const daysSelect = document.getElementById('couponFilterDaysSelect');
            const templateSelect = document.getElementById('couponFilterTemplateSelect');
            
            couponFilterDays = parseInt(daysSelect.value);
            couponFilterTemplate = templateSelect.value || 'all';
            
            currentAnalyticsDays = couponFilterDays;
            
            loadAnalytics();
        }
        
        function clearCouponFilters() {
            couponFilterDays = 30;
            couponFilterTemplate = 'all';
            currentAnalyticsDays = 7;
            
            loadAnalytics();
        }

        function exportCouponsCSV() {
            if (allCoupons.length === 0) {
                alert('No coupon data to export');
                return;
            }

            const csvContent = [
                ['Coupon Code', 'Uses', 'Unique Users', 'Generated By'],
                ...allCoupons.map(c => [c.coupon, c.count, c.unique_users || 0, c.generated_by || 'Unknown'])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            let filename = 'popular-coupons';
            
            if (couponFilterDays !== 30) {
                filename += `-last-${couponFilterDays}-days`;
            }
            
            if (couponFilterTemplate && couponFilterTemplate !== 'all' && couponFilterTemplate !== 'null') {
                filename += `-${couponFilterTemplate.replace(/[^a-z0-9-]/gi, '-')}`;
            }
            
            filename += `-${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderErrorsTable(errors) {
            // Filter to only show important bot errors (exclude invalid_coupon as it's shown in its own table)
            const importantErrors = errors.filter(e => e.type !== 'invalid_coupon');
            
            if (importantErrors.length === 0) {
                return '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No bot errors - everything is running smoothly!</p>';
            }
            
            return `
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Error Type</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${importantErrors.map(e => `
                                <tr>
                                    <td>${e.type.replace(/_/g, ' ').toUpperCase()}</td>
                                    <td>${e.count.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Invalid Coupon Attempts
        let allInvalidCoupons = [];

        async function loadInvalidCoupons() {
            try {
                // Load all invalid coupons (1000 limit for scrolling)
                const response = await fetch(`/api/invalid-coupons?limit=1000&offset=0&days=${currentAnalyticsDays}`);
                const data = await response.json();
                
                allInvalidCoupons = data.attempts || [];
                renderInvalidCoupons(data.attempts || [], data.total || 0);
            } catch (error) {
                console.error('Error loading invalid coupons:', error);
                document.getElementById('invalidCouponsContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load invalid coupon attempts</p>
                `;
            }
        }

        function renderInvalidCoupons(attempts, total) {
            const container = document.getElementById('invalidCouponsContainer');
            
            if (attempts.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No invalid coupon attempts</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-secondary" onclick="exportInvalidCouponsCSV()" style="padding: 8px 16px;">
                        üì• Export CSV
                    </button>
                    <span style="color: #4a5568;"><strong>${total.toLocaleString()}</strong> total invalid attempts</span>
                </div>
                <div class="table-scroll">
                    <table class="analytics-table">
                        <thead style="background: #fecaca;">
                            <tr>
                                <th>Invalid Code</th>
                                <th>Template Used</th>
                                <th>User</th>
                                <th>Timestamp</th>
                                <th>Attempts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allInvalidCoupons.map(a => {
                                // Build user display name with both name and username when available
                                let userDisplay;
                                const fullName = [a.first_name, a.last_name].filter(Boolean).join(' ');
                                const usernameLink = a.username ? `<a href="https://t.me/${a.username}" target="_blank" class="telegram-link">@${a.username}</a>` : '';
                                
                                if (fullName && a.username) {
                                    // Both name and username - show "First Last (@username)"
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (a.username) {
                                    // Only username
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    // Only name
                                    userDisplay = fullName;
                                } else {
                                    // No data at all
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr>
                                        <td><code>${a.coupon_code}</code></td>
                                        <td>${a.template_name || 'N/A'}</td>
                                        <td>${userDisplay}</td>
                                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                                        <td>${a.attempt_count || 1}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        function exportInvalidCouponsCSV() {
            if (allInvalidCoupons.length === 0) {
                alert('No invalid coupon data to export');
                return;
            }

            const csvContent = [
                ['Coupon Code', 'Template', 'Username', 'First Name', 'Last Name', 'Timestamp', 'Attempts'],
                ...allInvalidCoupons.map(a => [
                    a.coupon_code,
                    a.template_name || 'N/A',
                    a.username || '',
                    a.first_name || '',
                    a.last_name || '',
                    new Date(a.timestamp).toISOString(),
                    a.attempt_count || 1
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `invalid-coupons-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // User Analytics
        let allUsers = [];
        let usersOffset = 0;
        const usersLimit = 50;

        async function loadUserAnalytics() {
            try {
                usersOffset = 0;
                allUsers = [];
                const response = await fetch(`/api/bot-users?limit=${usersLimit}&offset=${usersOffset}`);
                const data = await response.json();
                
                allUsers = data.users || [];
                renderUserAnalytics(data.users || [], data.total || 0);
            } catch (error) {
                console.error('Error loading user analytics:', error);
                document.getElementById('userAnalyticsContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load user analytics</p>
                `;
            }
        }

        function renderUserAnalytics(users, total) {
            const container = document.getElementById('userAnalyticsContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No user data available</p>';
                return;
            }

            const hasMore = allUsers.length < total;

            container.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #4a5568;">Showing ${allUsers.length} of ${total} users</span>
                </div>
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Total Gens</th>
                            <th>Unique Coupons</th>
                            <th>First Seen</th>
                            <th>Last Seen</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allUsers.map(u => {
                            // Build user display name with both name and username when available
                            let userDisplay;
                            const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                            const usernameLink = u.username ? `<a href="https://t.me/${u.username}" target="_blank" class="telegram-link">@${u.username}</a>` : '';
                            
                            if (fullName && u.username) {
                                // Both name and username - show "First Last (@username)"
                                userDisplay = `${fullName} (${usernameLink})`;
                            } else if (u.username) {
                                // Only username
                                userDisplay = usernameLink;
                            } else if (fullName) {
                                // Only name
                                userDisplay = fullName;
                            } else {
                                // No data at all
                                userDisplay = 'Unknown User';
                            }
                            
                            return `
                                <tr>
                                    <td>${userDisplay}</td>
                                    <td>${u.total_generations || 0}</td>
                                    <td>${u.unique_coupons || 0}</td>
                                    <td>${u.first_used ? new Date(u.first_used).toLocaleDateString() : 'N/A'}</td>
                                    <td>${u.last_used ? new Date(u.last_used).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <button class="view-details-btn" onclick="showUserDetails(${u.chat_id})" style="padding: 6px 12px; font-size: 12px; border: 2px solid #7c3aed; color: #7c3aed; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${hasMore ? `
                    <button class="load-more-btn" onclick="loadMoreUsers()">
                        Load More
                    </button>
                ` : ''}
            `;
        }

        async function loadMoreUsers() {
            try {
                usersOffset += usersLimit;
                const response = await fetch(`/api/bot-users?limit=${usersLimit}&offset=${usersOffset}`);
                const data = await response.json();
                
                if (data.users && data.users.length > 0) {
                    allUsers = allUsers.concat(data.users);
                    renderUserAnalytics(data.users, data.total || 0);
                }
            } catch (error) {
                console.error('Error loading more users:', error);
            }
        }

        // User Details Modal
        async function showUserDetails(chatId) {
            const modal = document.getElementById('userDetailsModal');
            const content = document.getElementById('userDetailsContent');
            
            modal.classList.add('active');
            content.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">Loading user details...</p>';
            
            try {
                const response = await fetch(`/api/user-activity/${chatId}`);
                const data = await response.json();
                
                const user = data.user || {};
                const history = data.history || [];
                
                // Build user display name with both name and username when available
                let userDisplay;
                const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ');
                const usernameLink = user.username ? `<a href="https://t.me/${user.username}" target="_blank" class="telegram-link">@${user.username}</a>` : '';
                
                if (fullName && user.username) {
                    // Both name and username - show "First Last (@username)"
                    userDisplay = `${fullName} (${usernameLink})`;
                } else if (user.username) {
                    // Only username
                    userDisplay = usernameLink;
                } else if (fullName) {
                    // Only name
                    userDisplay = fullName;
                } else {
                    // No data at all
                    userDisplay = 'Unknown User';
                }
                
                content.innerHTML = `
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px; color: #1a202c;">User Profile</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <strong style="color: #4a5568;">User:</strong> ${userDisplay}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Chat ID:</strong> <code>${user.chat_id}</code>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Total Generations:</strong> ${user.total_generations || 0}
                            </div>
                            <div>
                                <strong style="color: #4a5568;">Unique Coupons:</strong> ${user.unique_coupons || 0}
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 12px; color: #1a202c;">Activity History</h3>
                    ${history.length === 0 ? `
                        <p style="color: #718096; text-align: center; padding: 20px;">No activity history</p>
                    ` : `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Template</th>
                                        <th>Coupon</th>
                                        <th>Status</th>
                                        <th>Error Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${history.map(h => {
                                        const isSuccess = h.success || h.status === 'success';
                                        const statusBadge = isSuccess 
                                            ? '<span class="status-badge status-success">Success</span>'
                                            : '<span class="status-badge status-error">Failed</span>';
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(h.timestamp).toLocaleString()}</td>
                                                <td>${h.template || 'N/A'}</td>
                                                <td><code>${h.coupon_code || 'N/A'}</code></td>
                                                <td>${statusBadge}</td>
                                                <td>${h.error_type || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                content.innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 40px;">
                        Failed to load user details. Please try again.
                    </p>
                `;
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
        }

        // Most Active Users Leaderboard
        async function loadMostActiveUsers() {
            try {
                const response = await fetch('/api/bot-users?limit=1000&offset=0');
                const data = await response.json();
                
                renderMostActiveUsers(data.users || []);
            } catch (error) {
                console.error('Error loading most active users:', error);
                document.getElementById('mostActiveUsersContainer').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Failed to load most active users</p>
                `;
            }
        }

        function renderMostActiveUsers(users) {
            const container = document.getElementById('mostActiveUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No user data available</p>';
                return;
            }

            const badges = ['ü•á', 'ü•à', 'ü•â'];
            const rankClasses = ['leaderboard-rank-1', 'leaderboard-rank-2', 'leaderboard-rank-3'];

            container.innerHTML = `
                <div class="table-scroll">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Total Gens</th>
                                <th>Unique Coupons</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((u, index) => {
                                const rank = index + 1;
                                const badge = rank <= 3 ? badges[index] : '';
                                const rankClass = rank <= 3 ? rankClasses[index] : '';
                                
                                // Build user display name with both name and username when available
                                let userDisplay;
                                const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                                const usernameLink = u.username ? `<a href="https://t.me/${u.username}" target="_blank" class="telegram-link">@${u.username}</a>` : '';
                                
                                if (fullName && u.username) {
                                    userDisplay = `${fullName} (${usernameLink})`;
                                } else if (u.username) {
                                    userDisplay = usernameLink;
                                } else if (fullName) {
                                    userDisplay = fullName;
                                } else {
                                    userDisplay = 'Unknown User';
                                }
                                
                                return `
                                    <tr class="${rankClass}">
                                        <td><span class="leaderboard-rank">${badge} #${rank}</span></td>
                                        <td>${userDisplay}</td>
                                        <td>${u.total_generations || 0}</td>
                                        <td>${u.unique_coupons || 0}</td>
                                        <td>${u.first_used ? new Date(u.first_used).toLocaleDateString() : 'N/A'}</td>
                                        <td>${u.last_used ? new Date(u.last_used).toLocaleDateString() : 'N/A'}</td>
                                        <td><button class="view-details-btn" style="padding: 6px 12px; font-size: 12px; border: 2px solid #7c3aed; color: #7c3aed; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onclick="showUserDetails(${u.chat_id})">View Details</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // Utility function to capitalize first letter
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        // Device Analytics
        async function loadDayOfWeekStats() {
            try {
                const response = await fetch(`/api/day-of-week-stats?days=${currentAnalyticsDays}`);
                const result = await response.json();
                
                // Update title based on data type
                const titleElement = document.getElementById('dayOfWeekCardTitle');
                if (result.type === 'hourly') {
                    titleElement.textContent = '‚è∞ Most Popular Hours';
                } else {
                    titleElement.textContent = 'üìÖ Most Popular Days';
                }
                
                if (result.data && result.data.length > 0) {
                    renderDayOfWeekChart(result.data, result.type);
                } else {
                    const chartContainer = document.querySelector('#dayOfWeekChart').parentElement;
                    chartContainer.innerHTML = `
                        <p style="color: #718096; text-align: center; padding: 40px;">No data available yet</p>
                    `;
                    document.getElementById('dayOfWeekStatsText').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading day-of-week analytics:', error);
                const chartContainer = document.querySelector('#dayOfWeekChart')?.parentElement;
                if (chartContainer) {
                    chartContainer.innerHTML = `
                        <p style="color: #ef4444; text-align: center; padding: 40px;">Failed to load analytics</p>
                    `;
                }
                document.getElementById('dayOfWeekStatsText').innerHTML = '';
            }
        }

        let dayOfWeekChart = null;

        function renderDayOfWeekChart(data, type) {
            // Destroy existing chart if it exists
            if (dayOfWeekChart) {
                dayOfWeekChart.destroy();
            }

            const ctx = document.getElementById('dayOfWeekChart');
            if (!ctx) return;

            const labels = data.map(d => d.label);
            const counts = data.map(d => d.count);
            
            // Find max value for highlighting
            const maxCount = Math.max(...counts);
            const backgroundColor = counts.map(count => 
                count === maxCount && maxCount > 0 ? '#fbbf24' : '#667eea'
            );

            // Calculate total
            const totalGenerations = counts.reduce((sum, count) => sum + count, 0);
            const mostPopularLabel = maxCount > 0 ? labels[counts.indexOf(maxCount)] : null;

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bot Uses',
                        data: counts,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const isPeak = value === maxCount && maxCount > 0;
                                    return `Uses: ${value}${isPeak ? ' üèÜ Peak!' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Display summary
            const labelType = type === 'hourly' ? 'Hour' : 'Day';
            if (mostPopularLabel) {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong> | 
                    üèÜ Most Popular ${labelType}: <strong>${mostPopularLabel}</strong> (${maxCount} uses)
                `;
            } else {
                document.getElementById('dayOfWeekStatsText').innerHTML = `
                    <strong>Total: ${totalGenerations.toLocaleString()} generations</strong>
                `;
            }
        }

        function renderDailyChart(usageData, granularity) {
            if (dailyChart) {
                dailyChart.destroy();
            }

            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;
            
            // Handle both new format (label/count) and old format (date/count)
            // Reverse to show oldest on left, newest on right
            const labels = usageData.map(d => d.label || d.date).reverse();
            const counts = usageData.map(d => d.count).reverse();
            
            // Find peak value and index
            const maxCount = Math.max(...counts);
            const peakIndex = counts.indexOf(maxCount);
            const peakLabel = labels[peakIndex];
            
            // Create colors array - highlight peak with gold/yellow
            const pointColors = counts.map((count, idx) => 
                count === maxCount ? '#fbbf24' : '#667eea'
            );
            const pointRadii = counts.map((count, idx) => 
                count === maxCount ? 8 : 4
            );
            
            // Update title based on granularity with peak info
            const titleElement = document.getElementById('usageChartTitle');
            if (titleElement) {
                const baseTitle = granularity === 'hourly' ? 'Hourly Usage' : 'Daily Usage';
                const peakInfo = maxCount > 0 ? ` <span style="color: #fbbf24; font-size: 14px;">‚≠ê Peak: ${maxCount} at ${peakLabel}</span>` : '';
                titleElement.innerHTML = baseTitle + peakInfo;
            }

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bot Uses',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: pointRadii,
                        pointHoverRadius: pointRadii.map(r => r + 2)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const isPeak = value === maxCount && maxCount > 0;
                                    return `${context.dataset.label}: ${value}${isPeak ? ' ‚≠ê PEAK' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Tab Switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = Array.from(tabs);
            if (tabName === 'upload') {
                tabButtons[0]?.classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            } else if (tabName === 'assets') {
                tabButtons[1]?.classList.add('active');
                document.getElementById('assetsTab').classList.add('active');
                loadAssets();
            }
        }

        // Alert Helper
        function showAlert(elementId, message, isError = false) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert ${isError ? 'alert-error' : 'alert-success'}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Template Upload
        function clearTemplateForm() {
            // Reset form fields
            document.getElementById('name').value = '';
            document.getElementById('slug').value = '';
            document.getElementById('squareImage').value = '';
            document.getElementById('storyImage').value = '';
            
            // Reset slug field to editable
            const slugInput = document.getElementById('slug');
            slugInput.readOnly = false;
            slugInput.style.backgroundColor = '';
            slugInput.style.cursor = '';
            
            // Reset coordinates to defaults
            document.getElementById('squareLeftPct').value = 5;
            document.getElementById('squareTopPct').value = 78;
            document.getElementById('squareWidthPct').value = 25;
            document.getElementById('squareHeightPct').value = 12;
            document.getElementById('squareMaxFontPx').value = 80;
            document.getElementById('squareMaxFontPxSlider').value = 80;
            document.getElementById('squareShowLogo').checked = true;
            
            document.getElementById('storyLeftPct').value = 5;
            document.getElementById('storyTopPct').value = 78;
            document.getElementById('storyWidthPct').value = 25;
            document.getElementById('storyHeightPct').value = 12;
            document.getElementById('storyMaxFontPx').value = 80;
            document.getElementById('storyMaxFontPxSlider').value = 80;
            document.getElementById('storyShowLogo').checked = true;
            
            // Reset colors to default red
            document.getElementById('squareFontColor').value = '#FF273E';
            document.getElementById('storyFontColor').value = '#FF273E';
            
            // Reset color swatches
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === '#FF273E') {
                    swatch.classList.add('selected');
                }
            });
            
            // Clear canvases
            const squareCanvas = document.getElementById('previewSquare');
            const storyCanvas = document.getElementById('previewStory');
            if (squareCanvas) {
                const ctx = squareCanvas.getContext('2d');
                ctx.clearRect(0, 0, squareCanvas.width, squareCanvas.height);
            }
            if (storyCanvas) {
                const ctx = storyCanvas.getContext('2d');
                ctx.clearRect(0, 0, storyCanvas.width, storyCanvas.height);
            }
            
            // Mark as not editing
            document.getElementById('isEditing').value = 'false';
            document.getElementById('submitBtn').textContent = 'Upload Template';
            
            console.log('[FORM] Template form cleared for new upload');
        }

        async function handleUpload(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            const nameValue = document.getElementById('name').value;
            const slugInput = document.getElementById('slug');
            
            // CRITICAL: When editing, use the preserved slug. Don't regenerate.
            const slugValue = slugInput.value;
            
            // DEBUG: Log what we're submitting
            console.log('[UPLOAD DEBUG] isEditingTemplate:', isEditingTemplate);
            console.log('[UPLOAD DEBUG] slug being submitted:', slugValue);
            console.log('[UPLOAD DEBUG] name being submitted:', nameValue);
            
            formData.append('name', nameValue);
            formData.append('slug', slugValue);
            
            const squareFile = document.getElementById('squareImage').files[0];
            const storyFile = document.getElementById('storyImage').files[0];
            if (squareFile) formData.append('squareImage', squareFile);
            if (storyFile) formData.append('storyImage', storyFile);
            
            formData.append('squareLeftPct', document.getElementById('squareLeftPct').value);
            formData.append('squareTopPct', document.getElementById('squareTopPct').value);
            formData.append('squareWidthPct', document.getElementById('squareWidthPct').value);
            formData.append('squareHeightPct', document.getElementById('squareHeightPct').value);
            formData.append('squareHAlign', 'center');
            formData.append('squareVAlign', 'middle');
            formData.append('squareMaxFontPx', document.getElementById('squareMaxFontPx').value);
            formData.append('squareShowLogo', document.getElementById('squareShowLogo').checked);
            
            formData.append('storyLeftPct', document.getElementById('storyLeftPct').value);
            formData.append('storyTopPct', document.getElementById('storyTopPct').value);
            formData.append('storyWidthPct', document.getElementById('storyWidthPct').value);
            formData.append('storyHeightPct', document.getElementById('storyHeightPct').value);
            formData.append('storyHAlign', 'center');
            formData.append('storyVAlign', 'middle');
            formData.append('storyMaxFontPx', document.getElementById('storyMaxFontPx').value);
            formData.append('storyShowLogo', document.getElementById('storyShowLogo').checked);
            
            formData.append('squareFontColor', document.getElementById('squareFontColor').value);
            formData.append('storyFontColor', document.getElementById('storyFontColor').value);

            try {
                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('uploadAlert', data.message + ' ‚úì');
                    clearTemplateForm();
                    isEditingTemplate = false;
                    drawingState.square.hasDrawnBox = false;
                    drawingState.story.hasDrawnBox = false;
                    updatePreviewsImmediate();
                    loadAssets(); // Refresh assets list to show the new/updated template
                } else {
                    showAlert('uploadAlert', data.error || 'Upload failed', true);
                }
            } catch (error) {
                showAlert('uploadAlert', 'Upload failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Template';
            }
        }

        // Auto-generate slug from name (only when creating new templates, not editing)
        document.getElementById('name').addEventListener('input', function(e) {
            if (!isEditingTemplate) {
                const slug = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('slug').value = slug;
            }
        });

        // Load Assets
        async function loadAssets() {
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading templates...</p>';
            
            try {
                let response;
                try {
                    response = await fetch('https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/index.json?ts=' + Date.now());
                } catch (_) {
                    response = await fetch('/assets/templates/index.json?ts=' + Date.now());
                }
                const data = await response.json();
                
                if (!data.templates || data.templates.length === 0) {
                    assetsList.innerHTML = '<p style="color: #718096; text-align: center;">No templates found</p>';
                    return;
                }
                
                assetsList.innerHTML = '';
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    const telegramEnabled = template.telegramEnabled !== false; // Default to true for backward compatibility
                    item.innerHTML = `
                        <input type="checkbox" class="template-checkbox" data-slug="${template.slug}" data-name="${template.name}" onchange="updateSelectAllState()">
                        <div class="asset-item-info">
                            <div class="asset-name">${template.name}</div>
                            <div class="asset-slug">${template.slug}</div>
                        </div>
                        <div class="telegram-toggle-container" title="${telegramEnabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot'}">
                            <label class="telegram-toggle-label">
                                <input type="checkbox" class="telegram-toggle-checkbox" data-slug="${template.slug}" ${telegramEnabled ? 'checked' : ''} onchange="toggleTelegramVisibility(event, '${template.slug}', this.checked)">
                                <span class="telegram-toggle-slider"></span>
                                <span class="telegram-toggle-text">${telegramEnabled ? '‚úì Telegram' : '‚úó Telegram'}</span>
                            </label>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="loadTemplateForEdit('${template.slug}')">‚úé</div>
                            <div class="asset-delete-icon" onclick="deleteTemplate('${template.slug}', '${template.name}')">üóë</div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                });
                
                document.getElementById('selectAllTemplates').checked = false;
            } catch (error) {
                assetsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading templates</p>';
                console.error('Failed to load assets:', error);
            }
        }

        // Load template for editing
        async function loadTemplateForEdit(slug) {
            try {
                let response;
                try {
                    response = await fetch(`https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/meta.json?ts=${Date.now()}`);
                } catch (_) {
                    response = await fetch(`/assets/templates/${slug}/meta.json?ts=${Date.now()}`);
                }
                const meta = await response.json();
                
                switchTab('upload');
                
                isEditingTemplate = true;
                document.getElementById('isEditing').value = 'true';
                document.getElementById('name').value = meta.name || slug;
                const slugInput = document.getElementById('slug');
                slugInput.value = slug;
                slugInput.readOnly = true;
                slugInput.style.backgroundColor = '#f3f4f6';
                slugInput.style.cursor = 'not-allowed';
                document.getElementById('submitBtn').textContent = 'Update Template';
                
                document.getElementById('squareLeftPct').value = meta.square?.box?.leftPct || meta.square?.leftPct || 5;
                document.getElementById('squareTopPct').value = meta.square?.box?.topPct || meta.square?.topPct || 78;
                document.getElementById('squareWidthPct').value = meta.square?.box?.widthPct || meta.square?.widthPct || 90;
                document.getElementById('squareHeightPct').value = meta.square?.box?.heightPct || meta.square?.heightPct || 12;
                document.getElementById('squareMaxFontPx').value = meta.square?.maxFontPx || 80;
                document.getElementById('squareShowLogo').checked = meta.square?.showLogo !== false;
                
                document.getElementById('storyLeftPct').value = meta.story?.box?.leftPct || meta.story?.leftPct || 5;
                document.getElementById('storyTopPct').value = meta.story?.box?.topPct || meta.story?.topPct || 78;
                document.getElementById('storyWidthPct').value = meta.story?.box?.widthPct || meta.story?.widthPct || 90;
                document.getElementById('storyHeightPct').value = meta.story?.box?.heightPct || meta.story?.heightPct || 12;
                document.getElementById('storyMaxFontPx').value = meta.story?.maxFontPx || 80;
                document.getElementById('storyShowLogo').checked = meta.story?.showLogo !== false;
                
                const squareFontColor = meta.square?.fontColor || '#FF273E';
                const storyFontColor = meta.story?.fontColor || '#FF273E';
                document.getElementById('squareFontColor').value = squareFontColor;
                document.getElementById('storyFontColor').value = storyFontColor;
                selectColor(squareFontColor, 'square');
                selectColor(storyFontColor, 'story');
                
                drawingState.square.hasDrawnBox = true;
                if (meta.story) {
                    drawingState.story.hasDrawnBox = true;
                }
                
                const squareImg = new Image();
                squareImg.onload = async function() {
                    try {
                        await squareImg.decode();
                        previewImages.square = squareImg;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square image decode failed:', e);
                    }
                };
                
                try {
                    squareImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/square.png?ts=${Date.now()}`;
                } catch (_) {
                    squareImg.src = `/assets/templates/${slug}/square.png?ts=${Date.now()}`;
                }
                
                if (meta.story) {
                    const storyImg = new Image();
                    storyImg.onload = async function() {
                        try {
                            await storyImg.decode();
                            previewImages.story = storyImg;
                            renderPreview('story');
                        } catch(e) {
                            console.error('Story image decode failed:', e);
                        }
                    };
                    
                    try {
                        storyImg.src = `https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/story.png?ts=${Date.now()}`;
                    } catch (_) {
                        storyImg.src = `/assets/templates/${slug}/story.png?ts=${Date.now()}`;
                    }
                }
                
                document.getElementById('submitBtn').textContent = 'Update Template';
                
            } catch (error) {
                showAlert('uploadAlert', 'Failed to load template: ' + error.message, true);
            }
        }

        // Delete template
        let deleteConfirmCallback = null;

        function deleteTemplate(slug, name) {
            document.getElementById('modalTitle').textContent = 'Delete Template?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                try {
                    const response = await fetch('/api/delete-template', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('uploadAlert', `Template "${name}" deleted successfully ‚úì`);
                        loadAssets();
                    } else {
                        showAlert('uploadAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('uploadAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteConfirmCallback = null;
        }

        // Toggle Telegram visibility
        async function toggleTelegramVisibility(event, slug, enabled) {
            const checkbox = event.target;
            const label = checkbox.closest('.telegram-toggle-label');
            const toggleText = label.querySelector('.telegram-toggle-text');
            const container = checkbox.closest('.telegram-toggle-container');
            
            try {
                const response = await fetch('/api/toggle-telegram-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug, enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update the toggle text
                    toggleText.textContent = enabled ? '‚úì Telegram' : '‚úó Telegram';
                    
                    // Update tooltip
                    container.title = enabled ? 'Visible in Telegram bot' : 'Hidden from Telegram bot';
                    
                    // Show brief success feedback
                    const statusMsg = enabled ? 'enabled' : 'disabled';
                    showAlert('uploadAlert', `Template "${slug}" ${statusMsg} for Telegram ‚úì`);
                } else {
                    // Revert checkbox on error
                    checkbox.checked = !enabled;
                    showAlert('uploadAlert', 'Failed to update: ' + data.error, true);
                }
            } catch (error) {
                // Revert checkbox on error
                checkbox.checked = !enabled;
                showAlert('uploadAlert', 'Failed to update Telegram visibility: ' + error.message, true);
                console.error('Toggle error:', error);
            }
        }

        // Bulk delete
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllTemplates').checked;
            document.querySelectorAll('.template-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.template-checkbox');
            const checkedBoxes = document.querySelectorAll('.template-checkbox:checked');
            document.getElementById('selectAllTemplates').checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }

        function deleteSelectedTemplates() {
            const selected = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => ({
                slug: cb.dataset.slug,
                name: cb.dataset.name
            }));
            
            if (selected.length === 0) {
                showAlert('uploadAlert', 'No templates selected', true);
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Delete Multiple Templates?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete ${selected.length} template(s)? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                
                let successCount = 0;
                let failCount = 0;
                
                for (const template of selected) {
                    try {
                        const response = await fetch('/api/delete-template', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug: template.slug })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                if (successCount > 0) {
                    showAlert('uploadAlert', `Successfully deleted ${successCount} template(s) ‚úì`);
                }
                if (failCount > 0) {
                    showAlert('uploadAlert', `Failed to delete ${failCount} template(s)`, true);
                }
                
                loadAssets();
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        // Color selection
        function selectColor(color, variant) {
            document.querySelectorAll(`.color-swatch[data-variant="${variant}"]`).forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
            document.getElementById(variant + 'FontColor').value = color;
            updatePreviews();
        }

        // Canvas preview setup
        const previewSquareCanvas = document.getElementById('previewSquare');
        const previewStoryCanvas = document.getElementById('previewStory');
        const ctxSquare = previewSquareCanvas.getContext('2d');
        const ctxStory = previewStoryCanvas.getContext('2d');

        const previewImages = {
            square: null,
            story: null
        };

        const drawingState = {
            square: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false },
            story: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false }
        };

        function computeAutoFontPx(ctx, text, maxWidth, maxHeight, minPx) {
            let lo = minPx, hi = maxHeight;
            while (hi - lo > 1) {
                const mid = Math.floor((lo + hi) / 2);
                ctx.font = `700 ${mid}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
                const metrics = ctx.measureText(text);
                if (metrics.width <= maxWidth) {
                    lo = mid;
                } else {
                    hi = mid;
                }
            }
            return lo;
        }

        function drawTextAutoFit(ctx, text, natW, natH, box, maxPx, fontColor) {
            const left = Math.round(natW * (box.leftPct / 100));
            const top = Math.round(natH * (box.topPct / 100));
            const width = Math.round(natW * (box.widthPct / 100));
            const height = Math.round(natH * (box.heightPct / 100));

            const cap = Math.min(maxPx, height);
            const px = computeAutoFontPx(ctx, text, width, cap, 8);

            const hAlign = (box?.hAlign || 'center');
            let x = left;
            let textAlign = 'left';
            if (hAlign === 'center') {
                x = left + Math.round(width / 2);
                textAlign = 'center';
            } else if (hAlign === 'right') {
                x = left + width;
                textAlign = 'right';
            }

            const vAlign = (box?.vAlign || 'bottom');
            let y = top + px;
            if (vAlign === 'middle') {
                y = top + Math.round(height / 2) + Math.round(px * 0.35);
            } else if (vAlign === 'bottom') {
                y = top + height;
            }

            ctx.font = `700 ${px}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'alphabetic';
            ctx.lineJoin = 'round';
            ctx.lineWidth = Math.max(2, Math.floor(px * 0.08));
            ctx.strokeStyle = 'rgba(0,0,0,.75)';
            ctx.fillStyle = fontColor || '#ffffff';
            ctx.strokeText(text, x, y);
            ctx.fillText(text, x, y);
        }

        function renderPreview(variant, showBoundingBox = false) {
            const canvas = variant === 'square' ? previewSquareCanvas : previewStoryCanvas;
            const ctx = variant === 'square' ? ctxSquare : ctxStory;
            const img = previewImages[variant];

            const natW = img && img.naturalWidth ? img.naturalWidth : 1080;
            const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

            const off = document.createElement('canvas');
            off.width = natW;
            off.height = natH;
            const og = off.getContext('2d');
            og.imageSmoothingQuality = 'high';

            if (img && img.naturalWidth) {
                og.drawImage(img, 0, 0, natW, natH);
            } else {
                og.fillStyle = '#10131a';
                og.fillRect(0, 0, natW, natH);
            }

            const prefix = variant === 'square' ? 'square' : 'story';
            const box = {
                leftPct: parseFloat(document.getElementById(prefix + 'LeftPct').value) || 5,
                topPct: parseFloat(document.getElementById(prefix + 'TopPct').value) || 78,
                widthPct: parseFloat(document.getElementById(prefix + 'WidthPct').value) || 90,
                heightPct: parseFloat(document.getElementById(prefix + 'HeightPct').value) || 12,
                hAlign: 'center',
                vAlign: 'middle'
            };
            const maxFontPx = parseInt(document.getElementById(prefix + 'MaxFontPx').value) || 80;

            if (showBoundingBox) {
                const boxLeft = Math.round(natW * (box.leftPct / 100));
                const boxTop = Math.round(natH * (box.topPct / 100));
                const boxWidth = Math.round(natW * (box.widthPct / 100));
                const boxHeight = Math.round(natH * (box.heightPct / 100));
                
                og.fillStyle = 'rgba(102, 126, 234, 0.15)';
                og.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                og.strokeStyle = 'rgba(102, 126, 234, 0.6)';
                og.lineWidth = Math.max(2, Math.round(Math.min(natW, natH) * 0.003));
                og.strokeRect(boxLeft, boxTop, boxWidth, boxHeight);
            }

            const state = drawingState[variant];
            if (state.hasDrawnBox) {
                const fontColor = document.getElementById(variant + 'FontColor').value || '#FF273E';
                drawTextAutoFit(og, 'COUPON-AREA', natW, natH, box, maxFontPx, fontColor);
            }

            const targetW = Math.max(1, Math.round(canvas.parentElement.clientWidth));
            const targetH = Math.max(1, Math.round(canvas.parentElement.clientHeight));
            const pixelRatio = window.devicePixelRatio || 2;
            canvas.width = targetW * pixelRatio;
            canvas.height = targetH * pixelRatio;
            canvas.style.width = targetW + 'px';
            canvas.style.height = targetH + 'px';
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(pixelRatio, pixelRatio);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, targetW, targetH);
            
            const scale = Math.min(targetW / natW, targetH / natH);
            const dw = Math.ceil(natW * scale);
            const dh = Math.ceil(natH * scale);
            const dx = Math.round((targetW - dw) / 2);
            const dy = Math.round((targetH - dh) / 2);
            
            ctx.drawImage(off, 0, 0, natW, natH, dx, dy, dw, dh);
        }

        let updatePreviewsTimeout = null;
        function updatePreviews() {
            if (updatePreviewsTimeout) {
                clearTimeout(updatePreviewsTimeout);
            }
            updatePreviewsTimeout = setTimeout(() => {
                renderPreview('square');
                renderPreview('story');
            }, 50);
        }
        
        function updatePreviewsImmediate() {
            renderPreview('square');
            renderPreview('story');
        }

        // Image upload handlers
        document.getElementById('squareImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.square.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.square = img;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        document.getElementById('storyImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                drawingState.story.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.story = img;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // Slider sync
        function setupSliderSync(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            if (!slider || !input) return;
            
            slider.addEventListener('input', function() {
                input.value = parseFloat(this.value).toFixed(1);
                updatePreviews();
            });
            
            input.addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!isNaN(val)) {
                    slider.value = val;
                }
                updatePreviews();
            });
        }

        setupSliderSync('squareMaxFontPxSlider', 'squareMaxFontPx');
        setupSliderSync('storyMaxFontPxSlider', 'storyMaxFontPx');

        // Drag-to-draw
        function setupDragToDraw(canvasId, variant) {
            const canvas = document.getElementById(canvasId);
            const state = drawingState[variant];

            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            function convertToImagePercentages(startX, startY, endX, endY) {
                const rect = canvas.getBoundingClientRect();
                const canvasDisplayWidth = rect.width;
                const canvasDisplayHeight = rect.height;

                const img = previewImages[variant];
                const natW = img && img.naturalWidth ? img.naturalWidth : (variant === 'square' ? 1080 : 1080);
                const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

                const scale = Math.min(canvasDisplayWidth / natW, canvasDisplayHeight / natH);
                const scaledImageWidth = natW * scale;
                const scaledImageHeight = natH * scale;

                const offsetX = (canvasDisplayWidth - scaledImageWidth) / 2;
                const offsetY = (canvasDisplayHeight - scaledImageHeight) / 2;

                const imgX1 = (Math.min(startX, endX) - offsetX) / scaledImageWidth;
                const imgY1 = (Math.min(startY, endY) - offsetY) / scaledImageHeight;
                const imgX2 = (Math.max(startX, endX) - offsetX) / scaledImageWidth;
                const imgY2 = (Math.max(startY, endY) - offsetY) / scaledImageHeight;

                const leftPct = Math.max(0, Math.min(100, imgX1 * 100));
                const topPct = Math.max(0, Math.min(100, imgY1 * 100));
                const widthPct = Math.max(1, Math.min(100 - leftPct, (imgX2 - imgX1) * 100));
                const heightPct = Math.max(1, Math.min(100 - topPct, (imgY2 - imgY1) * 100));

                return { leftPct, topPct, widthPct, heightPct };
            }

            function drawDragRectangle() {
                if (!state.isDrawing) return;

                const ctx = variant === 'square' ? ctxSquare : ctxStory;
                
                renderPreview(variant, true);

                const x1 = Math.min(state.startX, state.currentX);
                const y1 = Math.min(state.startY, state.currentY);
                const width = Math.abs(state.currentX - state.startX);
                const height = Math.abs(state.currentY - state.startY);

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);

                ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                ctx.fillRect(x1, y1, width, height);
                ctx.restore();
            }

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCanvasCoordinates(e);
                state.isDrawing = true;
                state.startX = coords.x;
                state.startY = coords.y;
                state.currentX = coords.x;
                state.currentY = coords.y;
                renderPreview(variant, true);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                drawDragRectangle();
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                state.isDrawing = false;

                const minDragDistance = 10;
                if (Math.abs(state.currentX - state.startX) < minDragDistance || 
                    Math.abs(state.currentY - state.startY) < minDragDistance) {
                    renderPreview(variant);
                    return;
                }

                const percentages = convertToImagePercentages(
                    state.startX, state.startY, 
                    state.currentX, state.currentY
                );

                const prefix = variant === 'square' ? 'square' : 'story';
                document.getElementById(prefix + 'LeftPct').value = percentages.leftPct.toFixed(1);
                document.getElementById(prefix + 'TopPct').value = percentages.topPct.toFixed(1);
                document.getElementById(prefix + 'WidthPct').value = percentages.widthPct.toFixed(1);
                document.getElementById(prefix + 'HeightPct').value = percentages.heightPct.toFixed(1);

                state.hasDrawnBox = true;

                updatePreviewsImmediate();
            });

            canvas.addEventListener('mouseleave', (e) => {
                if (state.isDrawing) {
                    state.isDrawing = false;
                    renderPreview(variant);
                }
            });
        }

        setupDragToDraw('previewSquare', 'square');
        setupDragToDraw('previewStory', 'story');

        // Nudge controls
        function nudgePosition(variant, direction) {
            const prefix = variant === 'square' ? 'square' : 'story';
            const leftInput = document.getElementById(prefix + 'LeftPct');
            const topInput = document.getElementById(prefix + 'TopPct');
            
            const step = 0.5;
            let currentLeft = parseFloat(leftInput.value) || 5;
            let currentTop = parseFloat(topInput.value) || 78;
            
            switch(direction) {
                case 'up':
                    currentTop = Math.max(0, currentTop - step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'down':
                    currentTop = Math.min(100, currentTop + step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'left':
                    currentLeft = Math.max(0, currentLeft - step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
                case 'right':
                    currentLeft = Math.min(100, currentLeft + step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
            }
            
            updatePreviews();
        }

        // Campaign Management
        async function loadCampaigns() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">Loading campaigns...</p>';
            
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                
                if (!data.campaigns || data.campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">No campaigns found</p>';
                    return;
                }
                
                campaignsList.innerHTML = '';
                data.campaigns.forEach(campaign => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <div class="asset-item-info" style="flex: 1;">
                            <div class="asset-name">${campaign.title}</div>
                            <div class="asset-slug">${campaign.description} | ${campaign.start_date} to ${campaign.end_date}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="editCampaign(${campaign.id})">‚úé</div>
                            <div class="asset-delete-icon" onclick="deleteCampaign(${campaign.id}, '${campaign.title}')">üóë</div>
                            <button onclick="viewSubmissions(${campaign.id}, '${campaign.title}')" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Submissions</button>
                        </div>
                    `;
                    campaignsList.appendChild(item);
                });
            } catch (error) {
                campaignsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading campaigns</p>';
                console.error('Failed to load campaigns:', error);
            }
        }

        async function handleCampaignSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('campaignSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const formData = new FormData();
            const editId = document.getElementById('editCampaignId').value;
            if (editId) formData.append('id', editId);
            
            formData.append('title', document.getElementById('campaignTitle').value);
            formData.append('description', document.getElementById('campaignDescription').value);
            formData.append('start_date', document.getElementById('campaignStartDate').value);
            formData.append('end_date', document.getElementById('campaignEndDate').value);
            formData.append('prize', document.getElementById('campaignPrize').value);
            
            const platforms = [];
            if (document.getElementById('platformInstagram').checked) platforms.push('Instagram');
            if (document.getElementById('platformTwitter').checked) platforms.push('Twitter');
            if (document.getElementById('platformFacebook').checked) platforms.push('Facebook');
            formData.append('platforms', platforms.join(','));
            
            const overlayFile = document.getElementById('campaignOverlay').files[0];
            if (overlayFile) {
                formData.append('overlay', overlayFile);
            } else if (editId) {
                const existingUrl = document.getElementById('existingOverlayUrl').value;
                if (existingUrl) formData.append('existingOverlay', existingUrl);
            }

            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('campaignAlert', data.message + ' ‚úì');
                    document.getElementById('campaignForm').reset();
                    document.getElementById('editCampaignId').value = '';
                    document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
                    document.getElementById('campaignCancelBtn').style.display = 'none';
                    document.getElementById('overlayPreview').style.display = 'none';
                    loadCampaigns();
                } else {
                    showAlert('campaignAlert', data.error || 'Failed to save campaign', true);
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to save campaign: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editId ? 'Update Campaign' : 'Create Campaign';
            }
        }

        async function editCampaign(id) {
            try {
                const response = await fetch(`/api/campaigns/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const campaign = data.campaign;
                    document.getElementById('editCampaignId').value = campaign.id;
                    document.getElementById('campaignTitle').value = campaign.title;
                    document.getElementById('campaignDescription').value = campaign.description;
                    document.getElementById('campaignStartDate').value = campaign.start_date;
                    document.getElementById('campaignEndDate').value = campaign.end_date;
                    document.getElementById('campaignPrize').value = campaign.prize;
                    
                    const platforms = campaign.platforms.split(',');
                    document.getElementById('platformInstagram').checked = platforms.includes('Instagram');
                    document.getElementById('platformTwitter').checked = platforms.includes('Twitter');
                    document.getElementById('platformFacebook').checked = platforms.includes('Facebook');
                    
                    if (campaign.overlay_url) {
                        document.getElementById('existingOverlayUrl').value = campaign.overlay_url;
                        document.getElementById('overlayPreviewImg').src = campaign.overlay_url;
                        document.getElementById('overlayPreview').style.display = 'block';
                    }
                    
                    document.getElementById('campaignFormTitle').textContent = 'Edit Campaign';
                    document.getElementById('campaignSubmitBtn').textContent = 'Update Campaign';
                    document.getElementById('campaignCancelBtn').style.display = 'inline-block';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('campaignAlert', 'Failed to load campaign: ' + error.message, true);
            }
        }

        function cancelCampaignEdit() {
            document.getElementById('campaignForm').reset();
            document.getElementById('editCampaignId').value = '';
            document.getElementById('campaignFormTitle').textContent = 'Create Campaign';
            document.getElementById('campaignSubmitBtn').textContent = 'Create Campaign';
            document.getElementById('campaignCancelBtn').style.display = 'none';
            document.getElementById('overlayPreview').style.display = 'none';
        }

        async function deleteCampaign(id, title) {
            document.getElementById('modalTitle').textContent = 'Delete Campaign?';
            document.getElementById('modalMessage').textContent = `Are you sure you want to delete "${title}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
            
            deleteConfirmCallback = async () => {
                closeDeleteModal();
                try {
                    const response = await fetch(`/api/campaigns/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('campaignAlert', `Campaign "${title}" deleted successfully ‚úì`);
                        loadCampaigns();
                    } else {
                        showAlert('campaignAlert', data.error || 'Delete failed', true);
                    }
                } catch (error) {
                    showAlert('campaignAlert', 'Delete failed: ' + error.message, true);
                }
            };
            
            document.getElementById('modalConfirmBtn').onclick = deleteConfirmCallback;
        }

        async function viewSubmissions(campaignId, campaignTitle) {
            document.getElementById('submissionsModalTitle').textContent = `Submissions: ${campaignTitle}`;
            document.getElementById('submissionsContent').innerHTML = '<p style="color: #718096; text-align: center;">Loading submissions...</p>';
            document.getElementById('submissionsModal').classList.add('active');
            
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/submissions`);
                const data = await response.json();
                
                if (data.success && data.submissions.length > 0) {
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">';
                    data.submissions.forEach(sub => {
                        html += `
                            <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                                <img src="${sub.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #4a5568; font-weight: 600;">${sub.user_id}</div>
                                <div style="font-size: 11px; color: #718096;">${new Date(sub.submitted_at).toLocaleDateString()}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('submissionsContent').innerHTML = html;
                } else {
                    document.getElementById('submissionsContent').innerHTML = '<p style="color: #718096; text-align: center;">No submissions yet</p>';
                }
            } catch (error) {
                document.getElementById('submissionsContent').innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading submissions</p>';
            }
        }

        function closeSubmissionsModal() {
            document.getElementById('submissionsModal').classList.remove('active');
        }

        function handleOverlayPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('overlayPreviewImg').src = e.target.result;
                    document.getElementById('overlayPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearOverlay() {
            document.getElementById('campaignOverlay').value = '';
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('existingOverlayUrl').value = '';
        }

        // Broadcast Functions
        async function loadBroadcastData() {
            await Promise.all([
                loadActiveUsersCount(),
                loadBroadcastHistory()
            ]);
        }

        async function loadActiveUsersCount() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                document.getElementById('activeUsersCount').textContent = data.active_users || 0;
            } catch (error) {
                console.error('Error loading active users:', error);
                document.getElementById('activeUsersCount').textContent = '?';
            }
        }

        async function loadBroadcastHistory() {
            try {
                const response = await fetch('/api/broadcast-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    document.getElementById('broadcastHistory').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            No broadcasts sent yet
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Message</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Recipients</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Sent</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; color: #718096; font-weight: 600;">Failed</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; color: #718096; font-weight: 600;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.jobs.forEach(job => {
                    const statusColor = {
                        'completed': '#10b981',
                        'processing': '#3b82f6',
                        'failed': '#ef4444',
                        'pending': '#f59e0b'
                    }[job.status] || '#718096';

                    const messagePreview = job.message.length > 50 
                        ? job.message.substring(0, 50) + '...' 
                        : job.message;

                    html += `
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 12px; font-size: 14px; color: #1a202c;">${messagePreview}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                                    ${job.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #4a5568;">${job.total_users}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #10b981; font-weight: 600;">${job.sent_count}</td>
                            <td style="padding: 12px; text-align: center; font-size: 14px; color: #ef4444; font-weight: 600;">${job.failed_count}</td>
                            <td style="padding: 12px; font-size: 13px; color: #718096;">${new Date(job.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('broadcastHistory').innerHTML = html;
            } catch (error) {
                console.error('Error loading broadcast history:', error);
                document.getElementById('broadcastHistory').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Error loading broadcast history
                    </div>
                `;
            }
        }

        async function sendBroadcast(event) {
            event.preventDefault();

            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showAlert('broadcastAlert', 'Please enter a message', true);
                return;
            }

            // Confirm before sending
            if (!confirm(`Send this broadcast to all active users?`)) {
                return;
            }

            // Show loading state
            document.getElementById('broadcastBtnText').style.display = 'none';
            document.getElementById('broadcastBtnSpinner').style.display = 'inline-block';
            document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, days: 30 })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('broadcastAlert', `‚úÖ Broadcast started! Sending to ${data.total_users} users. Job ID: ${data.job_id}`);
                    document.getElementById('broadcastForm').reset();
                    
                    // Reload history after a delay
                    setTimeout(() => loadBroadcastHistory(), 2000);
                } else {
                    showAlert('broadcastAlert', data.error || 'Failed to send broadcast', true);
                }
            } catch (error) {
                showAlert('broadcastAlert', 'Error: ' + error.message, true);
            } finally {
                // Reset loading state
                document.getElementById('broadcastBtnText').style.display = 'inline';
                document.getElementById('broadcastBtnSpinner').style.display = 'none';
                document.getElementById('broadcastForm').querySelector('button[type="submit"]').disabled = false;
            }
        }

        function previewBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message first');
                return;
            }

            // Convert basic Markdown to HTML for preview
            const htmlMessage = message
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<strong>$1</strong>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">$1</code>')
                .replace(/\n/g, '<br>');

            const previewWindow = window.open('', 'Broadcast Preview', 'width=400,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Broadcast Preview</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            padding: 20px;
                            background: #0d1117;
                            color: #fff;
                        }
                        .message {
                            background: #1c2128;
                            padding: 16px;
                            border-radius: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                        }
                        .label {
                            color: #8b949e;
                            font-size: 12px;
                            margin-bottom: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="label">üì± Telegram Message Preview</div>
                    <div class="message">${htmlMessage}</div>
                </body>
                </html>
            `);
        }

        // Initial render
        updatePreviewsImmediate();

        // Check authentication on page load
        async function checkAuthOnLoad() {
            try {
                // Try to make an authenticated API call to check if we're logged in
                const response = await fetch('/api/bot-stats?days=7', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    // User is authenticated, show dashboard and load fresh data
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    // Load all fresh data
                    await loadAssets();
                    
                    // If we're on the analytics tab, load analytics too
                    const analyticsView = document.getElementById('analyticsView');
                    if (analyticsView && !analyticsView.classList.contains('hidden')) {
                        await loadAnalytics();
                    }
                } else if (response.status === 401) {
                    // Not authenticated, show login page
                    document.getElementById('loginPage').classList.remove('hidden');
                    console.log('[AUTH] Not authenticated, showing login page');
                } else {
                    // Other error, show login page
                    document.getElementById('loginPage').classList.remove('hidden');
                    console.error('[AUTH] Unexpected response:', response.status);
                }
            } catch (error) {
                // Network error or other issue, show login page
                document.getElementById('loginPage').classList.remove('hidden');
                console.error('[AUTH] Error checking authentication:', error);
            }
        }

        // Run auth check when page loads
        checkAuthOnLoad();
    </script>
</body>
</html>
