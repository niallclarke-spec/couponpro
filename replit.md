# PromoStack Promo Gen

## Overview
PromoStack is a promotional image generation platform offering web and Telegram bot interfaces. It enables users to rapidly create branded coupon images for marketing on social media and messaging platforms. The platform's core purpose is to streamline the creation of visually appealing marketing assets, accessible via a web application (dash.promostack.io) or through commands to @promostack_bot in Telegram channels.

## User Preferences
I prefer clear, concise communication. When suggesting changes or explaining concepts, please provide a high-level summary first, followed by details if necessary. I value iterative development and would like to be consulted before any major architectural changes or significant code refactoring. Please prioritize solutions that are robust and scalable, especially concerning file persistence and session management in ephemeral environments. Ensure that the visual design remains consistent and user-friendly, particularly in the admin interface.

## System Architecture

### UI/UX Decisions
The platform features a consistent dark theme across both user-facing and administration interfaces. The admin panel is designed for intuitive workflow, incorporating centered control elements, real-time visual feedback through live previews, and a drag-to-draw interface for defining coupon text areas. Key design elements include high-DPI rendering for crisp output and color pickers for text customization.

### Technical Implementations
The frontend uses pure HTML, CSS, and vanilla JavaScript for a lightweight experience. The backend, including the admin panel and API, is a Python HTTP server (`server.py`). Image generation occurs client-side via canvas manipulation for the web app, including auto-fitting text and optional logo overlays, while the Telegram bot uses server-side Python/Pillow for rendering. Authentication uses HMAC-signed cookie authentication for stateless session management. Template images and `meta.json` backups are stored persistently in Digital Ocean Spaces (S3-compatible object storage) with CDN-enabled public URLs, accessed via `boto3`.

### Feature Specifications
- **Web Application (V1)**: Dynamic template loading, auto-fit text, live previews (square/portrait), optional logo overlay, image download/share, and a password-protected admin panel for template management (upload, edit, bulk delete). Integrated FunderPro coupon validation prevents downloads/shares of inactive coupons.
- **Telegram Bot Integration (V2)**: The @promostack_bot processes commands like `/template-name/COUPONCODE`, generating and posting promo images directly to Telegram channels using server-side Python/Pillow rendering. It supports flexible template matching and webhook integration. Validates coupons via FunderPro API before generating images. Includes conversational UX with `/start`, `/help`, `/generate` commands and command menu.
- **Campaigns & Promotions (V3)**: An admin-managed system for creating promotional campaigns with titles, descriptions, dates, target platforms, and overlay images. Campaigns automatically transition statuses. Users participate via dedicated campaign pages at `/campaign/{id}` where they upload images, see real-time canvas compositing with campaign overlays (or red tint fallback), download composite images, and submit social media URLs for entry tracking. Admins can upload overlay images (stored in Spaces under `campaigns/overlays/`) which are applied to user images. This feature uses a PostgreSQL database for campaigns and submissions with dedicated API endpoints, admin management UI, and campaign participation pages.
- **FunderPro CRM Integration (V4)**: Real-time coupon validation via FunderPro's discount API. The `coupon_validator.py` module validates coupon codes against the 10k Challenge product before allowing promo image generation. Integration enforces that only active, valid coupons from FunderPro's CRM can be used to create promotional materials, preventing marketing of expired or invalid offers. API endpoint: `POST /api/validate-coupon`.
- **Telegram Broadcast System (V5)**: Admin panel feature for broadcasting messages to all active Telegram bot users. Tracks users in `bot_users` table when they generate images. Broadcast jobs run asynchronously with 20 msg/s rate limiting, handling blocked users gracefully. Admin UI shows active user count, message preview, and broadcast history with status tracking (`broadcast_jobs` table). Enables notifications when new templates are added. API endpoints: `POST /api/broadcast`, `GET /api/broadcast-status/{id}`, `GET /api/broadcast-jobs`.
- **Template Visibility Control (V6)**: Admin panel checkbox toggles control which templates appear in the Telegram bot. Each template in the "Current Assets" tab displays a Telegram visibility toggle (✓/✗ indicator). Admins can selectively enable/disable templates for Telegram without affecting web app availability. Changes update `meta.json` in Spaces and regenerate `index.json` automatically. The Telegram bot filters templates based on `telegramEnabled` flag (defaults to `true` for backward compatibility). Web app shows all templates regardless of Telegram visibility. API endpoint: `POST /api/toggle-telegram-template` (requires authentication).
- **Bot Analytics Dashboard (V7)**: Comprehensive admin analytics with smart chart switching - Today/Yesterday views show hourly breakdowns (00:00-23:00 with 24-hour zero-fill), while 7/30/90 day views show daily aggregation. Features include: total generations, unique users, success rates, top templates, popular coupon codes (paginated 50/page with CSV export), and dynamic usage charts. Backend provides dual-key payload structure (`label`/`date` fields) with `granularity` indicator for full backward compatibility. API endpoint: `GET /api/bot-stats?days={today|yesterday|7|30|90}`.

### System Design Choices
The system uses stateless HMAC-signed cookie authentication to support ephemeral environments. All template images are stored in Digital Ocean Spaces for persistence across deployments, serving as the universal source of truth. A hybrid storage model utilizes local `meta.json` files for quick access while backing them up to object storage. The architecture is modular, using environment variables for configuration (`SPACES_ACCESS_KEY`, `TELEGRAM_BOT_TOKEN`, `DB_HOST`, `FUNDERPRO_PRODUCT_ID`, etc.). Telegram image generation uses Pillow for accurate, stroke-artifact-free rendering, matching web app quality. Coupon validation is enforced at the API level before image generation to prevent unauthorized use of inactive promotional codes.

**Production Robustness (Nov 2025)**: The Telegram bot is production-hardened for concurrent users with: (1) All database calls wrapped in `asyncio.to_thread()` to prevent event loop blocking, (2) AIORateLimiter configured with automatic retries (max_retries=3) to handle Telegram's rate limits gracefully, (3) **Single-process webhook architecture** - The bot runs ONLY via webhook mode in `server.py` (dedicated worker removed from `.do/app.yaml` on Nov 12, 2025 to fix critical state consistency bug). This ensures `coupon_cache` stays consistent across all Telegram updates, preventing "Please start over with /start" errors caused by dual-process state conflicts. Token priority ensures `TELEGRAM_BOT_TOKEN` (production) takes precedence over `TELEGRAM_BOT_TOKEN_TEST` (development).

## External Dependencies
- **Digital Ocean Spaces**: S3-compatible object storage for persistent template images (bucket: `couponpro-templates`, region: LON1) with CDN.
- **Digital Ocean PostgreSQL**: Managed database for campaigns and submissions (database: `promostack-db`, region: LON1).
- **Digital Ocean**: Primary production deployment platform.
- **Python 3.11**: Backend runtime environment.
- **`requirements.txt`**: Key Python packages include `boto3` (for S3 interaction), `psycopg2-binary` (PostgreSQL driver), `Pillow` (image processing), `python-dotenv`, `python-telegram-bot[rate-limiter]` (Telegram API with rate limiting), and `aiolimiter` (async rate limiting).
- **Environment Secrets**: 
  - **Development (Replit)**: `TELEGRAM_BOT_TOKEN_TEST` (for @promostack_test_bot - safe testing environment), `DATABASE_URL` (dev database), `SPACES_ACCESS_KEY`, `SPACES_SECRET_KEY`, `SPACES_REGION`, `SPACES_BUCKET`, `ADMIN_PASSWORD`, `FUNDERPRO_PRODUCT_ID`
  - **Production (Digital Ocean)**: `TELEGRAM_BOT_TOKEN` (for @promostack_bot - live production bot), `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` (production database), `SPACES_ACCESS_KEY`, `SPACES_SECRET_KEY`, `SPACES_REGION`, `SPACES_BUCKET`, `ADMIN_PASSWORD`, `FUNDERPRO_PRODUCT_ID`
  - **Important**: Development uses `TELEGRAM_BOT_TOKEN_TEST` to safely test bot changes without affecting the live production bot. Only push to GitHub when changes are fully tested and ready for production deployment.
- **.do/app.yaml**: Digital Ocean specific application configuration.