<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | PromoStack</title>
    <style>
        :root {
            --bg-primary: #081028;
            --bg-secondary: #091128;
            --bg-card: #0B1739;
            --bg-card-hover: #122048;
            --bg-sidebar: #081028;
            --accent-primary: #4f46e5;
            --accent-primary-hover: #6366f1;
            --accent-gradient: linear-gradient(90deg, #1e3a5f 0%, #4f46e5 50%, #7c3aed 100%);
            --accent-glow: rgba(79, 70, 229, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-primary: rgba(255, 255, 255, 0.06);
            --border-secondary: rgba(255, 255, 255, 0.10);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --sidebar-width: 260px;
            --status-success: #10b981;
            --status-success-bg: rgba(16, 185, 129, 0.15);
            --status-warning: #f59e0b;
            --status-warning-bg: rgba(245, 158, 11, 0.15);
            --status-error: #ef4444;
            --status-error-bg: rgba(239, 68, 68, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-primary);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-primary);
        }

        .sidebar-logo {
            width: 160px;
            height: auto;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border-primary);
        }

        .user-chip {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }

        .user-chip-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .user-chip-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-chip-info {
            flex: 1;
            min-width: 0;
        }

        .user-chip-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .user-chip-email {
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-item.signout {
            color: var(--text-secondary);
        }

        .nav-item.signout:hover {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            overflow-y: auto;
        }

        .content-wrapper {
            max-width: 1200px;
            padding: 32px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .status-badge.disconnected {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .status-badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
        }

        .btn-success {
            background: var(--status-success);
            color: white;
        }

        .warning-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--status-warning-bg);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .warning-banner svg {
            width: 20px;
            height: 20px;
            color: var(--status-warning);
            flex-shrink: 0;
        }

        .warning-banner-text {
            font-size: 14px;
            color: var(--status-warning);
        }

        .vip-plan-card {
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
        }

        .vip-plan-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .vip-plan-label {
            background: var(--accent-primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .vip-plan-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .vip-plan-details {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .filter-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle input:checked + .toggle-slider:before {
            background: white;
            transform: translateX(20px);
        }

        .products-grid {
            display: grid;
            gap: 16px;
        }

        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.2s;
        }

        .product-card:hover {
            border-color: var(--border-secondary);
            background: var(--bg-card-hover);
        }

        .product-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .product-nickname {
            font-size: 13px;
            color: var(--text-muted);
        }

        .product-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .product-status.active {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .product-status.archived {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
        }

        .product-details {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .product-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .product-interval {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .product-type {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            color: var(--text-muted);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(8, 16, 40, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-overlay .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-secondary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-overlay .text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            z-index: 10000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--status-success);
            color: white;
        }

        .toast.error {
            background: var(--status-error);
            color: white;
        }

        .welcome-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            border: 1px solid var(--border-primary);
            max-width: 480px;
            margin: 60px auto;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .welcome-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .quick-links {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .quick-link:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .quick-link svg {
            width: 24px;
            height: 24px;
            color: var(--accent-primary);
        }

        .quick-link-text {
            flex: 1;
            text-align: left;
        }

        .quick-link-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .quick-link-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
        }

        .mobile-menu-toggle svg {
            width: 24px;
            height: 24px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.show {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .content-wrapper {
                padding: 80px 16px 32px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .impersonation-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #7c3aed, #a855f7);
            color: white;
            padding: 8px 16px;
            z-index: 9999;
            display: flex;
            justify-content: center;
        }

        .impersonation-content {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .exit-impersonation-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .exit-impersonation-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        body.impersonating .app-layout,
        body.impersonating .sidebar {
            padding-top: 40px;
        }

        body.impersonating .loading-overlay {
            top: 40px;
        }

        .journeys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .journey-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.2s;
        }

        .journey-card:hover {
            border-color: var(--border-secondary);
            background: var(--bg-card-hover);
        }

        .journey-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .journey-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .journey-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .journey-status.draft {
            background: rgba(107, 114, 128, 0.15);
            color: #9ca3af;
        }

        .journey-status.active {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .journey-status.paused {
            background: var(--status-warning-bg);
            color: var(--status-warning);
        }

        .journey-meta {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .journey-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .journey-meta-item svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
        }

        .journey-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .btn-icon.danger:hover {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .journey-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-backdrop.show .journey-modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .status-options {
            display: flex;
            gap: 10px;
        }

        .status-option {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .status-option:hover {
            border-color: var(--border-secondary);
        }

        .status-option.selected {
            border-color: var(--accent-primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .status-option-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .active-warning {
            display: none;
            padding: 12px;
            background: var(--status-warning-bg);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-md);
            margin-top: 12px;
            font-size: 13px;
            color: var(--status-warning);
        }

        .active-warning.show {
            display: block;
        }

        .steps-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-primary);
        }

        .steps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .steps-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .steps-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
        }

        .step-order {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            min-width: 0;
        }

        .step-message {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .step-delay {
            font-size: 12px;
            color: var(--text-muted);
        }

        .step-actions {
            display: flex;
            gap: 4px;
        }

        .step-btn {
            padding: 6px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .step-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .step-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .step-btn.danger:hover {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .step-btn svg {
            width: 14px;
            height: 14px;
        }

        .steps-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .step-modal {
            max-width: 480px;
        }

        .limit-badge {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .journeys-grid {
                grid-template-columns: 1fr;
            }
            .journey-modal {
                width: 95%;
                max-height: 90vh;
            }
            .status-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="text" id="loading-text">Loading...</div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Impersonation Banner (shown when admin is viewing as tenant) -->
    <div id="impersonation-banner" class="impersonation-banner" style="display: none;">
        <div class="impersonation-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Viewing as: <strong id="impersonation-tenant-name"></strong></span>
            <button class="exit-impersonation-btn" onclick="exitImpersonation()">Exit</button>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

    <div class="app-layout" id="app-layout" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/assets/promostack-logo.png" alt="PromoStack" class="sidebar-logo" />
            </div>

            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    Dashboard
                </a>
                <a href="#products" class="nav-item" data-page="products">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    Products
                </a>
                <a href="#journeys" class="nav-item" data-page="journeys">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                        <path d="M12 11h4"/>
                        <path d="M12 16h4"/>
                        <path d="M8 11h.01"/>
                        <path d="M8 16h.01"/>
                    </svg>
                    Journeys
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-chip">
                    <div class="user-chip-avatar" id="user-avatar">
                        <span id="user-initials"></span>
                    </div>
                    <div class="user-chip-info">
                        <div class="user-chip-label">Signed in as</div>
                        <div class="user-chip-email" id="user-email">Loading...</div>
                    </div>
                </div>
                <button class="nav-item signout" id="signout-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16,17 21,12 16,7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Sign Out
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-wrapper">
                <section id="page-dashboard" class="page-section active">
                    <div class="welcome-card">
                        <h1 class="welcome-title">Welcome to PromoStack</h1>
                        <p class="welcome-text">Manage your products, subscriptions, and VIP access all in one place.</p>
                        <div class="quick-links">
                            <a href="#products" class="quick-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                </svg>
                                <div class="quick-link-text">
                                    <div class="quick-link-title">Products</div>
                                    <div class="quick-link-desc">Manage your Stripe products and VIP plans</div>
                                </div>
                            </a>
                            <a href="/coupon" class="quick-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6"/>
                                    <path d="M4 8V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2"/>
                                    <line x1="12" y1="4" x2="12" y2="20"/>
                                </svg>
                                <div class="quick-link-text">
                                    <div class="quick-link-title">Coupon Generator</div>
                                    <div class="quick-link-desc">Create discount codes for your customers</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </section>

                <section id="page-products" class="page-section">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1 class="page-title">Products</h1>
                            <div id="stripe-status-badge" class="status-badge disconnected">
                                <span class="status-badge-dot"></span>
                                <span id="stripe-status-text">Not Connected</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="sync-products-btn" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <polyline points="23,4 23,10 17,10"/>
                                <path d="M20.49,15a9,9,0,1,1-2.12-9.36L23,10"/>
                            </svg>
                            <span id="sync-btn-text">Sync from Stripe</span>
                        </button>
                    </div>

                    <div id="vip-warning-banner" class="warning-banner" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span class="warning-banner-text">No VIP Plan selected â€” subscriptions won't grant VIP access until you choose one.</span>
                    </div>

                    <div id="vip-plan-card" class="vip-plan-card" style="display: none;">
                        <div class="vip-plan-header">
                            <span class="vip-plan-label">Selected VIP Plan</span>
                        </div>
                        <div class="vip-plan-name" id="vip-plan-name">-</div>
                        <div class="vip-plan-details">
                            <span id="vip-plan-price">-</span>
                            <span id="vip-plan-interval">-</span>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div class="toggle-wrapper">
                            <label class="toggle">
                                <input type="checkbox" id="filter-recurring" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Show only recurring prices</span>
                        </div>
                    </div>

                    <div id="products-container">
                        <div class="empty-state" id="products-empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            <h3 class="empty-state-title" id="empty-state-title">No products synced yet</h3>
                            <p class="empty-state-text" id="empty-state-text">Click 'Sync from Stripe' to import your products.</p>
                        </div>
                        <div class="products-grid" id="products-grid" style="display: none;"></div>
                    </div>
                </section>

                <section id="page-journeys" class="page-section">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1 class="page-title">Journeys</h1>
                            <span class="limit-badge" id="journeys-limit-badge">0 / 6</span>
                        </div>
                        <button class="btn btn-primary" id="create-journey-btn" onclick="openJourneyModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Create Journey
                        </button>
                    </div>

                    <div id="journeys-empty-state" class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                            <path d="M12 11h4"/>
                            <path d="M12 16h4"/>
                            <path d="M8 11h.01"/>
                            <path d="M8 16h.01"/>
                        </svg>
                        <h3 class="empty-state-title">No journeys yet</h3>
                        <p class="empty-state-text">Create your first automated messaging journey to engage users when they join via deep links.</p>
                    </div>

                    <div class="journeys-grid" id="journeys-grid" style="display: none;"></div>
                </section>
            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="journey-modal-backdrop">
        <div class="journey-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="journey-modal-title">Create Journey</h2>
                <button class="modal-close" onclick="closeJourneyModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Journey Name</label>
                    <input type="text" class="form-input" id="journey-name-input" placeholder="e.g., Welcome Sequence">
                </div>

                <div class="form-group">
                    <label class="form-label">Trigger Type</label>
                    <select class="form-select" id="journey-trigger-type">
                        <option value="deep_link">Deep Link</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Trigger Value</label>
                    <input type="text" class="form-input" id="journey-trigger-value" placeholder="e.g., welcome_promo">
                    <p class="form-hint">Users who join via t.me/yourbot?start=<strong>welcome_promo</strong> will enter this journey</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="status-options">
                        <div class="status-option selected" data-status="draft" onclick="selectStatus('draft')">
                            <span class="status-option-label">Draft</span>
                        </div>
                        <div class="status-option" data-status="active" onclick="selectStatus('active')">
                            <span class="status-option-label">Active</span>
                        </div>
                        <div class="status-option" data-status="paused" onclick="selectStatus('paused')">
                            <span class="status-option-label">Paused</span>
                        </div>
                    </div>
                    <div class="active-warning" id="active-warning">
                        <strong>Warning:</strong> Activating this journey will immediately start sending messages to users who match the trigger.
                    </div>
                </div>

                <div class="steps-section">
                    <div class="steps-header">
                        <span class="steps-title">Steps</span>
                        <button class="btn btn-secondary btn-sm" onclick="addStep()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Step
                        </button>
                    </div>
                    <div id="steps-list-container">
                        <div class="steps-empty" id="steps-empty">No steps added yet. Add a step to define what messages to send.</div>
                        <div class="steps-list" id="steps-list"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeJourneyModal()">Cancel</button>
                <button class="btn btn-primary" id="save-journey-btn" onclick="saveJourney()">Save Journey</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="step-modal-backdrop">
        <div class="journey-modal step-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="step-modal-title">Add Step</h2>
                <button class="modal-close" onclick="closeStepModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Message Template</label>
                    <textarea class="form-textarea" id="step-message-input" placeholder="Enter the message to send..."></textarea>
                    <p class="form-hint">You can use variables like {first_name} for personalization</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Delay (seconds)</label>
                    <input type="number" class="form-input" id="step-delay-input" value="0" min="0">
                    <p class="form-hint">How long to wait before sending this message (0 = immediately after previous step)</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStepModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveStep()">Save Step</button>
            </div>
        </div>
    </div>

    <script>
        let CLERK_PUBLISHABLE_KEY = '{{CLERK_PUBLISHABLE_KEY}}';
        let clerkInstance = null;
        let stripeStatus = { connected: false, vip_price_id: null };
        let productsData = [];

        const journeysState = {
            journeys: [],
            currentJourneyId: null,
            steps: [],
            editingStepIndex: null,
            selectedStatus: 'draft',
            loading: false
        };
        const MAX_JOURNEYS = 6;

        async function getAuthHeaders(includeContentType = false) {
            const headers = {};
            if (includeContentType) {
                headers['Content-Type'] = 'application/json';
            }
            if (window.Clerk && window.Clerk.session) {
                try {
                    const token = await window.Clerk.session.getToken();
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                } catch (err) {
                    console.warn('Failed to get Clerk token:', err);
                }
            }
            const storedToken = sessionStorage.getItem('clerk_session_token');
            if (!headers['Authorization'] && storedToken) {
                headers['Authorization'] = `Bearer ${storedToken}`;
            }
            let userEmail = sessionStorage.getItem('clerk_user_email');
            if (window.Clerk && window.Clerk.user) {
                userEmail = window.Clerk.user.primaryEmailAddress?.emailAddress || 
                            window.Clerk.user.emailAddresses?.[0]?.emailAddress || 
                            userEmail;
            }
            if (userEmail) {
                headers['X-Clerk-User-Email'] = userEmail;
            }
            const impersonatedTenantId = sessionStorage.getItem('impersonating_tenant_id');
            if (impersonatedTenantId) {
                headers['X-Impersonate-Tenant'] = impersonatedTenantId;
            }
            return headers;
        }

        function checkImpersonation() {
            const impersonatingTenantId = sessionStorage.getItem('impersonating_tenant_id');
            if (impersonatingTenantId) {
                document.body.classList.add('impersonating');
                const banner = document.getElementById('impersonation-banner');
                if (banner) {
                    banner.style.display = 'flex';
                    const nameEl = document.getElementById('impersonation-tenant-name');
                    if (nameEl) {
                        nameEl.textContent = impersonatingTenantId;
                    }
                }
                window.impersonatedTenantId = impersonatingTenantId;
            }
        }

        function exitImpersonation() {
            sessionStorage.removeItem('impersonating_tenant_id');
            window.close();
            window.location.href = '/admin';
        }

        async function getClerkKey() {
            if (CLERK_PUBLISHABLE_KEY && CLERK_PUBLISHABLE_KEY !== '{{CLERK_PUBLISHABLE_KEY}}') {
                return CLERK_PUBLISHABLE_KEY;
            }
            try {
                const resp = await fetch('/api/config');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.clerkPublishableKey) {
                        return data.clerkPublishableKey;
                    }
                }
            } catch (err) {
                console.error('Failed to fetch config:', err);
            }
            return null;
        }

        function loadClerkScript(publishableKey) {
            return new Promise((resolve, reject) => {
                if (window.Clerk) {
                    resolve(window.Clerk);
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js';
                script.crossOrigin = 'anonymous';
                script.setAttribute('data-clerk-publishable-key', publishableKey);
                script.onload = () => {
                    const checkClerk = setInterval(() => {
                        if (window.Clerk) {
                            clearInterval(checkClerk);
                            resolve(window.Clerk);
                        }
                    }, 50);
                    setTimeout(() => {
                        clearInterval(checkClerk);
                        if (!window.Clerk) reject(new Error('Clerk failed to initialize'));
                    }, 5000);
                };
                script.onerror = () => reject(new Error('Failed to load Clerk script'));
                document.head.appendChild(script);
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading(text = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function formatPrice(amount, currency) {
            const formatted = (amount / 100).toFixed(2);
            const symbols = { usd: '$', eur: 'â‚¬', gbp: 'Â£' };
            const symbol = symbols[currency.toLowerCase()] || currency.toUpperCase() + ' ';
            return symbol + formatted;
        }

        function formatInterval(interval, count = 1) {
            if (!interval) return 'one-time';
            if (count === 1) return `/ ${interval}`;
            return `/ ${count} ${interval}s`;
        }

        async function handleSignOut() {
            showLoading('Signing out...');
            sessionStorage.removeItem('clerk_session_token');
            sessionStorage.removeItem('clerk_user_email');
            sessionStorage.removeItem('clerk_user_avatar');

            try {
                if (clerkInstance) {
                    await clerkInstance.signOut();
                }
            } catch (err) {
                console.error('Sign out error:', err);
            }

            await new Promise(resolve => setTimeout(resolve, 100));
            window.location.replace('/login?signed_out=1');
        }

        function showAuthenticatedUI(user) {
            const userEmailEl = document.getElementById('user-email');
            const userAvatarEl = document.getElementById('user-avatar');
            const userInitialsEl = document.getElementById('user-initials');

            const email = user.primaryEmailAddress?.emailAddress || 
                          user.emailAddresses?.[0]?.emailAddress || 
                          sessionStorage.getItem('clerk_user_email') || 
                          'Unknown';
            userEmailEl.textContent = email;

            const avatarUrl = user.imageUrl || user.profileImageUrl || sessionStorage.getItem('clerk_user_avatar');
            if (avatarUrl) {
                userAvatarEl.innerHTML = `<img src="${avatarUrl}" alt="Avatar" />`;
            } else {
                const initials = email.charAt(0).toUpperCase();
                userInitialsEl.textContent = initials;
            }

            document.getElementById('app-layout').style.display = 'flex';
            hideLoading();
        }

        function navigateTo(page) {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.toggle('active', section.id === `page-${page}`);
            });
            
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');

            if (page === 'products') {
                loadStripeStatus();
                loadProducts();
            }
            if (page === 'journeys') {
                loadJourneys();
            }
        }

        function handleHashChange() {
            const hash = window.location.hash.slice(1) || 'dashboard';
            navigateTo(hash);
        }

        async function loadStripeStatus() {
            try {
                const headers = await getAuthHeaders();
                const resp = await fetch('/api/stripe/status', { headers, credentials: 'include' });
                if (resp.ok) {
                    stripeStatus = await resp.json();
                    updateStripeStatusUI();
                }
            } catch (err) {
                console.error('Failed to load Stripe status:', err);
            }
        }

        function updateStripeStatusUI() {
            const badge = document.getElementById('stripe-status-badge');
            const statusText = document.getElementById('stripe-status-text');
            const syncBtn = document.getElementById('sync-products-btn');

            if (stripeStatus.connected) {
                badge.className = 'status-badge connected';
                statusText.textContent = 'Connected';
                syncBtn.disabled = false;
            } else {
                badge.className = 'status-badge disconnected';
                statusText.textContent = 'Not Connected';
                syncBtn.disabled = true;
            }
        }

        async function loadProducts() {
            try {
                const headers = await getAuthHeaders();
                const resp = await fetch('/api/stripe/products', { headers, credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    productsData = data.products || [];
                    stripeStatus.vip_price_id = data.vip_price_id;
                    renderProducts();
                }
            } catch (err) {
                console.error('Failed to load products:', err);
            }
        }

        function renderProducts() {
            const container = document.getElementById('products-grid');
            const emptyState = document.getElementById('products-empty-state');
            const vipWarning = document.getElementById('vip-warning-banner');
            const vipCard = document.getElementById('vip-plan-card');
            const filterRecurring = document.getElementById('filter-recurring').checked;

            let allPrices = [];
            productsData.forEach(product => {
                (product.prices || []).forEach(price => {
                    allPrices.push({
                        ...price,
                        product_name: product.name,
                        product_active: product.active
                    });
                });
            });

            if (filterRecurring) {
                allPrices = allPrices.filter(p => p.price_type === 'recurring');
            }

            if (!stripeStatus.connected) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                vipWarning.style.display = 'none';
                vipCard.style.display = 'none';
                document.getElementById('empty-state-title').textContent = 'Stripe not connected';
                document.getElementById('empty-state-text').textContent = 'Connect Stripe in the onboarding wizard to manage products.';
                return;
            }

            if (allPrices.length === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                vipWarning.style.display = 'none';
                vipCard.style.display = 'none';
                document.getElementById('empty-state-title').textContent = 'No products synced yet';
                document.getElementById('empty-state-text').textContent = "Click 'Sync from Stripe' to import your products.";
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'grid';

            const vipPrice = allPrices.find(p => p.price_id === stripeStatus.vip_price_id);
            if (vipPrice) {
                vipWarning.style.display = 'none';
                vipCard.style.display = 'block';
                document.getElementById('vip-plan-name').textContent = vipPrice.product_name;
                document.getElementById('vip-plan-price').textContent = formatPrice(vipPrice.unit_amount, vipPrice.currency);
                document.getElementById('vip-plan-interval').textContent = formatInterval(vipPrice.recurring_interval, vipPrice.recurring_interval_count);
            } else {
                vipWarning.style.display = 'flex';
                vipCard.style.display = 'none';
            }

            container.innerHTML = allPrices.map(price => {
                const isVip = price.price_id === stripeStatus.vip_price_id;
                const isActive = price.active && price.product_active;
                return `
                    <div class="product-card">
                        <div class="product-card-header">
                            <div>
                                <div class="product-name">${escapeHtml(price.product_name)}</div>
                                ${price.nickname ? `<div class="product-nickname">${escapeHtml(price.nickname)}</div>` : ''}
                            </div>
                            <span class="product-status ${isActive ? 'active' : 'archived'}">${isActive ? 'Active' : 'Archived'}</span>
                        </div>
                        <div class="product-details">
                            <span class="product-price">${formatPrice(price.unit_amount, price.currency)}</span>
                            <span class="product-interval">${formatInterval(price.recurring_interval, price.recurring_interval_count)}</span>
                            <span class="product-type">${price.price_type === 'recurring' ? 'Subscription' : 'One-time'}</span>
                        </div>
                        <div class="product-actions">
                            ${isVip 
                                ? `<button class="btn btn-success btn-sm" disabled>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="20,6 9,17 4,12"/>
                                    </svg>
                                    Selected
                                  </button>` 
                                : `<button class="btn btn-secondary btn-sm" onclick="setVipPlan('${price.price_id}')">Set as VIP Plan</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function syncProducts() {
            const btn = document.getElementById('sync-products-btn');
            const btnText = document.getElementById('sync-btn-text');
            
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner"></span> Syncing...';

            try {
                const headers = await getAuthHeaders(true);
                const resp = await fetch('/api/stripe/sync-products', {
                    method: 'POST',
                    headers,
                    credentials: 'include'
                });
                
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    showToast(`Synced ${data.products_synced} products and ${data.prices_synced} prices`, 'success');
                    await loadProducts();
                } else {
                    showToast(data.error || 'Failed to sync products', 'error');
                }
            } catch (err) {
                console.error('Sync error:', err);
                showToast('Failed to sync products', 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Sync from Stripe';
            }
        }

        async function setVipPlan(priceId) {
            try {
                showLoading('Setting VIP plan...');
                const headers = await getAuthHeaders(true);
                const resp = await fetch('/api/stripe/set-vip-price', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ price_id: priceId }),
                    credentials: 'include'
                });
                
                const data = await resp.json();
                hideLoading();
                
                if (resp.ok && data.success) {
                    showToast('VIP plan updated successfully', 'success');
                    stripeStatus.vip_price_id = priceId;
                    renderProducts();
                } else {
                    showToast(data.error || 'Failed to set VIP plan', 'error');
                }
            } catch (err) {
                hideLoading();
                console.error('Set VIP error:', err);
                showToast('Failed to set VIP plan', 'error');
            }
        }

        async function loadJourneys() {
            try {
                journeysState.loading = true;
                const headers = await getAuthHeaders();
                const resp = await fetch('/api/journeys', { headers, credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    journeysState.journeys = data.journeys || [];
                    renderJourneys();
                } else {
                    showToast('Failed to load journeys', 'error');
                }
            } catch (err) {
                console.error('Failed to load journeys:', err);
                showToast('Failed to load journeys', 'error');
            } finally {
                journeysState.loading = false;
            }
        }

        function renderJourneys() {
            const container = document.getElementById('journeys-grid');
            const emptyState = document.getElementById('journeys-empty-state');
            const createBtn = document.getElementById('create-journey-btn');
            const limitBadge = document.getElementById('journeys-limit-badge');
            
            const count = journeysState.journeys.length;
            limitBadge.textContent = `${count} / ${MAX_JOURNEYS}`;
            
            if (count >= MAX_JOURNEYS) {
                createBtn.disabled = true;
                createBtn.title = 'Maximum journeys reached';
            } else {
                createBtn.disabled = false;
                createBtn.title = '';
            }

            if (count === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'grid';

            container.innerHTML = journeysState.journeys.map(journey => {
                const triggers = journey.triggers || [];
                const firstTrigger = triggers[0];
                const triggerType = firstTrigger?.trigger_type || 'deep_link';
                const triggerValue = firstTrigger?.trigger_config?.start_param || firstTrigger?.trigger_config?.value || '-';
                
                return `
                    <div class="journey-card">
                        <div class="journey-card-header">
                            <div class="journey-name">${escapeHtml(journey.name)}</div>
                            <span class="journey-status ${journey.status}">${journey.status}</span>
                        </div>
                        <div class="journey-meta">
                            <div class="journey-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                <span>${triggerType === 'telegram_deeplink' || triggerType === 'deep_link' ? 'Deep Link' : triggerType}: <strong>${escapeHtml(triggerValue)}</strong></span>
                            </div>
                            <div class="journey-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                <span>${journey.step_count || 0} step${journey.step_count !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="journey-actions">
                            <button class="btn-icon" onclick="openJourneyModal('${journey.id}')" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="btn-icon danger" onclick="deleteJourney('${journey.id}')" title="Delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openJourneyModal(journeyId = null) {
            journeysState.currentJourneyId = journeyId;
            journeysState.steps = [];
            journeysState.selectedStatus = 'draft';
            
            document.getElementById('journey-name-input').value = '';
            document.getElementById('journey-trigger-value').value = '';
            document.getElementById('journey-trigger-type').value = 'deep_link';
            document.getElementById('journey-modal-title').textContent = journeyId ? 'Edit Journey' : 'Create Journey';
            
            selectStatus('draft');
            renderStepsList();
            
            if (journeyId) {
                await fetchJourneyDetail(journeyId);
            }
            
            document.getElementById('journey-modal-backdrop').classList.add('show');
        }

        function closeJourneyModal() {
            document.getElementById('journey-modal-backdrop').classList.remove('show');
            journeysState.currentJourneyId = null;
            journeysState.steps = [];
        }

        async function fetchJourneyDetail(journeyId) {
            try {
                const headers = await getAuthHeaders();
                const resp = await fetch(`/api/journeys/${journeyId}`, { headers, credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    const journey = data.journey;
                    
                    document.getElementById('journey-name-input').value = journey.name || '';
                    selectStatus(journey.status || 'draft');
                    
                    const triggers = journey.triggers || [];
                    if (triggers.length > 0) {
                        const trigger = triggers[0];
                        document.getElementById('journey-trigger-type').value = 'deep_link';
                        document.getElementById('journey-trigger-value').value = trigger.trigger_config?.start_param || trigger.trigger_config?.value || '';
                    }
                    
                    journeysState.steps = (journey.steps || []).map(s => ({
                        message_template: s.message_template,
                        delay_seconds: s.delay_seconds
                    }));
                    renderStepsList();
                }
            } catch (err) {
                console.error('Failed to fetch journey detail:', err);
                showToast('Failed to load journey details', 'error');
            }
        }

        function selectStatus(status) {
            journeysState.selectedStatus = status;
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.status === status);
            });
            document.getElementById('active-warning').classList.toggle('show', status === 'active');
        }

        async function saveJourney() {
            const name = document.getElementById('journey-name-input').value.trim();
            const triggerValue = document.getElementById('journey-trigger-value').value.trim();
            const status = journeysState.selectedStatus;
            
            if (!name) {
                showToast('Please enter a journey name', 'error');
                return;
            }
            
            try {
                showLoading('Saving journey...');
                const headers = await getAuthHeaders(true);
                
                let journeyId = journeysState.currentJourneyId;
                
                if (journeyId) {
                    const resp = await fetch(`/api/journeys/${journeyId}`, {
                        method: 'PUT',
                        headers,
                        body: JSON.stringify({ name, status }),
                        credentials: 'include'
                    });
                    if (!resp.ok) {
                        const data = await resp.json();
                        throw new Error(data.error || 'Failed to update journey');
                    }
                } else {
                    const resp = await fetch('/api/journeys', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ name, status }),
                        credentials: 'include'
                    });
                    const data = await resp.json();
                    if (!resp.ok) {
                        throw new Error(data.error || 'Failed to create journey');
                    }
                    journeyId = data.journey.id;
                }
                
                if (triggerValue) {
                    await fetch(`/api/journeys/${journeyId}/triggers`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            trigger_type: 'telegram_deeplink',
                            trigger_config: { start_param: triggerValue },
                            is_active: true
                        }),
                        credentials: 'include'
                    });
                }
                
                if (journeysState.steps.length > 0) {
                    await fetch(`/api/journeys/${journeyId}/steps`, {
                        method: 'PUT',
                        headers,
                        body: JSON.stringify({ steps: journeysState.steps }),
                        credentials: 'include'
                    });
                }
                
                hideLoading();
                showToast(journeysState.currentJourneyId ? 'Journey updated successfully' : 'Journey created successfully', 'success');
                closeJourneyModal();
                await loadJourneys();
                
            } catch (err) {
                hideLoading();
                console.error('Save journey error:', err);
                showToast(err.message || 'Failed to save journey', 'error');
            }
        }

        async function deleteJourney(journeyId) {
            if (!confirm('Are you sure you want to delete this journey? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading('Deleting journey...');
                const headers = await getAuthHeaders();
                const resp = await fetch(`/api/journeys/${journeyId}`, {
                    method: 'DELETE',
                    headers,
                    credentials: 'include'
                });
                
                hideLoading();
                
                if (resp.ok) {
                    showToast('Journey deleted successfully', 'success');
                    await loadJourneys();
                } else {
                    const data = await resp.json();
                    showToast(data.error || 'Failed to delete journey', 'error');
                }
            } catch (err) {
                hideLoading();
                console.error('Delete journey error:', err);
                showToast('Failed to delete journey', 'error');
            }
        }

        function renderStepsList() {
            const container = document.getElementById('steps-list');
            const emptyState = document.getElementById('steps-empty');
            
            if (journeysState.steps.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = journeysState.steps.map((step, index) => `
                <div class="step-item">
                    <div class="step-order">${index + 1}</div>
                    <div class="step-content">
                        <div class="step-message">${escapeHtml(step.message_template.substring(0, 80))}${step.message_template.length > 80 ? '...' : ''}</div>
                        <div class="step-delay">Delay: ${step.delay_seconds}s</div>
                    </div>
                    <div class="step-actions">
                        <button class="step-btn" onclick="moveStep(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Move up">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18,15 12,9 6,15"/>
                            </svg>
                        </button>
                        <button class="step-btn" onclick="moveStep(${index}, 1)" ${index === journeysState.steps.length - 1 ? 'disabled' : ''} title="Move down">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6,9 12,15 18,9"/>
                            </svg>
                        </button>
                        <button class="step-btn" onclick="editStep(${index})" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="step-btn danger" onclick="deleteStep(${index})" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function addStep() {
            journeysState.editingStepIndex = null;
            document.getElementById('step-message-input').value = '';
            document.getElementById('step-delay-input').value = '0';
            document.getElementById('step-modal-title').textContent = 'Add Step';
            document.getElementById('step-modal-backdrop').classList.add('show');
        }

        function editStep(index) {
            journeysState.editingStepIndex = index;
            const step = journeysState.steps[index];
            document.getElementById('step-message-input').value = step.message_template;
            document.getElementById('step-delay-input').value = step.delay_seconds;
            document.getElementById('step-modal-title').textContent = 'Edit Step';
            document.getElementById('step-modal-backdrop').classList.add('show');
        }

        function closeStepModal() {
            document.getElementById('step-modal-backdrop').classList.remove('show');
            journeysState.editingStepIndex = null;
        }

        function saveStep() {
            const message = document.getElementById('step-message-input').value.trim();
            const delay = parseInt(document.getElementById('step-delay-input').value, 10) || 0;
            
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }
            
            const stepData = {
                message_template: message,
                delay_seconds: delay
            };
            
            if (journeysState.editingStepIndex !== null) {
                journeysState.steps[journeysState.editingStepIndex] = stepData;
            } else {
                journeysState.steps.push(stepData);
            }
            
            closeStepModal();
            renderStepsList();
        }

        function deleteStep(index) {
            if (!confirm('Delete this step?')) return;
            journeysState.steps.splice(index, 1);
            renderStepsList();
        }

        function moveStep(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= journeysState.steps.length) return;
            
            const temp = journeysState.steps[index];
            journeysState.steps[index] = journeysState.steps[newIndex];
            journeysState.steps[newIndex] = temp;
            renderStepsList();
        }

        async function checkAuthAndInit() {
            showLoading('Loading...');
            
            try {
                const headers = {};
                const storedToken = sessionStorage.getItem('clerk_session_token');
                if (storedToken) {
                    headers['Authorization'] = `Bearer ${storedToken}`;
                }
                const userEmail = sessionStorage.getItem('clerk_user_email');
                if (userEmail) {
                    headers['X-Clerk-User-Email'] = userEmail;
                }

                const authResp = await fetch('/api/check-auth', {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });

                if (!authResp.ok) {
                    window.location.href = '/login';
                    return;
                }

                const clerkKey = await getClerkKey();
                if (!clerkKey) {
                    hideLoading();
                    showToast('Authentication not configured', 'error');
                    return;
                }

                clerkInstance = await loadClerkScript(clerkKey);
                await clerkInstance.load();

                if (clerkInstance.user) {
                    const token = await clerkInstance.session.getToken();
                    if (token) {
                        sessionStorage.setItem('clerk_session_token', token);
                        const email = clerkInstance.user.primaryEmailAddress?.emailAddress || 
                                      clerkInstance.user.emailAddresses?.[0]?.emailAddress;
                        if (email) {
                            sessionStorage.setItem('clerk_user_email', email);
                        }
                        const avatarUrl = clerkInstance.user.imageUrl || clerkInstance.user.profileImageUrl;
                        if (avatarUrl) {
                            sessionStorage.setItem('clerk_user_avatar', avatarUrl);
                        }
                    }
                    showAuthenticatedUI(clerkInstance.user);
                    handleHashChange();
                } else {
                    window.location.href = '/login';
                }

            } catch (err) {
                console.error('Auth check error:', err);
                window.location.href = '/login';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkImpersonation();
            checkAuthAndInit();

            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('sync-products-btn').addEventListener('click', syncProducts);
            document.getElementById('filter-recurring').addEventListener('change', renderProducts);

            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = item.dataset.page;
                });
            });

            window.addEventListener('hashchange', handleHashChange);

            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
            });

            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            });
        });
    </script>
</body>
</html>
