<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login | Promo Stack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0b0c10;
            min-height: 100vh;
            padding: 20px;
            color: #e9eef5;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 20px;
        }
        
        .brand img {
            height: auto;
            width: 220px;
            display: block;
        }
        
        .card {
            background: #121318;
            border: 1px solid #262b35;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 28px rgba(0,0,0,.35);
        }
        
        h1 {
            color: #e9eef5;
            margin-bottom: 24px;
            font-size: 24px;
        }

        h1.login-title {
            color: #ffffff;
            font-size: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .row .form-group {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #8a8f98;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .3px;
            white-space: nowrap;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            background: #191b22;
            color: #e9eef5;
            border: 1px solid #262b35;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #3a4250;
            box-shadow: 0 0 0 3px rgba(29,152,255,.18);
        }

        #name {
            border-color: #1d98ff;
            box-shadow: 0 0 12px rgba(29, 152, 255, 0.4);
        }

        #name:focus {
            border-color: #1d98ff;
            box-shadow: 0 0 16px rgba(29, 152, 255, 0.6);
        }
        
        input[type="file"] {
            width: 100%;
            padding: 8px;
            background: #191b22;
            color: #e9eef5;
            border: 2px solid #FF273E;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(255, 39, 62, 0.5);
        }

        input[type="file"]:focus {
            box-shadow: 0 0 18px rgba(255, 39, 62, 0.7);
        }
        
        .hint {
            font-size: 12px;
            color: #8a8f98;
            margin-top: 4px;
        }
        
        .btn {
            background: #1d98ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }

        #loginForm .btn {
            width: 100%;
        }

        .btn-outline {
            background: transparent;
            color: #1d98ff;
            border: 2px solid #1d98ff;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-sizing: border-box;
        }

        #loginForm .btn-outline {
            width: 100%;
        }

        .btn-outline:hover {
            background: rgba(29, 152, 255, 0.1);
        }
        
        .btn:hover {
            background: #1680e0;
        }
        
        .btn:disabled {
            background: #3a4250;
            cursor: not-allowed;
        }
        
        .btn-logout {
            background: #ff4a4a;
            float: right;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-logout:hover {
            background: #e03939;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(29, 152, 255, 0.15);
            color: #5eb8ff;
            border: 1px solid rgba(29, 152, 255, 0.3);
        }
        
        .alert-error {
            background: rgba(255, 74, 74, 0.15);
            color: #ff9c9c;
            border: 1px solid rgba(255, 74, 74, 0.3);
        }
        
        .section {
            border: 1px solid #262b35;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            background: #0f1014;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d98ff;
            margin-bottom: 16px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .section-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
        }

        .preview-label {
            font-size: 12px;
            color: #8a8f98;
            text-transform: uppercase;
            letter-spacing: .3px;
            margin-bottom: 8px;
        }
        
        .row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        #loginForm {
            max-width: 400px;
            margin: 0 auto;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 100px;
        }

        .login-logo {
            margin-bottom: 30px;
        }
        
        .hidden {
            display: none;
        }

        .preview-section {
            border: 1px solid #262b35;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            background: #0f1014;
        }

        .preview-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr 1fr;
            margin-top: 12px;
        }

        @media (max-width: 760px) {
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }

        .preview-item {
            text-align: center;
        }

        .preview-frame {
            position: relative;
            background: #0a0b10;
            border: 1px solid #262b35;
            border-radius: 14px;
            overflow: hidden;
            margin-top: 6px;
        }

        .preview-frame.square {
            aspect-ratio: 1/1;
        }

        .preview-frame.story {
            aspect-ratio: 9/16;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1d98ff;
        }

        .tab.active {
            color: #1d98ff;
            border-bottom-color: #1d98ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
        }

        .bulk-actions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #191b22;
            border: 1px solid #262b35;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e9eef5;
            font-weight: 500;
            cursor: pointer;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #1d98ff;
        }

        .delete-selected-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .template-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 16px;
            accent-color: #1d98ff;
            flex-shrink: 0;
        }

        .asset-item {
            background: #191b22;
            border: 1px solid #262b35;
            border-radius: 8px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .asset-item:hover {
            background: #1f2128;
            border-color: #1d98ff;
            transform: translateX(4px);
        }

        .asset-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .asset-name {
            font-weight: 600;
            color: #e9eef5;
            font-size: 16px;
        }

        .asset-slug {
            font-size: 13px;
            color: #8a8f98;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .asset-edit-icon,
        .asset-delete-icon {
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }

        .asset-edit-icon {
            color: #1d98ff;
        }

        .asset-edit-icon:hover {
            transform: scale(1.2);
        }

        .asset-delete-icon {
            color: #ef4444;
        }

        .asset-delete-icon:hover {
            transform: scale(1.2);
        }

        .slider {
            width: 100%;
            max-width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #262b35;
            outline: none;
            margin-bottom: 8px;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1d98ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #5eb8ff;
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1d98ff;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            background: #5eb8ff;
            transform: scale(1.2);
        }

        .row .form-group {
            display: flex;
            flex-direction: column;
        }

        .preview-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(29, 152, 255, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 10;
        }

        .color-picker-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .color-picker-group label {
            text-align: center;
        }

        .color-swatches {
            display: flex;
            gap: 12px;
        }

        .color-swatch {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,.3);
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,.4);
        }

        .color-swatch.selected {
            border-color: #1d98ff;
            box-shadow: 0 0 0 2px rgba(29, 152, 255, 0.3), 0 4px 12px rgba(0,0,0,.4);
        }

        .color-swatch.red {
            background: #FF273E;
        }

        .color-swatch.white {
            background: #FFFFFF;
        }

        .color-swatch-label {
            font-size: 11px;
            color: #8a8f98;
            text-align: center;
            margin-top: 4px;
        }

        .nudge-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
            align-items: center;
        }

        .nudge-controls-label {
            font-size: 12px;
            color: #8a8f98;
            text-transform: uppercase;
            letter-spacing: .3px;
            text-align: center;
        }

        .nudge-buttons {
            display: grid;
            grid-template-columns: repeat(3, 32px);
            grid-template-rows: repeat(3, 32px);
            gap: 4px;
            justify-content: center;
        }

        .nudge-btn {
            background: #191b22;
            color: #1d98ff;
            border: 1px solid #262b35;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .nudge-btn:hover {
            background: #1d98ff;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(29, 152, 255, 0.3);
        }

        .nudge-btn:active {
            transform: scale(0.95);
        }

        .nudge-up {
            grid-column: 2;
            grid-row: 1;
        }

        .nudge-left {
            grid-column: 1;
            grid-row: 2;
        }

        .nudge-right {
            grid-column: 3;
            grid-row: 2;
        }

        .nudge-down {
            grid-column: 2;
            grid-row: 3;
        }

        /* Custom Delete Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-box {
            background: #191b22;
            border: 1px solid #262b35;
            border-radius: 12px;
            padding: 28px 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #e9eef5;
            text-align: center;
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 15px;
            color: #a0a5ad;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 24px;
            white-space: pre-line;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #262b35;
            color: #e9eef5;
        }

        .modal-btn-cancel:hover {
            background: #313640;
            transform: translateY(-2px);
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body>
    <!-- Custom Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">🗑️</div>
            <div class="modal-title" id="modalTitle">Delete Template?</div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="login-container" id="loginWrapper">
            <div class="login-logo">
                <img src="/assets/promostack-logo.png" alt="PromoStack" style="width: 280px;" />
            </div>
            <div class="card" id="loginForm">
                <h1 class="login-title">🔐 Admin Login</h1>
                <div id="loginAlert"></div>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <a href="https://dash.promostack.io" class="btn-outline" style="margin-top: 12px;">Visit Frontend</a>
            </div>
        </div>

        <div class="brand" id="adminBrand" style="display:none;"><img src="/assets/promostack-logo.png" alt="PromoStack" /></div>

        <div class="card hidden" id="adminPanel">
            <button class="btn btn-logout" onclick="handleLogout()">Logout</button>
            <h1>📦 Template Manager</h1>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">Upload Template</button>
                <button class="tab" onclick="switchTab('assets')">Current Assets</button>
            </div>

            <div id="uploadTab" class="tab-content active">
                <div id="uploadAlert"></div>
            
            <form id="templateForm" onsubmit="handleUpload(event)">
                <div class="form-group">
                    <label for="name">Template Name *</label>
                    <input type="text" id="name" required placeholder="e.g., Flash Sale">
                    <div class="hint">This will appear in the dropdown</div>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="slug">Slug *</label>
                    <input type="text" id="slug" required pattern="[a-z0-9-]+" placeholder="e.g., flash-sale">
                    <div class="hint">Lowercase letters, numbers, and hyphens only</div>
                </div>

                <div class="section">
                    <div class="section-title">Square Image (1:1)</div>
                    
                    <div class="section-grid">
                        <div class="controls-column">
                            <div class="form-group">
                                <label for="squareImage">Square PNG files only</label>
                                <input type="file" id="squareImage" accept="image/png">
                                <div class="hint">Leave empty to keep existing image</div>
                            </div>

                            <div class="row">
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="squareLeftPct" value="5" min="0" max="100" step="0.1" required>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="squareTopPct" value="78" min="0" max="100" step="0.1" required>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="squareWidthPct" value="25" min="0" max="100" step="0.1" required>
                                </div>
                            </div>

                            <div class="form-group" style="display: none;">
                                <input type="number" id="squareHeightPct" value="12" min="0" max="100" step="0.1" required>
                            </div>

                            <div class="form-group" style="text-align: center;">
                                <label for="squareMaxFontPx" style="text-align: center;">Font Size</label>
                                <input type="range" id="squareMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                <input type="number" id="squareMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                            </div>

                            <div class="form-group" style="text-align: center;">
                                <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#e9eef5;margin:0;padding:10px 0;">
                                    <input id="squareShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                    <span>Show Logo</span>
                                </label>
                            </div>

                            <div class="nudge-controls">
                                <label class="nudge-controls-label">Fine-Tune Position</label>
                                <div class="nudge-buttons">
                                    <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('square', 'up')" title="Nudge Up">↑</button>
                                    <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('square', 'left')" title="Nudge Left">←</button>
                                    <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('square', 'right')" title="Nudge Right">→</button>
                                    <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('square', 'down')" title="Nudge Down">↓</button>
                                </div>
                            </div>

                            <div class="color-picker-group" style="margin-top: 16px;">
                                <label>Text Color</label>
                                <div class="color-swatches">
                                    <div>
                                        <div class="color-swatch red selected" data-color="#FF273E" data-variant="square" onclick="selectColor('#FF273E', 'square')"></div>
                                        <div class="color-swatch-label">Red</div>
                                    </div>
                                    <div>
                                        <div class="color-swatch white" data-color="#FFFFFF" data-variant="square" onclick="selectColor('#FFFFFF', 'square')"></div>
                                        <div class="color-swatch-label">White</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="preview-column">
                            <div class="preview-label">Preview</div>
                            <div class="preview-frame square">
                                <div class="preview-hint">Click and draw coupon area in your template</div>
                                <canvas id="previewSquare"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Story Image (9:16)</div>
                    
                    <div class="section-grid">
                        <div class="controls-column">
                            <div class="form-group">
                                <label for="storyImage">Story PNG files only</label>
                                <input type="file" id="storyImage" accept="image/png">
                                <div class="hint">Leave empty to keep existing image</div>
                            </div>

                            <div class="row">
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="storyLeftPct" value="5" min="0" max="100" step="0.1" required>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="storyTopPct" value="78" min="0" max="100" step="0.1" required>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <input type="number" id="storyWidthPct" value="25" min="0" max="100" step="0.1" required>
                                </div>
                            </div>

                            <div class="form-group" style="display: none;">
                                <input type="number" id="storyHeightPct" value="12" min="0" max="100" step="0.1" required>
                            </div>

                            <div class="form-group" style="text-align: center;">
                                <label for="storyMaxFontPx" style="text-align: center;">Font Size</label>
                                <input type="range" id="storyMaxFontPxSlider" min="8" max="200" step="1" value="80" class="slider">
                                <input type="number" id="storyMaxFontPx" value="80" min="8" max="200" step="1" required style="max-width: 100px; margin: 8px auto 0; display: block;">
                            </div>

                            <div class="form-group" style="text-align: center;">
                                <label style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;color:#e9eef5;margin:0;padding:10px 0;">
                                    <input id="storyShowLogo" type="checkbox" style="width:auto;margin:0;" checked />
                                    <span>Show Logo</span>
                                </label>
                            </div>

                            <div class="nudge-controls">
                                <label class="nudge-controls-label">Fine-Tune Position</label>
                                <div class="nudge-buttons">
                                    <button type="button" class="nudge-btn nudge-up" onclick="nudgePosition('story', 'up')" title="Nudge Up">↑</button>
                                    <button type="button" class="nudge-btn nudge-left" onclick="nudgePosition('story', 'left')" title="Nudge Left">←</button>
                                    <button type="button" class="nudge-btn nudge-right" onclick="nudgePosition('story', 'right')" title="Nudge Right">→</button>
                                    <button type="button" class="nudge-btn nudge-down" onclick="nudgePosition('story', 'down')" title="Nudge Down">↓</button>
                                </div>
                            </div>

                            <div class="color-picker-group" style="margin-top: 16px;">
                                <label>Text Color</label>
                                <div class="color-swatches">
                                    <div>
                                        <div class="color-swatch red selected" data-color="#FF273E" data-variant="story" onclick="selectColor('#FF273E', 'story')"></div>
                                        <div class="color-swatch-label">Red</div>
                                    </div>
                                    <div>
                                        <div class="color-swatch white" data-color="#FFFFFF" data-variant="story" onclick="selectColor('#FFFFFF', 'story')"></div>
                                        <div class="color-swatch-label">White</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="preview-column">
                            <div class="preview-label">Preview</div>
                            <div class="preview-frame story">
                                <div class="preview-hint">Click and draw coupon area in your template</div>
                                <canvas id="previewStory"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="squareFontColor" value="#FF273E">
                <input type="hidden" id="storyFontColor" value="#FF273E">

                <button type="submit" class="btn" id="submitBtn">Upload Template</button>
            </form>
            </div>

            <div id="assetsTab" class="tab-content">
                <div class="bulk-actions-header">
                    <label class="select-all-container">
                        <input type="checkbox" id="selectAllTemplates" onchange="toggleSelectAll()">
                        <span>Select All</span>
                    </label>
                    <button type="button" class="delete-selected-btn" onclick="deleteSelectedTemplates()">Delete Selected</button>
                </div>
                <div id="assetsList" class="assets-list">
                    <p style="color: #8a8f98; text-align: center;">Loading templates...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function selectColor(color, variant) {
            document.querySelectorAll(`.color-swatch[data-variant="${variant}"]`).forEach(swatch => {
                swatch.classList.remove('selected');
                if (swatch.dataset.color === color) {
                    swatch.classList.add('selected');
                }
            });
            document.getElementById(variant + 'FontColor').value = color;
            updatePreviews();
        }

        function showAlert(elementId, message, isError = false) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert ${isError ? 'alert-error' : 'alert-success'}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginWrapper').style.display = 'none';
                    document.getElementById('adminBrand').style.display = 'block';
                    document.getElementById('adminPanel').classList.remove('hidden');
                } else {
                    showAlert('loginAlert', data.error || 'Invalid password', true);
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed: ' + error.message, true);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('adminBrand').style.display = 'none';
                document.getElementById('loginWrapper').style.display = 'flex';
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        async function handleUpload(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('slug', document.getElementById('slug').value);
            
            // Only append images if they were selected (optional for updates)
            const squareFile = document.getElementById('squareImage').files[0];
            const storyFile = document.getElementById('storyImage').files[0];
            if (squareFile) {
                formData.append('squareImage', squareFile);
            }
            if (storyFile) {
                formData.append('storyImage', storyFile);
            }
            
            formData.append('squareLeftPct', document.getElementById('squareLeftPct').value);
            formData.append('squareTopPct', document.getElementById('squareTopPct').value);
            formData.append('squareWidthPct', document.getElementById('squareWidthPct').value);
            formData.append('squareHeightPct', document.getElementById('squareHeightPct').value);
            formData.append('squareHAlign', 'center');
            formData.append('squareVAlign', 'middle');
            formData.append('squareMaxFontPx', document.getElementById('squareMaxFontPx').value);
            
            formData.append('storyLeftPct', document.getElementById('storyLeftPct').value);
            formData.append('storyTopPct', document.getElementById('storyTopPct').value);
            formData.append('storyWidthPct', document.getElementById('storyWidthPct').value);
            formData.append('storyHeightPct', document.getElementById('storyHeightPct').value);
            formData.append('storyHAlign', 'center');
            formData.append('storyVAlign', 'middle');
            formData.append('storyMaxFontPx', document.getElementById('storyMaxFontPx').value);
            
            formData.append('squareFontColor', document.getElementById('squareFontColor').value);
            formData.append('storyFontColor', document.getElementById('storyFontColor').value);

            try {
                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('uploadAlert', data.message + ' ✓');
                    document.getElementById('templateForm').reset();
                } else {
                    showAlert('uploadAlert', data.error || 'Upload failed', true);
                }
            } catch (error) {
                showAlert('uploadAlert', 'Upload failed: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Template';
            }
        }

        document.getElementById('name').addEventListener('input', function(e) {
            const slug = e.target.value.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
            document.getElementById('slug').value = slug;
        });

        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Activate the correct tab button
            const tabButtons = Array.from(tabs);
            if (tabName === 'upload') {
                tabButtons[0]?.classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            } else if (tabName === 'assets') {
                tabButtons[1]?.classList.add('active');
                document.getElementById('assetsTab').classList.add('active');
                loadAssets();
            }
        }

        // Load and display current assets
        async function loadAssets() {
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = '<p style="color: #8a8f98; text-align: center;">Loading templates...</p>';
            
            try {
                // Try Spaces CDN first, fallback to local
                let response;
                try {
                    response = await fetch('https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/index.json?ts=' + Date.now());
                } catch (_) {
                    response = await fetch('/assets/templates/index.json?ts=' + Date.now());
                }
                const data = await response.json();
                
                if (!data.templates || data.templates.length === 0) {
                    assetsList.innerHTML = '<p style="color: #8a8f98; text-align: center;">No templates found</p>';
                    return;
                }
                
                assetsList.innerHTML = '';
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.innerHTML = `
                        <input type="checkbox" class="template-checkbox" data-slug="${template.slug}" data-name="${template.name}" onchange="updateSelectAllState()">
                        <div class="asset-item-info">
                            <div class="asset-name">${template.name}</div>
                            <div class="asset-slug">${template.slug}</div>
                        </div>
                        <div class="asset-actions">
                            <div class="asset-edit-icon" onclick="loadTemplateForEdit('${template.slug}')">✎</div>
                            <div class="asset-delete-icon" onclick="deleteTemplate('${template.slug}', '${template.name}')">🗑</div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                });
                
                // Reset select all checkbox
                document.getElementById('selectAllTemplates').checked = false;
            } catch (error) {
                assetsList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading templates</p>';
                console.error('Failed to load assets:', error);
            }
        }

        // Load template data for editing
        async function loadTemplateForEdit(slug) {
            try {
                // Try Spaces CDN first, fallback to local
                let response;
                try {
                    response = await fetch(`https://couponpro-templates.lon1.cdn.digitaloceanspaces.com/templates/${slug}/meta.json?ts=${Date.now()}`);
                } catch (_) {
                    response = await fetch(`/assets/templates/${slug}/meta.json?ts=${Date.now()}`);
                }
                const meta = await response.json();
                
                // Switch to upload tab
                switchTab('upload');
                
                // Populate form fields
                document.getElementById('name').value = meta.name || slug;
                document.getElementById('slug').value = slug;
                
                // Square settings - read from nested box structure
                document.getElementById('squareLeftPct').value = meta.square.box?.leftPct || meta.square.leftPct || 5;
                document.getElementById('squareTopPct').value = meta.square.box?.topPct || meta.square.topPct || 78;
                document.getElementById('squareWidthPct').value = meta.square.box?.widthPct || meta.square.widthPct || 90;
                document.getElementById('squareHeightPct').value = meta.square.box?.heightPct || meta.square.heightPct || 12;
                document.getElementById('squareMaxFontPx').value = meta.square.maxFontPx || 80;
                document.getElementById('squareShowLogo').checked = meta.square.showLogo !== false;
                
                // Story settings - read from nested box structure
                document.getElementById('storyLeftPct').value = meta.story.box?.leftPct || meta.story.leftPct || 5;
                document.getElementById('storyTopPct').value = meta.story.box?.topPct || meta.story.topPct || 78;
                document.getElementById('storyWidthPct').value = meta.story.box?.widthPct || meta.story.widthPct || 90;
                document.getElementById('storyHeightPct').value = meta.story.box?.heightPct || meta.story.heightPct || 12;
                document.getElementById('storyMaxFontPx').value = meta.story.maxFontPx || 80;
                document.getElementById('storyShowLogo').checked = meta.story.showLogo !== false;
                
                // Font color settings
                const squareFontColor = meta.square.fontColor || '#FF273E';
                const storyFontColor = meta.story.fontColor || '#FF273E';
                document.getElementById('squareFontColor').value = squareFontColor;
                document.getElementById('storyFontColor').value = storyFontColor;
                selectColor(squareFontColor, 'square');
                selectColor(storyFontColor, 'story');
                
                // Mark that boxes have been drawn (since we're loading an existing template)
                drawingState.square.hasDrawnBox = true;
                drawingState.story.hasDrawnBox = true;
                
                // Load images into preview - use separate instances per variant
                const squareImg = new Image();
                squareImg.onload = async function() {
                    try {
                        await squareImg.decode();
                        previewImages.square = squareImg;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square image decode failed:', e);
                    }
                };
                squareImg.onerror = () => console.error('Square image load failed');
                squareImg.src = `/assets/templates/${slug}/square.png?t=${Date.now()}`;
                
                const storyImg = new Image();
                storyImg.onload = async function() {
                    try {
                        await storyImg.decode();
                        previewImages.story = storyImg;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story image decode failed:', e);
                    }
                };
                storyImg.onerror = () => console.error('Story image load failed');
                storyImg.src = `/assets/templates/${slug}/story.png?t=${Date.now()}`;
                
                // Update submit button text
                document.getElementById('submitBtn').textContent = 'Update Template';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                alert('Failed to load template: ' + error.message);
                console.error('Failed to load template:', error);
            }
        }

        // Show custom delete confirmation modal
        function showDeleteModal(message, onConfirm) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('deleteModal').classList.add('active');
            
            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.onclick = () => {
                closeDeleteModal();
                onConfirm();
            };
        }

        // Close delete confirmation modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        // Delete template
        async function deleteTemplate(slug, name) {
            showDeleteModal(
                `Are you sure you want to delete "${name}"?\n\nThis will permanently remove the template and both images.`,
                async () => {
                    try {
                        const response = await fetch('/api/delete-template', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug })
                        });

                        const data = await response.json();

                        if (data.success) {
                            loadAssets();
                        } else {
                            alert('Delete failed: ' + (data.error || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Delete failed: ' + error.message);
                        console.error('Failed to delete template:', error);
                    }
                }
            );
        }

        // Toggle select all checkboxes
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllTemplates');
            const checkboxes = document.querySelectorAll('.template-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // Update select all state based on individual checkboxes
        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.template-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllTemplates');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }

        // Delete selected templates
        async function deleteSelectedTemplates() {
            const checkboxes = document.querySelectorAll('.template-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one template to delete');
                return;
            }

            const templates = Array.from(checkboxes).map(cb => ({
                slug: cb.dataset.slug,
                name: cb.dataset.name
            }));

            const confirmMsg = templates.length === 1 
                ? `Are you sure you want to delete "${templates[0].name}"?\n\nThis will permanently remove the template and all images.`
                : `Are you sure you want to delete ${templates.length} templates?\n\n${templates.map(t => '• ' + t.name).join('\n')}\n\nThis will permanently remove all templates and images.`;

            showDeleteModal(confirmMsg, async () => {
                let successCount = 0;
                let failCount = 0;
                const errors = [];

                for (const template of templates) {
                    try {
                        const response = await fetch('/api/delete-template', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slug: template.slug })
                        });

                        const data = await response.json();

                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                            errors.push(`${template.name}: ${data.error || 'Unknown error'}`);
                        }
                    } catch (error) {
                        failCount++;
                        errors.push(`${template.name}: ${error.message}`);
                    }
                }

                // Reload the assets list
                loadAssets();

                // Show summary
                let message = '';
                if (successCount > 0) {
                    message += `Successfully deleted ${successCount} template${successCount > 1 ? 's' : ''}`;
                }
                if (failCount > 0) {
                    message += (message ? '\n\n' : '') + `Failed to delete ${failCount} template${failCount > 1 ? 's' : ''}:\n${errors.join('\n')}`;
                    alert(message);
                } else if (successCount > 0) {
                    alert(message + ' ✓');
                }
            });
        }

        // ==================== PREVIEW LOGIC ====================
        const previewSquareCanvas = document.getElementById('previewSquare');
        const previewStoryCanvas = document.getElementById('previewStory');
        const ctxSquare = previewSquareCanvas.getContext('2d');
        const ctxStory = previewStoryCanvas.getContext('2d');

        const previewImages = {
            square: null,
            story: null
        };

        // Auto-fit text calculation (from main app)
        function computeAutoFontPx(ctx, text, maxWidthPx, maxPx, minPx = 8) {
            const min = Math.max(8, Number(minPx) || 8);
            let lo = min, hi = Math.max(min, Number(maxPx) || min);
            if (!Number.isFinite(maxWidthPx) || maxWidthPx <= 0) return min;
            while (hi - lo > 0.5) {
                const mid = (hi + lo) / 2;
                ctx.font = `700 ${mid}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
                const w = ctx.measureText(text).width;
                if (w <= maxWidthPx) lo = mid; else hi = mid;
            }
            return Math.floor(lo);
        }

        function drawTextAutoFit(ctx, text, natW, natH, box, maxPx, fontColor) {
            const left = Math.round(natW * ((box?.leftPct ?? 5) / 100));
            const top = Math.round(natH * ((box?.topPct ?? 80) / 100));
            const width = Math.round(natW * ((box?.widthPct ?? 90) / 100));
            const height = Math.round(natH * ((box?.heightPct ?? 12) / 100));

            const cap = Math.min(maxPx, height);
            const px = computeAutoFontPx(ctx, text, width, cap, 8);

            const hAlign = (box?.hAlign || 'center');
            let x = left;
            let textAlign = 'left';
            if (hAlign === 'center') {
                x = left + Math.round(width / 2);
                textAlign = 'center';
            } else if (hAlign === 'right') {
                x = left + width;
                textAlign = 'right';
            }

            const vAlign = (box?.vAlign || 'bottom');
            let y = top + px;
            if (vAlign === 'middle') {
                y = top + Math.round(height / 2) + Math.round(px * 0.35);
            } else if (vAlign === 'bottom') {
                y = top + height;
            }

            ctx.font = `700 ${px}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'alphabetic';
            ctx.lineJoin = 'round';
            ctx.lineWidth = Math.max(2, Math.floor(px * 0.08));
            ctx.strokeStyle = 'rgba(0,0,0,.75)';
            ctx.fillStyle = fontColor || '#ffffff';
            ctx.strokeText(text, x, y);
            ctx.fillText(text, x, y);
        }

        function renderPreview(variant, showBoundingBox = false) {
            const canvas = variant === 'square' ? previewSquareCanvas : previewStoryCanvas;
            const ctx = variant === 'square' ? ctxSquare : ctxStory;
            const img = previewImages[variant];

            const natW = img && img.naturalWidth ? img.naturalWidth : 1080;
            const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

            // Create offscreen canvas at full resolution
            const off = document.createElement('canvas');
            off.width = natW;
            off.height = natH;
            const og = off.getContext('2d');
            og.imageSmoothingQuality = 'high';

            // Draw background image or placeholder
            if (img && img.naturalWidth) {
                og.drawImage(img, 0, 0, natW, natH);
            } else {
                og.fillStyle = '#10131a';
                og.fillRect(0, 0, natW, natH);
            }

            // Get current form values
            const prefix = variant === 'square' ? 'square' : 'story';
            const box = {
                leftPct: parseFloat(document.getElementById(prefix + 'LeftPct').value) || 5,
                topPct: parseFloat(document.getElementById(prefix + 'TopPct').value) || 78,
                widthPct: parseFloat(document.getElementById(prefix + 'WidthPct').value) || 90,
                heightPct: parseFloat(document.getElementById(prefix + 'HeightPct').value) || 12,
                hAlign: 'center',
                vAlign: 'middle'
            };
            const maxFontPx = parseInt(document.getElementById(prefix + 'MaxFontPx').value) || 80;

            // Draw bounding box overlay ONLY if actively drawing
            if (showBoundingBox) {
                const boxLeft = Math.round(natW * (box.leftPct / 100));
                const boxTop = Math.round(natH * (box.topPct / 100));
                const boxWidth = Math.round(natW * (box.widthPct / 100));
                const boxHeight = Math.round(natH * (box.heightPct / 100));
                
                // Semi-transparent box fill
                og.fillStyle = 'rgba(29, 152, 255, 0.15)';
                og.fillRect(boxLeft, boxTop, boxWidth, boxHeight);
                
                // Box border
                og.strokeStyle = 'rgba(29, 152, 255, 0.6)';
                og.lineWidth = Math.max(2, Math.round(Math.min(natW, natH) * 0.003));
                og.strokeRect(boxLeft, boxTop, boxWidth, boxHeight);
            }

            // Draw preview text with selected color (only if box has been drawn)
            const state = drawingState[variant];
            if (state.hasDrawnBox) {
                const fontColor = document.getElementById(variant + 'FontColor').value || '#FF273E';
                drawTextAutoFit(og, 'COUPON-AREA', natW, natH, box, maxFontPx, fontColor);
            }

            // Scale to canvas with high DPI
            const targetW = Math.max(1, Math.round(canvas.parentElement.clientWidth));
            const targetH = Math.max(1, Math.round(canvas.parentElement.clientHeight));
            const pixelRatio = window.devicePixelRatio || 2;
            canvas.width = targetW * pixelRatio;
            canvas.height = targetH * pixelRatio;
            canvas.style.width = targetW + 'px';
            canvas.style.height = targetH + 'px';
            
            // Reset transform to prevent accumulation
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(pixelRatio, pixelRatio);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, targetW, targetH);
            
            const scale = Math.min(targetW / natW, targetH / natH);
            const dw = Math.ceil(natW * scale);
            const dh = Math.ceil(natH * scale);
            const dx = Math.round((targetW - dw) / 2);
            const dy = Math.round((targetH - dh) / 2);
            
            ctx.drawImage(off, 0, 0, natW, natH, dx, dy, dw, dh);
        }

        // Debounced update to improve performance
        let updatePreviewsTimeout = null;
        function updatePreviews() {
            if (updatePreviewsTimeout) {
                clearTimeout(updatePreviewsTimeout);
            }
            updatePreviewsTimeout = setTimeout(() => {
                renderPreview('square');
                renderPreview('story');
            }, 50);
        }
        
        function updatePreviewsImmediate() {
            renderPreview('square');
            renderPreview('story');
        }

        // Load image when file is selected
        document.getElementById('squareImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Reset the drawn box flag for new uploads
                drawingState.square.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.square = img;
                        renderPreview('square');
                    } catch(e) {
                        console.error('Square upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        document.getElementById('storyImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Reset the drawn box flag for new uploads
                drawingState.story.hasDrawnBox = false;
                
                const img = new Image();
                img.onload = async function() {
                    try {
                        await img.decode();
                        previewImages.story = img;
                        renderPreview('story');
                    } catch(e) {
                        console.error('Story upload decode failed:', e);
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // Sync sliders with number inputs
        function setupSliderSync(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            
            if (!slider || !input) return;
            
            // Slider changes number input
            slider.addEventListener('input', function() {
                input.value = parseFloat(this.value).toFixed(1);
                updatePreviews();
            });
            
            // Number input changes slider
            input.addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (!isNaN(val)) {
                    slider.value = val;
                }
                updatePreviews();
            });
        }

        // Setup all slider-input pairs (only for Font Size sliders)
        setupSliderSync('squareMaxFontPxSlider', 'squareMaxFontPx');
        setupSliderSync('storyMaxFontPxSlider', 'storyMaxFontPx');

        // ==================== DRAG-TO-DRAW LOGIC ====================
        const drawingState = {
            square: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false },
            story: { isDrawing: false, startX: 0, startY: 0, currentX: 0, currentY: 0, hasDrawnBox: false }
        };

        function setupDragToDraw(canvasId, variant) {
            const canvas = document.getElementById(canvasId);
            const state = drawingState[variant];

            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            function convertToImagePercentages(startX, startY, endX, endY) {
                const rect = canvas.getBoundingClientRect();
                const canvasDisplayWidth = rect.width;
                const canvasDisplayHeight = rect.height;

                const img = previewImages[variant];
                const natW = img && img.naturalWidth ? img.naturalWidth : (variant === 'square' ? 1080 : 1080);
                const natH = img && img.naturalHeight ? img.naturalHeight : (variant === 'square' ? 1080 : 1920);

                const scale = Math.min(canvasDisplayWidth / natW, canvasDisplayHeight / natH);
                const scaledImageWidth = natW * scale;
                const scaledImageHeight = natH * scale;

                const offsetX = (canvasDisplayWidth - scaledImageWidth) / 2;
                const offsetY = (canvasDisplayHeight - scaledImageHeight) / 2;

                const imgX1 = (Math.min(startX, endX) - offsetX) / scaledImageWidth;
                const imgY1 = (Math.min(startY, endY) - offsetY) / scaledImageHeight;
                const imgX2 = (Math.max(startX, endX) - offsetX) / scaledImageWidth;
                const imgY2 = (Math.max(startY, endY) - offsetY) / scaledImageHeight;

                const leftPct = Math.max(0, Math.min(100, imgX1 * 100));
                const topPct = Math.max(0, Math.min(100, imgY1 * 100));
                const widthPct = Math.max(1, Math.min(100 - leftPct, (imgX2 - imgX1) * 100));
                const heightPct = Math.max(1, Math.min(100 - topPct, (imgY2 - imgY1) * 100));

                return { leftPct, topPct, widthPct, heightPct };
            }

            function drawDragRectangle() {
                if (!state.isDrawing) return;

                const ctx = variant === 'square' ? ctxSquare : ctxStory;
                
                renderPreview(variant, true);

                const rect = canvas.getBoundingClientRect();
                const x1 = Math.min(state.startX, state.currentX);
                const y1 = Math.min(state.startY, state.currentY);
                const width = Math.abs(state.currentX - state.startX);
                const height = Math.abs(state.currentY - state.startY);

                const pixelRatio = window.devicePixelRatio || 1;

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'rgba(29, 152, 255, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);

                ctx.fillStyle = 'rgba(29, 152, 255, 0.1)';
                ctx.fillRect(x1, y1, width, height);
                ctx.restore();
            }

            canvas.addEventListener('mousedown', (e) => {
                const coords = getCanvasCoordinates(e);
                state.isDrawing = true;
                state.startX = coords.x;
                state.startY = coords.y;
                state.currentX = coords.x;
                state.currentY = coords.y;
                renderPreview(variant, true);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                drawDragRectangle();
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!state.isDrawing) return;
                const coords = getCanvasCoordinates(e);
                state.currentX = coords.x;
                state.currentY = coords.y;
                state.isDrawing = false;

                const minDragDistance = 10;
                if (Math.abs(state.currentX - state.startX) < minDragDistance || 
                    Math.abs(state.currentY - state.startY) < minDragDistance) {
                    renderPreview(variant);
                    return;
                }

                const percentages = convertToImagePercentages(
                    state.startX, state.startY, 
                    state.currentX, state.currentY
                );

                const prefix = variant === 'square' ? 'square' : 'story';
                document.getElementById(prefix + 'LeftPct').value = percentages.leftPct.toFixed(1);
                document.getElementById(prefix + 'TopPct').value = percentages.topPct.toFixed(1);
                document.getElementById(prefix + 'WidthPct').value = percentages.widthPct.toFixed(1);
                document.getElementById(prefix + 'HeightPct').value = percentages.heightPct.toFixed(1);

                // Mark that a box has been drawn
                state.hasDrawnBox = true;

                updatePreviewsImmediate();
            });

            canvas.addEventListener('mouseleave', (e) => {
                if (state.isDrawing) {
                    state.isDrawing = false;
                    renderPreview(variant);
                }
            });
        }

        setupDragToDraw('previewSquare', 'square');
        setupDragToDraw('previewStory', 'story');

        // Nudge position controls
        function nudgePosition(variant, direction) {
            const prefix = variant === 'square' ? 'square' : 'story';
            const leftInput = document.getElementById(prefix + 'LeftPct');
            const topInput = document.getElementById(prefix + 'TopPct');
            
            const step = 0.5;
            let currentLeft = parseFloat(leftInput.value) || 5;
            let currentTop = parseFloat(topInput.value) || 78;
            
            switch(direction) {
                case 'up':
                    currentTop = Math.max(0, currentTop - step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'down':
                    currentTop = Math.min(100, currentTop + step);
                    topInput.value = currentTop.toFixed(1);
                    break;
                case 'left':
                    currentLeft = Math.max(0, currentLeft - step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
                case 'right':
                    currentLeft = Math.min(100, currentLeft + step);
                    leftInput.value = currentLeft.toFixed(1);
                    break;
            }
            
            updatePreviews();
        }

        // Initial render
        updatePreviewsImmediate();
    </script>
</body>
</html>
